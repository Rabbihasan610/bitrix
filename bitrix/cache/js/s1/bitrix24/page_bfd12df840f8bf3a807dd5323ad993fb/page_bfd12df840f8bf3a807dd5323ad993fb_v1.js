
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/socialnetwork.admin.set/templates/.default/script.js?16992580712527";s:6:"source";s:78:"/bitrix/components/bitrix/socialnetwork.admin.set/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
var waitDiv = null;
var waitPopup = null;
var waitTimeout = null;
var waitTime = 500;

function __SASSetAdmin()
{
	__SASShowWait();
	BX.ajax({
		url: '/bitrix/components/bitrix/socialnetwork.admin.set/ajax.php',
		method: 'POST',
		dataType: 'json',
		data: {'ACTION': 'SET', 'sessid': BX.bitrix_sessid(), 'site': BX.util.urlencode(BX.message('SASSiteId'))},
		onsuccess: function(data) { __SASProcessAJAXResponse(data); }
	});
}

function __SASProcessAJAXResponse(data)
{
	if (data["SUCCESS"] != "undefined" && data["SUCCESS"] == "Y")
	{
		BX.reload();
		return false;
	}
	else if (data["ERROR"] != "undefined" && data["ERROR"].length > 0)
	{
		if (data["ERROR"].indexOf("SESSION_ERROR", 0) === 0)
		{
			__SASShowError(BX.message('SASErrorSessionWrong'));
			BX.reload();
		}
		else if (data["ERROR"].indexOf("CURRENT_USER_NOT_ADMIN", 0) === 0)
		{
			__SASShowError(BX.message('SASErrorNotAdmin'));
			return false;
		}
		else if (data["ERROR"].indexOf("CURRENT_USER_NOT_AUTH", 0) === 0)
		{
			__SASShowError(BX.message('SASErrorCurrentUserNotAuthorized'));
			return false;
		}
		else if (data["ERROR"].indexOf("SONET_MODULE_NOT_INSTALLED", 0) === 0)
		{
			__SASShowError(BX.message('SASErrorModuleNotInstalled'));
			return false;
		}
		else
		{
			__SASShowError(data["ERROR"]);
			return false;		
		}
	}
}
				
function __SASShowError(errorText) 
{
	__SASCloseWait();

	var errorPopup = new BX.PopupWindow('sas-error' + Math.random(), window, {
		autoHide: true,
		lightShadow: false,
		zIndex: 2,
		content: BX.create('DIV', {props: {'className': 'sonet-adminset-error-text-block'}, html: errorText}),
		closeByEsc: true,
		closeIcon: true
	});
	errorPopup.show();

}

function __SASShowWait(timeout)
{
	if (timeout !== 0)
	{
		return (waitTimeout = setTimeout(function(){
			__SASShowWait(0)
		}, 50));
	}

	if (!waitPopup)
	{
		waitPopup = new BX.PopupWindow('sas_wait', window, {
			autoHide: true,
			lightShadow: true,
			zIndex: 2,
			content: BX.create('DIV', {
				props: {
					className: 'sonet-adminset-wait-cont'
				},
				children: [
					BX.create('DIV', {
						props: {
							className: 'sonet-adminset-wait-icon'
						}
					}),
					BX.create('DIV', {
						props: {
							className: 'sonet-adminset-wait-text'
						},
						html: BX.message('SASWaitTitle')
					})
				]
			})
		});
	}
	else
		waitPopup.setBindElement(window);

	waitPopup.show();
}

function __SASCloseWait()
{
	if (waitTimeout)
	{
		clearTimeout(waitTimeout);
		waitTimeout = null;
	}

	if (waitPopup)
		waitPopup.close();
}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/tasks.iframe.popup/templates/wrap/logic.min.js?16992580841319";s:6:"source";s:68:"/bitrix/components/bitrix/tasks.iframe.popup/templates/wrap/logic.js";s:3:"min";s:72:"/bitrix/components/bitrix/tasks.iframe.popup/templates/wrap/logic.min.js";s:3:"map";s:72:"/bitrix/components/bitrix/tasks.iframe.popup/templates/wrap/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.IframePopup!="undefined"){return}BX.Tasks.Component.IframePopup={};BX.Tasks.Component.IframePopup.SideSlider=BX.Tasks.Component.extend({sys:{code:"iframe-popup-side-slider"},methods:{bindEvents:function(){BX.addCustomEvent(window,"tasksTaskEvent",this.onTaskGlobalEvent.bind(this));BX.bindDelegate(this.scope(),"click",{className:"js-id-copy-page-url"},this.onCopyUrl.bind(this))},onCopyUrl:function(o){o=o||window.event;this.onCopyUrlByNode(o.target,this.getWindowHref())},onCopyUrlByNode:function(o,e){this.timeoutIds=this.timeoutIds||[];if(!BX.clipboard.copy(e)){return}var t={content:BX.message("TASKS_TIP_TEMPLATE_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,offsetLeft:20,bindOptions:{position:"top"}};var n=new BX.PopupWindow("tasks_clipboard_copy",o,t);n.show();var i;while(i=this.timeoutIds.pop())clearTimeout(i);i=setTimeout(function(){n.close()},1500);this.timeoutIds.push(i)},getWindowHref:function(){return BX.util.remove_url_param(window.location.href,["IFRAME","IFRAME_TYPE"])},onTaskGlobalEvent:function(o,e){if(BX.type.isNotEmptyString(o)){e=e||{};if(!e.options.STAY_AT_PAGE){window.top.BX.onCustomEvent("BX.Bitrix24.PageSlider:close",[false])}}}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:84:"/bitrix/components/bitrix/tasks.task/templates/.default/logic.min.js?169925808224459";s:6:"source";s:64:"/bitrix/components/bitrix/tasks.task/templates/.default/logic.js";s:3:"min";s:68:"/bitrix/components/bitrix/tasks.task/templates/.default/logic.min.js";s:3:"map";s:68:"/bitrix/components/bitrix/tasks.task/templates/.default/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.Task!="undefined"){return}BX.Tasks.Component.Task=BX.Tasks.Util.Widget.extend({options:{removeTemplates:false,registerDispatcher:true,data:{}},constants:{PRIORITY_AVERAGE:1,PRIORITY_HIGH:2},sys:{code:"task-edit"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.instances.calendar=false;this.instances.helpWindow=false;this.analyticsData={};this.fireTaskEvent();if(this.option("doInit")){this.bindEvents();this.initParentTask();this.initRelatedTask();this.initReminder();this.initProjectDependence();this.initProjectPlan();this.initState();this.doSomeTricks()}this.onTitleChange();this.onResponsibleChange();this.checkNoWorkDays(this.getTaskData().MATCH_WORK_TIME==="Y");this.calendarSettings=this.option("calendarSettings")},getUser:function(){return this.option("auxData").USER},restrictMemberSelectors:function(){if(this.getUser().IS_SUPER_USER){return}this.vars.responsible=null;this.vars.originator=null;BX.Tasks.Util.Dispatcher.find(this.option("id")+"-responsible").then(function(t){this.vars.responsible=t;return BX.Tasks.Util.Dispatcher.find(this.option("id")+"-originator")}.bind(this)).then(function(t){this.vars.originator=t;var e=this.vars.responsible;this.vars.responsibleRestrLock=false;this.vars.originatorRestrLock=false;t.bindEvent("change",this.restrictResponsible.bind(this));e.bindEvent("change",this.restrictOriginator.bind(this))}.bind(this))},restrictResponsible:function(){if(this.vars.responsibleRestrLock){return}this.vars.originatorRestrLock=true;var t=this.vars.responsible;var e=this.vars.originator;var i=this.getUser().DATA;var s=e.value();var n=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){n=s[0]}if(n){s=t.value();var a=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){a=s[0]}if(n!="U"+i.ID){if(a!=i.ID){t.replaceItem(a,i)}t.readOnly(true)}else{t.readOnly(false)}}this.vars.originatorRestrLock=false},restrictOriginator:function(){if(this.vars.originatorRestrLock){return}this.vars.responsibleRestrLock=true;var t=this.vars.originator;var e=this.vars.responsible;if(t){if(e.count()>1){var i=this.getUser().DATA;var s=t.value();var n=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){n=s[0]}if(n){t.replaceItem(n,i);if(BX.hasClass(this.control("originator"),"invisible")){this.toggleBlock("originator")}}t.readOnly(true)}else{t.readOnly(false)}}this.vars.responsibleRestrLock=false},disableHints:function(){BX.Tasks.Util.hintManager.disableSeveral(this.option("auxData").HINT_STATE)},fireTaskEvent:function(){var t=this.option("componentData").EVENT_TYPE.toString().toUpperCase();var e=this.option("data").EVENT_TASK;var i=this.option("data").EVENT_TASK_UGLY;if(t&&(e||i)){BX.Tasks.Util.fireGlobalTaskEvent(t,e,this.option("componentData").EVENT_OPTIONS,i)}},doSomeTricks:function(){this.disableHints();this.replaceCmdBtn();var t=this.control("flag-replication");if(t.checked){BX.removeClass(this.control("replication-panel"),"invisible")}},replaceCmdBtn:function(){if(BX.browser.IsMac()){var t=this.control("cmd");if(t){t.innerHTML="&#8984;"}}},bindEditorEvents:function(t,e){BX.addCustomEvent(t,"OnIframeKeyup",e);BX.addCustomEvent(t,"OnTextareaKeyup",e)},setFocusOnTitle:function(t){setTimeout(function(){var e=this.control("title");if(e){t.Focus(false);e.focus();e.selectionStart=e.value.length;BX.focus()}}.bind(this),500)},isEditMode:function(){return this.option("template").EDIT_MODE},bindEvents:function(){if(!this.isEditMode()){BX.ready(BX.delegate((function(){var t=BX.delegate(this.onFormKeyDown,this);BX.bind(document,"keydown",t);var e=this.option("template").ID;var i=BXHtmlEditor.Get(e);if(i){this.bindEditorEvents(i,t);this.setFocusOnTitle(i,t)}else{BX.addCustomEvent(window,"OnEditorInitedAfter",BX.delegate((function(s){if(s!=null&&s.id==e){this.bindEditorEvents(s,t);this.setFocusOnTitle(i,t)}}),this))}}),this))}this.bindDelegateControl("toggler","click",this.passCtx(this.onToggleBlock));this.bindDelegateControl("flag","click",this.passCtx(this.onToggleFlag));this.bindDelegateControl("chooser","click",this.passCtx(this.onChooseBlock));this.bindDelegateControl("additional-header","click",this.passCtx(this.onToggleAdditionalBlock));this.bindDelegateControl("priority-cb","change",this.passCtx(this.onPriorityChange));this.bindDelegateControl("pin-footer","click",BX.delegate(this.onPinFooterClick,this));this.bindControl("cancel-button","click",BX.delegate(this.onCancelButtonClick,this));this.bindControl("title","keyup",BX.delegate(this.onTitleChange,this));this.bindControl("to-checklist","click",BX.delegate(this.onToCheckListClick,this));var t=this.scope().getElementsByClassName("js-id-wg-optbar-flag-match-work-time");if(t.length){BX.bind(t[0],"change",this.passCtx(this.onWorktimeChange))}this.bindControl("form","submit",BX.delegate(this.onFormSubmit,this));this.bindDelegateControl("submit","click",this.passCtx(this.onSubmitClick));this.bindNestedControls();this.bindSliderEvents();BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",function(t){var e=t.data.action;var i=["addAccomplice","fileUpload","tabIn"];if(BX.util.in_array(e,i)){this.analyticsData[e]="Y"}BX("checklistAnalyticsData").value=Object.keys(this.analyticsData).join(",")}.bind(this));BX.Tasks.Util.hintManager.bindHelp(this.control("options"));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:projectSelected",BX.delegate(this.onProjectSelected,this));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:projectDeselected",BX.delegate(this.onProjectDeselected,this));var e=BX.Tasks.Component.TasksWidgetMemberSelector.getInstance(this.sys.id+"-project");var i=e.getSelector().getDialog().getPreselectedItems();if(i.length){var s=parseInt(i[0][1],10);this.showScrumFields(s);BX.Event.EventEmitter.emit("BX.Tasks.Component.Task:projectPreselected",{groupId:s})}},bindNestedControls:function(){BX.Tasks.Util.Dispatcher.bindEvent(this.option("id")+"-responsible","change",this.onResponsibleChange.bind(this));BX.Tasks.Util.Dispatcher.bindEvent(this.option("id")+"-originator","change",this.onOriginatorChange.bind(this));this.restrictMemberSelectors();this.getDispatcher().bindEvent("options-"+this.option("id"),"toggle",this.processToggleFlag.bind(this))},bindSliderEvents:function(){BX.addCustomEvent("SidePanel.Slider:onLoad",this.setEditorBeforeUnloadEvent.bind(this,true));BX.addCustomEvent("SidePanel.Slider:onClose",this.setEditorBeforeUnloadEvent.bind(this,false));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate((function(t){if(t.getEventId()==="sonetGroupEvent"){var e=t.getData();if(BX.type.isNotEmptyString(e.code)&&e.code==="afterCreate"&&typeof e.data!="undefined"&&typeof e.data.group!="undefined"){var i=e.data.group;var s=BX.Tasks.Component.TasksWidgetMemberSelector.getInstance(this.sys.id+"-project");s.getSelector().onSelectorItemSelected({id:i.ID,entityType:"SG",networkId:"",DISPLAY:BX.util.htmlspecialcharsback(i.FIELDS.NAME)})}}}),this));BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",(function(t){t.denyAction()}))},setEditorBeforeUnloadEvent:function(t){var e=this.option("template").ID;var i=BXHtmlEditor.Get(e);if(i){t?i.AllowBeforeUnloadHandler():i.DenyBeforeUnloadHandler()}},getTaskData:function(){return this.option("data").TASK},getTaskActions:function(){return this.getTaskData().ACTION},initProjectDependence:function(){var t=BX.Tasks.Util.Dispatcher.get("projectdependence-"+this.id());t.assignCalendar(this.getCalendar());t.option("task",{data:this.getTaskData()});t.load(this.getTaskData().SE_PROJECTDEPENDENCE,this.getTaskActions().SE_PROJECTDEPENDENCE)},initProjectPlan:function(){this.instances.projectPlan=new BX.Tasks.Shared.Form.ProjectPlan({scope:this.control("date-plan-manager"),parent:this,matchWorkTime:this.getTaskData().MATCH_WORK_TIME==="Y"});this.instances.projectPlan.bindEvent("change-deadline",BX.delegate((function(t,e){if(!this.isEditMode()&&t){this.showExpiredDeadlineHint(e.getTime())}BX.Tasks.Util.Dispatcher.fireEvent("reminder-"+this.id(),"setTaskDeadLine",[t])}),this));if(!this.isEditMode()&&this.getTaskData().DEADLINE_ISO){this.showExpiredDeadlineHint(new Date(this.getTaskData().DEADLINE_ISO).getTime())}},showExpiredDeadlineHint:function(t){if(t<Date.now()){BX.Tasks.Util.hintManager.show(this.instances.projectPlan.getDeadlinePicker().control("display"),BX.message("TASKS_TASK_COMPONENT_TEMPLATE_HINT_DEADLINE_EXPIRED"),null,null,{autoHide:true})}},initParentTask:function(){var t="parenttask";var e=new BX.Tasks.Component.Task.TaskItemSet({id:t+"-"+this.id(),max:1,selectorCode:t,itemFx:"horizontal",itemFxHoverDelete:true,parent:this});e.bindEvent("change",BX.delegate((function(t){this.control("parent-input").value=t.length>0?parseInt(t[0]):""}),this));if(this.getTaskData().SE_PARENTTASK){e.load([this.getTaskData().SE_PARENTTASK])}this.instances[t]=e},initRelatedTask:function(){this.instances["dependson"]=new BX.Tasks.Component.Task.TaskItemSet({id:"dependson-"+this.id(),selectorCode:"dependson",itemFx:"horizontal",itemFxHoverDelete:true,parent:this});if(typeof this.getTaskData().SE_RELATEDTASK!="undefined"){this.instances["dependson"].load(this.getTaskData().SE_RELATEDTASK)}},initReminder:function(){var t=BX.Tasks.Util.Dispatcher.get("reminder-"+this.id());if(t!==null){t.load(this.getTaskData().SE_REMINDER,this.getTaskActions().SE_REMINDER);t.setTaskId(this.getTaskData().ID);t.setTaskDeadLine(this.getTaskData().DEADLINE)}},initState:function(){this.vars.state=BX.clone(this.option("state"));this.redrawState()},onPinFooterClick:function(){var t=!this.vars.state.FLAGS.FORM_FOOTER_PIN;var e=this.control("footer");if(e){BX[t?"addClass":"removeClass"](e,"pinned")}this.setState("FLAGS","FORM_FOOTER_PIN",false,t)},onPriorityChange:function(t){var e=this.control("priority");if(BX.type.isElementNode(e)){e.value=t.checked?this.PRIORITY_HIGH:this.PRIORITY_AVERAGE}},onFormSubmit:function(){var t=this.control("csrf");if(t){t.value=BX.bitrix_sessid()}this.vars.submitting=true},onSubmitClick:function(t,e){if(this.vars.submitting){BX.PreventDefault(e);return}BX.addClass(t,"ui-btn-clock");this.vars.submitting=true},onProjectSelected:function(t){this.showScrumFields(t.data.ID)},onProjectDeselected:function(t){var e=this.control("unchosen-blocks");if(!BX.type.isElementNode(e)){return}var i=["EPIC"];i.forEach((function(i){var s=e.querySelector("[data-block-name="+i+"]");setTimeout((function(){if(parseInt(s.dataset.groupId,10)===parseInt(t.data.ID,10)){s.dataset.groupId=0;BX.addClass(s,"hidden")}}),100)}))},showScrumFields:function(t){BX.ajax.runComponentAction("bitrix:tasks.task","needShowEpicField",{mode:"class",data:{groupId:t}}).then(function(e){var i=e.data;var s=this.control("unchosen-blocks");if(!BX.type.isElementNode(s)){return}var n=["EPIC"];if(i){n.forEach((function(e){var i=s.querySelector("[data-block-name="+e+"]");i.dataset.groupId=t;BX.removeClass(i,"hidden")}))}else{n.forEach((function(e){var i=s.querySelector("[data-block-name="+e+"]");i.dataset.groupId=t;BX.addClass(i,"hidden")}))}}.bind(this)).catch(function(t){}.bind(this))},submit:function(){BX.Tasks.CheckListInstance.getTreeStructure().appendRequestLayout();this.control("form").submit()},onFormKeyDown:function(t){t=t||window.event;var e=false;if(BX.Tasks.Util.isEnter(t)){if((t.ctrlKey||t.metaKey)&&t.type==="keydown"){var i=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");if(i&&i.isOpen()){return}this.submit();e=true}}if(e){BX.PreventDefault(t)}},onChooseBlock:function(t){var e=this.control("chosen-blocks");var i=this.control("unchosen-blocks");if(!BX.type.isElementNode(e)||!BX.type.isElementNode(i)){return}var s=BX.data(t,"target");if(typeof s!="undefined"&&BX.type.isNotEmptyString(s)){var t=this.control(s);var n=BX.data(t,"block-name");if(BX.type.isNotEmptyString(n)&&BX.type.isElementNode(t)){var a=this.vars.state["BLOCKS"][n];if(typeof a.C!="undefined"){var o=!a.C;var r=this.control(s+"-place",o?e:i);var l=this.control(s+"-place",o?i:e);if(r){if(!o){var c=this.control("additional");if(BX.hasClass(c,"hidden")){BX.removeClass(c,"hidden")}}BX.Tasks.Util.fadeSlideToggleByClass(l,200,(function(){BX.addClass(r,"invisible");BX.append(t,r);BX.Tasks.Util.fadeSlideToggleByClass(r,200);BX.removeClass(l,"invisible")}))}else{BX.toggleClass(t,"pinned")}this.setState("BLOCKS",n,"C",!a.C)}}}},onToggleAdditionalBlock:function(t){var e=BX.hasClass(t,"opened");BX.toggleClass(t,"opened");this.toggleBlock("unchosen-blocks")},onToggleBlock:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){if(e==="checklist"){var i=this;this.toggleBlock(e).then((function(){if(!BX.hasClass(i.control(e),"invisible")){var t=BX.Tasks.CheckListInstance.getTreeStructure();if(t.getDescendantsCount()===0){BX.Tasks.CheckListInstance.addCheckList().then((function(t){t.addCheckListItem()}))}}}))}else{this.toggleBlock(e)}}},toggleBlock:function(t,e){return BX.Tasks.Util.fadeSlideToggleByClass(this.control(t),e||100)},toggleOption:function(t,e){var i=this.getOptionNode(t);if(i){i.checked=!!e;this.onToggleFlag(i)}},switchOption:function(t,e){var i=this.getOptionNode(t);if(i){i.disabled=!!e}},getOptionNode:function(t){t=t.toLowerCase().replace(/_/g,"-");return this.control("flag-"+t)},onToggleFlag:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var i=this.control(e);var s=BX.data(t,"flag-name");if(BX.type.isElementNode(i)){i.value=t.checked?"Y":"N"}if((s==="SAVE_AS_TEMPLATE"||s==="REPLICATE")&&i.value==="Y"&&(this.option("auxData").TASK_LIMIT_EXCEEDED||this.option("auxData").TASK_RECURRENT_RESTRICT)){i.value="N";t.checked=false;var n=s==="REPLICATE"?"limit_tasks_recurring_tasks":"limit_tasks_template";BX.UI.InfoHelper.show(n,{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"taskEdit"}});return}this.processToggleFlag(s,i.value==="Y")}},processToggleFlag:function(t,e){if(t=="REPLICATE"){var i=this.option("auxData").TASK_LIMIT_EXCEEDED;var s=this.option("auxData").TASK_RECURRENT_RESTRICT;if(!i||i&&!e){BX.Tasks.Util.fadeSlideToggleByClass(this.control("replication-panel"));this.toggleOption("SAVE_AS_TEMPLATE",e);this.switchOption("SAVE_AS_TEMPLATE",e)}}else if(t=="TASK_PARAM_1"){this.toggleDateParameters(e)}this.setState("FLAGS",t,false,e)},toggleDateParameters:function(t){BX[t?"addClass":"removeClass"](this.control("date-plan"),"disabled-block");BX.Tasks.Util.Dispatcher.find("options-"+this.option("id")).then(function(e){e.switchOption("MATCH_WORK_TIME",!t)}.bind(this))},onOriginatorChange:function(){BX.Tasks.Util.Dispatcher.find(this.option("id")+"-originator").then(function(t){if(t.count()&&t.value()){var e="U"+this.getUser().DATA.ID.toString()==t.value()[0].toString();BX.Tasks.Util.Dispatcher.find("options-"+this.option("id")).then(function(t){t.switchOption("ADD_TO_TIMEMAN",e)}.bind(this))}}.bind(this))},onResponsibleChange:function(){BX.Tasks.Util.Dispatcher.find(this.option("id")+"-responsible").then(function(t){if(t.count()>1){BX.Tasks.Util.hintManager.showDisposable(t.scope(),BX.message("TASKS_TASK_COMPONENT_TEMPLATE_MULTIPLE_RESPONSIBLE_NOTICE"),"TASK_EDIT_MULTIPLE_RESPONSIBLES")}else{BX.Tasks.Util.hintManager.hide("TASK_EDIT_MULTIPLE_RESPONSIBLES")}if(t.count()>0){var e=this.control("absence-message");e.style.display="none";while(e.lastChild){e.removeChild(e.lastChild)}BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","isAbsence",{mode:"class",data:{userIds:t.value().map((function(t){return t.substring(1)}))}}).then(function(t){if(!t.status||t.status!=="success"){return}if(!t.data.length){return}var i=t.data.reduce((function(t,e){return t+"<br />"+e}));var s=new BX.UI.Alert({icon:BX.UI.Alert.Icon.INFO,color:BX.UI.Alert.Color.WARNING,text:i});e.appendChild(s.getContainer());e.style.display="block"}.bind(this),function(t){}.bind(this))}}.bind(this))},onCancelButtonClick:function(t){if(this.option("cancelActionIsEvent")){BX.Tasks.Util.fireGlobalTaskEvent("NOOP",{},{STAY_AT_PAGE:false});BX.PreventDefault(t)}},onWorktimeChange:function(t){this.checkNoWorkDays(t.checked);this.instances.projectPlan.setMatchWorkTime(t.checked)},checkNoWorkDays:function(t){if(!t){if(BX.type.isElementNode(BX("date-plan-alert"))){BX("date-plan-alert").remove()}return false}var e=true;var i=this.getCalendar();var s=i.weekends;var n=[0,1,2,3,4,5,6];n.forEach((function(t){if(!(t in s)){e=false}}));if(e&&!BX.type.isElementNode(BX("date-plan-alert"))){var a=BX.create("div",{props:{id:"date-plan-alert",className:"ui-alert ui-alert-danger"},attrs:{style:"margin-top: 10px"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_NO_WORK_DAYS_ERROR")})]});this.control("date-plan-manager").appendChild(a)}return e},onTitleChange:function(){var t=this.control("title");if(t.value.length>250){BX.addClass(t,"task-field-error")}else{BX.removeClass(t,"task-field-error")}},showToCheckListHintNoItems:function(){var t=new BX.PopupWindow({bindElement:this.control("to-checklist"),content:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_TO_CHECKLIST_HINT"),className:"tasks-to-checklist-popup",darkMode:true,autoHide:true,closeByEsc:true,angle:true,offsetLeft:this.control("to-checklist").offsetWidth/2,events:{onPopupClose:function(){this.destroy()}}});t.show();setTimeout((function(){t.close()}),2e3)},showToCheckListHintCreated:function(){var t=new BX.PopupWindow({bindElement:this.control("to-checklist"),content:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_TO_CHECKLIST_HINT_CREATED"),className:"tasks-to-checklist-popup",darkMode:true,autoHide:true,closeByEsc:true,angle:true,offsetLeft:this.control("to-checklist").offsetWidth/2,events:{onPopupClose:function(){this.destroy()}}});t.show();setTimeout((function(){t.close()}),2e3)},getEditorSelectedText:function(){var t="";var e=this.control("editor-container");var i=e.querySelector(".bxhtmled-iframe-cnt").style.display==="none";if(i){var s=e.querySelector(".bxhtmled-textarea");var n=s.selectionStart;var a=s.selectionEnd;t=s.value.substring(n,a)}else{var o=e.querySelector(".bx-editor-iframe").contentDocument;if(o.getSelection){t=o.getSelection().toString()}else if(o.selection){t=o.selection.createRange().text}}return t},getTitlesFromText:function(t){if(t===""){return[]}return t.split(/\r\n|\r|\n/g)},onToCheckListClick:function(){var t=this.getEditorSelectedText();var e=this.getTitlesFromText(t);if(e.length<=0){this.showToCheckListHintNoItems();return}var i=BX.Tasks.CheckListInstance.getTreeStructure();if(i.getDescendantsCount()===0){var s=this.getCheckListItemsFromTitles(e);BX.Tasks.CheckListInstance.addCheckList().then(function(t){s.forEach((function(e){t.addCheckListItem(e)}));t.handleTaskOptions();BX("checklistFromDescription").value="fromDescription";this.showToCheckListHintCreated()}.bind(this));if(BX.hasClass(this.control("checklist"),"invisible")){this.toggleBlock("checklist")}}else{var n=new BX.PopupMenuWindow({bindElement:this.control("to-checklist"),items:this.getToCheckListPopupMenuItems(e)});n.show()}},getToCheckListPopupMenuItems:function(t){var e=this;var i=BX.Tasks.CheckListInstance.getTreeStructure();var s=[{text:"+ "+BX.message("TASKS_TASK_COMPONENT_TEMPLATE_TO_CHECKLIST_ADD_NEW_CHECKLIST"),onclick:function(i,s){s.getMenuWindow().close();var n=e.getCheckListItemsFromTitles(t);BX.Tasks.CheckListInstance.addCheckList().then((function(t){n.forEach((function(e){t.addCheckListItem(e)}));t.handleTaskOptions();BX("checklistFromDescription").value="fromDescription";e.showToCheckListHintCreated()}));if(BX.hasClass(e.control("checklist"),"invisible")){e.toggleBlock("checklist")}}},{delimiter:true}];i.getDescendants().forEach((function(i){s.push({text:i.fields.getTitle(),onclick:function(s,n){n.getMenuWindow().close();var a=e.getCheckListItemsFromTitles(t);a.forEach((function(t){i.addCheckListItem(t)}));a[0].handleTaskOptions();BX("checklistFromDescription").value="fromDescription";e.showToCheckListHintCreated();if(BX.hasClass(e.control("checklist"),"invisible")){e.toggleBlock("checklist")}}})}));return s},getCheckListItemsFromTitles:function(t){var e=[];t.forEach((function(t){t=t.trim().substring(0,255).trim();if(t.length>0){var i=new BX.Tasks.CheckListItem({TITLE:t});e.push(i)}}));return e},getCalendar:function(){if(this.instances.calendar==false){this.instances.calendar=new BX.Tasks.Calendar(BX.Tasks.Calendar.adaptSettings(this.option("auxData").COMPANY_WORKTIME))}return this.instances.calendar},getState:function(t,e,i){if(t=="BLOCKS"){return this.vars.state[t][e][i]}if(t=="FLAGS"){return this.vars.state[t][e]}},setState:function(t,e,i,s){if(!BX.type.isNotEmptyString(e)){return}if(t=="FLAGS"){var n={ALLOW_TIME_TRACKING:true,TASK_CONTROL:true,ALLOW_CHANGE_DEADLINE:true,MATCH_WORK_TIME:true,FORM_FOOTER_PIN:true,REQUIRE_RESULT:true,TASK_PARAM_3:true};if(!(e in n)){return}}if(typeof this.vars.state[t]=="undefined"){this.vars.state[t]={}}if(typeof this.vars.state[t][e]=="undefined"){this.vars.state[t][e]={}}if(t=="BLOCKS"){this.vars.state[t][e][i]=s}if(t=="FLAGS"){this.vars.state[t][e]=s}this.submitState();this.redrawState()},submitState:function(){var t=BX.clone(this.vars.state);var e=t.FLAGS.FORM_FOOTER_PIN;delete t.FLAGS;t.FLAGS={FORM_FOOTER_PIN:e};BX.ajax.runComponentAction("bitrix:tasks.task","setState",{mode:"class",data:{state:t}}).then(function(t){}.bind(this)).catch(function(t){}.bind(this))},redrawState:function(){var t=this.control("state");if(BX.type.isElementNode(t)){var e="";if(typeof this.vars.state["BLOCKS"]!="undefined"){for(var i in this.vars.state["BLOCKS"]){var s=this.vars.state["BLOCKS"][i]["O"];var n=this.vars.state["BLOCKS"][i]["C"];if(typeof s!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:i,TYPE:"O",VALUE:s===true||s==="true"?"1":"0"})}if(typeof n!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:i,TYPE:"C",VALUE:n===true||n==="true"?"1":"0"})}}}if(typeof this.vars.state["FLAGS"]!="undefined"){for(var a in this.vars.state["FLAGS"]){var o=this.vars.state["FLAGS"][a];e+=this.getHTMLByTemplate("state-flag",{NAME:a,VALUE:o===true||o==="true"?"1":"0"})}}t.innerHTML=e}}}});BX.Tasks.Component.Task.UserItemSet=BX.Tasks.UserItemSet.extend({methods:{onSearchBlurred:function(){if(this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")){this.restoreKept()}},restoreKept:function(){if(this.vars.toDelete){this.addItem(this.vars.toDelete,{checkRestrictions:false});this.vars.toDelete=false}},onSelectorItemSelected:function(t){var e=this.extractItemValue(t);if(!this.hasItem(e)){var i=this.option("max");this.addItem(t);this.vars.toDelete=false;if(i==1){this.instances.selector.close();this.onSearchBlurred()}}this.resetInput()},openAddForm:function(t,e,i){var s=this.option("min");var n=this.option("max");if(i||n==1&&(s==0||s==1)){var a=this.getItemFirst();if(a){this.vars.toDelete=a.data();this.callMethod(BX.Tasks.UserItemSet,"deleteItem",[a.value(),{checkRestrictions:false}])}}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},deleteItem:function(t){if(!this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.openAddForm(false,false,true);return false}return true}}});BX.Tasks.Component.Task.GroupItemSet=BX.Tasks.Component.Task.UserItemSet.extend({sys:{code:"group-item-set"},methods:{extractItemDisplay:function(t){return t.NAME||BX.util.htmlspecialcharsback(t.nameFormatted)},getNSMode:function(){return"group"}}});BX.Tasks.Component.Task.TaskItemSet=BX.Tasks.PopupItemSet.extend({sys:{code:"task-item-set"},options:{itemFx:"horizontal"},methods:{construct:function(){this.callConstruct(BX.Tasks.PopupItemSet);this.instances.selector=window["O_"+this.option("selectorCode")]},extractItemDisplay:function(t){if(typeof t.DISPLAY!="undefined"){return t.DISPLAY}if(typeof t.name!="undefined"){return t.name}return t.TITLE+" ["+t.ID+"]"},extractItemValue:function(t){return typeof t.ID=="undefined"?t.id:t.ID},bindFormEvents:function(){if(typeof this.instances.selector!="undefined"&&this.instances.selector!=null&&this.instances.selector!=false){BX.addCustomEvent(this.instances.selector,"on-change",BX.delegate(this.itemsChanged,this));if(typeof this.instances.window!="undefined"){var t=this.instances.selector;BX.addCustomEvent(this.instances.window,"onAfterPopupShow",(function(){setTimeout((function(){t.searchInput.focus()}),100)}))}}},deleteItem:function(t,e){var i=BX.type.isNumber(t)||BX.type.isString(t)?t:t.value();if(this.callMethod(BX.Tasks.PopupItemSet,"deleteItem",arguments)){this.instances.selector.unselect(i)}}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:95:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/script.min.js?169925808360";s:6:"source";s:78:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/script.js";s:3:"min";s:82:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/script.min.js";s:3:"map";s:82:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/script.map.js";}"*/
BX.namespace("BX.Tasks");
/* End */
;
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?169925794962259";s:6:"source";s:77:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.js";s:3:"min";s:81:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js";s:3:"map";s:81:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.map.js";}"*/
BX.namespace("BX.Main");if(typeof BX.Main.interfaceButtons==="undefined"){BX.Main.interfaceButtons=function(t,e){this.classItem="main-buttons-item";this.classItemSublink="main-buttons-item-sublink";this.classItemText="main-buttons-item-text";this.classItemCounter="main-buttons-item-counter";this.classItemIcon="main-buttons-item-icon";this.classItemMore="main-buttons-item-more";this.classOnDrag="main-buttons-drag";this.classDropzone="main-buttons-submenu-dropzone";this.classSeparator="main-buttons-submenu-delimiter";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";this.classItemDisabled="main-buttons-disabled";this.classItemOver="--over";this.classMenuShown="--menu-shown";this.classItemActive="main-buttons-item-active";this.classSubmenu="main-buttons-submenu";this.classSecret="secret";this.classItemLocked="--locked";this.classExtraItemLink="";this.classExtraItemText="";this.classExtraItemIcon="";this.classExtraItemCounter="";this.submenuIdPrefix="main_buttons_popup_";this.childMenuIdPrefix="main_buttons_popup_child_";this.submenuWindowIdPrefix="menu-popup-";this.classSettingMenuItem="main-buttons-submenu-setting";this.classEditState="main-buttons-edit";this.classEditItemButton="main-buttons-item-edit-button";this.classDragItemButton="main-buttons-item-drag-button";this.classSettingsApplyButton="main-buttons-submenu-settings-apply";this.classSettingsResetButton="main-buttons-submenu-settings-reset";this.classSetHome="main-buttons-set-home";this.classSetHide="main-buttons-set-hide";this.classManage="main-buttons-manage";this.classContainer="main-buttons";this.classSubmenuNoHiddenItem="main-buttons-submenu-item-no-hidden";this.classDefaultSubmenuItem="menu-popup-item";this.classDefaultSubmenuDelimimeter="popup-window-delimiter-section";this.classInner="main-buttons-inner-container";this.listContainer=null;this.dragItem=null;this.overItem=null;this.moreButton=null;this.messages=null;this.licenseParams=null;this.ajaxSettings=null;this.enableItemMouseEnter=true;this.menuShowTimeout=null;this.isMoreMenuShown=false;this.onDragStarted=false;this.isSettingsEnabled=true;this.containerId=e.containerId;this.isEditEnabledState=false;this.theme=BX.Type.isStringFilled(e.theme)?e.theme:"default";this.maxItemLength=BX.Type.isNumber(e.maxItemLength)&&e.maxItemLength>6?e.maxItemLength:20;this.tmp={};this.itemData=new WeakMap;this.handleMoreMenuItemMouseEnter=this.handleMoreMenuItemMouseEnter.bind(this);this.init(t,e);return{getItemById:this.getItemById.bind(this),getAllItems:this.getAllItems.bind(this),getHiddenItems:this.getHiddenItems.bind(this),getVisibleItems:this.getVisibleItems.bind(this),getDisabledItems:this.getDisabledItems.bind(this),getMoreButton:this.getMoreButton.bind(this),adjustMoreButtonPosition:this.adjustMoreButtonPosition.bind(this),getItemData:this.getItemData.bind(this),getSubmenu:this.getMoreMenu.bind(this),showSubmenu:this.showMoreMenu.bind(this),closeSubmenu:this.closeMoreMenu.bind(this),refreshSubmenu:this.refreshMoreMenu.bind(this),getMoreMenu:this.getMoreMenu.bind(this),showMoreMenu:this.showMoreMenu.bind(this),closeMoreMenu:this.closeMoreMenu.bind(this),refreshMoreMenu:this.refreshMoreMenu.bind(this),getCurrentSettings:this.getCurrentSettings.bind(this),saveSettings:this.saveSettings.bind(this),updateCounter:this.updateCounter.bind(this),getActive:this.getActive.bind(this),isDisabled:this.isDisabled.bind(this),isVisibleItem:this.isVisibleItem.bind(this),isEditEnabled:this.isEditEnabled.bind(this),isActiveInMoreMenu:this.isActiveInMoreMenu.bind(this),isSettingsEnabled:this.isSettingsEnabled,classes:{item:this.classItem,itemText:this.classItemText,itemCounter:this.classItemCounter,itemIcon:this.classItemIcon,itemDisabled:this.classItemDisabled,itemOver:this.classItemOver,itemActive:this.classItemActive,itemLocked:this.classItemLocked,menuShown:this.classMenuShown,submenu:this.classSubmenu,submenuItem:this.classSubmenuItem,containerOnDrag:this.classOnDrag,classSettingMenuItem:this.classSettingMenuItem},itemsContainer:this.listContainer,itemsContainerId:this.listContainer.id}};BX.Main.interfaceButtons.prototype={init:function(t,e){this.listContainer=BX(this.getId());if(!BX.Type.isPlainObject(e)){throw"BX.MainButtons: params is not Object"}if(!("containerId"in e)||!BX.Type.isStringFilled(e.containerId)){throw"BX.MainButtons: containerId not set in params"}if(!BX.Type.isDomNode(this.listContainer)){throw"BX.MainButtons: #"+e.containerId+" is not dom node"}if("classes"in e&&BX.Type.isPlainObject(e.classes)){this.setCustomClasses(e.classes)}if("messages"in e&&BX.Type.isPlainObject(e.messages)){this.setMessages(e.messages)}if("licenseWindow"in e&&BX.Type.isPlainObject(e.licenseWindow)){this.setLicenseWindowParams(e.licenseWindow)}if("disableSettings"in e&&e.disableSettings==="true"){this.isSettingsEnabled=false;this.visibleControlMoreButton()}this.initSaving(e.ajaxSettings);this.moreButton=this.getMoreButton();this.listChildItems={};this.initItems();this.adjustMoreButtonPosition();this.bindEventsOnMoreButton();this.bindOnResizeFrame();BX.Event.bind(this.getContainer(),"click",BX.delegate(this._onDocumentClick,this));BX.addCustomEvent("onPullEvent-main",BX.delegate(this._onPush,this));this.updateMoreButtonCounter();if(this.isActiveInMoreMenu()){this.activateItem(this.moreButton)}const s=this.getHomeItem();if(s){const{url:t}=s;this.lastHomeLink=t}const i=Array.from(this.container.querySelectorAll(".main-buttons-item-child-button"));i.forEach((function(t){const e=t.closest(".main-buttons-item-child");if(e.dataset.isOpened){this.realChildButton=e;const t=e.closest(".main-buttons-item-child-button-cloned");if(t){this.clonedChildButton=t}}BX.Event.bind(t,"click",this.onShowChildButtonClick.bind(this))}),this)},calculateChildListWidth:function(){if(this.realChildButton){const t=this.realChildButton.querySelectorAll(".main-buttons-item-child-list-inner .main-buttons-item");const e=10;return Array.from(t).reduce((function(t,e){const s=BX.Text.toNumber(BX.Dom.style(e,"width"));const i=BX.Text.toNumber(BX.Dom.style(e,"margin-left"));const n=BX.Text.toNumber(BX.Dom.style(e,"margin-right"));return t+s+i+n}),e)}return 0},onShowChildButtonClick:function(t){t.preventDefault();if(!this.realChildButton){this.realChildButton=t.currentTarget.closest(".main-buttons-item-child")}const e=this.realChildButton.querySelector(".main-buttons-item-child-list");this.enableItemMouseEnter=false;setTimeout((()=>{this.enableItemMouseEnter=true}),200);const s=BX.Dom.attr(this.realChildButton,"data-child-items");const i=BX.Dom.attr(this.realChildButton,"data-is-opened");let n={};if(i){BX.Dom.attr(this.realChildButton,"data-is-opened",null);s.forEach((function(t){const e=this.getContainer().querySelector('[data-id="'+t+'"]');BX.Dom.style(e,"display",null);if(t.hasOwnProperty("PARENT_ITEM_ID")){n[t["PARENT_ITEM_ID"]]="N"}}),this);if(this.clonedChildButton){BX.Dom.remove(this.clonedChildButton)}BX.Dom.style(e,{overflow:null,"max-width":null});n=JSON.stringify(n);this.saveOptions("expanded_lists",n)}else{BX.Dom.attr(this.realChildButton,"data-is-opened",true);BX.Dom.style(e,"max-width",this.calculateChildListWidth()+"px");this.cloneChildButton(this.realChildButton);s.forEach((t=>{const e=this.getContainer().querySelector('[data-id="'+t+'"]');BX.Dom.insertBefore(e,this.realChildButton);BX.Dom.style(e,"display","inline-block");if(t.hasOwnProperty("PARENT_ITEM_ID")){n[t["PARENT_ITEM_ID"]]="Y"}}));setTimeout((()=>{BX.Dom.style(e,"overflow","unset")}),200);n=JSON.stringify(n);this.saveOptions("expanded_lists",n)}setTimeout((()=>{this._onResizeHandler()}),200)},cloneChildButton:function(t){this.clonedChildButton=BX.Runtime.clone(t);const e=this.clonedChildButton.querySelector(".main-buttons-item-child-list");if(e){BX.Dom.remove(e)}BX.Dom.addClass(this.clonedChildButton,"main-buttons-item-child-button-cloned");BX.Dom.style(this.clonedChildButton,"transition","none");BX.Dom.insertBefore(this.clonedChildButton,t);BX.Event.bind(this.clonedChildButton,"click",this.onShowChildButtonClick.bind(this));setTimeout((()=>{BX.Dom.style(this.clonedChildButton,"transition",null)}),0)},_onDocumentClick:function(t){if(this.isDragButton(t.target)){t.preventDefault();t.stopPropagation()}let e=this.getItem(t);if(BX.Type.isDomNode(e)){if(this.isSettings(e)){this.enableEdit();return false}if(this.isApplySettingsButton(e)){t.preventDefault();t.stopPropagation();this.disableEdit();return false}if(this.isResetSettingsButton(e)){this.resetSettings();return false}if(this.isEditButton(t.target)){this.handleEditButtonClick(t);return false}if(this.isSetHide(e)){const t=this.getVisibleItems();const e=BX.Type.isArray(t)?t.length:null;const s=this.editItemData.ID.replace(this.listContainer.id+"_","");let i=this.getItemById(s);const n=this.getItemAlias(i);i=this.isVisibleItem(i)?i:n;if(this.isDisabled(n)){this.enableItem(n)}else if(!this.isDisabled(n)&&e>2){this.disableItem(n)}if(e===1){BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[i,this])}this.refreshMoreMenu();this.saveSettings();this.adjustMoreButtonPosition();if(this.isEditEnabled()){this.enableEdit()}this.editMenu.popupWindow.close();return false}if(this.isSetHome(e)){const t=this.editItemData.ID.replace(this.listContainer.id+"_","");const e=this.getItemById(t);const s=this.getItemAlias(e);if(this.isDisabled(s)){this.enableItem(s)}this.listContainer.insertBefore(e,BX.firstChild(this.listContainer));this.adjustMoreButtonPosition();this.refreshMoreMenu();this.saveSettings();if(this.isEditEnabled()){this.enableEdit()}this.editMenu.popupWindow.close();return false}if(!this.isDragButton(t.target)&&!this.isEditButton(t.target)){const s=this.getItemData(e);let i=s["ON_CLICK"];if(this.isSublink(t.target)){i=BX.Type.isPlainObject(s["SUB_LINK"])?s["SUB_LINK"]["ON_CLICK"]:""}if(BX.Type.isStringFilled(i)){t.preventDefault();this.execScript(i,t)}}}if(this.isEditEnabled()&&this.getMoreMenu()){this.getMoreMenu().getPopupWindow().setAutoHide(false)}},isActiveInMoreMenu:function(){const t=this.getHiddenItems();const e=this.getDisabledItems();const s=t.concat(e);return s.some((function(t){const e=this.getItemData(t);return e["IS_ACTIVE"]===true}),this)},_onPush:function(t,e){if(t==="user_counter"&&e&&BX.message("SITE_ID")in e){const t=e[BX.message("SITE_ID")];for(const e in t){if(t.hasOwnProperty(e)){this.updateCounter(e,t[e])}}}},getActive:function(){let t=this.getAllItemsData();let e=null;let s=null;while(BX.Type.isArrayFilled(t)){const i=t.shift();if(i["IS_ACTIVE"]===true){if(s===null){s=i}e=i;t=BX.Type.isArrayFilled(i["ITEMS"])?[...i["ITEMS"]]:null}}if(e!==null&&s!==null){const t=BX(s.ID);if(BX.Type.isDomNode(t)){e.NODE=t}else{e.NODE=null}}return e},isSetHome:function(t){return BX.Dom.hasClass(t,this.classSetHome)},isSetHide:function(t){return BX.Dom.hasClass(t,this.classSetHide)},getSettingsButton:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSettingMenuItem)},getSettingsApplyButton:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSettingsApplyButton)},isApplySettingsButton:function(t){return BX.Dom.hasClass(t,this.classSettingsApplyButton)},enableEdit:function(){const t=this.getMoreMenu();if(t){const e=t.getPopupWindow();e.setAutoHide(false);BX.Dom.addClass(e.getPopupContainer(),this.classEditState)}BX.Dom.addClass(this.listContainer,this.classEditState);this.isEditEnabledState=true},disableEdit:function(){const t=this.getMoreMenu();if(t){const e=t.getPopupWindow();e.setAutoHide(true);BX.Dom.removeClass(e.getPopupContainer(),this.classEditState)}BX.Dom.removeClass(this.listContainer,this.classEditState);this.isEditEnabledState=false;this.destroyItemEditMenu()},isEditEnabled:function(){return this.isEditEnabledState},showItemEditMenu:function(t,e){if(BX.Type.isPlainObject(t)&&"ID"in t){const s=[this.listContainer.id,"_edit_item"].join("");let i=BX.Main.MenuManager.getMenuById(s);if(i){BX.Main.MenuManager.destroy(s)}i=this.createItemEditMenu(t,s,e);i.popupWindow.show()}},destroyItemEditMenu:function(){const t=[this.listContainer.id,"_edit_item"].join("");const e=BX.Main.MenuManager.getMenuById(t);if(e){BX.Main.MenuManager.destroy(t)}},getContainer:function(){if(!BX.Type.isDomNode(this.container)){this.container=BX(this.containerId).parentNode.parentNode}return this.container},getItemEditMenu:function(){return BX.Main.MenuManager.getMenuById([this.listContainer.id,"_edit_item"].join(""))},createItemEditMenu:function(t,e,s){const i=[{text:this.message("MIB_SET_HOME"),className:"main-buttons-set-home menu-popup-no-icon"}];const n=t["ID"].replace(this.listContainer.id+"_","");const o=this.getItemById(n);if(this.isDisabled(o)){i.push({text:this.message("MIB_SET_SHOW"),className:"main-buttons-set-hide menu-popup-no-icon"})}else{i.push({text:this.message("MIB_SET_HIDE"),className:"main-buttons-set-hide menu-popup-no-icon"})}if(t["IS_PINNED"]){const e=this.getParentItem(t["ID"]);i.push({text:this.message("MIB_UNPIN_ITEM").replace("#NAME#",e?e["TEXT"]:""),onclick:(e,s)=>{this.handleItemUnpin(t,o);s.getMenuWindow().close()}})}const a=BX.pos(s);const u={menuId:e,anchor:s,menuItems:i,settings:{autoHide:true,offsetTop:0,offsetLeft:a.width/2,zIndex:20,angle:{position:"top",offset:a.width/2}}};const r=BX.Main.MenuManager.create(u.menuId,u.anchor,u.menuItems,u.settings);if(this.isVisibleItem(o)){t.NODE=o}else{t.NODE=this.getItemAlias(o)}this.editItemData=t;if("menuItems"in r&&BX.Type.isArray(r.menuItems)){r.menuItems.forEach((function(t){BX.Event.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))}),this)}BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onBeforeCreateEditMenu",[r,t,this]);this.editMenu=r;return r},setHome:function(){const t=this.getHomeItem();if(!t){return}const{itemData:e,url:s,firstVisibleItem:i}=t;if(!e){return}if(this.lastHomeLink!==s){this.saveOptions("firstPageLink",s);BX.onCustomEvent("BX.Main.InterfaceButtons:onFirstItemChange",[s,i])}this.lastHomeLink=s},getHomeItem:function(){const t=this.getVisibleItems();const e=BX.Type.isArray(t)&&t.length>0?t[0]:null;if(!e){return null}const s=this.getItemData(e);const i=this.normalizeUrl(s["URL"]);if(this.canBeHomed(i,s)){return{itemData:s,url:i,firstVisibleItem:e}}if(BX.Type.isArrayFilled(s["ITEMS"])){for(let t=0;t<s["ITEMS"].length;t++){const i=s["ITEMS"][t];if(i["IS_PINNED"]||i["IS_DISBANDED"]||i["IS_DELIMITER"]){continue}const n=this.normalizeUrl(i["URL"]);if(this.canBeHomed(n,i)){return{itemData:i,url:n,firstVisibleItem:e}}}}return null},normalizeUrl:function(t){if(!BX.Type.isStringFilled(t)){return""}if(t.charAt(0)==="?"){const e=document.createElement("a");e.href=t;t=e.pathname+e.search}return t},canBeHomed:function(t,e){if(!BX.Type.isStringFilled(t)||BX.Type.isStringFilled(e["ON_CLICK"])){return false}if(BX.Reflection.getClass("BX.SidePanel.Instance")){const e=BX.SidePanel.Instance.getUrlRule(t);if(e){return false}}const s=new BX.Event.BaseEvent({data:{itemLink:t,itemData:e}});BX.Event.EventEmitter.emit("BX.Main.InterfaceButtons:onBeforeFirstItemChange",s);return!s.isDefaultPrevented()},isEditButton:function(t){return BX.Dom.hasClass(t,this.classEditItemButton)},isDragButton:function(t){return BX.Dom.hasClass(t,this.classDragItemButton)},isResetSettingsButton:function(t){return BX.Dom.hasClass(t,this.classSettingsResetButton)},getContainerHeight:function(){const t=this.getAllItems().map((function(t){const e=getComputedStyle(t);return BX.height(t)+parseInt(e.marginTop)+parseInt(e.marginBottom)}));return Math.max.apply(Math,t)},setLicenseWindowParams:function(t){this.licenseParams=t||{}},message:function(t){let e;try{e=this.messages[t]}catch(t){e=""}return e},setCustomClasses:function(t){if(!BX.Type.isPlainObject(t)){return}this.classItem=t.item||this.classItem;this.classItemSublink=t.itemSublink||this.classItemSublink;this.classItemText=t.itemText||this.classItemText;this.classItemCounter=t.itemCounter||this.classItemCounter;this.classItemIcon=t.itemIcon||this.classItemIcon;this.classItemMore=t.itemMore||this.classItemMore;this.classItemOver=t.itemOver||this.classItemOver;this.classMenuShown=t.menuShown||this.classMenuShown;this.classItemActive=t.itemActive||this.classItemActive;this.classItemDisabled=t.itemDisabled||this.classItemDisabled;this.classOnDrag=t.onDrag||this.classOnDrag;this.classDropzone=t.dropzone||this.classDropzone;this.classSeparator=t.separator||this.classSeparator;this.classSubmenuItem=t.submenuItem||this.classSubmenuItem;this.classSubmenu=t.submenu||this.classSubmenu;this.classSecret=t.secret||this.classSecret;this.classItemLocked=t.itemLocked||this.classItemLocked;this.classExtraItemLink=t.extraItemLink||this.classExtraItemLink;this.classExtraItemText=t.extraItemText||this.classExtraItemText;this.classExtraItemIcon=t.extraItemIcon||this.classExtraItemIcon;this.classExtraItemCounter=t.extraItemCounter||this.classExtraItemCounter},setMessages:function(t){if(!BX.Type.isPlainObject(t)){return}this.messages=t},makeFullItemId:function(t){if(!BX.Type.isStringFilled(t)){return}return[this.listContainer.id,t.replace("-","_")].join("_")},getItemById:function(t){let e=null;if(BX.Type.isStringFilled(t)){const s=t.startsWith(this.listContainer.id)?t:this.makeFullItemId(t);e=BX.Buttons.Utils.getBySelector(this.listContainer,"#"+s.replaceAll(":","\\:"))}return e},getItemCounterObject:function(t){let e=null;if(BX.Type.isDomNode(t)){e=BX.Buttons.Utils.getByClass(t,this.classItemCounter)}return e},updateCounter:function(t,e){if(t.indexOf("crm")===0&&e<0){return}this.updateItemsByCounterId(this.getAllItemsData(),t,e);this.updateMoreButtonCounter()},updateItemsByCounterId:function(t,e,s,i=[]){for(let n=0;n<t.length;n++){const o=t[n];if(o["COUNTER_ID"]===e){o["COUNTER"]=Number(s);this.setCounterValueById(e,o["COUNTER"]);for(let t=i.length-1;t>=0;t--){const e=i[t];e["COUNTER"]=e["ITEMS"].reduce(((t,e)=>{const s=e["IS_PINNED"]===true;const i=BX.Type.isNumber(e["COUNTER"])&&!s?e["COUNTER"]:0;return t+i}),0);this.setCounterValueById(e["COUNTER_ID"],e["COUNTER"])}}if(o["ITEMS"]){this.updateItemsByCounterId(o["ITEMS"],e,s,[...i,o])}}},recalculateItemsCounters:function(t,e=[]){let s=0;for(let i=0;i<t.length;i++){const n=t[i];if(n["ITEMS"]){n["COUNTER"]=this.recalculateItemsCounters(n["ITEMS"],[...e,n])}const o=n["IS_PINNED"]===true;s+=BX.Type.isNumber(n["COUNTER"])&&!o?n["COUNTER"]:0}for(let t=e.length-1;t>=0;t--){const s=e[t];s["COUNTER"]=s["ITEMS"].reduce(((t,e)=>{const s=e["IS_PINNED"]===true;const i=BX.Type.isNumber(e["COUNTER"])&&!s?e["COUNTER"]:0;return t+i}),0);this.setCounterValueById(s["COUNTER_ID"],s["COUNTER"])}return s},setCounterValueById:function(t,e){if(!BX.Type.isStringFilled(t)){return}const s=e>99?"99+":e>0?e:"";const i=document.querySelectorAll(`[data-mib-counter-id="${t}"]`);Array.from(i).forEach((t=>{t.textContent=s}))},setMoreButtonCounter:function(t){const e=this.getItemCounterObject(this.moreButton);e.textContent=t>99?"99+":t>0?t:""},bindEventsOnMoreButton:function(){BX.Event.bind(this.moreButton,"click",this.handleMoreButtonClick.bind(this));BX.Event.bind(this.moreButton,"mouseenter",this.handleMoreButtonMouseEnter.bind(this));BX.Event.bind(this.moreButton,"mouseleave",this.handleMoreButtonMouseLeave.bind(this))},bindOnResizeFrame:function(){window.frames["maininterfacebuttonstmpframe-"+this.getId()].onresize=BX.throttle(this._onResizeHandler,20,this)},getId:function(){return BX.Buttons.Utils.getByClass(this.getContainer(),this.classInner).id},getAllItems:function(){return BX.Buttons.Utils.getByClass(this.listContainer,this.classItem,true)},getAllItemsData:function(){return this.getAllItems().map((t=>this.getItemData(t)))},getVisibleItems:function(){const t=this.getAllItems();let e=[];if(t&&t.length){e=t.filter((t=>this.isVisibleItem(t)&&!this.isDisabled(t)))}return e},getHiddenItems:function(){const t=this.getAllItems();let e=[];if(t&&t.length){e=t.filter((t=>!this.isVisibleItem(t)&&!this.isDisabled(t)))}return e},getDisabledItems:function(){return this.getAllItems().filter((t=>this.isDisabled(t)))},getMoreButton:function(){const t=this.getContainer().getElementsByClassName(this.classItemMore);return t[0]||null},getLastVisibleItem:function(){const t=this.getVisibleItems();let e=null;if(BX.Type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.Type.isDomNode(e)){e=null}return e},getLastDisabledItem:function(){const t=this.getDisabledItems();let e=null;if(BX.Type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.Type.isDomNode(e)){e=null}return e},adjustMoreButtonPosition:function(){this.updateMoreButtonCounter();if(this.getMoreMenu()){this.getMoreMenu().getPopupWindow().adjustPosition()}},getMoreMenuId:function(t){let e="";if(BX.Type.isDomNode(this.listContainer)&&BX.Type.isStringFilled(this.listContainer.id)){e=this.submenuIdPrefix+this.listContainer.id}if(t){e=this.submenuWindowIdPrefix+e}return e},getChildMenuId:function(){let t="";if(BX.Type.isDomNode(this.listContainer)&&BX.Type.isStringFilled(this.listContainer.id)){t=this.childMenuIdPrefix+this.listContainer.id}return t},getMenuItemText:function(t,e=null){const s=BX.Type.isElementNode(t)?this.getItemData(t):t;return BX.Tag.render`
				<span class="main-buttons-menu-popup-item">${[BX.Tag.render`<span class="${this.classItemIcon}"></span>`,this.createItemText(s),this.createItemCounter(s),e&&this.isEditEnabled()?this.createItemPin(s,e):""]}</span>
			`},createRootItem:function(t){let e=this.classItem;e+=BX.Type.isStringFilled(t["CLASS"])?" "+t["CLASS"]:"";if(t["IS_PASSIVE"]){e+=" --passive"}else if(t["IS_ACTIVE"]){if(BX.Type.isStringFilled(this.classItemActive)){e+=" "+this.classItemActive}else{e+=" main-buttons-item-active"}}if(t["HAS_MENU"]){e+=" --has-menu"}if(t["IS_LOCKED"]){e+=" --locked"}const s=BX.Tag.render`
				<div
					id="${t["ID"]}"
					class="${e}"
					data-disabled="${t["IS_DISABLED"]}"
					data-class="${t["CLASS_SUBMENU_ITEM"]}"
					data-id="${t["DATA_ID"]}"
					data-top-menu-id="${this.getId()}"
					title=""
				>${[this.createItemLink(t,true),BX.Type.isPlainObject(t["SUB_LINK"])?this.createItemSubLink(t["SUB_LINK"]):""]}</div>
			`;this.setItemData(s,t);return s},createItemLink:function(t,e=false){t=BX.Type.isPlainObject(t)?t:{};let s;const i=["main-buttons-item-link",this.classExtraItemLink].join(" ").trim();if(BX.Type.isStringFilled(t["URL"])){s=BX.Tag.render`<a class="${i}" href="${BX.Text.encode(t["URL"])}"></a>`}else{s=BX.Tag.render`<span class="${i}"></span>`}BX.Dom.append(this.createItemIcon(t),s);BX.Dom.append(this.createItemText(t,e),s);BX.Dom.append(this.createItemCounter(t),s);return s},createItemSubLink:function(t){t=BX.Type.isPlainObject(t)?t:{};const e=BX.Type.isStringFilled(t["CLASS"])?" "+t["CLASS"]:"";const s=BX.Type.isStringFilled(t["URL"])?BX.Text.encode(t["URL"]):"";return BX.Tag.render`
				<a class="${this.classItemSublink}${e}" href="${s}"></a>
			`},createItemIcon:function(t){const e=[this.classItemIcon,this.classExtraItemIcon].join(" ").trim();return BX.Tag.render`<span class="${e}"></span>`},createItemText:function(t,e=false){t=BX.Type.isPlainObject(t)?t:{};const s=[this.classItemText,this.classExtraItemText].join(" ").trim();let i=BX.Type.isStringFilled(t["TEXT"])?t["TEXT"]:"";if(e&&i.length>this.maxItemLength){i=i.substring(0,this.maxItemLength-3)+"..."}let n="";if(BX.Type.isPlainObject(t["SUPER_TITLE"])){let{TEXT:e,CLASS:s,COLOR:i}=t["SUPER_TITLE"];s=BX.Type.isStringFilled(s)?` ${s}`:"";const o=BX.Type.isStringFilled(i)?` style="color:${i}"`:"";n=BX.Tag.render`
					<span class="main-buttons-item-super-title${s}"${o}>${e}</span>
				`}return BX.Tag.render`
				<span class="${s}">${[BX.Tag.render`<span 
						class="main-buttons-item-drag-button"
						onclick="${this.handleDragButtonClick.bind(this)}" 
						data-slider-ignore-autobinding="true"
					></span>`,n,BX.Tag.render`
						<span class="main-buttons-item-text-title">
							<span class="main-buttons-item-text-box">${BX.Text.encode(i)}<span class="main-buttons-item-menu-arrow"></span></span>
						</span>
					`,BX.Tag.render`<span 
						class="main-buttons-item-edit-button"
						onclick="${this.handleEditButtonClick.bind(this)}" 
						data-slider-ignore-autobinding="true"
					></span>`,BX.Tag.render`<span class="main-buttons-item-text-marker"></span>`]}</span>
			`},createItemCounter:function(t){t=BX.Type.isPlainObject(t)?t:{};const e=[this.classItemCounter,this.classExtraItemCounter].join(" ").trim();let s="";const i=BX.Type.isNumber(t["MAX_COUNTER_SIZE"])?t["MAX_COUNTER_SIZE"]:99;if(BX.Type.isNumber(t["COUNTER"])&&t["COUNTER"]>0){s=t["COUNTER"]>i?`${i}+`:t["COUNTER"]}const n=BX.Type.isStringFilled(t["COUNTER_ID"])?t["COUNTER_ID"]:"";return BX.Tag.render`<span data-mib-counter-id="${n}" class="${e}">${s}</span>`},createItemPin:function(t,e){return BX.Tag.render`
				<span class="main-buttons-item-pin" 
					data-slider-ignore-autobinding="true"
					onclick="${this.handleItemPin.bind(this,t,e)}"
					onmouseenter="${this.handleItemPinEnter.bind(this)}"
					onmouseleave="${this.handleItemPinLeave.bind(this)}"
				></span>
			`},getLockedClass:function(t){let e="";if(BX.Type.isDomNode(t)&&this.isLocked(t)){e=this.classItemLocked}return e},getMoreMenuItems:function(){const t=this.getAllItems();const e=this.getHiddenItems();const s=this.getDisabledItems();const i=[];if(t.length){t.forEach((t=>{if(e.indexOf(t)===-1&&s.indexOf(t)===-1){const e=this.getItemData(t);i.push({id:e["DATA_ID"],html:this.getMenuItemText(t),href:e["URL"],onclick:e["ON_CLICK"],title:t.getAttribute("title"),className:[this.classSubmenuItem,this.getIconClass(t),this.classSecret,this.getAliasLink(t),this.getLockedClass(t)].join(" "),items:this.getMoreMenuSubItems(t),events:{onMouseEnter:this.handleMoreMenuItemMouseEnter}})}}))}if(e.length){e.forEach((t=>{const e=this.getItemData(t);const s=[this.classSubmenuItem,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(e["IS_ACTIVE"]===true){s.push(this.classItemActive)}i.push({id:e["DATA_ID"],html:this.getMenuItemText(t),href:e["URL"],onclick:e["ON_CLICK"],title:t.getAttribute("title"),className:s.join(" "),items:this.getMoreMenuSubItems(t),events:{onMouseEnter:this.handleMoreMenuItemMouseEnter}})}))}if(this.isSettingsEnabled){i.push({delimiter:true,html:"<span>"+this.message("MIB_MANAGE")+"</span>",className:[this.classSeparator,this.classSubmenuItem,this.classManage].join(" ")});i.push({html:this.message("MIB_SETTING_MENU_ITEM"),className:[this.classSettingMenuItem,this.classSubmenuItem].join(" ")});const t=["ui-btn",this.theme==="default"?"ui-btn-sm":"ui-btn-xs","ui-btn-success-light","ui-btn-no-caps","ui-btn-round","ui-btn-icon-main-buttons-apply"];i.push({html:`\n\t\t\t\t\t<span class="${t.join(" ")}">\n\t\t\t\t\t\t<span class="ui-btn-text">${this.message("MIB_APPLY_SETTING_MENU_ITEM")}</span>\n\t\t\t\t\t</span>`,className:[this.classSettingsApplyButton,this.classSubmenuItem].join(" ")});i.push({html:this.message("MIB_RESET_SETTINGS"),className:[this.classSettingsResetButton,this.classSubmenuItem].join(" ")});i.push({delimiter:true,html:"<span>"+this.message("MIB_HIDDEN")+"</span>",className:[this.classSeparator,this.classSubmenuItem,this.classHiddenLabel].join(" ")});if(!s.length){i.push({html:"<span>"+this.message("MIB_NO_HIDDEN")+"</span>",className:[this.classSubmenuItem,this.classSubmenuNoHiddenItem].join(" ")})}if(s.length){s.forEach((t=>{const e=this.getItemData(t);const s=[this.classSubmenuItem,this.classItemDisabled,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(e["IS_ACTIVE"]===true){s.push(this.classItemActive)}i.push({id:e["DATA_ID"],html:this.getMenuItemText(t),href:e["URL"],onclick:e["ON_CLICK"],title:t.getAttribute("title"),className:s.join(" "),items:this.getMoreMenuSubItems(t),events:{onMouseEnter:this.handleMoreMenuItemMouseEnter}})}))}}return i},getMenuItems:function(t){return this.createMenuItems(this.getItemData(t),t)},getMoreMenuSubItems:function(t){return this.createMenuItems(this.getItemData(t),null)},createMenuItems:function(t,e=null){if(!BX.Type.isArrayFilled(t["ITEMS"])){return[]}const s=t["ITEMS"];const i=[];for(let t=0;t<s.length;t++){const n=s[t];if(n["IS_PINNED"]||n["IS_DISBANDED"]){continue}const o=n["IS_DELIMITER"]===true;if(o){const t=i.length===0;const e=i[i.length-1];if(t||e&&e["delimiter"]===true){continue}}const a=["menu-popup-no-icon","main-buttons-menu-item"];if(n["IS_ACTIVE"]===true){a.push("main-buttons-menu-item-active")}const u=BX.Text.toBoolean(n["IS_LOCKED"]);if(u){a.push(this.classItemLocked)}if(this.isEditEnabled()){a.push(this.classEditState)}let r;if(o){r={delimiter:true,className:a.join(" "),text:n["TEXT"]}}else{r={html:this.getMenuItemText(n,e),href:n["URL"],onclick:n["ON_CLICK"],title:n["TITLE"],className:a.join(" ")}}const l=n.hasOwnProperty("AJAX_OPTIONS");if(l){r.cacheable=true;r.events=this._getEvents(n["AJAX_OPTIONS"]);r.items=[{id:"loading",text:this.message("MIB_MAIN_BUTTONS_LOADING")}]}else if(BX.Type.isArrayFilled(n["ITEMS"])&&!this.isEditEnabled()){const t=this.createMenuItems(n,e);if(t.length){r.items=t}}i.push(r)}if(i.length&&i[i.length-1]["delimiter"]===true){i.pop()}return i},_setAjaxMode:function(t){for(let e in t){if(!t.hasOwnProperty(e)){continue}if(t[e].hasOwnProperty("ajaxOptions")){t[e].cacheable=true;t[e].events=this._getEvents(t[e]["ajaxOptions"]);t[e].items=[{id:"loading",text:this.message("MIB_MAIN_BUTTONS_LOADING")}]}}},_getEvents:function(t){return{onSubMenuShow:()=>{if(this.subMenuLoaded){return}const e=this.getSubMenu();e.removeMenuItem("loading");const s=e.getMenuItem("loading");this.getSubItems(t).then((t=>{this._setAjaxMode(t);this.subMenuLoaded=true;this.addSubMenu(t);this.showSubMenu()})).catch((t=>{if(s){s.getLayout().text.innerText=t}}))}}},getSubItems:function(t){return new Promise((function(e,s){if(this.progress){s(this.message("MIB_MAIN_BUTTONS_LOADING"));return}if(t.mode==="component"){this.progress=true;BX.ajax.runComponentAction(t.component,t.action,{mode:t.componentMode,signedParameters:t.signedParameters?t.signedParameters:{},data:t.data}).then((t=>{this.progress=false;e(t.data)}))}else{this.progress=true;BX.ajax.runAction(t.action,{data:t.data}).then((t=>{this.progress=false;e(t.data)}))}}))},getMoreMenuArgs:function(){const t=this.getMoreMenuId();const e=this.moreButton;const s=this.getMoreMenuItems();let i;const n=800;if(this.theme==="default"){const t=350;const s=25;i={autoHide:false,compatibleMode:false,offsetLeft:-s,offsetTop:4,cacheable:false,className:"main-buttons-menu-popup main-buttons-more-menu-popup",minWidth:240,maxWidth:t,maxHeight:n,subMenuOptions:{className:"main-buttons-menu-popup main-buttons-more-menu-popup --sub-menu",minWidth:150,maxWidth:t,events:{onFirstShow:this.handleMoreMenuFirstShow.bind(this)}},bindOptions:{position:"bottom",forceTop:true},events:{onClose:this.handleMoreMenuClose.bind(this),onDestroy:this.handleMoreMenuClose.bind(this),onFirstShow:this.handleMoreMenuFirstShow.bind(this),onShow:this.handleMoreMenuShow.bind(this),onBeforeAdjustPosition:this.handleAdjustPosition.bind(this,e)}}}else{const t=this.moreButton.querySelector(".main-buttons-item-text-title");const e=t.offsetWidth;const s=250;const o=e/2-s/2+BX.Main.Popup.getOption("angleLeftOffset");const a=BX.Main.Popup.getOption("angleLeftOffset")-BX.Main.Popup.getOption("angleMinTop");const u=s/2-a;i={autoHide:false,compatibleMode:false,offsetTop:4,offsetLeft:o,minWidth:s,maxWidth:s,maxHeight:n,angle:{position:"top",offset:u},className:"main-buttons-default-menu-popup main-buttons-more-menu-popup",subMenuOptions:{className:"main-buttons-default-menu-popup main-buttons-more-menu-popup --sub-menu",minWidth:null,events:{onFirstShow:this.handleMoreMenuFirstShow.bind(this)}},cacheable:false,bindOptions:{position:"bottom",forceTop:true},events:{onClose:this.handleMoreMenuClose.bind(this),onDestroy:this.handleMoreMenuClose.bind(this),onFirstShow:this.handleMoreMenuFirstShow.bind(this),onShow:this.handleMoreMenuShow.bind(this)}}}if(this.isEditEnabled()){i.className+=" "+this.classEditState}return[t,e,s,i]},getChildMenuArgs:function(t){const e=800;if(this.theme==="default"){const s=25;const i=350;return{autoHide:false,compatibleMode:false,offsetLeft:-s,offsetTop:4,cacheable:false,className:"main-buttons-menu-popup",maxWidth:i,minWidth:t.offsetWidth+s*2+30,maxHeight:e,subMenuOptions:{className:"main-buttons-menu-popup --sub-menu",minWidth:null,events:{onFirstShow:this._onChildMenuFirstShow.bind(this)}},bindOptions:{position:"bottom",forceTop:true},events:{onFirstShow:this._onChildMenuFirstShow.bind(this),onShow:this._onChildMenuShow.bind(this,t),onClose:this._onChildMenuClose.bind(this,t),onDestroy:this._onChildMenuClose.bind(this,t),onBeforeAdjustPosition:this.handleAdjustPosition.bind(this,t)}}}else{const s=250;return{autoHide:false,compatibleMode:false,offsetTop:4,cacheable:false,className:"main-buttons-default-menu-popup",minWidth:Math.min(t.offsetWidth+25*2+30,s),maxWidth:s,maxHeight:e,bindOptions:{position:"bottom",forceTop:true},subMenuOptions:{className:"main-buttons-default-menu-popup --sub-menu",minWidth:null,events:{onFirstShow:this._onChildMenuFirstShow.bind(this)}},events:{onFirstShow:this._onChildMenuFirstShow.bind(this),onShow:this._onChildMenuShow.bind(this,t),onClose:this._onChildMenuClose.bind(this,t),onDestroy:this._onChildMenuClose.bind(this,t)}}}},centerPopupArrow(t,e){const s=e.offsetWidth;const i=t.getPopupContainer().offsetWidth;const n=s/2-i/2;const o=BX.Main.Popup.getOption("angleLeftOffset")-BX.Main.Popup.getOption("angleMinTop");t.setAngle({offset:i/2-o});t.setOffset({offsetLeft:n+BX.Main.Popup.getOption("angleLeftOffset")})},visibleControlMoreButton:function(){const t=this.getHiddenItems();if(!t.length){this.getMoreButton().style.display="none"}else{this.getMoreButton().style.display=""}},createMoreMenu:function(){const t=BX.Main.MenuManager.create(...this.getMoreMenuArgs());if(this.isSettingsEnabled){this.dragAndDropInitInSubmenu()}t.getMenuItems().forEach((function(t){const e=t.getLayout().item;BX.Event.bind(e,"click",BX.delegate(this._onDocumentClick,this))}),this);return t},createChildMenu:function(t){const e=this.getMenuItems(t);if(e.length){const s=BX.Main.MenuManager.create(this.getChildMenuId(),t,e,this.getChildMenuArgs(t));if(!this.isEditEnabled()&&this.isSettingsEnabled){const e=()=>{this.showMoreMenu();this.enableEdit();this.destroyChildMenu();this.showChildMenu(t)};s.getMenuItems().forEach((t=>{const s=t.getLayout().item;s.draggable=true;BX.Event.bind(s,"dragstart",e)}))}return s}return null},showMoreMenu:function(){clearTimeout(this.submenuLeaveTimeout);if(!this.isEditEnabled()){this.closeChildMenu()}let t=this.getMoreMenu();if(t!==null){t.getPopupWindow().show()}else{this.destroyMoreMenu();t=this.createMoreMenu();t.getPopupWindow().show()}this.setMoreMenuShown(true);this.activateItem(this.moreButton);if(this.isEditEnabled()){t.getPopupWindow().setAutoHide(false)}},showChildMenu:function(t){clearTimeout(this.childMenuLeaveTimeout);if(!this.isEditEnabled()){this.closeMoreMenu()}if(!this.isVisibleItem(t)){return}const e=BX.Main.MenuManager.getMenuById(this.getChildMenuId());if(e&&e.bindElement===t){e.getPopupWindow().show();this.destroyItemEditMenu()}else{this.destroyChildMenu(t);const e=this.createChildMenu(t);if(e){e.getPopupWindow().show();this.destroyItemEditMenu()}}},closeMoreMenu:function(){const t=this.getMoreMenu();if(t===null){return}t.getPopupWindow().close();if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}this.setMoreMenuShown(false)},closeChildMenu:function(){const t=this.getChildMenu();if(t===null){return}this.closePinHint();t.close()},getMoreMenu:function(){return BX.Main.MenuManager.getMenuById(this.getMoreMenuId())},getChildMenu:function(){return BX.Main.MenuManager.getMenuById(this.getChildMenuId())},destroyMoreMenu:function(){BX.Main.MenuManager.destroy(this.getMoreMenuId())},destroyChildMenu:function(){BX.Main.MenuManager.destroy(this.getChildMenuId())},refreshMoreMenu:function(){const t=this.getMoreMenu();if(t===null){return}const e=this.getMoreMenuArgs();if(BX.Type.isArray(e)){this.destroyMoreMenu();this.createMoreMenu();this.showMoreMenu()}},setMoreMenuShown:function(t){this.isSubmenuShown=false;if(BX.type.isBoolean(t)){this.isSubmenuShown=t}if(this.isSubmenuShown){BX.Dom.addClass(this.moreButton,this.classMenuShown)}else{BX.Dom.removeClass(this.moreButton,this.classMenuShown)}},activateItem:function(t){if(!BX.Type.isDomNode(t)){return}if(!BX.Dom.hasClass(t,this.classItemActive)){BX.Dom.addClass(t,this.classItemActive)}},deactivateItem:function(t){if(!BX.Type.isDomNode(t)){return}if(BX.Dom.hasClass(t,this.classItemActive)){BX.Dom.removeClass(t,this.classItemActive)}},getCurrentSettings:function(){const t={};this.getAllItems().forEach(((e,s)=>{t[e.id]={sort:s,isDisabled:this.isDisabled(e),isPinned:this.isPinned(e)}}));return t},initSaving:function(t){this.sendOptions=this.sendOptions.bind(this);this.optionsToSave=[];this.debouncedSendOptions=BX.debounce(this.sendOptions,5e3);if(BX.Type.isPlainObject(t)){this.ajaxSettings={componentName:t.componentName,signedParams:t.signedParams}}},sendOptions:function(){if(this.optionsToSave.length<=0){return}const t={};this.optionsToSave.forEach((function(e){t[e.name]=e.value}));this.optionsToSave=[];window.removeEventListener("beforeunload",this.sendOptions);BX.removeCustomEvent("SidePanel.Slider:onClose",this.sendOptions);return BX.ajax.runComponentAction(this.ajaxSettings.componentName,"save",{mode:"class",signedParameters:this.ajaxSettings.signedParams,data:{options:t}})},saveOptions:function(t,e){if(this.ajaxSettings){if(this.optionsToSave.length<=0){window.addEventListener("beforeunload",this.sendOptions);BX.addCustomEvent("SidePanel.Slider:onClose",this.sendOptions)}this.optionsToSave.push({name:t,value:e});this.debouncedSendOptions()}else if(this.listContainer.id){BX.userOptions.save("ui",this.listContainer.id,t,e)}},saveSettings:function(){const t=this.getCurrentSettings();const e="settings";if(!BX.Type.isPlainObject(t)){return}if(BX.Type.isDomNode(this.listContainer)){if("id"in this.listContainer){this.saveOptions(e,JSON.stringify(t));this.setHome()}}},resetSettings:function(){let t=null;const e=BX.PopupWindowManager.create(this.listContainer.id+"_reset_popup",null,{content:this.message("MIB_RESET_ALERT"),autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true},titleBar:this.message("MIB_RESET_SETTINGS"),buttons:[t=new BX.PopupWindowButton({text:this.message("MIB_RESET_BUTTON"),className:"popup-window-button-create",events:{click:()=>{if(BX.Dom.hasClass(t.buttonNode,"popup-window-button-wait")){return}BX.Dom.addClass(t.buttonNode,"popup-window-button-wait");this.handleResetSettings((s=>{if(s){BX.Dom.removeClass(t.buttonNode,"popup-window-button-wait");e.setContent(s)}else{this.saveOptions("settings",JSON.stringify({}));this.saveOptions("firstPageLink","");this.sendOptions().then((function(){window.location.reload()})).catch((function(){window.location.reload()}))}}))}}}),new BX.PopupWindowButtonLink({text:this.message("MIB_CANCEL_BUTTON"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});e.show()},handleResetSettings:function(t){const e=[];BX.onCustomEvent("BX.Main.InterfaceButtons:onBeforeResetMenu",[e,this]);let s=new BX.Promise;const i=s;for(let t=0;t<e.length;t++){s=s.then(e[t])}s.then((function(e){t(null,e)}),(function(e){t(e,null)}));i.fulfill()},moveButtonAlias:function(t,e){if(!t||!this.dragItem){return}const s=this.getItemAlias(this.dragItem);const i=this.getItemAlias(t);if(this.isListItem(s)){if(i){if(e){BX.Dom.insertAfter(s,i)}else{this.listContainer.insertBefore(s,i)}}else{this.listContainer.appendChild(s)}}if(this.getMoreMenu()){this.getMoreMenu().getPopupWindow().adjustPosition()}},moveButton:function(t,e){if(!BX.Type.isDomNode(t)||!BX.Type.isDomNode(this.dragItem)){return}if(this.isListItem(t)){if(this.isDisabled(this.dragItem)){this.dragItem.dataset.disabled="false"}if(BX.Type.isDomNode(t)){if(e){BX.Dom.insertAfter(this.dragItem,t)}else{this.listContainer.insertBefore(this.dragItem,t)}}else{this.listContainer.appendChild(this.dragItem)}}if(this.isSubmenuItem(t)){if(e){BX.Dom.insertAfter(this.dragItem,t)}else{this.getMoreMenuContainer().insertBefore(this.dragItem,t)}}},getMoreMenuContainer:function(){const t=this.getMoreMenu();let e=null;if(t!==null){e=t.itemsContainer}return e},findNextSiblingByClass:function(t,e){const s=t;for(;!!t;t=t.nextElementSibling){if(e){if(BX.Dom.hasClass(t,e)&&t!==s){return t}}else{return null}}return null},findChildrenByClassName:function(t,e){let s=null;if(BX.Type.isDomNode(t)&&BX.Type.isStringFilled(e)){s=BX.Buttons.Utils.getByClass(t,e)}return s},initItems:function(){this.getAllItems().forEach((t=>{this.initItem(t)}))},initItem:function(t){if(this.isSettingsEnabled){t.setAttribute("draggable","true");t.setAttribute("tabindex","-1");BX.Event.bind(t,"dragstart",BX.delegate(this._onDragStart,this));BX.Event.bind(t,"dragend",BX.delegate(this._onDragEnd,this));BX.Event.bind(t,"dragenter",BX.delegate(this._onDragEnter,this));BX.Event.bind(t,"dragover",BX.delegate(this._onDragOver,this));BX.Event.bind(t,"dragleave",BX.delegate(this._onDragLeave,this));BX.Event.bind(t,"drop",BX.delegate(this._onDrop,this));t.dataset.link="item-"+BX.Text.getRandom().toLowerCase()}BX.Event.bind(t,"click",this._handleItemClick.bind(this));BX.Event.bind(t,"mouseenter",this.handleItemMouseEnter.bind(this));BX.Event.bind(t,"mouseleave",this.handleItemMouseLeave.bind(this))},dragAndDropInitInSubmenu:function(){const t=this.getMoreMenu();if(!t){return}const e=t.menuItems;e.forEach((t=>{if(this.isSeparator(t.layout.item)||this.isSettings(t.layout.item)||this.isApplySettingsButton(t.layout.item)||this.isResetSettingsButton(t.layout.item)){t.layout.item.draggable=false}else{t.layout.item.draggable=true;t.layout.item.dataset.sortable=true;BX.Event.bind(t.layout.item,"dragstart",BX.delegate(this._onDragStart,this));BX.Event.bind(t.layout.item,"dragenter",BX.delegate(this._onDragEnter,this));BX.Event.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this));BX.Event.bind(t.layout.item,"dragleave",BX.delegate(this._onDragLeave,this));BX.Event.bind(t.layout.item,"dragend",BX.delegate(this._onDragEnd,this));BX.Event.bind(t.layout.item,"drop",BX.delegate(this._onDrop,this))}if(BX.Dom.hasClass(t.layout.item,this.classHiddenLabel)||BX.Dom.hasClass(t.layout.item,this.classManage)){BX.Event.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this))}}))},getItem:function(t){if(!BX.Type.isDomNode(t)){if(!t||!BX.Type.isDomNode(t.target)){return null}}else{t={target:t}}let e=t.target.closest("."+this.classItem);if(!BX.Type.isDomNode(e)){e=t.target.closest("."+this.classDefaultSubmenuItem+", ."+this.classDefaultSubmenuDelimimeter)}return e},getItemData:function(t){if(!BX.Type.isDomNode(t)){return{}}const e=this.itemData.get(t);if(e){return e}let s;try{s=JSON.parse(t.dataset.item)}catch(t){s={}}this.setItemData(t,s);return s},setItemData(t,e){if(BX.Type.isElementNode(t)&&BX.Type.isPlainObject(e)){e.NODE=t;this.itemData.set(t,e)}},setOpacity:function(t){if(!BX.Type.isDomNode(t)){return}BX.style(t,"opacity",.5)},unsetOpacity:function(t){if(!BX.Type.isDomNode(t)){return}BX.style(t,"opacity","1")},setDragStyles:function(){BX.Dom.addClass(this.listContainer,this.classOnDrag);BX.Dom.addClass(BX(this.getMoreMenuId(true)),this.classOnDrag);this.setOpacity(this.dragItem)},unsetDragStyles:function(){const t=this.getMoreMenu();this.getAllItems().forEach((t=>{this.unsetOpacity(t);BX.Dom.removeClass(t,this.classItemOver)}));if(t&&BX.Type.isArray(t.menuItems)&&t.menuItems.length){t.menuItems.forEach((t=>{this.unsetOpacity(t);BX.Dom.removeClass(t.layout.item,this.classItemOver)}))}BX.Dom.removeClass(this.listContainer,this.classOnDrag);BX.Dom.removeClass(BX(this.getMoreMenuId(true)),this.classOnDrag)},getIconClass:function(t){let e="";if(BX.Type.isDomNode(t)&&"dataset"in t&&"class"in t.dataset&&BX.Type.isStringFilled(t.dataset.class)){e=t.dataset.class}return e},disableItem:function(t){const e=this.getItemAlias(t);if(t&&"dataset"in t){t.dataset.disabled="true";if(e){e.dataset.disabled="true"}}},enableItem:function(t){let e;if(!BX.Type.isDomNode(t)){return}if(this.isSubmenuItem(t)){BX.Dom.removeClass(t,this.classItemDisabled);e=this.getItemAlias(t);if(BX.Type.isDomNode(e)){e.dataset.disabled="false"}}},getAliasLink:function(t){return this.dataValue(t,"link")||""},getItemAlias:function(t){let e=null;if(!BX.Type.isDomNode(t)){return e}const s=this.getAllItems();const i=this.isSubmenuItem(t);const n=this.isListItem(t);if(!i&&!n){return e}if(i){s.forEach((function(s){BX.Dom.hasClass(t,this.getAliasLink(s))&&(e=s)}),this)}if(n){e=BX.Buttons.Utils.getByClass(document,this.getAliasLink(t))}return e},hideItem:function(t){!!t&&BX.Dom.addClass(t,this.classSecret)},showItem:function(t){!!t&&BX.Dom.removeClass(t,this.classSecret)},fakeDragItem:function(){if(!BX.Type.isDomNode(this.dragItem)||!BX.Type.isDomNode(this.overItem)){return}let t=null;if(this.isDragToSubmenu()){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.listContainer.appendChild(this.dragItem);this.dragItem=t;this.showItem(this.dragItem);this.adjustMoreButtonPosition();this.updateMoreMenuItems();this.tmp.moved=false;this.tmp.movetToSubmenu=true;this.setOpacity(this.dragItem)}}if(this.isDragToList()&&!this.tmp.movetToSubmenu){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.hideItem(this.dragItem);this.dragItem=t;this.adjustMoreButtonPosition();this.updateMoreMenuItems();this.setOpacity(this.dragItem)}}this.tmp.movetToSubmenu=false},updateMoreMenuItems:function(){const t=this.getMoreMenu();if(t===null){return}const e=t.menuItems;if(!BX.Type.isArray(e)||!e.length){return}const s=this.getHiddenItems();const i=this.getDisabledItems();const n=i.concat(s);e.forEach((t=>{const e=[].some.call(n,(e=>BX.Dom.hasClass(t.layout.item,this.dataValue(e,"link"))||this.isDisabled(t.layout.item)||this.isSeparator(t.layout.item)||this.isDropzone(t.layout.item)));if(e||(this.isSettings(t.layout.item)||this.isApplySettingsButton(t.layout.item)||this.isResetSettingsButton(t.layout.item)||this.isNotHiddenItem(t.layout.item)||this.isSeparator(t.layout.item)||t.layout.item===this.dragItem)&&!this.isMoreButton(t.layout.item)){this.showItem(t.layout.item)}else{this.hideItem(t.layout.item)}}))},isNotHiddenItem:function(t){return BX.Dom.hasClass(t,this.classSubmenuNoHiddenItem)},getNotHidden:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSubmenuNoHiddenItem)},setOverStyles:function(t){if(BX.Type.isDomNode(t)&&!BX.Dom.hasClass(t,this.classItemOver)){BX.Dom.addClass(t,this.classItemOver)}},unsetOverStyles:function(t){if(BX.Type.isDomNode(t)&&BX.Dom.hasClass(t,this.classItemOver)){BX.Dom.removeClass(t,this.classItemOver)}},dataValue:function(t,e){let s="";if(BX.Type.isDomNode(t)){const i=BX.data(t,e);if(typeof i!=="undefined"){s=i}}return s},execScript:function(t,e){if(BX.Type.isStringFilled(t)){const s=new Function("event",t);s(e)}},showLicenseWindow:function(){if(!B24.licenseInfoPopup){return}const t=B24.licenseInfoPopup;t.init({B24_LICENSE_BUTTON_TEXT:this.message("MIB_LICENSE_BUY_BUTTON"),B24_TRIAL_BUTTON_TEXT:this.message("MIB_LICENSE_TRIAL_BUTTON"),IS_FULL_DEMO_EXISTS:this.licenseParams.isFullDemoExists,HOST_NAME:this.licenseParams.hostname,AJAX_URL:this.licenseParams.ajaxUrl,LICENSE_ALL_PATH:this.licenseParams.licenseAllPath,LICENSE_DEMO_PATH:this.licenseParams.licenseDemoPath,FEATURE_GROUP_NAME:this.licenseParams.featureGroupName,AJAX_ACTIONS_URL:this.licenseParams.ajaxActionsUrl,B24_FEATURE_TRIAL_SUCCESS_TEXT:this.message("MIB_LICENSE_WINDOW_TRIAL_SUCCESS_TEXT")});t.show("main-buttons",this.message("MIB_LICENSE_WINDOW_HEADER_TEXT"),this.message("MIB_LICENSE_WINDOW_TEXT"))},_handleItemClick:function(t){if(!this.isEditEnabled()){const e=this.getItem(t);this.showChildMenu(e)}},handleEditButtonClick:function(t){t.preventDefault();t.stopPropagation();let e=this.getItem(t);if(!BX.Type.isDomNode(e)){return}if(this.isSubmenuItem(e)){e=this.getItemAlias(e)}const s=this.getItemData(e);const i=this.getItemEditMenu();if(i&&i.popupWindow.isShown()&&this.lastEditNode===e){i.popupWindow.close()}else{this.showItemEditMenu(s,t.target)}this.lastEditNode=e},handleDragButtonClick:function(t){t.preventDefault();t.stopPropagation()},handleItemPinEnter:function(t){const e=this.getChildMenu();if(e){this.showPinHint(t.currentTarget)}},showPinHint:function(t){const e=48;const s=BX.Main.PopupManager.create({id:"main-buttons-pin-hint",closeByEsc:true,padding:15,className:"main-buttons-pin-hint-popup",height:e,cacheable:false,autoHide:true,bindOptions:{forceBindPosition:true},content:this.message("MIB_PIN_HINT"),darkMode:true,events:{onAfterShow:function(e){const s=e.getTarget();const i=BX.Dom.getPosition(t);const n=BX.Dom.getPosition(s.getPopupContainer());if(n.left<i.left+i.width){s.setAngle({position:"top",offset:0});s.setOffset({offsetLeft:20,offsetTop:5});s.adjustPosition()}}}});s.setAngle({position:"left",offset:0});s.setOffset({offsetLeft:t.offsetWidth+5,offsetTop:-t.offsetHeight/2-e/2-2});s.setBindElement(t);s.show();s.adjustPosition()},closePinHint:function(){const t=BX.Main.PopupManager.getPopupById("main-buttons-pin-hint");if(t){t.close()}},handleItemPinLeave:function(t){this.closePinHint()},handleItemPin:function(t,e,s){s.stopPropagation();s.preventDefault();const i=this.createRootItem(t);BX.Dom.addClass(i,"main-buttons-item-insert-animation");BX.Dom.insertBefore(i,e);requestAnimationFrame((()=>{requestAnimationFrame((()=>{BX.Dom.style(i,{width:i.scrollWidth+"px",opacity:1})}))}));const n=()=>{BX.Dom.removeClass(i,"main-buttons-item-insert-animation");BX.Dom.style(i,"width",null);BX.Dom.style(i,"opacity",null);const t=this.getItemData(e);this.recalculateItemsCounters([t]);this.showMoreMenu();this.updateMoreButtonCounter();this.showChildMenu(e);this.saveSettings()};setTimeout(n,300);this.initItem(i);this.pinItem(t);this.destroyMoreMenu();this.destroyChildMenu()},handleItemUnpin:function(t,e){BX.Dom.style(e,{width:e.offsetWidth+"px"});BX.Dom.addClass(e,"main-buttons-item-insert-animation");requestAnimationFrame((()=>{requestAnimationFrame((()=>{BX.Dom.style(e,{width:0,margin:0,opacity:0})}))}));const s=()=>{BX.Dom.remove(e);this.showMoreMenu();this.updateMoreButtonCounter();this.saveSettings()};setTimeout(s,300);this.pinItem(t,false);const i=[];let n="";const o=t["ID"].split(":");o.forEach((t=>{n+=`${n===""?"":":"}${t}`;const e=this.getItemById(n);if(e){i.push(this.getItemData(e))}}));this.destroyMoreMenu();this.recalculateItemsCounters(i)},pinItem:function(t,e=true){const s=t["ID"];const i=s.split(":");let n="";i.forEach(((t,o)=>{n+=`${n===""?"":":"}${t}`;const a=this.getItemById(n);if(!a){return}const u=this.getItemData(a);let r=u["ITEMS"];let l=n;const h=i.slice(o+1);const m=[u];while(BX.Type.isArrayFilled(h)&&BX.Type.isArrayFilled(r)){l=l+":"+h.shift();for(let t=0;t<r.length;t++){const i=r[t];if(i["ID"]===s){i["IS_PINNED"]=e;for(let t=m.length-1;t>=0;t--){const s=m[t];const i=t===0;if(e){const t=s["ITEMS"].some((t=>{const e=t["IS_PINNED"]===true;const s=t["IS_DISBANDED"]===true;const i=t["IS_DELIMITER"]===true;return!e&&!s&&!i}));if(!t){s["IS_DISBANDED"]=true;if(i){a.dataset.disbanded=true}}}else{if(i){a.dataset.disbanded=false}s["IS_DISBANDED"]=false}const n=s["ITEMS"].some((t=>t["IS_ACTIVE"]===true&&t["IS_PINNED"]!==true&&t["IS_DELIMITER"]!==true));if(n){s["IS_ACTIVE"]=true;if(i){this.activateItem(a)}}else{s["IS_ACTIVE"]=false;if(i){this.deactivateItem(a)}}}return}else if(i["ID"]===l){r=i["ITEMS"];l=i["ID"];m.push(i);break}}}}))},getParentItem:function(t){const e=t.split(":");let s="";for(let i=0;i<e.length;i++){s+=`${s===""?"":":"}${e[i]}`;const n=this.getItemById(s);if(!n){continue}const o=this.getItemData(n);let a=o["ITEMS"];let u=s;const r=e.slice(i+1);let l=null;while(BX.Type.isArrayFilled(r)&&BX.Type.isArrayFilled(a)){u=u+":"+r.shift();for(let e=0;e<a.length;e++){const s=a[e];if(s["ID"]===t){return l===null?o:l}else if(s["ID"]===u){a=s["ITEMS"];u=s["ID"];l=s;break}}}}return null},_onDragStart:function(t){const e=this.getVisibleItems();const s=BX.Type.isArray(e)?e.length:null;this.dragItem=this.getItem(t);if(!BX.Type.isDomNode(this.dragItem)){return}if(s===1&&this.isListItem(this.dragItem)){t.preventDefault();BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[this.dragItem,this]);return}if(this.isMoreButton(this.dragItem)||this.isSeparator(this.dragItem)||this.isNotHiddenItem(this.dragItem)||BX.Dom.attr(this.dragItem,"data-parent-item-id")||BX.Dom.attr(this.dragItem,"data-has-child")){t.preventDefault();return}this.onDragStarted=true;this.closeChildMenu();this.destroyItemEditMenu();if(this.isListItem(this.dragItem)){this.showMoreMenu()}this.setDragStyles();if(!this.isEditEnabled()){this.enableEdit()}},_onDragEnd:function(t){t.preventDefault();const e=this.getItem(t);this.onDragStarted=false;if(!BX.Type.isDomNode(e)){return}this.unsetDragStyles();this.refreshMoreMenu();if(!this.isEditEnabled()){this.closeMoreMenu()}const s=BX.findNextSibling(this.dragItem,(t=>this.isVisibleItem(t)));const i=BX.findPreviousSibling(this.dragItem,(t=>this.isVisibleItem(t)));if(BX.Dom.hasClass(i,this.classHiddenLabel)||this.isDisabled(i)&&this.isSubmenuItem(i)||this.isDisabled(s)&&this.isSubmenuItem(s)){this.disableItem(this.dragItem);this.refreshMoreMenu()}if(this.isEditEnabled()){this.enableEdit()}else{this.disableEdit()}this.updateMoreButtonCounter();this.saveSettings();this.dragItem=null;this.overItem=null;this.tmp.moved=false},updateMoreButtonCounter:function(){let t=this.getHiddenItems();const e=this.getDisabledItems();t=t.concat(e);let s=0;if(BX.Type.isArray(t)){t.forEach((t=>{const e=this.getItemData(t);const i=BX.Type.isNumber(e["COUNTER"])&&e["COUNTER"]>0?e["COUNTER"]:0;s+=i}))}if(BX.Type.isNumber(s)){this.setMoreButtonCounter(s)}},_onDragEnter:function(t){const e=this.getItem(t);if(BX.Type.isDomNode(e)&&this.isNotHiddenItem(e)){this.setOverStyles(e)}},_onDragOver:function(t){t.preventDefault();this.overItem=this.getItem(t);if(!BX.Type.isDomNode(this.overItem)||!BX.Type.isDomNode(this.dragItem)||this.overItem===this.dragItem||this.isNotHiddenItem(this.overItem)||BX.Dom.attr(this.overItem,"data-parent-item-id")||BX.Dom.attr(this.overItem,"data-has-child")){return}this.fakeDragItem();const e=this.isNext(t);const s=this.isGoodPosition(t);if(e&&s){let t;let e=false;if(this.isListItem(this.overItem)){t=this.findNextSiblingByClass(this.overItem,this.classItem);if(t===null&&this.getLastVisibleItem()===this.overItem){t=this.overItem;e=true}}else{t=this.findNextSiblingByClass(this.overItem,this.classSubmenuItem);if(this.isSettings(t)||this.isApplySettingsButton(t)||this.isResetSettingsButton(t)){return}if(t===null&&this.getItemAlias(this.getLastDisabledItem())===this.overItem){t=this.overItem;e=true}}if(BX.Type.isDomNode(t)){this.moveButton(t,e);this.moveButtonAlias(t,e);this.adjustMoreButtonPosition();this.updateMoreMenuItems()}}else if(!e&&s&&!BX.Dom.hasClass(this.overItem,this.classHiddenLabel)){this.moveButton(this.overItem);this.moveButtonAlias(this.overItem);this.adjustMoreButtonPosition();this.updateMoreMenuItems()}},_onDragLeave:function(t){const e=this.getItem(t);if(BX.Type.isDomNode(e)){this.unsetOverStyles(t.target)}},_onDrop:function(t){const e=this.getItem(t);if(!BX.Type.isDomNode(e)){return}if(this.isNotHiddenItem(e)||this.isDisabled(e)){this.disableItem(this.dragItem);this.adjustMoreButtonPosition()}const s=this.getItemAlias(this.dragItem);if(this.isListItem(s)){s.dataset.disabled="false"}this.unsetDragStyles();t.preventDefault()},handleMoreMenuFirstShow:function(t){const e=t.getTarget();BX.Event.bind(e.getPopupContainer(),"mouseenter",this.handleMoreMenuMouseEnter.bind(this));BX.Event.bind(e.getPopupContainer(),"mouseleave",this.handleMoreMenuMouseLeave.bind(this))},handleMoreMenuMouseEnter:function(){clearTimeout(this.submenuLeaveTimeout)},handleMoreMenuMouseLeave:function(){this.tryCloseMoreMenuOnTimeout()},tryCloseMoreMenuOnTimeout:function(){clearTimeout(this.submenuLeaveTimeout);if(!this.isEditEnabled()){this.submenuLeaveTimeout=setTimeout((()=>{this.closeMoreMenu()}),500)}},handleMoreMenuShow:function(t){BX.Event.EventEmitter.emit("BX.Main.InterfaceButtons:onMenuShow");BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onMoreMenuShow",{event:t});setTimeout((()=>{if(!this.isEditEnabled()){t.getTarget().setAutoHide(true)}}),500)},handleMoreMenuClose:function(){BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onMoreMenuClose");this.setMoreMenuShown(false);if(this.isEditEnabled()){this.activateItem(this.moreButton)}else{if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}}this.destroyItemEditMenu()},_onChildMenuFirstShow:function(t){const e=t.getTarget();BX.Event.bind(e.getPopupContainer(),"mouseenter",this._onChildMenuMouseEnter.bind(this));BX.Event.bind(e.getPopupContainer(),"mouseleave",this._onChildMenuMouseLeave.bind(this))},_onChildMenuMouseEnter:function(){clearTimeout(this.childMenuLeaveTimeout)},_onChildMenuMouseLeave:function(){this.tryCloseChildMenuOnTimeout()},tryCloseChildMenuOnTimeout:function(){if(this.isEditEnabled()){return}clearTimeout(this.childMenuLeaveTimeout);this.childMenuLeaveTimeout=setTimeout((()=>{this.closeChildMenu()}),500)},_onChildMenuShow:function(t,e){BX.Dom.addClass(t,this.classMenuShown);BX.Event.EventEmitter.emit("BX.Main.InterfaceButtons:onMenuShow");BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onSubMenuShow",{item:t,event:e});if(this.theme!=="default"){this.centerPopupArrow(e.getTarget(),t)}setTimeout((()=>{e.getTarget().setAutoHide(true)}),500)},_onChildMenuClose:function(t){BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onSubMenuClose");BX.Dom.removeClass(t,this.classMenuShown);this.closePinHint()},handleAdjustPosition:function(t,e){const s=25;const i=BX.Dom.getPosition(t);const n=e.getTarget();if(e.left<i.left-s){const t=n.getPopupContainer().offsetWidth;const o=i.right-t+s;if(o>0){e.left=o;BX.Dom.addClass(n.getPopupContainer(),"--left-handed")}}else{BX.Dom.removeClass(n.getPopupContainer(),"--left-handed")}},_onResizeHandler:function(){this.adjustMoreButtonPosition();this.updateMoreMenuItems();this.closeChildMenu();if(!this.isSettingsEnabled){this.visibleControlMoreButton()}},handleMoreButtonClick:function(t){t.preventDefault();this.showMoreMenu()},handleMoreButtonMouseEnter:function(t){if(this.enableItemMouseEnter){clearTimeout(this.menuShowTimeout);this.menuShowTimeout=setTimeout((()=>{this.showMoreMenu()}),100)}clearTimeout(this.submenuLeaveTimeout)},handleMoreButtonMouseLeave:function(){clearTimeout(this.menuShowTimeout);this.tryCloseMoreMenuOnTimeout()},handleItemMouseEnter:function(t){if(!this.enableItemMouseEnter){return}if(this.onDragStarted){return}const e=this.getItem(t);clearTimeout(this.childMenuLeaveTimeout);clearTimeout(this.menuShowTimeout);this.menuShowTimeout=setTimeout((()=>{this.showChildMenu(e)}),100);BX.Dom.addClass(e,this.classItemOver)},handleItemMouseLeave:function(t){clearTimeout(this.menuShowTimeout);if(!this.enableItemMouseEnter){return}if(this.onDragStarted){return}const e=this.getItem(t);BX.Dom.removeClass(e,this.classItemOver);this.tryCloseChildMenuOnTimeout()},handleMoreMenuItemMouseEnter:function(t){if(this.isEditEnabled()){t.preventDefault()}},getSettingsResetButton:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSettingsResetButton)},isDisabled:function(t){let e=false;if(BX.Type.isDomNode(t)){e=this.dataValue(t,"disabled")==="true"||BX.Dom.hasClass(t,this.classItemDisabled)}return e},isPinned:function(t){let e=false;if(BX.Type.isDomNode(t)){e=this.getItemData(t)["IS_PINNED"]===true}return e},isSettings:function(t){let e=false;if(BX.Type.isDomNode(t)){e=BX.Dom.hasClass(t,this.classSettingMenuItem)}return e},isLocked:function(t){let e=false;if(BX.Type.isDomNode(t)){e=this.dataValue(t,"locked")==="true"||BX.Dom.hasClass(t,this.classItemLocked)}return e},isDropzone:function(t){return BX.Dom.hasClass(t,this.classDropzone)},isNext:function(t){const e=this.dragItem.getBoundingClientRect();const s=this.overItem.getBoundingClientRect();const i=getComputedStyle(this.dragItem);const n=parseInt(i.marginRight.replace("px",""));let o=null;if(this.isListItem(this.overItem)){o=t.clientX>s.left-n&&t.clientX>e.right}if(this.isSubmenuItem(this.overItem)){o=t.clientY>e.top}return o},isGoodPosition:function(t){const e=this.overItem;if(!BX.Type.isDomNode(e)){return false}let s;const i=e.getBoundingClientRect();if(this.isListItem(e)){s=this.isNext(t)&&t.clientX>=i.left+i.width/2||!this.isNext(t)&&t.clientX<=i.left+i.width/2}if(this.isSubmenuItem(e)){s=this.isNext(t)&&t.clientY>=i.top+i.height/2||!this.isNext(t)&&t.clientY<=i.top+i.height/2}return s},isSubmenuItem:function(t){return BX.Dom.hasClass(t,this.classSubmenuItem)},isVisibleItem:function(t){if(!BX.Type.isDomNode(t)){return false}return t.offsetTop===0},isMoreButton:function(t){let e=false;if(BX.Type.isDomNode(t)&&BX.Dom.hasClass(t,this.classItemMore)){e=true}return e},isListItem:function(t){let e=false;if(BX.Type.isDomNode(t)&&BX.Dom.hasClass(t,this.classItem)){e=true}return e},isSublink:function(t){let e=false;if(BX.Type.isDomNode(t)){e=BX.Dom.hasClass(t,this.classItemSublink)}return e},isSeparator:function(t){let e=false;if(BX.Type.isDomNode(t)){e=BX.Dom.hasClass(t,this.classSeparator)}return e},isDragToSubmenu:function(){return!this.isSubmenuItem(this.dragItem)&&this.isSubmenuItem(this.overItem)},isDragToList:function(){return this.isSubmenuItem(this.dragItem)&&!this.isSubmenuItem(this.overItem)}}}if(typeof BX.Main.interfaceButtonsManager==="undefined"){BX.Main.interfaceButtonsManager={data:{},init:function(t){let e=null;if(!BX.Type.isPlainObject(t)||!("containerId"in t)){throw"BX.Main.interfaceButtonsManager: containerId not set in params Object"}e=BX(t.containerId);if(BX.Type.isDomNode(e)){this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}else{BX(BX.delegate((function(){e=BX(t.containerId);if(!BX.Type.isDomNode(e)){throw"BX.Main.interfaceButtonsManager: container is not dom node"}this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}),this))}},getById:function(t){let e=null;if(BX.type.isString(t)&&BX.Type.isStringFilled(t)){try{e=this.data[t]}catch(t){}}return e},getObjects:function(){return this.data}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js?16992579501940";s:6:"source";s:76:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
;(function() {
	'use strict';

	BX.namespace('BX.Buttons');

	/**
	 * BX.Main.interfaceButtons Utils
	 * @type {{getByClass: BX.Buttons.Utils.getByClass, getByTag: BX.Buttons.Utils.getByTag, getBySelector: BX.Buttons.Utils.getBySelector}}
	 */
	BX.Buttons.Utils = {
		/**
		 * Gets elements by className
		 * @param {HTMLElement|HTMLDocument} rootElement
		 * @param {string} className
		 * @param {boolean} [all = false] Gets all elements
		 * @returns {HTMLElement|Array}
		 */
		getByClass: function(rootElement, className, all)
		{
			var result = [];

			if (className)
			{
				result = (rootElement || document.body).getElementsByClassName(className);

				if (!all)
				{
					result = result.length ? result[0] : null;
				}
				else
				{
					result = [].slice.call(result);
				}
			}

			return result;
		},

		/**
		 * Gets elements by by element tag name
		 * @param {HTMLElement|HTMLDocument} rootElement
		 * @param {string} tag
		 * @param {boolean} [all = false] Gets all elements
		 * @returns {HTMLElement|Array}
		 */
		getByTag: function(rootElement, tag, all)
		{
			var result = [];

			if (tag)
			{
				result = (rootElement || document.body).getElementsByTagName(tag);

				if (!all)
				{
					result = result.length ? result[0] : null;
				}
				else
				{
					result = [].slice.call(result);
				}
			}

			return result;
		},

		/**
		 * Gets elements by css selector
		 * @param {HTMLElement|HTMLDocument} rootElement
		 * @param {string} selector
		 * @param {boolean} [all = false] Gets all elements
		 * @returns {HTMLElement|Array}
		 */
		getBySelector: function(rootElement, selector, all)
		{
			var result = [];

			if (selector)
			{
				if (!all)
				{
					result = (rootElement || document.body).querySelector(selector);
				}
				else
				{
					result = (rootElement || document.body).querySelectorAll(selector);
					result = [].slice.call(result);
				}
			}

			return result;
		}
	}
})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/logic.min.js?16992580834013";s:6:"source";s:77:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/logic.js";s:3:"min";s:81:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/logic.min.js";s:3:"map";s:81:"/bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TopMenu!="undefined"){return}BX.Tasks.Component.TopMenu=BX.Tasks.Component.extend({sys:{code:"topmenu"},methodsStatic:{instances:{},getInstance:function(t){return BX.Tasks.Component.TopMenu.instances[t]},addInstance:function(t,e){BX.Tasks.Component.TopMenu.instances[t]=e}},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);BX.Tasks.Component.TopMenu.addInstance(this.sys.code,this);this.userId=Number(this.option("userId"));this.ownerId=Number(this.option("ownerId"));this.groupId=Number(this.option("groupId"));this.isScrumLimitExceeded=Boolean(this.option("isScrumLimitExceeded"));this.isTaskAccessPermissionsLimit=Boolean(this.option("isTaskAccessPermissionsLimit"))},bindEvents:function(){try{var t=this.option("use_ajax_filter")?this.scope().getElementsByClassName("tasks_role_link"):{};if(t.length){for(var e=0;e<t.length;e++){BX.bind(t[e],"click",(function(t){t.preventDefault();var e=t.target.className;var s=this.dataset.id=="view_all"?"":this.dataset.id;var n=this.dataset.url;if(e==="main-buttons-item-sublink "&&s===""||e==="main-buttons-item-edit-button"){return}BX.onCustomEvent("Tasks.TopMenu:onItem",[s,n]);var i=this.parentElement.getElementsByClassName("tasks_role_link");if(i.length){for(var o=0;o<i.length;o++){BX.removeClass(i[o],"main-buttons-item-active")}}BX.addClass(this,"main-buttons-item-active")}))}}}catch(t){}BX.addCustomEvent("onPullEvent-tasks",function(t,e){switch(t){case"user_counter":this.onUserCounter(e);break;case"project_add":this.onProjectAdd(e);break;case"project_remove":this.onProjectRemove(e);break}}.bind(this));BX.addCustomEvent("BX.Main.Filter:apply",function(t,e,s){this.onFilterApply(t,e,s)}.bind(this))},isMyList:function(){return this.userId===this.ownerId},onUserCounter:function(t){if(!this.isMyList()||this.userId!==Number(t.userId)){return}var e=BX("tasks_panel_menu_view_projects");if(e){e.querySelector(".main-buttons-item-counter").innerText=this.getCounterValue(t.projects_major)}Object.keys(t[0]).forEach(function(e){var s=BX("tasks_panel_menu_"+(this.groupId?"group_":"")+e);if(s){s.querySelector(".main-buttons-item-counter").innerText=this.getCounterValue(t[0][e].total)}}.bind(this));var s=BX("tasks_panel_menu_view_scrum");if(s){s.querySelector(".main-buttons-item-counter").innerText=this.getCounterValue(t.scrum_total_comments)}},createScrum:function(t,e){if(this.isScrumLimitExceeded){BX.UI.InfoHelper.show(e,{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"scrumList"}})}else{BX.SidePanel.Instance.open(t)}},showConfigPermissions:function(){if(this.isTaskAccessPermissionsLimit){BX.UI.InfoHelper.show("limit_task_access_permissions",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"topMenu"}})}else{BX.SidePanel.Instance.open("/tasks/config/permissions/",{cacheable:false,events:{onOpen:function(){var t=BX.Main.interfaceButtonsManager;for(var e in t.data){t.data[e].closeSubmenu()}}}})}},onProjectAdd:function(t){this.updateScrumLimit()},onProjectRemove:function(t){this.updateScrumLimit()},updateScrumLimit(){var t=BX("tasks_panel_menu_view_scrum");if(!t){return}this.checkScrumLimit().then(function(t){this.isScrumLimitExceeded=Boolean(t)}.bind(this))},checkScrumLimit:function(){return BX.ajax.runAction("bitrix:tasks.scrum.info.checkScrumLimit",{data:{},signedParameters:this.signedParameters}).then((function(t){return t.data}))},getCounterValue:function(t){if(!t){return""}var e=99;return t>e?e+"+":t},onFilterApply:function(t,e,s){try{var n=s.getFilterFieldsValues().ROLEID;var i=BX.Tasks.Component.TopMenu.getInstance("topmenu").scope();var o=i.querySelectorAll(".tasks_role_link");for(var a=0;a<o.length;a++){BX.removeClass(o[a],"main-buttons-item-active")}if(typeof n!=="undefined"){if(!n){n="view_all"}BX.addClass(BX("tasks_panel_menu_"+n),"main-buttons-item-active");var r=BX.Tasks.Component.TasksToolbar.getInstance();if(r){r.rerender(n)}}}catch(t){}}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:104:"/bitrix/components/bitrix/tasks.interface.filter.buttons/templates/.default/script.min.js?16992580822944";s:6:"source";s:85:"/bitrix/components/bitrix/tasks.interface.filter.buttons/templates/.default/script.js";s:3:"min";s:89:"/bitrix/components/bitrix/tasks.interface.filter.buttons/templates/.default/script.min.js";s:3:"map";s:89:"/bitrix/components/bitrix/tasks.interface.filter.buttons/templates/.default/script.map.js";}"*/
"use strict";BX.namespace("BX.Tasks");BX.Tasks.InterfaceFilterButtons=function(t){this.section=t.section;this.entityId=t.entityId;this.muted=t.muted;this.checklistShowCompleted=t.checklistShowCompleted;this.initButtons();this.bindControls()};BX.Tasks.InterfaceFilterButtons.prototype={constructor:BX.Tasks.InterfaceFilterButtons,initButtons:function(){this.muteButton=this.getMuteButton();this.optionsMenuButton=this.getOptionsMenuButton()},getMuteButton:function(){var t="";switch(this.section){case"VIEW_TASK":t="taskViewMute";break;default:break}return BX(t)},getOptionsMenuButton:function(){var t="";switch(this.section){case"EDIT_TASK":t="taskEditPopupMenuOptions";break;case"VIEW_TASK":t="taskViewPopupMenuOptions";break;default:break}return BX(t)},bindControls:function(){var t=[{control:this.muteButton,action:"click",method:this.onMuteButtonClick.bind(this)},{control:this.optionsMenuButton,action:"click",method:this.onOptionsMenuButtonClick.bind(this)}];t.forEach(function(t){if(t.control){BX.bind(t.control,t.action,t.method)}})},onMuteButtonClick:function(){if(this.muteInProgress){return}this.muteInProgress=true;var t="tasks.task."+(this.muted?"unmute":"mute");var e={data:{taskId:this.entityId}};BX.ajax.runAction(t,e).then(function(){var t=this.muted?"ui-btn-icon-unfollow":"ui-btn-icon-follow";var e=this.muted?"ui-btn-icon-follow":"ui-btn-icon-unfollow";var n=this.muted?BX.message("MUTE_BUTTON_HINT_MUTE"):BX.message("MUTE_BUTTON_HINT_UNMUTE");BX.removeClass(this.muteButton,t);BX.addClass(this.muteButton,e);this.muteButton.setAttribute("data-hint",n);this.muteButton.removeAttribute("data-hint-init");BX.UI.Hint.init();BX.UI.Hint.hide();BX.UI.Hint.show(this.muteButton,n);this.muted=!this.muted;this.muteInProgress=false}.bind(this))},onOptionsMenuButtonClick:function(){var t=[{delimiter:true,text:BX.message("POPUP_MENU_CHECKLIST_SECTION")}];t.push({tabId:"showCompleted",text:BX.message("POPUP_MENU_SHOW_COMPLETED"),className:this.checklistShowCompleted?"menu-popup-item-accept":"menu-popup-item",onclick:function(t,e){e.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(e.layout.item,"menu-popup-item-accept");var n=BX.Tasks.CheckListInstance.getTreeStructure();var i=n.optionManager;i.setShowCompleted(!i.getShowCompleted());n.handleTaskOptions()}}});t.push({tabId:"showOnlyMine",text:BX.message("POPUP_MENU_SHOW_ONLY_MINE"),className:"menu-popup-item",onclick:function(t,e){e.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(e.layout.item,"menu-popup-item-accept");var n=BX.Tasks.CheckListInstance.getTreeStructure();var i=n.optionManager;i.setShowOnlyMine(!i.getShowOnlyMine());n.handleTaskOptions()}}});var e=BX.PopupMenu.create("taskPopupMenuOptions",this.optionsMenuButton,t,{closeByEsc:true,offsetLeft:this.optionsMenuButton.getBoundingClientRect().width/2,angle:true});e.popupWindow.show()}};
/* End */
;
; /* Start:"a:4:{s:4:"full";s:109:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/templateselector/logic.min.js?16992580832638";s:6:"source";s:90:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/templateselector/logic.js";s:3:"min";s:94:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/templateselector/logic.min.js";s:3:"map";s:94:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/templateselector/logic.map.js";}"*/
BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskDetailPartsTemplateSelector!="undefined"){return}BX.Tasks.Component.TaskDetailPartsTemplateSelector=BX.Tasks.Util.Widget.extend({sys:{code:"templateselector"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);BX.bind(this.control("open"),"click",this.onPopupOpen.bind(this));this.menu=null;this.menuItems=null},onPopupOpen:function(t){t=t||window.event;var e=t.currentTarget;this.getMenuItems().then(function(t){this.menuItems=t;this.showMenu(e)}.bind(this))},showMenu:function(t){if(!this.menu){this.menu=this.createMenu(t)}this.menu.popupWindow.show();BX.addClass(t,"webform-button-active")},getMenuItems:function(){var t=new BX.Promise;if(this.option("menuItems").length){t.fulfill(this.option("menuItems"))}else if(this.menuItems){t.fulfill(this.menuItems)}else{BX.ajax.runComponentAction("bitrix:tasks.templates.list","getList",{mode:"class",data:{select:["ID","TITLE"],order:{ID:"DESC"},filter:{ZOMBIE:"N"}}}).then(function(e){t.fulfill(this.makeItemsFromResult(e))}.bind(this),function(e){t.reject()}.bind(this))}return t},makeItemsFromResult:function(t){var e=[];var n=this.option("commonUrl");var i=t.data;if(i&&i.length){var s=n+(n.indexOf("?")<0?"?":"&");var o=window.location.href;var a=window.location.pathname;var r=o.split(a)[1];var l=r.substr(1,r.length-1);var u=l.split("&");Object.keys(u).forEach((function(t){if(u[t].indexOf("IFRAME")===0||u[t].indexOf("TEMPLATE")===0){delete u[t]}}));u=u.filter((function(t){return t!==undefined}));if(u.length){s+=u.join("&")+"&"}BX.Tasks.each(i,(function(t){e.push({ID:parseInt(t.ID),TITLE:t.TITLE,URL:s+"TEMPLATE="+parseInt(t.ID)})}))}return e},createMenu:function(t){var e=[];var n=function(){this.popupWindow.close()};BX.Tasks.each(this.menuItems||[],(function(t){e.push({text:BX.util.htmlspecialchars(t.TITLE),title:t.TITLE,href:t.URL,onclick:n})}));e.push({delimiter:true});e.push({text:BX.util.htmlspecialchars(BX.message("TASKS_TTDP_TEMPLATESELECTOR_TO_LIST")),title:BX.util.htmlspecialchars(BX.message("TASKS_TTDP_TEMPLATESELECTOR_TO_LIST")),href:this.option("toTemplates"),target:"_top",onclick:n});var i=this.id()+"-form-transport";var s=new BX.PopupMenuWindow(i,t,e,{offsetLeft:20,closeByEsc:true,angle:{position:"top"},events:{onPopupClose:this.onPopupClose.bind(this)}});if(!this.option("useSlider")){var o=s.menuItems;for(var a=0;a<o.length;a++){var r=o[a].layout;if(r&&r.item){r.item.dataset.sliderIgnoreAutobinding=true}}}return s},onPopupClose:function(){BX.removeClass(this.control("open"),"webform-button-active")}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?169925795070830";s:6:"source";s:69:"/bitrix/components/bitrix/main.post.form/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.map.js";}"*/
(function(){if(window["LHEPostForm"]){return}this.BX=this.BX||{};(function(e,t,i,n,r){"use strict";var a=function(){function e(t,i){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id","SomeParser");babelHelpers.defineProperty(this,"buttonParams",{name:"Some parser name",iconClassName:"some-parser-class",disabledForTextarea:false,src:"/icon.png",toolbarSort:205});this.editor=t;this.htmlEditor=i;this.handler=this.handler.bind(this)}babelHelpers.createClass(e,[{key:"handler",value:function e(){}},{key:"parse",value:function e(t){return t}},{key:"unparse",value:function e(t,i){return""}},{key:"hasButton",value:function e(){return this.buttonParams!==null}},{key:"getButton",value:function e(){if(this.buttonParams===null){return null}return{id:this.id,name:this.buttonParams.name,iconClassName:this.buttonParams.iconClassName,disabledForTextarea:this.buttonParams.disabledForTextarea,src:this.buttonParams.src,toolbarSort:this.buttonParams.toolbarSort,handler:this.handler}}},{key:"getParser",value:function e(){var t=this;return{name:this.id,obj:{Parse:function e(i,n){return t.parse(n)},UnParse:this.unparse.bind(this)}}}}]);return e}();var o=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,a=new Array(n),o=0;o<n;o++){a[o]=arguments[o]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"id","spoiler");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"buttonParams",{name:r.Loc.getMessage("MPF_SPOILER"),iconClassName:"spoiler",disabledForTextarea:false,src:r.Loc.getMessage("MPF_TEMPLATE_FOLDER")+"/images/lhespoiler.svg",toolbarSort:205});return i}babelHelpers.createClass(t,[{key:"handler",value:function e(){var t;if(!this.htmlEditor.bbCode||!this.htmlEditor.synchro.IsFocusedOnTextarea()){t=this.htmlEditor.action.actions.formatBlock.exec("formatBlock","blockquote","bx-spoiler",false,{bxTagParams:{tag:"spoiler"}})}else{t=this.htmlEditor.action.actions.formatBbCode.exec("quote",{tag:"SPOILER"})}return t}},{key:"parse",value:function e(t,i){if(/\[spoiler(([^\]])*)\]/gi.test(t)){t=t.replace(/[\x01-\x02]/gi,"").replace(/\[spoiler([^\]]*)\]/gi,"\x01$1\x01").replace(/\[\/spoiler]/gi,"\x02");var n=/(?:\x01([^\x01]*)\x01)([^\x01-\x02]+)\x02/gi;while(t.match(n)){t=t.replace(n,function(e,t,i){t=t.replace(/^(="|='|=)/gi,"").replace(/("|')?$/gi,"");return'<blockquote class="bx-spoiler" id="'.concat(this.htmlEditor.SetBxTag(false,{tag:"spoiler"}),'" title="').concat(t,'">').concat(i,"</blockquote>")}.bind(this))}}t=t.replace(/\001([^\001]*)\001/gi,"[spoiler$1]").replace(/\002/gi,"[/spoiler]");return t}},{key:"unparse",value:function e(t,i){var n="";for(var r=0;r<i.node.childNodes.length;r++){n+=this.htmlEditor.bbParser.GetNodeHtml(i.node.childNodes[r])}n=n.trim();if(n!==""){return"[SPOILER"+(i.node.hasAttribute("title")?"="+i.node.getAttribute("title"):"")+"]"+n+"[/SPOILER]"}return""}}]);return t}(a);var s=function(e){babelHelpers.inherits(i,e);function i(e,n){var r;babelHelpers.classCallCheck(this,i);r=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"id","postuser");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"buttonParams",null);t.EventEmitter.subscribe(n,"OnIframeKeydown",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(window.onKeyDownHandler){window.onKeyDownHandler(i,n,n.formID)}}));t.EventEmitter.subscribe(n,"OnIframeKeyup",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(window.onKeyUpHandler){window.onKeyUpHandler(i,n,n.formID)}}));t.EventEmitter.subscribe(n,"OnIframeClick",(function(){if(window["BXfpdStopMent"+n.formID]){window["BXfpdStopMent"+n.formID]()}}));t.EventEmitter.subscribe(n,"OnTextareaKeyup",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(n.textareaView&&n.textareaView.GetCursorPosition&&window.onTextareaKeyUpHandler){window.onTextareaKeyUpHandler(i,n,n.formID)}}));t.EventEmitter.subscribe(n,"OnTextareaKeydown",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(n.textareaView&&n.textareaView.GetCursorPosition&&window.onTextareaKeyDownHandler){window.onTextareaKeyDownHandler(i,n,n.formID)}}));return r}babelHelpers.createClass(i,[{key:"parse",value:function e(t,i){var n=this;t=t.replace(/\[USER\s*=\s*(\d+)\](.*?)\[\/USER\]/gi,(function(e,t,i){i=i.trim();if(i===""){return""}var r=n.htmlEditor.SetBxTag(false,{tag:n.id,userId:t,userName:i});return'<span id="'.concat(r,'" class="bxhtmled-metion">').concat(i,"</span>")})).replace(/\[PROJECT\s*=\s*(\d+)\](.*?)\[\/PROJECT\]/gi,(function(e,t,i){i=i.trim();if(i===""){return""}var r=n.htmlEditor.SetBxTag(false,{tag:n.id,projectId:t,projectName:i});return'<span id="'.concat(r,'" class="bxhtmled-metion">').concat(i,"</span>")})).replace(/\[DEPARTMENT\s*=\s*(\d+)\](.*?)\[\/DEPARTMENT\]/gi,(function(e,t,i){i=i.trim();if(i===""){return""}var r=n.htmlEditor.SetBxTag(false,{tag:n.id,departmentId:t,departmentName:i});return'<span id="'.concat(r,'" class="bxhtmled-metion">').concat(i,"</span>")}));return t}},{key:"unparse",value:function e(t,i){var n=this;var a="";i.node.childNodes.forEach((function(e){a+=n.htmlEditor.bbParser.GetNodeHtml(e)}));a=String(a).trim();var o="";if(r.Type.isStringFilled(a)){if(!r.Type.isUndefined(t.userId)){o="[USER=".concat(t.userId,"]").concat(a,"[/USER]")}else if(!r.Type.isUndefined(t.projectId)){o="[PROJECT=".concat(t.projectId,"]").concat(a,"[/PROJECT]")}else if(!r.Type.isUndefined(t.departmentId)){o="[DEPARTMENT=".concat(t.departmentId,"]").concat(a,"[/DEPARTMENT]")}}return o}}]);return i}(a);var l=function(){function e(i,n,r){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"actionPool",[]);this.cid=i;this.container=n;this.editor=r;t.EventEmitter.subscribe(r.getEventObject(),"onShowControllers",(function(e){var i=e.data;t.EventEmitter.emit(n.parentNode,"BFileDLoadFormController",new t.BaseEvent({compatData:[i]}))}));t.EventEmitter.subscribe(r.getEventObject(),"onCollectControllers",(function(e){e.data[i]={values:[]}}))}babelHelpers.createClass(e,[{key:"exec",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t){this.actionPool.push(t)}if(this.isReady){try{var i;while((i=this.actionPool.shift())&&i){i.apply(this)}}catch(e){console.log("error in attachments controllers: ",e)}}}},{key:"getId",value:function e(){return this.cid}},{key:"getFieldName",value:function e(){return null}},{key:"reinitFrom",value:function e(t){var i=this;this.exec((function(){if(!i.getFieldName()){return}i.container.querySelector('inptut[name="'.concat(i.getFieldName(),'"]')).forEach((function(e){e.parentNode.removeChild(e)}))}))}},{key:"isReady",get:function e(){return true}}]);return e}();var d=function(e){babelHelpers.inherits(i,e);function i(e,n,r){var a;babelHelpers.classCallCheck(this,i);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n,r));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"diskUfUploader",null);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"diskUfHandler",null);var o=function e(i){a.diskUfUploader=i;a.exec();var n=function e(i){t.EventEmitter.emit(r.getEventObject(),"onUploadsHasBeenChanged",i)};t.EventEmitter.subscribe(a.diskUfUploader,"onFileIsInited",n);t.EventEmitter.subscribe(a.diskUfUploader,"ChangeFileInput",n)};if(BX.UploaderManager.getById(e)){o(BX.UploaderManager.getById(e))}t.EventEmitter.subscribeOnce(n.parentNode,"DiskDLoadFormControllerInit",(function(t){var i=babelHelpers.slicedToArray(t.compatData,1),n=i[0];a.diskUfHandler=n;if(e===n.CID&&!a.diskUfUploader){o(n.agent)}}));t.EventEmitter.subscribe(r.getEventObject(),"onShowControllers",(function(e){var i=e.data;t.EventEmitter.emit(n.parentNode,"DiskLoadFormController",new t.BaseEvent({compatData:[i]}))}));return a}babelHelpers.createClass(i,[{key:"getFieldName",value:function e(){if(this.diskUfHandler){return this.diskUfHandler.params.controlName}return null}},{key:"reinitFrom",value:function e(t){var i=this;this.exec((function(){if(!i.getFieldName()){return}Array.from(i.container.querySelectorAll('inptut[name="'.concat(i.getFieldName(),'"]'))).forEach((function(e){e.parentNode.removeChild(e)}));var e=null;for(var n in t){if(t.hasOwnProperty(n)&&t[n]&&t[n]["USER_TYPE_ID"]==="disk_file"&&t[n]["FIELD_NAME"]===i.getFieldName()){e=t[n]["VALUE"]}}if(e){var r={};e.forEach((function(e){var t=document.querySelector("#disk-attach-"+e);if(t.tagName!=="A"){t=t.querySelector("img")}if(t){r["E"+e]={type:"file",id:e,name:t.getAttribute("data-bx-title")||t.getAttribute("data-title"),size:t.getAttribute("data-bx-size")||"",sizeInt:t.getAttribute("data-bx-size")||"",width:t.getAttribute("data-bx-width"),height:t.getAttribute("data-bx-height"),storage:"disk",previewUrl:t.tagName==="A"?"":t.getAttribute("data-bx-src")||t.getAttribute("data-src"),fileId:t.getAttribute("bx-attach-file-id")};if(t.hasAttribute("bx-attach-xml-id"))r["E"+e]["xmlId"]=t.getAttribute("bx-attach-xml-id");if(t.hasAttribute("bx-attach-file-type"))r["E"+e]["fileType"]=t.getAttribute("bx-attach-file-type")}}));i.diskUfHandler.selectFile({},{},r)}}))}},{key:"isReady",get:function e(){return!!this.diskUfUploader}}]);return i}(l);var c;var u=function(e){babelHelpers.inherits(i,e);function i(e,n){var a;babelHelpers.classCallCheck(this,i);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"id","uploadfile");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"buttonParams",null);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"regexp",/\[FILE ID=((?:\s|\S)*?)?\]/gi);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"values",new Map);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"controllers",new Map);a.checkButtonsDebounced=r.Runtime.debounce(a.checkButtons,500,babelHelpers.assertThisInitialized(a));a.init();t.EventEmitter.subscribe(e.getEditor(),"OnContentChanged",a.checkButtons.bind(babelHelpers.assertThisInitialized(a)));t.EventEmitter.subscribe(e.getEventObject(),"onReinitializeBefore",(function(e){var t=babelHelpers.slicedToArray(e.data,2),i=t[0],n=t[1];a.reinit(i,n)}));return a}babelHelpers.createClass(i,[{key:"init",value:function e(){var i=this;Array.from(this.editor.getContainer().querySelectorAll(".file-selectdialog")).forEach((function(e,n){var r=e.id.replace("file-selectdialog-","");var a=i.controllers.get(r);if(!a){a=new l(r,e,i.editor);t.EventEmitter.subscribe(e.parentNode,"OnFileUploadSuccess",(function(t){var n=babelHelpers.slicedToArray(t.data,2),a=n[0].element_id,o=n[1],s=o.id,l=o.doc_prefix,d=o.CID;if(r===s){var c=document.querySelector("#"+i.editor.getFormId())?document.querySelector("#"+i.editor.getFormId()).querySelector("#upload-cid"):null;if(c){c.value=d}var u=i.parseFile(e.querySelector("#"+l+a)),f=babelHelpers.slicedToArray(u,2),p=f[0],h=f[1];i.values.set(p,h)}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadRemove",(function(e){var t=babelHelpers.slicedToArray(e.compatData,2),n=t[0],a=t[1].id;if(r===a&&i.values.has(n)){i.values["delete"](n);i.deleteFile([n])}}));if(n===0){t.EventEmitter.subscribe(i.editor.getEventObject(),"onFilesHaveCaught",(function(e){e.stopImmediatePropagation();if(window["BfileFD"+r]){window["BfileFD"+r].agent.UploadDroppedFiles(babelHelpers.toConsumableArray(e.getData()))}}))}}if(e.querySelector("table.files-list")){Array.from(e.querySelector("table.files-list").querySelectorAll("tr")).forEach((function(e){var t=i.parseFile(e),n=babelHelpers.slicedToArray(t,2),r=n[0],a=n[1];i.values.set(r,a)}))}}))}},{key:"parseFile",value:function e(t){var i=this;var n=t.id.replace("wd-doc","");var a={id:n,name:t.querySelector('[data-role="name"]')?t.querySelector('[data-role="name"]').innerHTML:t.querySelector("span.f-wrap").innerHTML,node:t,buttonNode:t.querySelector('[data-role="button-insert"]'),image:{src:null,lowsrc:null,width:null,height:null}};var o=function e(){i.insertFile(n,t)};var s=t.querySelector(".f-wrap");if(s){s.addEventListener("click",o);s.style.cursor="pointer";s.title=r.Loc.getMessage("MPF_FILE")}var l=t.querySelector("img");if(l){l.addEventListener("click",o);l.title=r.Loc.getMessage("MPF_FILE");l.style.cursor="pointer";a.image.lowsrc=l.lowsrc||l.src;a.image.src=l.rel||l.src;a.image.width=l.getAttribute("data-bx-full-width");a.image.height=l.getAttribute("data-bx-full-height")}if(t instanceof HTMLTableRowElement&&t.querySelector(".files-info")){if(!a.buttonNode){a.buttonNode=r.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n<span type="button" onclick="','" data-role="button-insert" class="insert-btn">\n\t<span data-role="insert-btn" class="insert-btn-text">','</span>\n\t<span data-role="in-text-btn" class="insert-btn-text">',"</span>\n</span>"])),o,r.Loc.getMessage("MPF_FILE_INSERT_IN_TEXT"),r.Loc.getMessage("MPF_FILE_IN_TEXT"));t.querySelector(".files-info").appendChild(a.buttonNode);this.checkButtonsDebounced()}}return[n,a]}},{key:"buildHTML",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var r=this.htmlEditor.SetBxTag(false,{tag:this.id,fileId:t});var a='<span data-bx-file-id="'.concat(t,'" id="').concat(r,'" style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;">').concat(i.name,"</span>");if(i.image.src){var o=[];if(n){o.push('style="width:'.concat(n.width,"px;height:").concat(n.height,'px;"'))}else if(i.image.width&&i.image.height){o.push('style="width:'.concat(i.image.width,"px;height:").concat(i.image.height,'px;" '));o.push("onload=\"this.style.width='auto';this.style.height='auto';\"")}a='<img style="max-width: 90%;"  data-bx-file-id="'.concat(t,'" id="').concat(r,'" src="').concat(i.image.src,'" lowsrc="').concat(i.image.lowsrc,'" ').concat(o.join(" "),"/>")}return a}},{key:"buildText",value:function e(t,i){return"[FILE ID=".concat(t).concat(i||"","]")}},{key:"insertFile",value:function e(i,n){var r=this.values.get(String(i));if(r){t.EventEmitter.emit(this.editor.getEventObject(),"OnInsertContent",[this.buildText(i),this.buildHTML(i,r)])}}},{key:"deleteFile",value:function e(t){var i=this.htmlEditor.GetContent();if(this.htmlEditor.GetViewMode()==="wysiwyg"){var n=this.htmlEditor.GetIframeDoc();for(var r in this.htmlEditor.bxTags){if(this.htmlEditor.bxTags.hasOwnProperty(r)&&babelHelpers["typeof"](this.htmlEditor.bxTags[r])==="object"&&this.htmlEditor.bxTags[r]["tag"]===this.id&&t.indexOf(String(this.htmlEditor.bxTags[r]["fileId"]))>=0&&n.getElementById(r)){var a=n.getElementById(r);a.parentNode.removeChild(a)}}this.htmlEditor.SaveContent()}else{var o=i.replace(this.regexp,(function(e,i){return t.indexOf(i)>=0?"":e}));this.htmlEditor.SetContent(o);this.htmlEditor.Focus()}}},{key:"checkButtons",value:function e(t){var i=t?t.compatData[0]:this.htmlEditor.GetContent();var n=babelHelpers.toConsumableArray(i.matchAll(this.regexp)).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];return n}));this.values.forEach((function(e,t){if(!e.buttonNode){return}var i=n.indexOf(t)>=0;if(i===true&&e.buttonNode.className!=="insert-text"){e.buttonNode.className="insert-text";e.buttonNode.querySelector('[data-role="insert-btn"]').style.display="none";e.buttonNode.querySelector('[data-role="in-text-btn"]').style.display=""}else if(i!==true&&e.buttonNode.className!=="insert-btn"){e.buttonNode.className="insert-btn";e.buttonNode.querySelector('[data-role="insert-btn"]').style.display="";e.buttonNode.querySelector('[data-role="in-text-btn"]').style.display="none"}}))}},{key:"reinit",value:function e(t,i){this.values.forEach((function(e,t){if(e.node&&e.node.parentNode){e.node.parentNode.removeChild(e.node)}}));this.values.clear();this.controllers.forEach((function(e){e.reinitFrom(i)}))}},{key:"parse",value:function e(t){if(!this.regexp.test(t)){return t}t=t.replace(this.regexp,function(e,t,i,n){if(this.values.has(t)){return this.buildHTML(t,this.values.get(t),i>0&&n>0?{width:i,height:n}:null)}return e}.bind(this));return t}},{key:"unparse",value:function e(t,i){var n=i.node;var r=parseInt(n.hasAttribute("width")?n.getAttribute("width"):0);var a=parseInt(n.hasAttribute("height")?n.getAttribute("height"):0);var o="";if(r>0&&a>0){o=" WIDTH="+r+" HEIGHT="+a}var s=n.getAttribute("data-bx-file-id");return this.buildText(s,o)}}]);return i}(a);var f=function(e){babelHelpers.inherits(i,e);function i(e,n){var r;babelHelpers.classCallCheck(this,i);r=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"id","uploadimage");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"buttonParams",null);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"regexp",/\[IMAGE ID=((?:\s|\S)*?)?\]/gi);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"values",new Map);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"controllers",new Map);r.init();console.log("PostImage: ");t.EventEmitter.subscribe(e.getEventObject(),"onReinitializeBefore",(function(e){var t=babelHelpers.slicedToArray(e.data,2),i=t[0],n=t[1];r.reinit(i,n)}));return r}babelHelpers.createClass(i,[{key:"init",value:function e(){var i=this;Array.from(this.editor.getContainer().querySelectorAll(".file-selectdialog")).forEach((function(e){var n=e.id.replace("file-selectdialog-","");var r=i.controllers.get(n);if(!r){r=new l(n,e,i.editor);t.EventEmitter.subscribe(e.parentNode,"OnFileUploadSuccess",(function(t){var r=babelHelpers.slicedToArray(t.data,2),a=r[0].element_id,o=r[1],s=o.id,l=o.doc_prefix,d=o.CID;if(n===s){var c=document.querySelector("#"+i.editor.getFormId())?document.querySelector("#"+i.editor.getFormId()).querySelector("#upload-cid"):null;if(c){c.value=d}var u=i.parseFile(e.querySelector("#"+l+a)),f=babelHelpers.slicedToArray(u,2),p=f[0],h=f[1];i.values.set(p,h)}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadRemove",(function(e){var t=babelHelpers.slicedToArray(e.compatData,2),r=t[0],a=t[1].id;if(n===a&&i.values.has(r)){i.values["delete"](r)}}))}if(e.querySelector("table.files-list")){Array.from(e.querySelector("table.files-list").querySelectorAll("tr")).forEach((function(e){var t=i.parseFile(e),n=babelHelpers.slicedToArray(t,2),r=n[0],a=n[1];i.values.set(r,a)}))}}))}},{key:"parseFile",value:function e(t){var i=t.id.replace("wd-doc","");var n={id:i,name:t.querySelector('[data-role="name"]')?t.querySelector('[data-role="name"]').innerHTML:t.querySelector("span.f-wrap").innerHTML,node:t,image:{src:null,lowsrc:null,width:null,height:null}};return[i,n]}},{key:"reinit",value:function e(t,i){this.values.forEach((function(e,t){if(e.node&&e.node.parentNode){e.node.parentNode.removeChild(e.node)}}));this.values.clear();this.controllers.forEach((function(e){e.reinitFrom(i)}))}},{key:"parse",value:function e(t){return t}},{key:"unparse",value:function e(t,i){var n=i.node;return""}}]);return i}(a);var p;var h=function(e){babelHelpers.inherits(i,e);function i(){var e;var t;babelHelpers.classCallCheck(this,i);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++){r[a]=arguments[a]}t=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(i)).call.apply(e,[this].concat(r)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"id","diskfile");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"regexp",/\[(?:DOCUMENT ID|DISK FILE ID)=([n0-9]+)\]/gi);return t}babelHelpers.createClass(i,[{key:"init",value:function e(){var i=this;Array.from(this.editor.getContainer().querySelectorAll(".diskuf-selectdialog")).forEach((function(e,n){var r=e.id.replace("diskuf-selectdialog-","");var a=i.controllers.get(r);if(!a){a=new d(r,e,i.editor);i.controllers.set(r,a);t.EventEmitter.subscribe(e.parentNode,"OnFileUploadSuccess",(function(t){var n=babelHelpers.slicedToArray(t.data,3),r=n[0].element_id,o=n[1].CID,s=n[2];if(a.getId()!==o||i.values.has(r)){return}var l=i.parseFile(e.querySelector("#disk-edit-attach"+r)),d=babelHelpers.slicedToArray(l,3),c=d[0],u=d[1],f=d[2];i.values.set(c,f);if(c!==u){i.values.set(u,f)}if(s&&s["insertImageAfterUpload"]&&f.image.src){i.insertFile(c,f.node)}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadRemove",(function(e){var t=babelHelpers.slicedToArray(e.compatData,2),n=t[0],r=t[1].CID;if(a.getId()===r&&i.values.has(n)){var o=i.values.get(n);i.values["delete"](o.id);i.values["delete"](o.fileId);i.deleteFile([o.id,o.fileId])}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadFailed",(function(e){var t=babelHelpers.slicedToArray(e.compatData,3),n=t[0],r=t[1].CID,o=t[2];if(a.getId()===r&&o&&o["referrerToEditor"]){BX.onCustomEvent(o["referrerToEditor"],"OnImageDataUriCaughtFailed",[]);BX.onCustomEvent(i.editor,"OnImageDataUriCaughtFailed",[o["referrerToEditor"]])}}));if(n===0){b(i,a,e,i.editor);m(i,a,e,i.editor);t.EventEmitter.subscribe(i.editor.getEventObject(),"onFilesHaveCaught",(function(e){e.stopImmediatePropagation();a.diskUfUploader.onChange(babelHelpers.toConsumableArray(e.getData()))}))}}if(e.querySelector("table.files-list")){Array.from(e.querySelector("table.files-list").querySelectorAll("tr")).forEach((function(e){var t=i.parseFile(e),n=babelHelpers.slicedToArray(t,3),r=n[0],a=n[1],o=n[2];i.values.set(r,o);if(r!==a){i.values.set(a,o)}}))}}))}},{key:"parseFile",value:function e(t){var i=this;var n=String(t.id.replace("disk-edit-attach",""));var a={id:n,name:t.querySelector('[data-role="name"]')?t.querySelector('[data-role="name"]').innerHTML:t.querySelector("span.f-wrap").innerHTML,fileId:t.getAttribute("bx-attach-file-id"),node:t,buttonNode:t.querySelector('[data-role="button-insert"]'),image:{src:null,lowsrc:null,width:null,height:null}};var o=t.querySelector(".f-wrap");var s=function e(){i.insertFile(n,t)};if(o){o.addEventListener("click",s);o.style.cursor="pointer";o.title=r.Loc.getMessage("MPF_FILE")}var l=t.querySelector("img.files-preview");if(l&&(l.src.indexOf("bitrix/tools/disk/uf.php")>=0||l.src.indexOf("/disk/showFile/")>=0)){l.addEventListener("click",s);l.title=r.Loc.getMessage("MPF_FILE");l.style.cursor="pointer";a.image.lowsrc=l.lowsrc||l.src;a.image.src=(l.rel||l.getAttribute("data-bx-src")||l.src).replace(/&(width|height)=\d+/gi,"");var d=function e(){a.image.width=l.getAttribute("data-bx-full-width");a.image.height=l.getAttribute("data-bx-full-height")};l.addEventListener("load",d);if(l.complete){d()}}if(t instanceof HTMLTableRowElement&&!a.buttonNode){a.buttonNode=r.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n<span class="insert-btn" data-role="button-insert" onclick="','">\n\t<span data-role="insert-btn" class="insert-btn-text">','</span>\n\t<span data-role="in-text-btn" class="insert-btn-text" style="display: none;">',"</span>\n</span>"])),s,r.Loc.getMessage("MPF_FILE_INSERT_IN_TEXT"),r.Loc.getMessage("MPF_FILE_IN_TEXT"));setTimeout((function(){if(t.querySelector(".files-info")){t.querySelector(".files-info").appendChild(a.buttonNode);i.checkButtonsDebounced()}}))}return[n,a.fileId,a]}},{key:"buildText",value:function e(t,i){return"[DISK FILE ID=".concat(t).concat(i||"","]")}}]);return i}(u);function b(e,i,n,r){t.EventEmitter.subscribe(r.getEventObject(),"OnVideoHasCaught",(function(r){var a=r.getData();var o=function i(r){var o=babelHelpers.slicedToArray(r.data,3),s=o[0].element_id;babelHelpers.objectDestructuringEmpty(o[1]);var l=o[2];if(a===l&&e.values.has(s)){t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadSuccess",i);e.insertFile(s,e.values.get(s).node)}};t.EventEmitter.subscribe(n.parentNode,"OnFileUploadSuccess",o);i.exec((function(){i.diskUfUploader.onChange([a])}));r.stopImmediatePropagation()}))}function m(e,i,n,r){t.EventEmitter.subscribe(r.getEventObject(),"OnImageHasCaught",(function(r){r.stopImmediatePropagation();var a=r.getData();return new Promise((function(o,s){var l=function i(r){var s=babelHelpers.slicedToArray(r.data,3),l=s[0].element_id;babelHelpers.objectDestructuringEmpty(s[1]);var c=s[2];if(a===c&&e.values.has(l)){t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadSuccess",i);t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadFailed",d);var u=e.values.get(l);var f=e.buildHTML(l,u);o({image:u.image,html:f})}};var d=function e(i){var r=babelHelpers.slicedToArray(i.data,3),o=r[0];babelHelpers.objectDestructuringEmpty(r[1]);var d=r[2];if(a===d){t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadSuccess",l);t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadFailed",e);s()}};t.EventEmitter.subscribe(n.parentNode,"OnFileUploadSuccess",l);t.EventEmitter.subscribe(n.parentNode,"OnFileUploadFailed",d);i.exec((function(){i.diskUfUploader.onChange([r.getData()])}))}))}))}function v(e,t,i){if(e==="Spoiler"){return new o(t,i)}else if(e==="MentionUser"){return new s(t,i)}else if(e==="UploadImage"){return new f(t,i)}else if(e==="UploadFile"){return new u(t,i)}else if(babelHelpers["typeof"](e)==="object"&&e["disk_file"]){return new h(t,i)}return null}function E(e,t){if(!t){return}BX.addCustomEvent(t,"onAutoSavePrepare",(function(t){t.FORM.setAttribute("bx-lhe-autosave-prepared","Y");setTimeout((function(){BX.addCustomEvent(e,"OnContentChanged",(function(e){t["mpfTextContent"]=e;t.Init()}))}),1500)}));BX.addCustomEvent(t,"onAutoSave",(function(e,t){if(BX.type.isNotEmptyString(e["mpfTextContent"]))t["text"]=e["mpfTextContent"]}));BX.addCustomEvent(t,"onAutoSaveRestore",(function(t,i){if(i["text"]&&/[^\s]+/gi.test(i["text"])){e.CheckAndReInit(i["text"])}}));if(t.hasAttribute("bx-lhe-autosave-prepared")&&t.BXAUTOSAVE){t.removeAttribute("bx-lhe-autosave-prepared");setTimeout(t.BXAUTOSAVE.Prepare,100)}}function g(e,t,i){var n=false;if(i.showPanelEditor!==true&&i.showPanelEditor!==false){i.showPanelEditor=!t.toolbar.IsShown();n=true}e.exec((function(){var n=e.getContainer().querySelector('[data-bx-role="button-show-panel-editor"]');if(i.showPanelEditor){t.dom.toolbarCont.style.opacity="inherit";t.toolbar.Show();if(n){n.classList.add("feed-add-post-form-btn-active")}}else{t.toolbar.Hide();if(n){n.classList.remove("feed-add-post-form-btn-active")}}}));if(n!==false){BX.userOptions.save("main.post.form","postEdit","showBBCode",i.showPanelEditor?"Y":"N")}}function y(e,t){if(!(t.urlPreviewId&&window["BXUrlPreview"]&&BX(t.urlPreviewId))){return}var i=new BXUrlPreview(BX(t.urlPreviewId));var n=function e(t){i.attachUrlPreview({url:t})};var r=function e(t,n,r,a){if(n==="createLink"&&BX.type.isPlainObject(a)&&a.hasOwnProperty("href")){i.attachUrlPreview({url:a.href})}};BX.addCustomEvent(e,"OnAfterUrlConvert",n);BX.addCustomEvent(e,"OnAfterLinkInserted",n);BX.addCustomEvent(e,"OnBeforeCommandExec",r);BX.addCustomEvent(e,"OnReinitialize",(function(e,t){i.detachUrlPreview();var n;for(var r in t){if(t.hasOwnProperty(r)&&t[r].hasOwnProperty("USER_TYPE_ID")&&t[r]["USER_TYPE_ID"]==="url_preview"){n=t[r]["VALUE"];break}}if(n){i.attachUrlPreview({id:n})}}))}function w(e,t){e.exec((function(){t.contextMenu.items["postimage"]=t.contextMenu.items["postdocument"]=t.contextMenu.items["postfile"]=[{TEXT:r.Loc.getMessage("BXEdDelFromText"),bbMode:true,ACTION:function e(){var i=t.contextMenu.GetTargetItem("postimage");if(!i)i=t.contextMenu.GetTargetItem("postdocument");if(!i)i=t.contextMenu.GetTargetItem("postfile");if(i&&i.element){t.selection.RemoveNode(i.element)}t.contextMenu.Hide()}}];if(t.toolbar.controls&&t.toolbar.controls.FontSelector){t.toolbar.controls.FontSelector.SetWidth(45)}}))}function B(e){var i=document.querySelector("#lhe_button_submit_"+e.getFormId());if(i){i.addEventListener("click",(function(i){t.EventEmitter.emit(e.getEventObject(),"OnButtonClick",["submit"]);i.preventDefault();i.stopPropagation()}))}var n=document.querySelector("#lhe_button_cancel_"+e.getFormId());if(n){n.addEventListener("click",(function(i){t.EventEmitter.emit(e.getEventObject(),"OnButtonClick",["cancel"]);i.preventDefault();i.stopPropagation()}))}}function I(e,i){var n=e.getContainer().querySelector('[data-bx-role="toolbar"]');if(n.querySelector('[data-id="file"]')){var r=n.querySelector('[data-id="file"]');if(r){r.addEventListener("click",(function(){t.EventEmitter.emit(e.getEventObject(),"onShowControllers",r.hasAttribute("data-bx-button-status")?"hide":"show")}));t.EventEmitter.subscribe(e.getEventObject(),"onShowControllers",(function(e){var t=e.data;if(t.toString()==="show"){r.setAttribute("data-bx-button-status","active")}else{r.removeAttribute("data-bx-button-status")}}));r.setAttribute("data-bx-files-count",0);t.EventEmitter.subscribe(e.getEventObject(),"onShowControllers:File:Increment",(function(e){var t=e.data;var i=t>0?t:1;var n=Math.max(parseInt(r.getAttribute("data-bx-files-count")||0)+i,0);if(n>0){if(!r["counterObject"]){r["counterObject"]=new BX.UI.Counter({value:n,color:BX.UI.Counter.Color.GRAY,animate:true});var a=r.querySelector("span");a.appendChild(r["counterObject"].getContainer())}else{r["counterObject"].update(n)}}r.setAttribute("data-bx-files-count",n)}));t.EventEmitter.subscribe(e.getEventObject(),"onShowControllers:File:Decrement",(function(e){var t=e.data;var i=t>0?t:1;var n=Math.max(parseInt(r.getAttribute("data-bx-files-count")||0)-i,0);r.setAttribute("data-bx-files-count",n);if(r["counterObject"]){r["counterObject"].update(n)}}))}}if(n.querySelector('[data-id="search-tag"]')){window["BXPostFormTags_"+e.getFormId()]=new BXPostFormTags(e.getFormId(),n.querySelector('[data-id="search-tag"]'))}if(n.querySelector('[data-id="create-link"]')){n.querySelector('[data-id="create-link"]').addEventListener("click",(function(e){i.toolbar.controls.InsertLink.OnClick(e)}))}if(n.querySelector('[data-id="video"]')){n.querySelector('[data-id="video"]').addEventListener("click",(function(e){i.toolbar.controls.InsertVideo.OnClick(e)}))}if(n.querySelector('[data-id="quote"]')){var a=n.querySelector('[data-id="quote"]');a.setAttribute("data-bx-type","action");a.setAttribute("data-bx-action","quote");a.addEventListener("mousedown",(function(e){i.toolbar.controls.Quote.OnMouseDown.apply(i.toolbar.controls.Quote,[e]);i.CheckCommand(a)}))}if(e.getContainer().querySelector('[data-bx-role="button-show-panel-editor"]')){e.getContainer().querySelector('[data-bx-role="button-show-panel-editor"]').addEventListener("click",(function(){e.showPanelEditor()}))}}var S;var C;function T(e,t){if(!C){C=new IntersectionObserver((function(e){e.forEach((function(e){if(e.isIntersecting){C.unobserve(e.target);var t=e.target.observedCallback;delete e.target.observedCallback;setTimeout(t)}}))}),{threshold:0})}e.observedCallback=t;C.observe(e)}var P=0;var O=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.container=i.querySelector('[data-bx-role="toolbar"]');this.adjustMorePosition=this.adjustMorePosition.bind(this);this.moreItem=i.querySelector('[data-bx-role="toolbar-item-more"]');this.moreItem.addEventListener("click",this.showSubmenu.bind(this));T(this.container,this.adjustMorePosition);window.addEventListener("resize",this.adjustMorePosition)}babelHelpers.createClass(e,[{key:"insertAfter",value:function e(t,i){if(!r.Type.isElementNode(t["BODY"])&&!r.Type.isStringFilled(t["BODY"])){return}var n=r.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<div class="main-post-form-toolbar-button" data-bx-role="toolbar-item"></div>'])));if(r.Type.isElementNode(t["BODY"])){n.appendChild(t["BODY"])}else{n.innerHTML=t["BODY"]}if(t["ID"]){n.setAttribute("data-id",t["ID"])}if(i!==null){var a=false;var o=null;Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){if(a===true&&o===null){o=e}else if(a===false&&e&&e.dataset&&e.dataset.id===i){a=true}}));if(o){o.parentNode.insertBefore(n,o)}}if(!n.parentNode){this.container.appendChild(n)}this.adjustMorePosition()}},{key:"getItems",value:function e(){return Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]'))}},{key:"getVisibleItems",value:function e(){var t=this;var i=[];Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){if(e.offsetTop>t.container.clientHeight/2){i.push(e)}}));return i}},{key:"getHiddenItems",value:function e(){var t=[];Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){if(e.offsetTop>0){t.push(e)}}));return t}},{key:"adjustMorePosition",value:function e(){var t=this.getVisibleItems().length;if(t<=0||t>=this.getItems().length){this.moreItem.style.display="none"}else{this.moreItem.style.display=""}}},{key:"getPopup",value:function e(){var t=this;if(!this.popup){this.popup=n.PopupManager.create({id:"main_post_form_toolbar_"+P++,className:"main-post-form-toolbar-popup",cacheable:false,content:this.getPopupContainer(),closeByEsc:true,autoHide:true,angle:true,bindElement:this.moreItem,offsetTop:-5,offsetLeft:5,events:{onClose:function e(){Array.from(t.getPopupContainer().querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){t.container.appendChild(e)}));delete t.popup}}})}return this.popup}},{key:"getPopupContainer",value:function e(){if(!this.popupContainer){this.popupContainer=document.createElement("DIV")}return this.popupContainer}},{key:"showSubmenu",value:function e(){var t=this;var i=this.getHiddenItems();if(i.length<=0){return}i.forEach((function(e){t.getPopupContainer().appendChild(e)}));this.getPopup().show()}}]);return e}();var x=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"showPopup",value:function e(t){var i=n.PopupManager.getPopupById(this.getPopupId());if(!i){i=new n.Popup(this.getPopupId(),null,{content:this.getTasksLimitPopupContent(),lightShadow:false,offsetLeft:20,autoHide:false,angle:{position:"bottom"},closeByEsc:false,closeIcon:true})}i.setBindElement(t.bindPosition);i.show()}},{key:"getPopupId",value:function e(){return"bx-post-mention-tasks-limit-popup"}},{key:"getTasksLimitPopupContent",value:function e(){return r.Dom.create("DIV",{style:{width:"400px",padding:"10px"},children:[r.Dom.create("SPAN",{html:r.Loc.getMessage("MPF_MENTION_TASKS_LIMIT").replace("#A_BEGIN#",'<a href="javascript:void(0);" onclick="BX.Main.PostFormTasksLimit.onClickTasksLimitPopupSlider();">').replace("#A_END#","</a>")})]})}},{key:"onClickTasksLimitPopupSlider",value:function e(){this.hidePopup();BX.UI.InfoHelper.show("limit_tasks_observers_participants",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"postForm",subject:"auditor"}})}},{key:"hidePopup",value:function e(){var t=n.PopupManager.getPopupById(this.getPopupId());if(t){t.close()}}}]);return e}();function X(e,t,i){H(e,t);k(i,"get");return F(e,i)}function k(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function H(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function F(e,t){if(t.get){return t.get.call(e)}return t.value}var A=function(){function e(i,n){var a=this;babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"jobs",new Map);babelHelpers.defineProperty(this,"editorParams",{height:100,ctrlEnterHandler:null,parsers:null,showPanelEditor:false,lazyLoad:true,urlPreviewId:null,tasksLimitExceeded:false});babelHelpers.defineProperty(this,"actionQueue",[]);this.id=i["id"];this.name=i["name"];this.formId=i["formId"];this.eventNode=i.eventNode||document.querySelector("#div"+(this.name||this.id));this.eventNode.dataset.bxHtmlEditable="Y";this.formEntityType=null;e.repo.set(this.getId(),this);if(!r.Type.isArray(n.parsers)&&r.Type.isPlainObject(n.parsers)){n.parsers=Object.values(n.parsers)}this.setEditorParams(n);this.bindEvents(window["BXHtmlEditor"]?window["BXHtmlEditor"].Get(this.getId()):null);this.toolbar=new O(this.getEventObject(),this.getContainer());this.inited=true;if(this.name!==null){window[this.name]=this}BX.onCustomEvent(this,"onInitialized",[this,this.getFormId()]);t.EventEmitter.subscribe(this.getEventObject(),"OnFileUploadSuccess",(function(e){var t=e.compatData;BX.onCustomEvent(a.getEventObject(),"onFileIsAdded",t)}));t.EventEmitter.subscribe(this.getEventObject(),"onBusy",(function(e){var i=e.data;if(a.jobs.size<=0){t.EventEmitter.emit(a.getEventObject(),"onLHEIsBusy")}a.jobs.set(i,(a.jobs.get(i)||0)+1)}));t.EventEmitter.subscribe(this.getEventObject(),"onReady",(function(e){var i=e.data;if(a.jobs.size<=0||!a.jobs.has(i)){return}var n=a.jobs.get(i);if(n<=1){a.jobs["delete"](i);if(a.jobs.size<=0){t.EventEmitter.emit(a.getEventObject(),"onLHEIsReady")}}else{a.jobs.set(i,--n)}}))}babelHelpers.createClass(e,[{key:"setEditorParams",value:function e(t){this.editorParams=Object.assign(this.editorParams,t)}},{key:"bindEvents",value:function e(){var i=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.events={};[["OnEditorInitedBefore",this.OnEditorInitedBefore.bind(this)],["OnCreateIframeAfter",this.OnCreateIframeAfter.bind(this)],["OnEditorInitedAfter",this.OnEditorInitedAfter.bind(this)]].forEach((function(e){var t=babelHelpers.slicedToArray(e,2),r=t[0],a=t[1];if(!n){i.events[r]=function(e){if(e.id===i.getId()){
//!it important to use deprecated eventEmitter
BX.removeCustomEvent(r,i.events[r]);delete i.events[r];a(e)}};//!it important to use deprecated eventEmitter
BX.addCustomEvent(r,i.events[r])}else{a(n)}}));t.EventEmitter.subscribe(this.getEventObject(),"OnShowLHE",this.OnShowLHE.bind(this));t.EventEmitter.subscribe(this.getEventObject(),"OnButtonClick",this.OnButtonClick.bind(this));t.EventEmitter.subscribe(this.getEventObject(),"OnParserRegister",(function(e){var t=e.data;i.addParser(t)}));t.EventEmitter.subscribe(this.getEventObject(),"OnGetHTMLEditor",(function(e){var t=e.data;t.htmlEditor=i.getEditor()}));t.EventEmitter.subscribe(this.getEventObject(),"OnInsertContent",(function(e){var t=babelHelpers.slicedToArray(e.data,2),n=t[0],r=t[1];i.insertContent(n,r)}));t.EventEmitter.subscribe(this.getEventObject(),"OnAddButton",(function(e){var t=babelHelpers.slicedToArray(e.data,2),n=t[0],r=t[1];i.getToolbar().insertAfter(n,r)}));B(this)}},{key:"getId",value:function e(){return this.id}},{key:"setEditor",value:function i(n){var a=this;if(this.htmlEditor===n){return}this.htmlEditor=n;n.formID=this.getFormId();t.EventEmitter.subscribe(n,"OnCtrlEnter",(function(){n.SaveContent();if(r.Type.isFunction(a.editorParams.ctrlEnterHandler)){a.editorParams.ctrlEnterHandler()}else if(r.Type.isStringFilled(a.editorParams.ctrlEnterHandler)&&window[a.editorParams.ctrlEnterHandler]){window[a.editorParams.ctrlEnterHandler]()}else if(document.forms[a.getFormId()]){BX.submit(document.forms[a.getFormId()])}}));this.editorParams["height"]=n.config["height"];console.groupCollapsed("main.post.form: parsers: ",this.getId());this.editorParams.parsers.forEach((function(e){var t=v(e,a,n);if(t){console.groupCollapsed(e);console.log(t);if(t.hasButton()){n.AddButton(t.getButton())}n.AddParser(t.getParser());console.groupEnd(e)}}));console.groupEnd("main.post.form: parsers: ",this.getId());t.EventEmitter.subscribe(n,"OnImageDataUriHandle",(function(e){var i=babelHelpers.slicedToArray(e.compatData,2),r=i[0],o=i[1];var s=BX.UploaderUtils.dataURLToBlob(o.src);if(s&&s.size>0&&s.type.indexOf("image/")===0){t.EventEmitter.emit(a.getEventObject(),"onShowControllers","show");s.name=s.name||o.title||"image."+s.type.substr(6);s.referrerToEditor=o;t.EventEmitter.emit(a.getEventObject(),"OnImageHasCaught",new t.BaseEvent({data:s})).forEach((function(e){e.then((function(e){var i=e.image,r=e.html;t.EventEmitter.emit(n,"OnImageDataUriCaughtUploaded",new t.BaseEvent({compatData:[o,i,{replacement:r}]}))}))["catch"]((function(){t.EventEmitter.emit(n,"OnImageDataUriCaughtFailed",new t.BaseEvent({compatData:[o]}))}))}))}}));t.EventEmitter.subscribe(t.EventEmitter.GLOBAL_TARGET,"onAddVideoMessage",(function(e){var i=babelHelpers.slicedToArray(e.compatData,2),n=i[0],r=i[1];if(!r||a.getFormId()!==r){return}t.EventEmitter.emit(a.getEventObject(),"onShowControllers","show");t.EventEmitter.emit(a.getEventObject(),"OnVideoHasCaught",new t.BaseEvent({data:n}))}));(function(){var i=BX("micro"+(a.name||a.id));var n=false;var r=0;var o=function e(t){t.preventDefault();t.stopPropagation();if(r>0){clearTimeout(r);r=0}if(n===true){return}var o=t&&t["dataTransfer"]&&t["dataTransfer"]["types"]&&t["dataTransfer"]["types"].indexOf("Files")>=0;if(o){n=true;a.getContainer().classList.add("feed-add-post-dnd-over");if(i){i.classList.add("feed-add-post-micro-dnd-ready")}}return true};var s=function e(t){t.preventDefault();t.stopPropagation();if(r>0){clearTimeout(r)}r=setTimeout((function(){n=false;a.getContainer().classList.remove("feed-add-post-dnd-over");if(i){i.classList.remove("feed-add-post-micro-dnd-ready")}}),100);return false};var l=function e(i){s(i);if(i&&i["dataTransfer"]&&i["dataTransfer"]["types"]&&i["dataTransfer"]["types"].indexOf("Files")>=0&&i["dataTransfer"]["files"]&&i["dataTransfer"]["files"].length>0){t.EventEmitter.emit(a.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",{onShowControllers:"show"}]}));t.EventEmitter.emit(a.getEventObject(),"onFilesHaveCaught",new t.BaseEvent({data:i["dataTransfer"]["files"]}))}return false};a.getContainer().addEventListener("dragover",o);a.getContainer().addEventListener("dragenter",o);a.getContainer().addEventListener("dragleave",s);a.getContainer().addEventListener("dragexit",s);a.getContainer().addEventListener("drop",l);a.getContainer().setAttribute("dropzone","copy f:*/*");if(!document.body.hasAttribute("dropzone")){document.body.setAttribute("dropzone","copy f:*/*");document.body.addEventListener("dragover",(function(e){e.preventDefault();e.stopPropagation();return true}));document.body.addEventListener("drop",function(i){i.preventDefault();i.stopPropagation();if(i&&i["dataTransfer"]&&i["dataTransfer"]["types"]&&i["dataTransfer"]["types"].indexOf("Files")>=0&&i["dataTransfer"]["files"]&&i["dataTransfer"]["files"].length>0){var n;var r;var a=X(this.constructor,e,D).keys();while((r=a.next())&&r.done!==true&&r.value){n=r.value}if(n){t.EventEmitter.emit(n.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",{onShowControllers:"show"}]}));t.EventEmitter.emit(n.getEventObject(),"onFilesHaveCaught",new t.BaseEvent({data:i["dataTransfer"]["files"]}))}}return false}.bind(a))}if(i){i.addEventListener("dragenter",(function(e){o(e);t.EventEmitter.emit(a.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",{onShowControllers:"show"}]}))}))}t.EventEmitter.subscribe(a.getEditor(),"OnIframeDrop",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];return l(i)}));t.EventEmitter.subscribe(a.getEditor(),"OnIframeDragOver",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];return o(i)}));t.EventEmitter.subscribe(a.getEditor(),"OnIframeDragLeave",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];return s(i)}))})();t.EventEmitter.subscribe(n,"OnInsertContent",(function(e){var t=babelHelpers.slicedToArray(e.data,2),i=t[0],n=t[1];a.insertContent(i,n)}));g(this,n,this.editorParams);y(n,this.editorParams);w(this,n);E(n,BX(this.getFormId()));I(this,n);t.EventEmitter.subscribe(this.getEventObject(),"OnAfterShowLHE",(function(){a.getEditor().AllowBeforeUnloadHandler()}));t.EventEmitter.subscribe(this.getEventObject(),"OnAfterHideLHE",(function(){x.hidePopup();a.getEditor().DenyBeforeUnloadHandler()}));t.EventEmitter.subscribe(n,"OnIframeClick",(function(){var e=new MouseEvent("click",{bubbles:true,cancelable:true,view:window});n.iframeView.container.dispatchEvent(e)}))}},{key:"getEditor",value:function e(){return this.htmlEditor}},{key:"getFormId",value:function e(){return this.formId}},{key:"getEventObject",value:function e(){return this.eventNode}},{key:"getContainer",value:function e(){return this.eventNode}},{key:"getToolbar",value:function e(){return this.toolbar}},{key:"OnEditorInitedBefore",value:function e(t){this.setEditor(t)}},{key:"OnCreateIframeAfter",value:function e(){if(this.editorIsLoaded!==true){this.editorIsLoaded=true;this.exec();t.EventEmitter.emit(this,"OnEditorIsLoaded",[])}}},{key:"OnEditorInitedAfter",value:function e(i){if(!this.editorParams.lazyLoad){t.EventEmitter.emit(this.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",i,false]}))}if(i.sandbox&&i.sandbox.inited){this.OnCreateIframeAfter()}}},{key:"addParser",value:function e(t){var i=this;this.exec((function(){t.init(i.getEditor());i.getEditor().AddParser({name:t.id,obj:{Parse:function e(i,n){return t.parse(n)},UnParse:t.unparse}});if(!i["addParserAfterDebounced"]){i.addParserAfterDebounced=r.Runtime.debounce((function(){i.getEditor().SetContent(i.getEditor().GetContent().replace(/&#91;/gi,"[").replace(/&#93;/gi,"]"),true)}),100)}i.addParserAfterDebounced()}))}},{key:"insertContent",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;this.exec((function(){var e=i.getEditor().GetViewMode();if(e==="wysiwyg"){i.getEditor().InsertHtml(n||t);setTimeout(i.getEditor().AutoResizeSceleton.bind(i.getEditor()),500);setTimeout(i.getEditor().AutoResizeSceleton.bind(i.getEditor()),1e3)}else{i.getEditor().textareaView.Focus();if(!i.getEditor().bbCode){var r=i.getEditor().GetIframeDoc();var a=r.createElement("DIV");a.style.display="none";a.innerHTML=t;r.body.appendChild(a);t=i.getEditor().Parse(t,true,false);a.parentNode.removeChild(a)}i.getEditor().textareaView.WrapWith("","",t)}}))}},{key:"reinit",value:function e(i,n){var a="hide";if(r.Type.isPlainObject(n)&&Object.values(n).length){Object.values(n).forEach((function(e){if(e&&e["VALUE"]){a="show"}}))}t.EventEmitter.emit(this.getEventObject(),"onShowControllers",a);t.EventEmitter.emit(this.getEventObject(),"onReinitializeBefore",[i,n]);this.getEditor().CheckAndReInit(r.Type.isString(i)?i:"");BX.onCustomEvent(this.getEditor(),"onReinitialize",[this,i,n]);if(this.editorParams["height"]){this.oEditor.SetConfigHeight(this.editorParams["height"]);this.oEditor.ResizeSceleton()}}},{key:"OnShowLHE",value:function i(n){var a=this;var o=n.data,s=n.compatData;var l=o||s,d=babelHelpers.slicedToArray(l,3),c=d[0],u=d[1],f=d[2];if(!this.getEditor()&&window["BXHtmlEditor"]){window["BXHtmlEditor"].Get(this.getId()).Init()}c=c===false||c==="hide"||c==="justShow"?c:true;var p=BX("micro"+(this.name||this.id));if(p){p.style.display=c===true||c==="justShow"?"none":"block"}if(c==="hide"){X(this.constructor,e,D)["delete"](this);t.EventEmitter.emit(this.getEventObject(),"OnBeforeHideLHE");if(this.getContainer().style.display==="none"){t.EventEmitter.emit(this.getEventObject(),"OnAfterHideLHE");t.EventEmitter.emit(this.getEventObject(),"onShowControllers","hide")}else{new BX["easing"]({duration:200,start:{opacity:100,height:this.getContainer().scrollHeight},finish:{opacity:0,height:20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function e(t){a.getContainer().style.height=t.height+"px";a.getContainer().style.opacity=t.opacity/100},complete:function e(){a.getContainer().style.cssText="";a.getContainer().style.display="none";t.EventEmitter.emit(a.getEventObject(),"OnAfterHideLHE");t.EventEmitter.emit(a.getEventObject(),"onShowControllers","hide")}}).animate()}}else if(c){X(this.constructor,e,D).set(this);this.formEntityType=r.Type.isArray(f)&&r.Type.isStringFilled(f[0])&&f[0].match(/^TASK_(\d+)$/i)?"task":null;if(u&&r.Type.isPlainObject(u)){if(u["onShowControllers"]){t.EventEmitter.emit(this.getEventObject(),"onShowControllers",u["onShowControllers"])}}t.EventEmitter.emit(this.getEventObject(),"OnBeforeShowLHE");if(c==="justShow"||this.getContainer().style.display==="block"){this.getContainer().style.display="block";t.EventEmitter.emit(this.getEventObject(),"OnAfterShowLHE");if(u!==false){this.getEditor().Focus()}}else{r.Dom.adjust(this.getContainer(),{style:{display:"block",overflow:"hidden",height:"20px",opacity:.1}});new BX["easing"]({duration:200,start:{opacity:10,height:20},finish:{opacity:100,height:this.getContainer().scrollHeight},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function e(t){a.getContainer().style.height=t.height+"px";a.getContainer().style.opacity=t.opacity/100},complete:function e(){t.EventEmitter.emit(a.getEventObject(),"OnAfterShowLHE");a.getEditor().Focus();a.getContainer().style.cssText=""}}).animate()}}else{X(this.constructor,e,D)["delete"](this);t.EventEmitter.emit(this.getEventObject(),"OnBeforeHideLHE");t.EventEmitter.emit(this.getEventObject(),"onShowControllers","hide");this.getContainer().style.display="none";t.EventEmitter.emit(this.getEventObject(),"OnAfterHideLHE")}}},{key:"OnButtonClick",value:function e(i){var n=babelHelpers.slicedToArray(i.data,1),r=n[0];if(r!=="cancel"){var a={result:true};t.EventEmitter.emit(this.getEventObject(),"OnClickBeforeSubmit",new t.BaseEvent({compatData:[this,a]}));if(a["result"]!==false){t.EventEmitter.emit(this.getEventObject(),"OnClickSubmit",new t.BaseEvent({compatData:[this]}))}}else{t.EventEmitter.emit(this.getEventObject(),"OnClickCancel",new t.BaseEvent({compatData:[this]}));t.EventEmitter.emit(this.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["hide"]}))}}},{key:"exec",value:function e(t,i){if(typeof t=="function"){this.actionQueue.push([t,i])}if(this.editorIsLoaded===true){var n;while((n=this.actionQueue.shift())&&n){n[0].apply(this,n[1])}}}},{key:"showPanelEditor",value:function e(){g(this,this.getEditor(),{})}},{key:"getContent",value:function e(){return this.oEditor?this.oEditor.GetContent():""}},{key:"setContent",value:function e(t){if(this.getEditor()){this.getEditor().SetContent(t)}}},{key:"controllerInit",value:function e(i){t.EventEmitter.emit(this.getEventObject(),"onShowControllers",i==="hide"?"hide":"show")}},{key:"isReady",get:function e(){return this.editorIsLoaded}},{key:"oEditor",get:function e(){return this.getEditor()}},{key:"oEditorId",get:function e(){return this.getId()}},{key:"formID",get:function e(){return this.getFormId()}},{key:"params",get:function e(){return{formID:this.getFormId()}}},{key:"controllers",get:function e(){var i=new t.BaseEvent;var n={};i.setData(n);t.EventEmitter.emit(this.getEventObject(),"onCollectControllers",i);var a={};Object.keys(n).forEach((function(e){a[e]=Object.assign({},n[e]);a[e]["values"]={};if(r.Type.isArray(n[e]["values"])){n[e]["values"].forEach((function(t){a[e]["values"][t]={id:t}}))}else if(r.Type.isPlainObject(n[e]["values"])){a[e]["values"]=Object.assign({},n[e]["values"])}}));return a}},{key:"arFiles",get:function e(){var i=new t.BaseEvent;var n={};i.setData(n);t.EventEmitter.emit(this.getEventObject(),"onCollectControllers",i);var r={};Object.keys(n).forEach((function(e){if(n[e]["values"]){n[e]["values"].forEach((function(t){r[t]=[e]}))}}));return r}}]);return e}();babelHelpers.defineProperty(A,"repo",new Map);var D={writable:true,value:new Map};window["LHEPostForm"]={getEditor:function e(t){return window["BXHtmlEditor"]?window["BXHtmlEditor"].Get(babelHelpers["typeof"](t)=="object"?t.id:t):null},getHandler:function e(t){var i=r.Type.isStringFilled(t)?t:t.id;return A.repo.get(i)},getHandlerByFormId:function e(t){var i=null;A.repo.forEach((function(e){if(e.getFormId()===t){i=e}}));return i},reinitData:function e(t,i,n){var a={};if(!r.Type.isPlainObject(n)){n={}}Object.entries(n).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];if(r.Type.isPlainObject(n)&&n["USER_TYPE_ID"]&&n["VALUE"]&&Object.values(n["VALUE"]).length>0){a[i]=n}}));var o=this.getHandler(t);if(o&&(o.isReady||r.Type.isStringFilled(i)||Object.values(a).length>0)){o.exec(o.reinit,[i,a])}return false},reinitDataBefore:function e(i){var n=A.repo.get(i);if(n&&n.getEventObject()){t.EventEmitter.emit(n.getEventObject(),"onReinitializeBefore",[n])}}};e.PostForm=A;e.PostFormTasksLimit=x})(this.BX.Main=this.BX.Main||{},BX.Event,BX,BX.Main,BX);(function(){if(window["BXPostFormTags"])return;var e={selector:{},mentionParams:{}};window.BXPostFormTags=function(e,t){this.popup=null;this.formID=e;this.buttonID=t;this.sharpButton=null;this.addNewLink=null;this.tagsArea=null;this.hiddenField=null;this.popupContent=null;BX.ready(BX.proxy(this.init,this))};window.BXPostFormTags.prototype.init=function(){this.sharpButton=BX(this.buttonID);this.addNewLink=BX("post-tags-add-new-"+this.formID);this.tagsArea=BX("post-tags-block-"+this.formID);this.tagsContainer=BX("post-tags-container-"+this.formID);this.hiddenField=BX("post-tags-hidden-"+this.formID);this.popupContent=BX("post-tags-popup-content-"+this.formID);this.popupInput=BX.findChild(this.popupContent,{tag:"input"});var e=BX.findChildren(this.tagsContainer,{className:"feed-add-post-del-but"},true);for(var t=0,i=e.length;t<i;t++){BX.bind(e[t],"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:e[t].parentNode,tagValue:e[t].parentNode.getAttribute("data-tag")}))}BX.bind(this.sharpButton,"click",BX.proxy(this.onButtonClick,this));BX.bind(this.addNewLink,"click",BX.proxy(this.onAddNewClick,this))};window.BXPostFormTags.prototype.onTagDelete=function(){BX.remove(this.tagBox);this.obj.hiddenField.value=this.obj.hiddenField.value.replace(this.tagValue+",","").replace("  "," ")};window.BXPostFormTags.prototype.show=function(){if(this.popup===null){this.popup=new BX.PopupWindow("bx-post-tag-popup",this.addNewLink,{content:this.popupContent,lightShadow:false,offsetTop:8,offsetLeft:10,autoHide:true,angle:true,closeByEsc:true,zIndex:-840,buttons:[new BX.PopupWindowButton({text:BX.message("TAG_ADD"),events:{click:BX.proxy(this.onTagAdd,this)}})]});BX.bind(this.popupInput,"keydown",BX.proxy(this.onKeyPress,this));BX.bind(this.popupInput,"keyup",BX.proxy(this.onKeyPress,this))}this.popup.show();BX.focus(this.popupInput)};window.BXPostFormTags.prototype.addTag=function(e){var t=BX.type.isNotEmptyString(e)?e.split(","):this.popupInput.value.split(",");var i=[];for(var n=0;n<t.length;n++){var r=BX.util.trim(t[n]);if(r.length>0){var a=this.hiddenField.value.split(",");if(!BX.util.in_array(r,a)){var o;var s=BX.create("span",{children:[o=BX.create("span",{attrs:{class:"feed-add-post-del-but"}})],attrs:{class:"feed-add-post-tags"}});s.insertBefore(document.createTextNode(r),o);this.tagsContainer.insertBefore(s,this.addNewLink);BX.bind(o,"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:s,tagValue:r}));this.hiddenField.value+=r+",";i.push(r)}}}return i};window.BXPostFormTags.prototype.onTagAdd=function(){this.addTag();this.popupInput.value="";this.popup.close()};window.BXPostFormTags.prototype.onAddNewClick=function(e){e=e||window.event;this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onButtonClick=function(e){e=e||window.event;BX.show(this.tagsArea);this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onKeyPress=function(e){e=e||window.event;var t=e.keyCode?e.keyCode:e.which?e.which:null;if(t==13){setTimeout(BX.proxy(this.onTagAdd,this),0)}};window.BXPostFormImportant=function(e,t,i){if(i){this.formID=e;this.buttonID=t;this.inputName=i;this.fireButton=null;this.activeBlock=null;this.hiddenField=null;BX.ready(BX.proxy(this.init,this))}return false};window.BXPostFormImportant.prototype.init=function(){this.fireButton=BX(this.buttonID);this.activeBlock=BX(this.buttonID+"-active");var e=BX(this.formID);if(e){this.hiddenField=e[this.inputName];if(this.hiddenField&&this.hiddenField.value==1){this.showActive()}}BX.bind(this.fireButton,"click",BX.proxy((function(e){e=e||window.event;this.showActive();BX.PreventDefault(e)}),this));BX.bind(this.activeBlock,"click",BX.proxy((function(e){e=e||window.event;this.hideActive();BX.PreventDefault(e)}),this))};window.BXPostFormImportant.prototype.showActive=function(e){BX.hide(this.fireButton);BX.show(this.activeBlock,"inline-block");if(this.hiddenField){this.hiddenField.value=1}return false};window.BXPostFormImportant.prototype.hideActive=function(e){BX.hide(this.activeBlock);BX.show(this.fireButton,"inline-block");if(this.hiddenField){this.hiddenField.value=0}return false};var t=null;window.MPFbuttonShowWait=function(e){if(e&&!BX.type.isElementNode(e)){e=null}e=e||this;e=e?e.tagName=="A"?e:e.parentNode:e;if(e){BX.addClass(e,"ui-btn-clock");t=e;BX.defer((function(){e.disabled=true}))()}};var i={listen:false,plus:false,text:"",bSearch:false,node:null,mode:null};BX.addCustomEvent(window,"onInitialized",(function(e){if(e&&e.eventNode){BX.onCustomEvent(e.eventNode,"OnClickCancel",(function(){i.node=null}))}}));BX.addCustomEvent(window,"BX.MPF.MentionSelector:open",(function(t){var i=BX.Type.isStringFilled(t.formId)?t.formId:"";if(!BX.Type.isStringFilled(i)||BX.Type.isUndefined(e.mentionParams[i])){return}var n=BX.Type.isDomNode(t.bindNode)?t.bindNode:null;var r=BX.type.isNotEmptyObject(t.bindPosition)?t.bindPosition:null;var a=window.MPFgetSelectorId("bx-mention-"+i+"-id")+(n?"-withsearch":"");var o=BX.UI.EntitySelector.Dialog.getById(a);if(!o){window.MPFcreateSelectorDialog({formId:i,selectorId:a,enableSearch:!!n,params:e.mentionParams[i]});o=BX.UI.EntitySelector.Dialog.getById(a)}if(!o){return}o.deselectAll();o.search("");o.show();var s={};if(BX.Type.isDomNode(n)){o.focusSearch();o.popup.setBindElement(n);s.position="top"}else if(BX.type.isNotEmptyObject(r)){r.top-=5;o.popup.setBindElement(r)}o.popup.adjustPosition(s)}));window.onKeyDownHandler=function(e,t,r){var a=e.keyCode;if(!window["BXfpdStopMent"+r]){return true}var o=window.MPFgetSelectorId("bx-mention-"+r+"-id");if(a===t.KEY_CODES["backspace"]&&i.node){var s=BX.util.trim(t.util.GetTextContent(i.node));if(s==="+"||s==="@"||i.mode=="button"&&s.length==1){window["BXfpdStopMent"+r]()}else if(i.mode=="button"&&s.length==1){window["BXfpdStopMent"+r]()}}if(BX.util.in_array(a,[107,187])||(e.shiftKey||e.modifiers>3)&&BX.util.in_array(a,[50,43,61])||e.altKey&&BX.util.in_array(a,[76])||e.altKey&&e.ctrlKey&&BX.util.in_array(a,[81])&&e.key==="@"||e.altKey&&BX.util.in_array(a,[71,81])&&e.key==="@"||e.altKey&&BX.util.in_array(a,[50])&&e.key==="@"||BX.Type.isFunction(e.getModifierState)&&!!e.getModifierState("AltGraph")&&BX.util.in_array(a,[81,50,48])&&!BX.Type.isUndefined(e.key)&&e.key==="@"||BX.util.in_array(a,[192])&&e.key==="@"){setTimeout((function(){var e=t.selection.GetRange();var a=t.GetIframeDoc();var s=e?e.endContainer.textContent:"";var l=s?s.slice(e.endOffset-1,e.endOffset):"";var d=s?s.slice(e.endOffset-2,e.endOffset-1):"";if((l=="@"||l=="+")&&(!d||BX.util.in_array(d,["+","@",",","("])||d.length==1&&BX.util.trim(d)==="")){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=true;i.mode="plus";e.setStart(e.endContainer,e.endOffset-1);e.setEnd(e.endContainer,e.endOffset);t.selection.SetSelection(e);i.node=BX.create("SPAN",{props:{id:"bx-mention-node"}},a);t.selection.Surround(i.node,e);e.setStart(i.node,1);e.setEnd(i.node,1);t.selection.SetSelection(e);if(BX.Type.isStringFilled(o)){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:r,bindPosition:n(i.node,t)}])}}}),10)}if(i.listen){var l=null;var d=BX.Type.isStringFilled(o)?BX.UI.EntitySelector.Dialog.getById(o):null;if(d&&d.getActiveTab()){l=d.getActiveTab().getId()}var c=null;switch(a){case t.KEY_CODES.enter:c="Enter";break;case 9:c="Tab";break;case t.KEY_CODES.up:c="ArrowUp";break;case t.KEY_CODES.down:c="ArrowDown";break;case t.KEY_CODES.left:if(l==="departments"){c="ArrowLeft"}break;case t.KEY_CODES.right:if(l==="departments"){c="ArrowRight"}break}if(c){var u=new KeyboardEvent("keydown",{key:c,keyCode:a,bubbles:true,cancelable:true,view:window});if(!document.dispatchEvent(u)){t.iframeKeyDownPreventDefault=true;e.stopPropagation();e.preventDefault()}}}if(!i.listen&&i.listenFlag&&a===t.KEY_CODES["enter"]){var f=t.selection.GetRange();if(f.collapsed){var p=f.endContainer;var h=t.GetIframeDoc();if(p){if(p.className!=="bxhtmled-metion"){p=BX.findParent(p,(function(e){return e.className=="bxhtmled-metion"}),h.body)}if(p&&p.className=="bxhtmled-metion"){t.selection.SetAfter(p)}}}}};window.onKeyUpHandler=function(e,t,n){var r=e.keyCode;var a;var o;if(!window["BXfpdStopMent"+n]){return true}if(i.listen===true){if(r==t.KEY_CODES.escape){var s=new KeyboardEvent("keyup",{key:"Escape",keyCode:r,bubbles:true,cancelable:true,view:window});if(!document.dispatchEvent(s)){e.stopPropagation();e.preventDefault()}window["BXfpdStopMent"+n]()}else if(r!==t.KEY_CODES.enter&&r!==t.KEY_CODES.left&&r!==t.KEY_CODES.right&&r!==t.KEY_CODES.up&&r!==t.KEY_CODES.down){if(BX(i.node)){o=BX.util.trim(t.util.GetTextContent(i.node));var l=o;o=o.replace(/^[\+@]*/,"");i.bSearch=BX.Type.isStringFilled(o);var d=window.MPFgetSelectorId("bx-mention-"+n+"-id");var c=BX.UI.EntitySelector.Dialog.getById(d);if(BX.Type.isStringFilled(o)&&c){c.search(o)}if(i.leaveContent&&i._lastText){if(l===""){window["BXfpdStopMent"+n]()}else if(l!==""&&o===""){i.bSearch=false;if(c){c.search("")}}}i.lastText=o;i._lastText=l}else{window["BXfpdStopMent"+n]()}}}else{if(!e.shiftKey&&(r===t.KEY_CODES["space"]||r===t.KEY_CODES["escape"]||r===188||r===190)){a=t.selection.GetRange();if(a.collapsed){var u=a.endContainer;var f=t.GetIframeDoc();if(u){if(u.className!=="bxhtmled-metion"){u=BX.findParent(u,(function(e){return e.className=="bxhtmled-metion"}),f.body)}if(u&&u.className=="bxhtmled-metion"){o=t.util.GetTextContent(u);var p=o.match(/[\s\.\,]$/);if(p||r===t.KEY_CODES["escape"]){u.innerHTML=o.replace(/[\s\.\,]$/,"");var h=BX.create("SPAN",{html:p||t.INVISIBLE_SPACE},f);t.util.InsertAfter(h,u);t.selection.SetAfter(h)}}}}}}};window.onTextareaKeyDownHandler=function(e,t,n){var r=e.keyCode;if(i.listen&&r==t.KEY_CODES.enter){t.textareaKeyDownPreventDefault=true;e.stopPropagation();e.preventDefault()}};window.onTextareaKeyUpHandler=function(e,t,n){var r=null;var a="";var o=e.keyCode;var s=window.MPFgetSelectorId("bx-mention-"+n+"-id");if(i.listen===true){if(o==27){window["BXfpdStopMent"+n]()}else if(o!==13){a=t.textareaView.GetValue(false);r=t.textareaView.GetCursorPosition();var l="";var d="";if(a.indexOf("+")!==-1||a.indexOf("@")!==-1){var c=a.substr(0,r);var u=Math.max(c.lastIndexOf("+"),c.lastIndexOf("@"));if(u>=0){l=c.substr(u);d=l;l=l.replace(/^[\+@]*/,"");i.bSearch=BX.Type.isStringFilled(l);var f=BX.UI.EntitySelector.Dialog.getById(s);if(BX.Type.isStringFilled(l)&&f){f.search(l)}}}if(i._lastText){if(d===""){window["BXfpdStopMent"+n]()}else if(d!==""&&l===""){i.bSearch=false;if(f){f.search("")}}}i.lastText=l;i._lastText=d}}else{if(o==16){var p=this;this.shiftPressed=true;if(this.shiftTimeout){this.shiftTimeout=clearTimeout(this.shiftTimeout)}this.shiftTimeout=setTimeout((function(){p.shiftPressed=false}),100)}if(o==107||(e.shiftKey||e.modifiers>3||this.shiftPressed)&&BX.util.in_array(o,[187,50,107,43,61])){r=t.textareaView.element.selectionStart;if(r>0){a=t.textareaView.element.value;var h=a.substr(r-1,1);if(h&&(h==="+"||h==="@")){i.listen=true;i.listenFlag=true;i.text="";i.textarea=true;i.bSearch=false;i.mode="plus";BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:n,bindPosition:BX.pos(document.getElementById("bx-b-mention-"+n))}])}}}}};var n=function(e,t){var i=BX.pos(e);var n=BX.pos(t.dom.areaCont);var r=BX.GetWindowScrollPos(t.GetIframeDoc());var a=n.top+i.bottom-r.scrollTop+2;var o=n.left+i.right-r.scrollLeft;return{top:a,left:o}};window.BxInsertMention=function(e){var t=e.item;var r=e.type;var a=e.formID;var o=e.editorId;var s=e.bNeedComa;var l=LHEPostForm.getEditor(o);var d;if((r==="user"||r==="project"||r==="department")&&t&&t.entityId>0&&l){if(l.GetViewMode()=="wysiwyg"){var c=l.GetIframeDoc();var u=l.selection.GetRange();var f=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(t.name)},c);d=BX.create("SPAN",{html:s?",&nbsp;":"&nbsp;"},c);var p={tag:"postuser",params:{value:t.entityId}};switch(r){case"project":p.projectId=t.entityId;p.projectName=t.name;break;case"department":p.departmentId=t.entityId;p.departmentName=t.name;break;default:p.userId=t.entityId;p.userName=t.name}l.SetBxTag(f,p);if(BX(i.node)&&i.node.parentNode){l.util.ReplaceNode(i.node,f)}else{l.selection.InsertNode(f,u)}if(f&&f.parentNode){var h=BX.findParent(f,{className:"bxhtmled-metion"},c.body);if(h){l.util.InsertAfter(f,h)}}if(f&&f.parentNode){l.util.InsertAfter(d,f);l.selection.SetAfter(d)}}else if(l.GetViewMode()=="code"&&l.bbCode){l.textareaView.Focus();var b=l.textareaView.GetValue(false);var m=l.textareaView.GetCursorPosition();var v=b.substr(0,m);var E=Math.max(v.lastIndexOf("+"),v.lastIndexOf("@"));if(E>=0&&m>E){l.textareaView.SetValue(b.substr(0,E)+b.substr(m));l.textareaView.element.setSelectionRange(E,E)}var g="";switch(r){case"user":g="USER";break;case"project":g="PROJECT";break;case"department":g="DEPARTMENT";break;default:}l.textareaView.WrapWith(false,false,"["+g+"="+t.entityId+"]"+t.name+"[/"+g+"]"+(s?", ":" "))}if(e.fireAddEvent===true){BX.onCustomEvent(window,"onMentionAdd",[t,r])}if(window["BXfpdStopMent"+a]){window["BXfpdStopMent"+a]()}i["text"]="";if(l.GetViewMode()=="wysiwyg"){l.Focus();l.selection.SetAfter(d)}var y=LHEPostForm.getHandler(o);if(y&&y.formEntityType==="task"&&y.editorParams.tasksLimitExceeded){BX.Main.PostFormTasksLimit.showPopup({bindPosition:n(i.node,l)})}}};window.MPFgetSelectorId=function(e){var t=false;var i=BX(e);if(!i){return t}t=i.getAttribute("data-bx-selector-id");return t};window.MPFcreateSelectorDialog=function(e){new BX.UI.EntitySelector.Dialog({targetNode:"mpf-mention-"+e.formId,id:e.selectorId,context:"MENTION",multiple:false,enableSearch:e.enableSearch,clearSearchOnSelect:true,hideOnSelect:true,hideByEsc:true,entities:e.params.entities,height:300,width:400,compactView:true,events:{onShow:function(){window.BXfpdOnDialogOpen()},onHide:function(){window.BXfpdOnDialogClose({editorId:e.params.editorId})},"Item:onSelect":function(t){var i=t.getData().item;if(i){window["BXfpdSelectCallbackMent"+e.formId]({item:{name:i.getTitle(),entityId:i.getId()},entityType:i.getEntityId()})}}}})};window.MPFMentionInit=function(t,n){e.mentionParams[t]=n;if(n.initDestination===true){BX.addCustomEvent("onAutoSaveRestoreDestination",(function(e){if(BX.type.isNotEmptyObject(e)&&BX.type.isNotEmptyObject(e.data)&&BX.type.isNotEmptyString(e.data.DEST_DATA)&&BX.type.isNotEmptyString(e.formId)&&e.formId==t&&BX.UI.EntitySelector){var i=JSON.parse(e.data.DEST_DATA);if(!Array.isArray(i)){return}var n=BX.UI.EntitySelector.Dialog.getById("oPostFormLHE_blogPostForm");if(!BX.type.isNotEmptyObject(n)){return}n.preselectedItems=i;n.setPreselectedItems(i)}}));BX.addCustomEvent(window,"onMentionAdd",(function(e,t){var i=BX.UI.EntitySelector.Dialog.getById("oPostFormLHE_blogPostForm");if(!BX.type.isNotEmptyObject(i)){return}var n="";if(t==="user"){if(e.isExtranet==="Y"){n="extranet"}else if(e.isEmail==="Y"){n="email"}else{n="employee"}}else if(t==="project"){if(e.isExtranet==="Y"){n="extranet"}}i.addItem({avatar:e.avatar,customData:{email:BX.Type.isStringFilled(e.email)?e.email:""},entityId:t,entityType:n,id:e.entityId,title:e.name}).select()}))}window["BXfpdSelectCallbackMent"+t]=function(e){window.BxInsertMention({item:e.item,type:e.entityType.toLowerCase(),formID:t,editorId:n.editorId,fireAddEvent:n.initDestination})};window["BXfpdStopMent"+t]=function(){var e=window.MPFgetSelectorId("bx-mention-"+t+"-id");var i=BX.UI.EntitySelector.Dialog.getById(e);if(i){i.hide()}};if(BX(t)){BX.addCustomEvent(BX(t),"OnUCFormAfterShow",(function(e){if(!BX.type.isNotEmptyObject(e)||!BX.type.isArray(e.id)||!BX.Type.isStringFilled(e.id[0])){return}var t=new RegExp("EVENT_(\\d+)","i");if(!t.test(e.id[0])){return}}))}var r=LHEPostForm.getHandlerByFormId(t);if(r){r.exec()}BX.ready((function(){var e=BX("bx-b-mention-"+t);BX.bind(e,"click",(function(r){if(i.listen!==true){var a=LHEPostForm.getEditor(n.editorId);var o=a.GetIframeDoc();if(a.GetViewMode()=="wysiwyg"&&o){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=false;i.mode="button";var s=a.selection.GetRange();if(BX(i.node)){BX.remove(BX(i.node))}a.InsertHtml('<span id="bx-mention-node">'+a.INVISIBLE_SPACE+"</span>",s);setTimeout((function(){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:t,bindNode:e}]);i.node=o.getElementById("bx-mention-node");if(i.node){s.setStart(i.node,0);if(i.node.firstChild&&i.node.firstChild.nodeType==3&&i.node.firstChild.nodeValue.length>0){s.setEnd(i.node,1)}else{s.setEnd(i.node,0)}a.selection.SetSelection(s)}a.Focus()}),100)}else if(a.GetViewMode()=="code"){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=false;i.mode="button";setTimeout((function(){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:t,bindNode:e}])}),100)}BX.onCustomEvent(e,"mentionClick")}}))}))};window.BXfpdOnDialogOpen=function(){i.listen=true;i.listenFlag=true};window.BXfpdOnDialogClose=function(e){i.listen=false;setTimeout((function(){i.listenFlag=false;if(!i.listen){var t=LHEPostForm.getEditor(e.editorId);if(t){t.Focus()}}}),100)};MPFEntitySelector=function(t){this.selector=null;this.inputNode=null;this.messages={};if(!BX.Type.isStringFilled(t.id)){return null}if(e.selector[t.id]){return e.selector[t.id]}e.selector[t.id]=this.init(t)};MPFEntitySelector.prototype.init=function(e){if(!BX.type.isPlainObject(e)){e={}}if(!BX.Type.isStringFilled(e.id)||!BX.Type.isStringFilled(e.tagNodeId)||!BX(e.tagNodeId)){return null}if(BX.Type.isStringFilled(e.inputNodeId)&&BX(e.inputNodeId)){this.inputNode=BX(e.inputNodeId)}if(BX.type.isNotEmptyObject(e.messages)){this.messages=e.messages}this.selector=new BX.UI.EntitySelector.TagSelector({id:e.id,dialogOptions:{id:e.id,context:BX.Type.isStringFilled(e.context)?e.context:null,preselectedItems:BX.type.isArray(e.preselectedItems)?e.preselectedItems:[],events:{"Item:onSelect":function(){this.recalcValue(this.selector.getDialog().getSelectedItems())}.bind(this),"Item:onDeselect":function(){this.recalcValue(this.selector.getDialog().getSelectedItems())}.bind(this)},entities:[{id:"meta-user",options:{"all-users":{title:this.messages.allUsersTitle,allowView:BX.type.isBoolean(e.allowToAll)&&e.allowToAll}}},{id:"user",options:{emailUsers:BX.type.isBoolean(e.allowSearchEmailUsers)?e.allowSearchEmailUsers:false,inviteGuestLink:BX.type.isBoolean(e.allowSearchEmailUsers)?e.allowSearchEmailUsers:false,myEmailUsers:true}},{id:"project",options:{features:{blog:["premoderate_post","moderate_post","write_post","full_post"]}}},{id:"department",options:{selectMode:"usersAndDepartments",allowFlatDepartments:false}}]},addButtonCaption:BX.message("BX_FPD_LINK_1"),addButtonCaptionMore:BX.message("BX_FPD_LINK_2")});this.selector.renderTo(document.getElementById(e.tagNodeId));return this.selector};MPFEntitySelector.prototype.recalcValue=function(e){if(!BX.type.isArray(e)||!this.inputNode){return}var t=[];e.forEach((function(e){t.push([e.entityId,e.id])}));this.inputNode.value=JSON.stringify(t)};window.MPFEntitySelector=MPFEntitySelector})()})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:71:"/bitrix/components/bitrix/system.field.edit/script.min.js?1699257951814";s:6:"source";s:53:"/bitrix/components/bitrix/system.field.edit/script.js";s:3:"min";s:57:"/bitrix/components/bitrix/system.field.edit/script.min.js";s:3:"map";s:57:"/bitrix/components/bitrix/system.field.edit/script.map.js";}"*/
function addElement(e,n){if(document.getElementById("main_"+e)){var d=document.getElementById("main_"+e).getElementsByTagName("div");if(d&&d.length>0&&d[0]){var t=d[0].parentNode;t.appendChild(d[d.length-1].cloneNode(true))}}}function addElementFile(e,n){var d=document.getElementById("main_"+e);var t=document.getElementById("main_add_"+e);if(d&&t){t=t.cloneNode(true);t.id="";t.style.display="";d.appendChild(t)}}function addElementDate(e,n){var d=document.getElementById("date_container_"+n);var t=document.getElementById("hidden_"+n).innerHTML;if(d&&t){var a=e[n].fieldName;var i=e[n].index;t=t.replace(/[#]FIELD_NAME[#]/g,a+"["+i+"]");t=t.replace(/[\%]23FIELD_NAME[\%]23/g,escape(a+"["+i+"]"));var l=d.appendChild(document.createElement("DIV"));l.innerHTML+=t;e[n].index++}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?169925797466406";s:6:"source";s:67:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.js";s:3:"min";s:71:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js";s:3:"map";s:71:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.map.js";}"*/
this.BX=this.BX||{};this.BX.Disk=this.BX.Disk||{};(function(e,t,i,n,a,r,s){"use strict";var o=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"set",value:function t(i){for(var n in i){if(e.hasOwnProperty(n)){e[n]=i[n]}}}},{key:"getDocumentHandlers",value:function t(){if(!e.documentHandlers){return[]}return e.documentHandlers}},{key:"getDocumentHandler",value:function t(i){if(!e.documentHandlers){return{}}var n=e.documentHandlers.find((function(e){return e.code===i}));return n||{}}}]);return e}();babelHelpers.defineProperty(o,"urlUpload",null);babelHelpers.defineProperty(o,"documentHandlers",null);babelHelpers.defineProperty(o,"previewSize",{width:115,height:115});var l;var c=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.id=t;this.object=i;this.data={NAME:i.name};s.EventEmitter.subscribe(this.object,"onUploadProgress",this.onUploadProgress.bind(this));s.EventEmitter.subscribe(this.object,"onUploadDone",this.onUploadDone.bind(this));s.EventEmitter.subscribe(this.object,"onUploadError",this.onUploadError.bind(this));this.progress=new BX.UI.ProgressRound({width:18,colorTrack:"rgba(255,255,255,.3)",colorBar:"#fff",lineSize:3,statusType:BX.UI.ProgressRound.Status.INCIRCLE,textBefore:"<i></i>",textAfter:this.object.size})}babelHelpers.createClass(e,[{key:"getContainer",value:function e(){if(!this.container){var t=this.object.name.split(".").pop().toLowerCase();t=r.Text.encode(t===this.object.name?"":t);this.container=r.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-file disk-file-thumb--',' disk-file-thumb--active">\n\t\t\t<div class="ui-icon ui-icon-file-',' disk-file-thumb-icon"><i></i></div>\n\t\t\t<div class="disk-file-thumb-text">','</div>\n\t\t\t<div class="disk-file-thumb-loader">\n\t\t\t\t','\n\t\t\t\t<div class="disk-file-thumb-loader-btn" onclick="','"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t'])),t,t,r.Text.encode(this.object.name),this.progress.getContainer(),this.onClickDelete.bind(this))}return this.container}},{key:"onClickDelete",value:function e(t){var i=this;t.preventDefault();t.stopPropagation();s.EventEmitter.emit(this,"onDelete",[this]);setTimeout((function(){i.object.deleteFile()}),400);delete this.container}},{key:"onUploadProgress",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,2),n=i[0],a=i[1];a=Math.min(Math.max(this.progress.getValue(),a),98);this.progress.update(a)}},{key:"onUploadDone",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,2),n=i[0],a=i[1].file;s.EventEmitter.emit(this,"onUploadDone",[a,n.file]);delete this.object.hash;this.object.deleteFile()}},{key:"onUploadError",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,1),n=i[0];s.EventEmitter.emit(this,"onUploadError",[n.file]);this.progress.setTextBefore(r.Loc.getMessage("WDUF_ITEM_ERROR"));this.container.classList.add("disk-file-upload-error");this.object.deleteFile()}}]);return e}();function u(e,t,i){d(e,t);t.set(e,i)}function d(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function h(e,t,i){b(e,t);p(i,"get");return f(e,i)}function p(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function b(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function f(e,t){if(t.get){return t.get.call(e)}return t.value}var m=new WeakMap;var v=function(){function e(t){var i=t.id,n=t.container,a=t.dropZone,r=t.input;babelHelpers.classCallCheck(this,e);u(this,m,{writable:true,value:0});this.container=n;this.agent=BX.Uploader.getInstance({id:i,allowUpload:"A",uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:o.urlUpload,showImage:false,sortItems:false,dropZone:a,input:r,pasteFileHashInForm:false});s.EventEmitter.subscribe(this.agent,"onFileIsCreated",this.catchFile.bind(this));s.EventEmitter.subscribe(this.agent,"onPackageIsInitialized",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];var n={width:o.previewSize.width,height:o.previewSize.height,exact:"N"};if(i.data){i.data["previewParams"]=n}else{i.post.data["previewParams"]=n}}))}babelHelpers.createClass(e,[{key:"catchFile",value:function t(i){var n=this;var a=babelHelpers.slicedToArray(i.compatData,2),r=a[0],o=a[1];this.incrementItemsCount();var l=new c(r,o);s.EventEmitter.subscribe(l,"onUploadDone",(function(t){var i=babelHelpers.slicedToArray(t.data,2),a=i[0],r=i[1];if(!l[h(n.constructor,e,g)]){n.decrementItemsCount();s.EventEmitter.emit(n,"onUploadDone",{itemData:n.convertToItemSavedType(a),itemContainer:l.getContainer(),blob:r})}}));s.EventEmitter.subscribe(l,"onUploadError",(function(t){var i=babelHelpers.slicedToArray(t.data,1),a=i[0];n.decrementItemsCount();l[h(n.constructor,e,g)]=true;s.EventEmitter.emit(n,"onUploadError",{itemContainer:l.getContainer(),blob:a})}));s.EventEmitter.subscribe(l,"onDelete",(function(){n.decrementItemsCount();l[h(n.constructor,e,g)]=true;n.container.removeChild(l.getContainer())}));this.container.appendChild(l.getContainer())}},{key:"addTestThumb",value:function e(t){var i=this;var n=new c(Math.ceil(Math.random()*1e3),{name:"test.file.js",size:"348 Kb",deleteFile:function e(){}});this.container.appendChild(n.getContainer());if(t>0){n.onUploadProgress({compatData:[null,t]})}s.EventEmitter.subscribe(n,"onDelete",(function(){i.container.removeChild(n.getContainer())}))}},{key:"addTestErrorThumb",value:function e(){var t=this;var i=new c(Math.ceil(Math.random()*1e3),{name:"test.file.js",size:"348 Kb",deleteFile:function e(){}});this.container.appendChild(i.getContainer());i.onUploadError({compatData:[{file:null}]});s.EventEmitter.subscribe(i,"onDelete",(function(){t.container.removeChild(i.getContainer())}))}},{key:"upload",value:function e(t){var i=babelHelpers.toArray(t),n=i.slice(0);this.agent.onAttach(n)}},{key:"convertToItemSavedType",value:function e(t){return{ID:t.attachId,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:false,CAN_RESTORE:false,CAN_UPDATE:t.canChangeName,CAN_RENAME:t.canChangeName,CAN_MOVE:t.canChangeName,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:t.previewUrl?t.previewUrl:"",BIG_PREVIEW_URL:t.previewUrl?t.previewUrl.replace(/\&(width|height)=\d+/gi,""):null,EXTENSION:t.ext,NAME:t.name,SIZE:t.size,SIZE_BYTES:t.sizeInt,STORAGE:t.storage,TYPE_FILE:t.fileType}}},{key:"incrementItemsCount",value:function e(){var t;if(babelHelpers.classPrivateFieldGet(this,m)<=0){s.EventEmitter.emit(this,"onUploadIsStart")}babelHelpers.classPrivateFieldSet(this,m,(t=+babelHelpers.classPrivateFieldGet(this,m))+1),t}},{key:"decrementItemsCount",value:function e(){var t;if(babelHelpers.classPrivateFieldGet(this,m)===1){s.EventEmitter.emit(this,"onUploadIsDone")}babelHelpers.classPrivateFieldSet(this,m,Math.max((babelHelpers.classPrivateFieldSet(this,m,(t=+babelHelpers.classPrivateFieldGet(this,m))-1),t),0))}}]);return e}();var g={writable:true,value:Symbol("deleted")};var E=function(){function e(t){var i=t.container,n=t.eventObject;babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"hasContainer",false);babelHelpers.defineProperty(this,"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(this,"properties",{pluggedIn:false});this.container=i;this.eventObject=n;this.properties.pluggedIn=this.eventObject&&this.eventObject.dataset.bxHtmlEditable==="Y";if(!this.container){return}this.hasContainer=true}babelHelpers.createClass(e,[{key:"isRelevant",value:function e(){return this.hasContainer}},{key:"getEventObject",value:function e(){return this.eventObject}},{key:"getContainer",value:function e(){return this.container}},{key:"isPluggedIn",value:function e(){return this.properties.pluggedIn}},{key:"show",value:function e(){this.container.style.display="";delete this.container.style.display}},{key:"hide",value:function e(){this.container.style.display="none"}}]);return e}();var D;var I=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"hiddenFilesCount",0);babelHelpers.defineProperty(this,"stepNumber",0);babelHelpers.defineProperty(this,"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(this,"stepValue",5)}babelHelpers.createClass(e,[{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){return r.Tag.render(D||(D=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-file" onclick="','">\n\t\t\t<div class="ui-icon ui-icon-more disk-file-thumb-icon">\n\t\t\t\t<i></i>\n\t\t\t</div>\n\t\t\t<div class="disk-file-thumb-text">',"</div>\n\t\t</div>"])),t.onClick.bind(t),t.getValueContainer())}))}},{key:"getValueContainer",value:function e(){return this.cache.remember("valueContainer",(function(){return document.createElement("DIV")}))}},{key:"reset",value:function e(){this.hiddenFilesCount=1;this.stepNumber=0;this.getValueContainer().innerHTML=this.hiddenFilesCount;this.show();return this}},{key:"increment",value:function e(){this.hiddenFilesCount++;this.getValueContainer().innerHTML=this.hiddenFilesCount;this.show()}},{key:"decrement",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;this.hiddenFilesCount-=t;this.getValueContainer().innerHTML=this.hiddenFilesCount;if(this.hiddenFilesCount<=0){this.hide()}}},{key:"onClick",value:function e(){this.stepNumber++;var t=Math.min(30,this.stepValue*this.stepNumber);this.decrement(t);s.EventEmitter.emit(this,"onGetMore",{itemsCount:t})}},{key:"show",value:function e(){delete this.getContainer().style.display}},{key:"hide",value:function e(){this.getContainer().style.display="none"}}]);return e}();var k=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"getSelectedFile",value:function e(t,i,n){var a=this;return new Promise((function(e){r.ajax.get(r.Uri.addParam(a.urlSelect,{ACTION:"none",MULTI:"Y",ID:["E",t].join(""),NAME:i,wish:"fakemove",dialogName:n}),e)}))}},{key:"loadFolder",value:function e(t,i,n){var a=t;var s=r.Uri.addParam([BX.DiskFileDialog.obCurrentTab[n].link.replace("/index.php","").replace("/files/lib/","/files/"),"element/upload",a].join("/"),{use_light_view:"Y",AJAX_CALL:"Y",SIMPLE_UPLOAD:"Y",IFRAME:"Y",sessid:BX.bitrix_sessid(),SECTION_ID:a,CHECK_NAME:i});return new Promise((function(e){r.ajax.loadJSON(s,{},e)}))}},{key:"getSelectedData",value:function e(t){var i=this;return new Promise((function(e){r.ajax.get(r.Uri.addParam(i.urlSelect,{dialogName:t}),e)}))}},{key:"getSelectedCloudData",value:function e(t,i){var n=this;return new Promise((function(e){r.ajax.get(r.Uri.addParam(n.urlSelect,{cloudImport:1,service:i,dialogName:t}),e)}))}},{key:"moveFile",value:function e(t,i){return new Promise((function(e){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","moveUploadedFile"),data:{attachedId:t,targetFolderId:i},onsuccess:e})}))}},{key:"getMetaDataForCreatedFileInUf",value:function e(t){return r.ajax.runAction("disk.api.file.getMetaDataForCreatedFileInUf",{data:{id:t}})}},{key:"renameAction",value:function e(t,i){return new Promise((function(e){r.ajax.post("/bitrix/tools/disk/uf.php?action=renameFile",{newName:i,attachedId:t,sessid:r.Loc.getMessage("bitrix_sessid")},e)}))}},{key:"deleteAction",value:function e(t){return new Promise((function(e){r.ajax.post("/bitrix/tools/disk/uf.php?action=deleteFile",{attachedId:t,sessid:r.Loc.getMessage("bitrix_sessid")},e)}))}}]);return e}();babelHelpers.defineProperty(k,"urlSelect","/bitrix/tools/disk/uf.php?action=selectFile&SITE_ID="+r.Loc.getMessage("SITE_ID")+"&dialog2=Y&ACTION=SELECT&MULTI=Y");var C,y,T,S,_,w,F;function A(e,t){U(e,t);t.add(e)}function L(e,t,i){U(e,t);t.set(e,i)}function U(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function N(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var H=new WeakMap;var x=new WeakSet;var O=new WeakSet;var P=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));A(babelHelpers.assertThisInitialized(i),O);A(babelHelpers.assertThisInitialized(i),x);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"properties",{pluggedIn:false,insertedInText:false});L(babelHelpers.assertThisInitialized(i),H,{writable:true,value:void 0});i.setEventNamespace("Disk:UF:");i.id=String(e["ID"]);i.setData(e);i.subscribe("onMoved",i.onMoved.bind(babelHelpers.assertThisInitialized(i)));return i}babelHelpers.createClass(t,[{key:"getId",value:function e(){return this.id}},{key:"getFileId",value:function e(){return this.data.FILE_ID}},{key:"getData",value:function e(t){if(t){return this.data[t]}return this.data}},{key:"getAllIds",value:function e(){return[this.getId(),["n",this.data.FILE_ID].join("")]}},{key:"setData",value:function e(t){this.data=t}},{key:"setPluggedIn",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.properties.pluggedIn=t===true}},{key:"isPluggedIn",value:function e(){return this.properties.pluggedIn}},{key:"setInsertedInText",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.properties.insertedInText=t===true;r.Dom.addClass(this.getContainer(),"--edit-text-preview")}},{key:"isInsertedInText",value:function e(){return this.properties.insertedInText}},{key:"getNameWithoutExtension",value:function e(){var t=this.data["NAME"].split(".");if(t.length>1){t.pop()}var i=t.join(".");if(i.length>50){return i.substr(0,39)+"..."+i.substr(-5)}return i}},{key:"getButtonBox",value:function e(){var t="";if(this.isPluggedIn()){t=r.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="disk-file-thumb-btn-text-copy"\n\t\t\t\t\tonclick="','"\n\t\t\t\t\tonmouseenter="','"\n\t\t\t\t\tonmouseleave="','"\n\t\t\t\t>\n\t\t\t\t</div>'])),this.onClickInsertInText.bind(this),N(this,x,M).bind(this),N(this,O,R).bind(this))}return r.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="disk-file-thumb-btn-box">\n\t\t\t\t','\n\t\t\t\t<div class="disk-file-thumb-btn-more" data-bx-role="more" onclick="','"></div>\n\t\t\t</div>\n\t\t'])),t,this.onClickMore.bind(this))}},{key:"getDeleteButton",value:function e(){return r.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="disk-file-thumb-btn-close-box">\n\t\t\t\t<div class="disk-file-thumb-btn-close" onclick="','"></div>\n\t\t\t</div>\n\t\t'])),this.onClickDelete.bind(this))}},{key:"getNameBox",value:function e(t,i){var n="";if(i){n=r.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<span class="disk-file-thumb-file-extension">.',"</span>"])),i)}return r.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="disk-file-thumb-text-box">\n\t\t\t\t<div data-bx-role="name" class="disk-file-thumb-text">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),t,n)}},{key:"getIcon",value:function e(t){return r.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div data-bx-role="icon" class="ui-icon ui-icon-file-',' disk-file-thumb-icon"><i></i></div>\n\t\t'])),t)}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){var e=r.Text.encode(t.getNameWithoutExtension());var i=r.Text.encode(t.data["EXTENSION"]).toLowerCase();switch(i){case"pptx":i="ppt";break}return r.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-file disk-file-thumb--','">\n\t\t\t',"\n\t\t\t","\n\t\t\t","\n\t\t\t","\n\t\t</div>"])),i,t.getIcon(i),t.getNameBox(e,i),t.getDeleteButton(),t.getButtonBox())}))}},{key:"rename",value:function e(t){this.data["NAME"]=t;if(this.hasContainer()){this.getContainer().querySelector('[data-bx-role="name"]').innerHTML=r.Text.encode(this.data["NAME"])}}},{key:"destroy",value:function e(){var t=this;var i=this.cache.keys();i.forEach((function(e){var i=t.cache.get(e);if(r.Type.isDomNode(i)&&i.parentNode){i.parentNode.removeChild(i)}t.cache["delete"](e)}));this.emit("onDestroy")}},{key:"hasContainer",value:function e(){return this.cache.has("container")}},{key:"getMenu",value:function e(){var t=this;var n=this.getData("NAME").split(".").pop();n=n===this.getData("NAME")?"":[".",n].join("");var a=String(this.getData("NAME"));var s=a.substring(0,a.length-n.length);return this.cache.remember("menu",(function(){var e=t.getContainer().querySelector("div[data-bx-role='more']");var a=new i.Menu({id:"crm-tunnels-menu-".concat(r.Text.getRandom().toLowerCase()),bindElement:e,items:[t.isPluggedIn()?{dataset:{bxRole:"insertIntoTheText"},text:r.Loc.getMessage("WDUF_ITEM_MENU_INSERT_INTO_THE_TEXT"),onclick:function e(i,n){a.close();t.onClickInsertInText(i)}}:null,{dataset:{bxRole:"deleteFile"},text:r.Loc.getMessage("WDUF_ITEM_MENU_DELETE"),onclick:function e(i){a.close();t.onClickDelete(i)}},t.data["CAN_RENAME"]===true?{dataset:{bxRole:"renameFile"},text:r.Loc.getMessage("WDUF_ITEM_MENU_RENAME"),items:[{html:['<textarea class="disk-file-popup-rename-file-textarea"\n\t\t\t\t\t\t\t\t\t\t\tname="rename" onkeydown="if(event.keyCode===13){ BX.fireEvent(event.target.parentNode.querySelector(\'input[name=save]\'), \'click\'); }"\n\t\t\t\t\t\t\t\t\t\t\tplaceholder="'.concat(r.Text.encode(s),'">').concat(r.Text.encode(s),"</textarea>"),'<div class="ui-btn-container ui-btn-container-center">\n\t\t\t\t\t\t\t\t\t\t\t<input type="button" class="ui-btn ui-btn-sm ui-btn-primary" name="save" value="'.concat(r.Loc.getMessage("WDUF_ITEM_MENU_RENAME_SAVE"),'">\n\t\t\t\t\t\t\t\t\t\t\t<input type="button" class="ui-btn ui-btn-sm ui-btn-link" value="').concat(r.Loc.getMessage("WDUF_ITEM_MENU_RENAME_CANCEL"),'">\n\t\t\t\t\t\t\t\t\t\t</div>')].join(""),className:"menu-popup-item-rename-form",onclick:function e(i,s){if(r.Type.isDomNode(i.target)&&i.target.type==="button"){if(i.target.name==="save"){t.onRenamed([s.getContainer().querySelector("textarea").value,n].join(""));t.clearMenu()}a.close()}}}]}:null,{delimiter:true,text:[r.Loc.getMessage("WDUF_ITEM_MENU_FILE"),r.Text.encode(t.data["SIZE"])].join(" ")},t.data["CAN_MOVE"]===true?{dataset:{bxRole:"moveFile"},text:r.Text.encode(t.data["STORAGE"]),className:"menu-popup-item-storage",onclick:function e(i,n){var r;i["counter"]=((r=i["counter"])!==null&&r!==void 0?r:1)+1;a.close();t.onClickMoveTo(i,n)}}:{text:r.Text.encode(t.data["STORAGE"]),className:"menu-popup-item-storage"}].filter((function(e){return e!==null})),angle:true,offsetLeft:9});return a}))}},{key:"clearMenu",value:function e(){if(this.cache.has("menu")){this.cache.get("menu").destroy();this.cache["delete"]("menu")}}},{key:"onClick",value:function e(t){this.emit("onClick")}},{key:"onClickDelete",value:function e(t){t.preventDefault();t.stopPropagation();this.emit("onDelete");this.destroy();k.deleteAction(this.getId())}},{key:"onClickInsertInText",value:function e(t){this.emit("onClickInsertInText")}},{key:"onClickMore",value:function e(t){t.preventDefault();t.stopPropagation();this.getMenu().show()}},{key:"onClickEdit",value:function e(){}},{key:"onClickMoveTo",value:function e(t,i,n){var a=s.EventEmitter.emit(BX.DiskFileDialog,"onFileNeedsToMove",[this]);return a.length>0}},{key:"onMoved",value:function e(t){var i=t.data;this.data["STORAGE"]=i;this.clearMenu()}},{key:"onRenamed",value:function e(t){if(this.getData("NAME")===t){return}this.rename(t);k.renameAction(this.getId(),t)}},{key:"getHTMLForHTMLEditor",value:function e(t){if(this.getData("TYPE_FILE")==="player"){return'<img contenteditable="false" class="bxhtmled-player-surrogate" data-bx-file-id="'.concat(r.Text.encode(this.data.ID),'" id="').concat(t,'" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" />')}return'<span contenteditable="false" data-bx-file-id="'.concat(r.Text.encode(this.data.ID),'" id="').concat(t,'" style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;">').concat(r.Text.encode(this.data.NAME),"</span>")}}],[{key:"detect",value:function e(){return true}}]);return t}(s.EventEmitter);function M(e){var t=this;if(babelHelpers.classPrivateFieldGet(this,H)){return}var i=e.currentTarget;var n=i.offsetWidth;babelHelpers.classPrivateFieldSet(this,H,new BX.PopupWindow({content:r.Loc.getMessage("WDUF_ITEM_MENU_INSERT_INTO_THE_TEXT"),cacheable:false,animation:"fading-slide",bindElement:i,offsetTop:0,bindOptions:{position:"top"},darkMode:true,events:{onClose:function e(){babelHelpers.classPrivateFieldGet(t,H).destroy();babelHelpers.classPrivateFieldSet(t,H,null)},onShow:function e(t){var i=t.getTarget();i.getPopupContainer().style.display="block";var a=n/2-i.getPopupContainer().offsetWidth/2;i.setOffset({offsetLeft:a+40});i.setAngle({offset:i.getPopupContainer().offsetWidth/2-17})}}}));babelHelpers.classPrivateFieldGet(this,H).show()}function R(e){if(!babelHelpers.classPrivateFieldGet(this,H)){return}babelHelpers.classPrivateFieldGet(this,H).close();babelHelpers.classPrivateFieldSet(this,H,null)}var B;var j=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++){a[s]=arguments[s]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"cache",new r.Cache.MemoryCache);return i}babelHelpers.createClass(t,[{key:"setData",value:function e(t){this.data=t;this.data.BIG_REVIEW_URL=this.data.PREVIEW_URL.replace(/\&(width|height)\=\d+/gi,"")}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){var e=r.Text.encode(t.getNameWithoutExtension());var i=r.Text.encode(t.data["EXTENSION"]).toLowerCase();return r.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-preview">\n\t\t\t<div style="background-image: url(\'','\'); background-size: cover;" class="disk-file-thumb-image"></div>\n\t\t\t',"\n\t\t\t","\n\t\t\t","\n\t\t\t","\n\t\t</div>"])),encodeURI(t.data["PREVIEW_URL"]),t.getIcon(i),t.getNameBox(e,i),t.getDeleteButton(),t.getButtonBox())}))}},{key:"getHTMLForHTMLEditor",value:function e(t){return'<img style="max-width: 90%;" data-bx-file-id="'.concat(r.Text.encode(this.data.ID),'" id="').concat(t,'" src="').concat(this.data.BIG_REVIEW_URL,'" />')}}],[{key:"detect",value:function e(t){return!!t["PREVIEW_URL"]}}]);return t}(P);function X(e,t){W(e,t);t.add(e)}function W(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function V(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var G=0;var z=new WeakSet;var Y=function(){function e(t){babelHelpers.classCallCheck(this,e);X(this,z);babelHelpers.defineProperty(this,"tag","[DISK FILE ID=#id#]");babelHelpers.defineProperty(this,"regexp",/\[(?:DOCUMENT ID|DISK FILE ID)=([n0-9]+)\]/gi);this.id=["diskfile"+G++].join("_");this.items=t.items}babelHelpers.createClass(e,[{key:"getInterface",value:function e(){var t=this;return{id:this.id,init:function e(i){t.htmlEditor=i},parse:this.parse.bind(this),unparse:this.unparse.bind(this)}}},{key:"hasInterface",value:function e(){return this.regexp!==null&&this.tag!==null}},{key:"setParams",value:function e(t){var i=t.tag,n=t.regexp;if(r.Type.isStringFilled(i)&&i!=="null"){this.tag=i}else{this.tag=null}if(r.Type.isStringFilled(n)&&n!=="null"){this.regexp=new RegExp(n)}else if(n instanceof RegExp){this.regexp=n}else{this.regexp=null}}},{key:"insertFile",value:function e(t){var i=this.items.get(String(t));if(i){var n=i instanceof j?"\n":" ";var a=i instanceof j?"<br>":"&nbsp;";s.EventEmitter.emit(this.htmlEditor,"OnInsertContent",[n+this.getItemBBCode(t)+n,a+this.getItemHTML(t)+a])}}},{key:"getItemBBCode",value:function e(t){var i=this.items.get(String(t));if(i&&i.isPluggedIn()){i.setInsertedInText()}return this.tag.replace("#id#",t)}},{key:"getItemHTML",value:function e(t){var i=this.items.get(String(t));if(i){return V(this,z,K).call(this,i,t)}return null}},{key:"deleteFile",value:function e(t){if(!this.items.has(t)){return}var i=this.items.get(t).getAllIds();if(this.htmlEditor.GetViewMode()==="wysiwyg"){var n=this.htmlEditor.GetIframeDoc();for(var a in this.htmlEditor.bxTags){if(this.htmlEditor.bxTags.hasOwnProperty(a)&&babelHelpers["typeof"](this.htmlEditor.bxTags[a])==="object"&&this.htmlEditor.bxTags[a]["tag"]===this.id&&i.indexOf(String(this.htmlEditor.bxTags[a]["itemId"]))>=0&&n.getElementById(a)){var r=n.getElementById(a);r.parentNode.removeChild(r)}}this.htmlEditor.SaveContent()}else{var s=this.htmlEditor.GetContent().replace(this.regexp,(function(e,t){return i.indexOf(t)>=0?"":e}));this.htmlEditor.SetContent(s);this.htmlEditor.Focus()}}},{key:"parse",value:function e(t){if(!this.regexp.test(t)){return t}t=t.replace(this.regexp,function(e,t){var i=this.items.has(t)?this.items.get(t):babelHelpers.toConsumableArray(this.items.values()).find((function(e){return e.getAllIds().indexOf(t)>=0}));if(i){return V(this,z,K).call(this,i,t)}return e}.bind(this));return t}},{key:"unparse",value:function e(t,i){var n=i.node;var a=t.itemId;if(this.items.has(a)){return this.getItemBBCode(a)}return""}}]);return e}();function K(e,t){if(e.isPluggedIn()){e.setInsertedInText()}return e.getHTMLForHTMLEditor(this.htmlEditor.SetBxTag(false,{tag:this.id,fileId:t,itemId:e.getId()}))}var q=[P,j];function Z(e){var t=P;q.forEach((function(i){if(i.detect(e)){t=i}}));return new t(e)}var J=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.id,a=e.container,r=e.fieldName,s=e.multiple,o=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:a.querySelector('[data-bx-role="placeholder"]'),eventObject:o}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"maxVisibleCount",10);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"prefixHTMLNode","disk-attach-");i.items=new Map;i.multiple=s!==false;i.fieldName=r;if(!a.querySelector('[data-bx-role="placeholder"]')){return babelHelpers.possibleConstructorReturn(i)}if(i.isPluggedIn()){i.buildInHTMLEditor()}return i}babelHelpers.createClass(t,[{key:"buildInHTMLEditor",value:function e(){var t=this;if(this.getParser().hasInterface()){s.EventEmitter.emit(this.eventObject,"OnParserRegister",this.getParser().getInterface())}s.EventEmitter.subscribe(this.eventObject,"onReinitializeBefore",(function(e){var i=babelHelpers.slicedToArray(e.data,2),n=i[0],a=i[1];var s=true;if(a){Object.values(a).forEach((function(e){if(e&&e["USER_TYPE_ID"]==="disk_file"&&e["FIELD_NAME"].replace("[]","")===t.fieldName.replace("[]","")){try{var i=[];var n={};if(r.Type.isArray(e["VALUE"])){e["VALUE"].forEach((function(e){var a=document.querySelector(["#",t.prefixHTMLNode,e].join(""));var s=String(e);if(!a||n[s]){return}n[s]=true;var o=a.querySelector("img")||a.querySelector("div[data-bx-preview]");var l=o||a;var c=l.hasAttribute("data-title")?l.getAttribute("data-title"):l.hasAttribute("data-bx-title")?l.getAttribute("data-bx-title"):"";var u={ID:e,FILE_ID:l.getAttribute("bx-attach-file-id"),CAN_RESTORE:false,CAN_UPDATE:false,CAN_RENAME:false,CAN_MOVE:false,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:null,BIG_PREVIEW_URL:null,EXTENSION:c.split(".").pop(),NAME:c,SIZE:l.getAttribute("data-bx-size"),SIZE_BYTES:l.getAttribute("data-bx-size"),STORAGE:"disk",TYPE_FILE:l.getAttribute("bx-attach-file-type")};if(o){u["PREVIEW_URL"]=o.hasAttribute("data-bx-preview")&&r.Type.isStringFilled(o.getAttribute("data-bx-preview"))?o.getAttribute("data-bx-preview"):o.hasAttribute("data-thumb-src")&&r.Type.isStringFilled(o.getAttribute("data-thumb-src"))?o.getAttribute("data-thumb-src"):o.src;u["BIG_PREVIEW_URL"]=o.hasAttribute("data-bx-src")?o.getAttribute("data-bx-src"):o.getAttribute("data-src")}i.push(u)}))}t.set(i);s=false}catch(e){console.log("e: ",e)}}}))}if(s!==false){t.clear()}}))}},{key:"set",value:function e(t){var i=this;this.clear();var n=this.maxVisibleCount;return new Promise((function(e){t.forEach((function(e){var t=i.addItem(e);n--;if(n>0){i.appendNode(t)}else if(n===0){i.container.appendChild(i.getItemMore().reset().getContainer())}else{i.getItemMore().increment()}}));e()}))}},{key:"clear",value:function e(){this.items.forEach((function(e){e.destroy()}));this.container.innerHTML=""}},{key:"add",value:function e(t,i){this.multiple||this.clear();var n=this.addItem(t);this.appendNode(n,i);return n}},{key:"addItem",value:function e(t){var i=this;var n=Z(t);var a=this.getContainer().querySelector('[data-bx-role="reserve-item"][value="'.concat(r.Text.encode(n.getId()),'"]'));if(!a){a=document.createElement("INPUT");a.name=this.fieldName;a.type="hidden";a.value=n.getId();this.container.appendChild(a)}n.subscribe("onDelete",(function(){if(a&&a.parentNode){a.parentNode.removeChild(a)}s.EventEmitter.emit(i,"OnItemDelete",n)}));n.subscribe("onDestroy",(function(){i.items["delete"](n.getId())}));if(this.isPluggedIn()){s.EventEmitter.emit(this.eventObject,"onShowControllers:File:Increment");if(this.getParser().hasInterface()){n.setPluggedIn();n.subscribe("onClickInsertInText",(function(){i.getParser().insertFile(n.getId())}));n.subscribe("onDelete",(function(){i.getParser().deleteFile(n.getId())}));n.subscribe("onDestroy",(function(){s.EventEmitter.emit(i.eventObject,"onShowControllers:File:Decrement")}))}}this.items.set(n.getId(),n);return n}},{key:"getItem",value:function e(t){return this.items.get(t)}},{key:"appendNode",value:function e(t,i){if(i){if(i.parentNode){i.parentNode.replaceChild(t.getContainer(),i)}}else{this.container.appendChild(t.getContainer())}return t}},{key:"getItemMore",value:function e(){var t=this;return this.cache.remember("moreButton",(function(){var e=new I;s.EventEmitter.subscribe(e,"onGetMore",t.showMoreItems.bind(t));return e}))}},{key:"showMoreItems",value:function e(t){var i=t.data.itemsCount;var n=i;var a=this.getItemMore().getContainer();a.style.opacity="0";a.style.visibility="hidden";this.items.forEach((function(e){if(i>0){if(!e.hasContainer()){i--;var t=document.createElement("DIV");a.parentNode.insertBefore(t,a);setTimeout((function(){r.Dom.style(e.getContainer(),"opacity","0");r.Dom.addClass(e.getContainer(),"disk-file-thumb--animate");r.Dom.style(e.getContainer(),"opacity","");t.parentNode.replaceChild(e.getContainer(),t);e.getContainer().addEventListener("transitionend",(function(){r.Dom.removeClass(e.getContainer(),"disk-file-thumb--animate")}))}),(n-i)*100)}}}));if(i<=0){setTimeout((function(){a.style.opacity="";a.style.visibility=""}),n*100+100)}}},{key:"getParser",value:function e(){this.parser=this.parser||new Y(this);return this.parser}}]);return t}(E);var $=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:n.querySelector('[data-bx-role="setting"]'),eventObject:a}));if(i.getContainer()){i.getContainer().addEventListener("click",i.show.bind(babelHelpers.assertThisInitialized(i)));i.allowEditNode=n.querySelector('input[data-bx-role="settings-allow-edit"]');i.allowGridNode=n.querySelector('input[data-bx-role="settings-allow-grid"]')}return i}babelHelpers.createClass(t,[{key:"show",value:function e(){var t=this;if(!this.popup){this.popup=new i.Menu({bindElement:this.getContainer(),className:"disk-uf-file-popup-settings",items:[this.allowEditNode?{dataset:{bxRole:"allowEdit"},className:this.allowEditNode.checked?"menu-popup-item-take":"",text:r.Loc.getMessage("WDUF_ALLOW_EDIT"),onclick:function(e,t){this.allowEditNode.checked=!this.allowEditNode.checked;if(this.allowEditNode.checked){t.getContainer().classList.add("menu-popup-item-take");t.getContainer().classList.remove("menu-popup-no-icon")}else{t.getContainer().classList.remove("menu-popup-item-take");t.getContainer().classList.add("menu-popup-no-icon")}}.bind(this)}:null,{dataset:{bxRole:"allowGrid"},className:this.allowGridNode.checked?"menu-popup-item-take":"",text:r.Loc.getMessage("WDUF_ALLOW_COLLAGE"),onclick:function(e,t){this.allowGridNode.checked=!this.allowGridNode.checked;if(this.allowGridNode.dataset.bxSave==="Y"){BX.userOptions.save("disk","disk.uf.file",this.allowGridNode.dataset.bxName,this.allowGridNode.checked?"grid":".default")}if(this.allowGridNode.checked){t.getContainer().classList.add("menu-popup-item-take");t.getContainer().classList.remove("menu-popup-no-icon")}else{t.getContainer().classList.remove("menu-popup-item-take");t.getContainer().classList.add("menu-popup-no-icon")}}.bind(this)},{text:this.buildDocumentServiceTextLabel(),items:this.buildSubMenuWithDocumentServices()}],angle:true,offsetTop:-16,offsetLeft:16,events:{onClose:function e(){delete t.popup}}})}this.popup.show()}},{key:"buildDocumentServiceTextLabel",value:function e(){var t=BX.Disk.getDocumentService();if(!t&&BX.Disk.isAvailableOnlyOffice()){t="onlyoffice"}else if(!t){t="l"}var i=o.getDocumentHandler(t).name;return r.Loc.getMessage("DISK_UF_FILE_EDIT_SERVICE_LABEL",{"#NAME#":i})}},{key:"buildSubMenuWithDocumentServices",value:function e(){var t=this;var i=[];o.getDocumentHandlers().forEach((function(e){i.push({text:e.name,dataset:{code:e.code},onclick:function e(i,n){BX.Disk.saveDocumentService(n.dataset.code);n.getMenuWindow().getParentMenuItem().setText(t.buildDocumentServiceTextLabel());n.getMenuWindow().getPopupWindow().close()}})}));return i}},{key:"hide",value:function e(){if(this.popup){this.popup.close()}}}]);return t}(E);var Q=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:n.querySelector('[data-bx-role="document-area"]'),eventObject:a}));if(i.getContainer()){Array.from(i.getContainer().querySelectorAll("[data-bx-handler]")).forEach((function(e){e.addEventListener("click",(function(){i.createDocument(e.getAttribute("data-bx-handler"))}))}))}return i}babelHelpers.createClass(t,[{key:"createDocument",value:function e(t){if(!BX.Disk.getDocumentService()&&BX.Disk.isAvailableOnlyOffice()){BX.Disk.saveDocumentService("onlyoffice")}else if(!BX.Disk.getDocumentService()){BX.Disk.saveDocumentService("l")}var i=function(e){var t=this;var i=e.object.name.split(".");i.pop();setTimeout((function(){s.EventEmitter.emit(t,"onFileIsCreated",{itemData:t.convertToItemSavedType(e)})}),200)}.bind(this);if(BX.Disk.Document.Local.Instance.isSetWorkWithLocalBDisk()){BX.Disk.Document.Local.Instance.createFile({type:t}).then(function(e){i(e)}.bind(this));return}var n=new BX.Disk.Document.CreateProcess({typeFile:t,serviceCode:BX.Disk.getDocumentService(),onAfterSave:function e(t,n){if(t.status!=="success"){return}if(!n){k.getMetaDataForCreatedFileInUf(t.object.id).then((function(e){var t=e.data;i(t)}))}else{i(n)}}});n.start()}},{key:"convertToItemSavedType",value:function e(t){return{ID:"n"+t.object.id,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:false,CAN_RESTORE:false,CAN_UPDATE:true,CAN_RENAME:true,CAN_MOVE:true,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:t.link,PREVIEW_URL:null,BIG_PREVIEW_URL:null,EXTENSION:t.object.extension,NAME:t.object.name,SIZE:t.object.size,SIZE_BYTES:t.object.sizeInt,STORAGE:t.folderName}}}]);return t}(E);var ee=function(e){babelHelpers.inherits(t,e);function t(e){var i=e.container,n=e.eventObject;babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:i.querySelector('[data-bx-role="control-panel"]'),eventObject:n}))}return t}(E);var te=0;var ie=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);var r=n.querySelector('[data-bx-role="file-local-controller"]')||n.querySelector(".diskuf-selector-link");i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:r,eventObject:a}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"opened",false);i.dialogName=["selectFile",te++].join("-");if(!i.getContainer()){return babelHelpers.possibleConstructorReturn(i)}i.getContainer().addEventListener("click",i.onClick.bind(babelHelpers.assertThisInitialized(i)));i.openSection=i.openSection.bind(babelHelpers.assertThisInitialized(i));i.selectFile=i.selectFile.bind(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(BX.DiskFileDialog,"loadItems",i.openSection);return i}babelHelpers.createClass(t,[{key:"onClick",value:function e(){var t=this;k.getSelectedData(this.dialogName).then((function(){setTimeout((function(){BX.DiskFileDialog.obCallback[t.dialogName]={saveButton:t.selectFile};BX.DiskFileDialog.openDialog(t.dialogName)}),10)}))}},{key:"openSection",value:function e(t){var i=babelHelpers.slicedToArray(t.data,2),n=i[0],a=i[1];if(a===this.dialogName){BX.DiskFileDialog.target[a]=r.Uri.addParam(n,{dialog2:"Y"})}}},{key:"selectFile",value:function e(t,i,n){s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);for(var a in n){if(n.hasOwnProperty(a)){s.EventEmitter.emit(this,"onUploadDone",{itemData:this.convertToItemSavedType(n[a])})}}}},{key:"convertToItemSavedType",value:function e(t){var i;return{ID:t.id,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:false,CAN_RESTORE:false,CAN_RENAME:false,CAN_UPDATE:false,CAN_MOVE:false,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:t.previewUrl?t.previewUrl:"",BIG_PREVIEW_URL:t.previewUrl?t.previewUrl.replace(/\&(width|height)=\d+/gi,""):null,EXTENSION:t.ext,NAME:t.name,SIZE:t.size,SIZE_BYTES:t.sizeInt,STORAGE:(i=t["storage"])!==null&&i!==void 0?i:r.Loc.getMessage("WDUF_MY_DISK")}}}]);return t}(E);var ne=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,i));BX.Disk.ExternalLoader.startLoad({file:{id:n.id,name:n.object.name,service:n.object.service},onFinish:function e(t){s.EventEmitter.emit(babelHelpers.assertThisInitialized(n),"onUploadDone",[t])},onProgress:function e(t){n.onUploadProgress({compatData:[{},t]})}});return n}babelHelpers.createClass(t,[{key:"onClickDelete",value:function e(t){t.preventDefault();t.stopPropagation();s.EventEmitter.emit(this,"onDelete",[this]);delete this.container}},{key:"onUploadDone",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,2),n=i[0],a=i[1].file}},{key:"onUploadError",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,1),n=i[0];s.EventEmitter.emit(this,"onUploadError",[n.file]);this.progress.getContainer().parentNode.removeChild(this.progress.getContainer());this.container.classList.add("disk-file-upload-error")}}]);return t}(c);var ae=0;var re=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:n.querySelector('[data-bx-role="placeholder"]'),eventObject:a}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"services",[]);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"items",new Map);if(!i.getContainer()){return babelHelpers.possibleConstructorReturn(i)}Array.from(n.querySelectorAll('[data-bx-role="file-external-controller"]')).forEach((function(e){i.services.push(e)}));Array.from(n.querySelectorAll(".diskuf-selector-link-cloud")).forEach((function(e){i.services.push(e)}));i.eventObject=a;i.dialogName=["selectFileCloud",ae++].join("-");i.services.forEach((function(e){e.addEventListener("click",i.onClick.bind(babelHelpers.assertThisInitialized(i)))}));i.openSection=i.openSection.bind(babelHelpers.assertThisInitialized(i));i.selectFile=i.selectFile.bind(babelHelpers.assertThisInitialized(i));return i}babelHelpers.createClass(t,[{key:"onClick",value:function e(t){var i=this;s.EventEmitter.subscribe(BX.DiskFileDialog,"loadItems",this.openSection);this.currentService=t.currentTarget.getAttribute("data-bx-doc-handler");k.getSelectedCloudData(this.dialogName,this.currentService).then((function(){setTimeout((function(){BX.DiskFileDialog.obCallback[i.dialogName]={saveButton:i.selectFile};BX.DiskFileDialog.openDialog(i.dialogName)}),10)}))}},{key:"openSection",value:function e(t){var i=babelHelpers.slicedToArray(t.data,2),n=i[0],a=i[1];if(a===this.dialogName){BX.DiskFileDialog.target[a]=r.Uri.addParam(n,{dialog2:"Y"})}}},{key:"selectFile",value:function e(t,i,n){s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);for(var a in n){if(n.hasOwnProperty(a)&&n[a].type==="file"){this.catchFile(n[a],this.currentService)}}this.currentService=null}},{key:"catchFile",value:function e(t,i){var n=this;if(this.items.has(t.id)){return}t["service"]=t["provider"]||i;var a=new ne(t.id,t);this.items.set(a.id,a);s.EventEmitter.subscribe(a,"onUploadDone",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];if(n.items.has(a.id)){n.items["delete"](a.id);s.EventEmitter.emit(n,"onUploadDone",{itemData:n.convertToItemSavedType(i),itemContainer:a.getContainer()})}}));s.EventEmitter.subscribe(a,"onUploadError",(function(){n.items["delete"](a.id);s.EventEmitter.emit(n,"onUploadError",{itemContainer:a.getContainer()})}));s.EventEmitter.subscribe(a,"onDelete",(function(){n.items["delete"](a.id);n.container.removeChild(a.getContainer())}));this.container.appendChild(a.getContainer())}},{key:"convertToItemSavedType",value:function e(t){var i=t.name.split(".").pop().toLowerCase();var n={ID:t.ufId,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:true,CAN_RESTORE:false,CAN_RENAME:false,CAN_UPDATE:false,CAN_MOVE:false,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:t.previewUrl?t.previewUrl:"",BIG_PREVIEW_URL:t.previewUrl?t.previewUrl.replace(/\&(width|height)=\d+/gi,""):null,EXTENSION:i===t.name?"":i,NAME:t.name,SIZE:t.sizeFormatted,SIZE_BYTES:t.size,STORAGE:t.storage};return n}}]);return t}(E);var se=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"dialogName","moveFile");this.openSection=this.openSection.bind(this);this.loadFolder=this.loadFolder.bind(this);this.stopLoadingFolder=this.stopLoadingFolder.bind(this);this.checkFileName=this.checkFileName.bind(this);this.onApply=this.onApply.bind(this);this.onCancel=this.onCancel.bind(this)}babelHelpers.createClass(e,[{key:"fire",value:function e(t){var i=this;if(this.item!==null&&this.item!==t){this.onCancel()}this.item=t;k.getSelectedFile(t.getFileId(),t.getData("NAME"),this.dialogName).then((function(){setTimeout((function(){BX.DiskFileDialog.obCallback[i.dialogName]={saveButton:i.onApply,cancelButton:i.onCancel};BX.DiskFileDialog.openDialog(i.dialogName)}),10)}));s.EventEmitter.subscribe(BX.DiskFileDialog,"loadItems",this.openSection);s.EventEmitter.subscribe(BX.DiskFileDialog,"selectItem",this.loadFolder);s.EventEmitter.subscribe(BX.DiskFileDialog,"unSelectItem",this.stopLoadingFolder)}},{key:"openSection",value:function e(t){var i=babelHelpers.slicedToArray(t.data,2),n=i[0],a=i[1];if(a===this.dialogName){BX.DiskFileDialog.target[a]=r.Uri.addParam(n,{dialog2:"Y"})}}},{key:"loadFolder",value:function e(t){var i=this;var n=babelHelpers.slicedToArray(t.data,3),a=n[0],s=n[1],o=n[2];if(o!==this.dialogName){return}k.loadFolder(s.substr(1),this.item.getData("NAME"),this.dialogName).then((function(e){var t=e.permission===true&&e["okmsg"]!=="";if(i.timeout>0){clearTimeout(i.timeout)}i.timeout=setTimeout((function(){if(t){BX.DiskFileDialog.showNotice(r.Loc.getMessage("WDUF_FILE_IS_EXISTS"),i.dialogName)}else{BX.DiskFileDialog.closeNotice(i.dialogName)}}),200)}))}},{key:"stopLoadingFolder",value:function e(t){var i=t.data;if(this.timeout>0){clearTimeout(this.timeout)}this.timeout=setTimeout(this.checkFileName,200)}},{key:"onApply",value:function e(t,i,n,a){var r=this;s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"selectItem",this.loadFolder);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"unSelectItem",this.stopLoadingFolder);if(!this.item){return}var o=this.item.getId();var l=false;var c=function e(t,i,n,a){k.moveFile(t,i).then((function(e){if(!e||e.status!=="success"){BX.Disk.showModalWithStatusAction(e);return}r.showMovedFile(t,n,a)}))};var u,d;for(var h in n){if(n.hasOwnProperty(h)&&n[h].type==="folder"){u=t.name+n[h].path;d={sectionID:h,iblockID:t.iblock_id};c(o,n[h].id,d,u);l=true}}if(!l){u=t.name;d={sectionID:t.section_id,iblockID:t.iblock_id};if(!!a&&!!a.path&&a.path!=="/"){u+=a.path;d.sectionID=a.id;if(!!a){c(o,a.id,d,u)}}}}},{key:"checkFileName",value:function e(t){if(this.timeout>0){clearTimeout(this.timeout)}if(t!==this.dialogName||!this.item){return}var i=this.item.getData("NAME");var n=false;for(var a in BX.DiskFileDialog.obItems[this.dialogName]){if(BX.DiskFileDialog.obItems[this.dialogName].hasOwnProperty(a)&&BX.DiskFileDialog.obItems[this.dialogName][a]["name"]===i){n=true;break}}if(n){BX.DiskFileDialog.showNotice(r.Loc.getMessage("WDUF_FILE_IS_EXISTS"),this.dialogName)}else{BX.DiskFileDialog.closeNotice(this.dialogName)}}},{key:"showMovedFile",value:function e(t,i,n){if(this.item){this.item.emit("onMoved",n)}this.item=null}},{key:"onCancel",value:function e(){s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"selectItem",this.loadFolder);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"unSelectItem",this.stopLoadingFolder);this.item=null;if(this.timeout>0){clearTimeout(this.timeout)}this.timeout=null}}],[{key:"subscribe",value:function t(){if(BX.DiskFileDialog.subscribed!==true){BX.DiskFileDialog.subscribed=true;s.EventEmitter.subscribe(BX.DiskFileDialog,"onFileNeedsToMove",(function(t){t.stopImmediatePropagation();e.getInstance().fire(babelHelpers.toConsumableArray(t.getData()).shift())}))}}},{key:"getInstance",value:function t(){if(this.instance===null){this.instance=new e}return this.instance}}]);return e}();babelHelpers.defineProperty(se,"subscribed",false);babelHelpers.defineProperty(se,"instance",null);var oe,le;var ce=0;function ue(e){var t={},i,n;for(i in e){n=i.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase();t[n]=e[i];t[i]=e[i]}return t}var de=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.id,a=e.fieldName,r=e.container,l=e.eventObject,c=e.input;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:r,eventObject:l}));i.id=n;i.fieldName=a;i.input=c;if(!i.input){return babelHelpers.possibleConstructorReturn(i)}i.agent=BX.Uploader.getInstance({id:n,streams:1,allowUpload:"A",uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:o.urlUpload,showImage:false,sortItems:false,dropZone:null,input:i.input,pasteFileHashInForm:false});i.onUploadDone=i.onUploadDone.bind(babelHelpers.assertThisInitialized(i));i.onUploadError=i.onUploadError.bind(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(i.agent,"onFileIsUploaded",(function(e){var t=babelHelpers.slicedToArray(e.compatData,3),n=t[0],a=t[1],r=t[2];i.onUploadDone(a,r)}));s.EventEmitter.subscribe(i.agent,"onFileIsUploadedWithError",(function(e){var t=babelHelpers.slicedToArray(e.compatData,3),n=t[0],a=t[1],r=t[2];i.onUploadError(a,r)}));i.fileSelector=new ie(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(i.fileSelector,"onUploadDone",(function(e){var t=e.data.itemData;i.onSelectionIsDone(t)}));i.fileSelectorCloud=new re(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(i.fileSelectorCloud,"onUploadDone",(function(e){var t=e.data.itemData;i.onSelectionIsDone(t)}));return i}babelHelpers.createClass(t,[{key:"onSelectionIsDone",value:function e(t){var i={id:"disk-edit-attach"+t["ID"],"bx-agentFileId":t["ID"]};if(t["FILE_ID"])i["bx-attach-file-id"]="n"+t["FILE_ID"];var n=r.Tag.render(oe||(oe=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="','" value="','">'])),this.fieldName,t["ID"]);for(var a in i){if(i.hasOwnProperty(a)){n.setAttribute(a,i[a])}}this.getContainer().appendChild(n);var o={element_id:t["ID"],element_name:t["NAME"],element_url:t["PREVIEW_URL"],storage:t["STORAGE"]};s.EventEmitter.emit(this.getEventObject(),"OnFileUploadSuccess",new s.BaseEvent({compatData:[o,{},null,{id:ce++,name:t["NAME"],size:t["SIZE"],sizeInt:t["SIZE_INT"]}]}))}},{key:"onUploadDone",value:function e(t,i){if(i["file"]&&i["file"]["attachId"]!==i["file"]["id"]){i["file"]["id"]=i["file"]["attachId"];delete i["file"]["attachId"]}var n=ue(i["file"]);var a={id:"disk-edit-attach"+n.id,"bx-agentFileId":t.id};if(n["XML_ID"])a["bx-attach-xml-id"]=n["XML_ID"];if(n["FILE_ID"])a["bx-attach-file-id"]="n"+n["FILE_ID"];if(n["FILE_TYPE"])a["bx-attach-file-type"]=n["FILE_TYPE"];n.element_id=n.id;var s=r.Tag.render(le||(le=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="','" value="','">'])),this.fieldName,n.id);for(var o in a){if(a.hasOwnProperty(o)){s.setAttribute(o,a[o])}}this.getContainer().appendChild(s);this.onFileIs(t,n)}},{key:"onFileIs",value:function e(t,i){var n={element_id:i.element_id,element_name:i.element_name||t.name,element_url:i.element_name||i.previewUrl||i.preview_url,storage:"disk"};s.EventEmitter.emit(this.getEventObject(),"OnFileUploadSuccess",new s.BaseEvent({compatData:[n,this,t.file,t]}))}},{key:"onUploadError",value:function e(t,i){BX.onCustomEvent(this.getEventObject(),"OnFileUploadFailed",[this,t.file,t])}}]);return t}(E);var he=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;var a=e.id,r=e.fieldName,o=e.container,l=e.eventObject,c=e.input,u=e.parserParams;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:o,eventObject:l}));n.id=a;n.fieldName=r;n.input=c;if(u){n.getFileController().getParser().setParams(u)}n.init();if(i.length>0){s.EventEmitter.emit(n.getEventObject(),"onShowControllers","show");n.show(i)}return n}babelHelpers.createClass(t,[{key:"init",value:function e(){var t=this;if(this.input){this.getFilesUploader()}this.initDocumentController();this.settingsController=new $(this,{});this.panelController=new ee(this);this.fileSelector=new ie(this);s.EventEmitter.subscribe(this.fileSelector,"onUploadDone",(function(e){var i=e.data.itemData;t.getFileController().add(i)}));this.fileSelectorCloud=new re(this);s.EventEmitter.subscribe(this.fileSelectorCloud,"onUploadDone",(function(e){var i=e.data,n=i.itemData,a=i.itemContainer;t.getFileController().add(n,a)}));var i=function e(i){var n=r.Type.isArray(i.getData())?i.getData().shift():i.getData();if(n==="show"){t.show()}else{t.hide()}};s.EventEmitter.subscribe(this.getEventObject(),"onCollectControllers",(function(e){e.data[t.fieldName]={storage:"disk",tag:t.getFileController().isPluggedIn()?t.getFileController().getParser().tag:null,values:[],handler:{selectFile:function e(i,n,a){t.fileSelector.selectFile(i,n,a)}}};Array.from(t.getContainer().querySelectorAll('input[type="hidden"][name="'.concat(t.fieldName,'"]'))).forEach((function(i){e.data[t.fieldName].values.push(i.value)}))}));s.EventEmitter.subscribe(this.getEventObject(),"onShowControllers",i);s.EventEmitter.subscribe(this.getEventObject(),"DiskLoadFormController",i);s.EventEmitter.subscribe(s.EventEmitter.GLOBAL_TARGET,"disk.uf.file:create:thumb:upload",(function(e){var i=e.data;t.show();t.getFilesUploader().addTestThumb(i)}));s.EventEmitter.subscribe(s.EventEmitter.GLOBAL_TARGET,"disk.uf.file:create:thumb:error",(function(){t.show();t.getFilesUploader().addTestErrorThumb()}))}},{key:"initDocumentController",value:function e(){var i=this;this.documentController=new Q({container:this.getContainer(),eventObject:this.getEventObject()});s.EventEmitter.subscribe(this.documentController,"onFileIsCreated",(function(e){var t=e.data.itemData;s.EventEmitter.emit(i.getEventObject(),"onShowControllers","show");i.getFileController().add(t)}));if(!this.documentController.isRelevant()){return}else if(!this.isPluggedIn()){this.documentController.show();return}if(this.eventObject.dataset.bxDiskDocumentButton!=="added"){this.eventObject.dataset.bxDiskDocumentButton="added";var n=document.createElement("DIV");n.addEventListener("click",(function(){var e=n.closest('[data-id="disk-document"]');if(e&&e.hasAttribute("data-bx-button-status")){s.EventEmitter.emit(i.getEventObject(),"onHideDocuments")}else{s.EventEmitter.emit(i.getEventObject(),"onShowControllers","hide");s.EventEmitter.emit(i.getEventObject(),"onShowDocuments","show")}}));n.innerHTML="<i></i>"+r.Loc.getMessage("WDUF_CREATE_DOCUMENT");s.EventEmitter.emit(this.eventObject,"OnAddButton",[{BODY:n,ID:"disk-document"},"file"]);s.EventEmitter.subscribe(this.getEventObject(),"onShowDocuments",(function(){var e=n.closest('[data-id="disk-document"]');if(e){e.setAttribute("data-bx-button-status","active")}}));s.EventEmitter.subscribe(this.getEventObject(),"onHideDocuments",(function(){var e=n.closest('[data-id="disk-document"]');if(e){e.removeAttribute("data-bx-button-status")}}))}s.EventEmitter.subscribe(this.getEventObject(),"onShowDocuments",(function(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"show",i).call(i);i.documentController.show()}));s.EventEmitter.subscribe(this.getEventObject(),"onHideDocuments",(function(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"hide",i).call(i);i.documentController.hide()}));var a=function e(t){var n=t.data;if(n==="show"){s.EventEmitter.emit(i.getEventObject(),"onHideDocuments")}};s.EventEmitter.subscribe(this.getEventObject(),"DiskLoadFormController",a);s.EventEmitter.subscribe(this.getEventObject(),"onShowControllers",a)}},{key:"getFileController",value:function e(){if(!this.filesController){this.filesController=new J({id:this.id,fieldName:this.fieldName,container:this.container,eventObject:this.eventObject})}return this.filesController}},{key:"getFilesUploader",value:function e(){var t=this;if(!this.filesUploader){this.filesUploader=new v({id:this.id,container:this.container.querySelector('[data-bx-role="placeholder"]'),dropZone:this.container,input:this.input});s.EventEmitter.subscribe(this.getEventObject(),"OnVideoHasCaught",(function(e){var i=e.getData();var n=function e(n){var a=n.data,r=a.itemData,o=a.itemContainer,l=a.blob;if(i===l){s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",e);t.getFileController().getParser().insertFile(r.ID)}};s.EventEmitter.subscribe(t.filesUploader,"onUploadDone",n);t.filesUploader.upload([i]);e.stopImmediatePropagation()}));s.EventEmitter.subscribe(this.getEventObject(),"OnImageHasCaught",(function(e){var i=e.getData();e.stopImmediatePropagation();return new Promise((function(e,n){var a=function n(a){var o=a.data,l=o.itemData,c=o.itemContainer,u=o.blob;if(i===u){s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",n);s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",r);e({image:{src:l.PREVIEW_URL},html:t.getFileController().getParser().getItemHTML(l.ID)})}};s.EventEmitter.subscribe(t.filesUploader,"onUploadDone",a);var r=function e(r){var o=r.data.blob;if(i===o){s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",a);s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",e);n()}};s.EventEmitter.subscribe(t.filesUploader,"onUploadDone",r);t.filesUploader.upload([i])}))}));s.EventEmitter.subscribe(this.getEventObject(),"onFilesHaveCaught",(function(e){e.stopImmediatePropagation();t.filesUploader.upload(babelHelpers.toConsumableArray(e.getData()))}));s.EventEmitter.subscribe(this.filesUploader,"onUploadDone",(function(e){var i=e.data,n=i.itemData,a=i.itemContainer;t.getFileController().add(n,a)}));s.EventEmitter.subscribe(this.filesUploader,"onUploadIsStart",(function(){s.EventEmitter.emit(t.getEventObject(),"onBusy",t)}));s.EventEmitter.subscribe(this.filesUploader,"onUploadIsDone",(function(){s.EventEmitter.emit(t.getEventObject(),"onReady",t)}))}return this.filesUploader}},{key:"getPanelController",value:function e(){return this.panelController}},{key:"show",value:function e(i){var n=this;var a=this.getContainer().parentNode.querySelector("#"+this.getContainer().id+"-switcher");if(a){a.parentNode.removeChild(a)}if(this.getFileController().isPluggedIn()){this.getContainer().setAttribute("data-bx-plugged-in","Y")}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"show",this).call(this);this.showInitialLoader();this.getFileController().show();this.getPanelController().show();if(i){this.getFileController().set(i).then((function(){n.hideInitialLoader()}))}else{this.hideInitialLoader()}}},{key:"hide",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"hide",this).call(this);this.getFileController().hide();this.getPanelController().hide()}},{key:"showInitialLoader",value:function e(){}},{key:"hideInitialLoader",value:function e(){}}],[{key:"getInstance",value:function e(i,n){if(!this.repo[i["id"]]){this.repo[i["id"]]=new t(i,n)}return this.repo[i["id"]]}},{key:"getBriefInstance",value:function e(t){if(!this.repo[t["id"]]){this.repo[t["id"]]=new de(t,[])}return this.repo[t["id"]]}}]);return t}(E);babelHelpers.defineProperty(he,"repo",{});setTimeout((function(){if(BX.DiskFileDialog){se.subscribe()}}),1e3);var pe=function e(t){var i=BX("diskuf-selectdialog-"+t["UID"]);if(i&&BX.isNodeInDom(i)){var n=i.parentNode;if(!i.hasAttribute("bx-disk-load-is-bound")){i.setAttribute("bx-disk-load-is-bound","Y");BX.addCustomEvent(n,"DiskLoadFormController",(function(e){try{BX.Disk.UF.Options.set({urlUpload:t.urlUpload});return BX.Disk.UF.Form.getBriefInstance({container:i,eventObject:i.parentNode,id:t.UID,fieldName:t.controlName,input:BX.findChild(i,{className:"diskuf-fileUploader"},true)})}catch(e){console.log("Error with compatibility",e)}}))}if(!!t["values"]&&t["values"].length>0&&!t["hideSelectDialog"])BX.onCustomEvent(i.parentNode,"DiskLoadFormController",["show"])}};e.Form=he;e.Options=o;e.add=pe})(this.BX.Disk.UF=this.BX.Disk.UF||{},BX,BX.Main,BX.UI,BX.UI,BX,BX.Event);(function(e){if(e.BX.Disk&&e.BX.Disk.UFShowController)return;var t=e.BX;var i=0;var n={};var a=function(e){return t.Disk.ajaxPromise({url:t.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","getBreadcrumbs"),method:"POST",dataType:"json",data:{attachedId:e}})};var r=function(e){if(!t(e)||e.hasAttribute("bx-is-bound"))return;e.setAttribute("bx-is-bound","Y");this.img=e;this.node=e.parentNode.parentNode.parentNode;t.unbindAll(e);t.unbindAll(this.node);t.show(this.node);t.remove(this.node.nextSibling);this.id="wufdp_"+Math.random()};r.prototype={turnOn:function(){this.timeout=setTimeout(t.delegate((function(){this.show()}),this),500)},turnOff:function(){clearTimeout(this.timeout);this.timeout=null;this.hide()},show:function(){if(this.popup!=null)this.popup.close();if(this.popup==null){var e={width:this.img.naturalWidth,height:this.img.naturalHeight};if(t["UploaderUtils"]){var i=t.UploaderUtils.scaleImage(e,{width:parseInt(t.message("DISK_THUMB_WIDTH")),height:parseInt(t.message("DISK_THUMB_HEIGHT"))});e=i.destin}this.popup=new t.PopupWindow("bx-wufd-preview-img-"+this.id,this.img.parentNode,{lightShadow:true,offsetTop:-7,offsetLeft:(51-28)/2+14,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:t.proxy((function(){this.popup=null}),this)},content:t.create("DIV",{props:e,children:[t.create("IMG",{props:e,attrs:{src:this.img.src}})]})});this.popup.show()}this.popup.setAngle({position:"bottom"});this.popup.bindOptions.forceBindPosition=true;this.popup.adjustPosition();this.popup.bindOptions.forceBindPosition=false},hide:function(){if(this.popup!=null)this.popup.close()}};t.addCustomEvent("onDiskPreviewIsReady",(function(e){new r(e)}));t.Disk.UF.runImport=function(e){t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_PROCESS_LOADING"),showLoaderIcon:true,autoHide:false});t.Disk.ExternalLoader.reloadLoadAttachedObject({attachedObject:{id:e.id,name:e.name,service:e.service},onFinish:t.delegate((function(e){if(e.hasOwnProperty("hasNewVersion")&&!e.hasNewVersion){t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_HAS_LAST_VERSION"),showSuccessIcon:true,autoHide:true})}else if(e.status==="success"){t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_SUCCESS_LOADING"),showSuccessIcon:true,autoHide:true})}else{t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_FAIL_LOADING"),autoHide:true})}}),this),onProgress:t.delegate((function(e){}),this)}).start()};t.Disk.UF.disableAutoCommentToAttachedObject=function(e){var i=e.attachedId;t.Disk.ajax({method:"POST",dataType:"json",url:t.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","disableAutoCommentToAttachedObject"),data:{attachedId:i},onsuccess:t.delegate((function(e){}),this)})};t.Disk.UF.enableAutoCommentToAttachedObject=function(e){var i=e.attachedId;t.Disk.ajax({method:"POST",dataType:"json",url:t.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","enableAutoCommentToAttachedObject"),data:{attachedId:i},onsuccess:t.delegate((function(e){}),this)})};t.Disk.UF.showTransformationUpgradePopup=function(e){B24.licenseInfoPopup.show("disk_transformation_video_limit",t.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_TITLE"),t.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_CONTENT"),false)};t.Disk.UFShowController=function(e){if(!t.type.isPlainObject(e)){e={}}this.entityType=t.type.isNotEmptyString(e.entityType)?e.entityType:"";this.entityId=parseInt(e.entityId)>0?e.entityId:"";this.signedParameters=t.type.isNotEmptyString(e.signedParameters)?e.signedParameters:"";this.loader=null;this.container=t.type.isNotEmptyString(e.nodeId)?document.getElementById(e.nodeId):null;if(this.container){var i=this.container.querySelector(".disk-uf-file-switch-control");if(i){t.Event.bind(i,"click",t.Disk.UFShowController.onToggleView)}}if(t.type.isNotEmptyString(e.nodeId)){n[e.nodeId]=this}};t.Disk.UFShowController.getInstance=function(e){return t.type.isNotEmptyString(e)&&n[e]?n[e]:null};t.Disk.UFShowController.onToggleView=function(e){var i=e.currentTarget.closest(".diskuf-files-toggle-container"),n=e.currentTarget.getAttribute("data-bx-view-type");if(!t.type.isDomNode(i)||!t.type.isNotEmptyString(i.id)){return}var a=t.Disk.UFShowController.getInstance(i.id);if(a){a.toggleViewType({viewType:n})}e.preventDefault()};t.Disk.UFShowController.prototype.toggleViewType=function(e){this.showToggleViewLoader();t.ajax.runComponentAction("bitrix:disk.uf.file","toggleViewType",{mode:"class",signedParameters:this.signedParameters,data:{params:{viewType:e.viewType}}}).then(function(e){this.hideToggleViewLoader();t.clean(this.container);t.html(this.container,e.data.html)}.bind(this),(function(e){this.hideToggleViewLoader()}))};t.Disk.UFShowController.prototype.showToggleViewLoader=function(e){this.container.classList.add("diskuf-files-toggle-container-active");this.loader=new t.Loader({target:this.container});this.loader.show()};t.Disk.UFShowController.prototype.hideToggleViewLoader=function(e){this.container.classList.remove("diskuf-files-toggle-container-active");if(this.loader){this.loader.destroy()}};e.DiskOpenMenuCreateService=function(e){var i=[t.Disk.UF.getDocumentHandler("onlyoffice")?{text:t.Disk.UF.getDocumentHandler("onlyoffice").name,className:"bx-viewer-popup-item item-b24-docs",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("onlyoffice");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("onlyoffice").name})}}:null,t.Disk.Document.Local.Instance.isEnabled()?{text:t.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT"),className:"bx-viewer-popup-item item-b24",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("l");t.adjust(e,{text:t.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT")})}}:null,{text:t.Disk.UF.getDocumentHandler("gdrive").name,className:"bx-viewer-popup-item item-gdocs",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("gdrive");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("gdrive").name})}},{text:t.Disk.UF.getDocumentHandler("office365").name,className:"bx-viewer-popup-item item-office365",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("office365");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("office365").name})}},{text:t.Disk.UF.getDocumentHandler("onedrive").name,className:"bx-viewer-popup-item item-office",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("onedrive");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("onedrive").name})}}];t.PopupMenu.show("disk_open_menu_with_services",t(e),i,{offsetTop:0,offsetLeft:25,angle:{position:"top",offset:45},autoHide:true,zIndex:1e4,overlay:{opacity:.01},events:{}})};e.DiskOpenMenuImportService=function(e,i){var n=[];for(var a in i){if(!i.hasOwnProperty(a))continue;n.push({text:i[a].name,code:i[a].id,href:"#",onclick:function(e,i){var n=i.layout.item;t.addClass(n,"diskuf-selector-link-cloud");n.setAttribute("data-bx-doc-handler",i.code);t.onCustomEvent("onManualChooseCloudImport",[{target:n}]);t.removeClass(n,"diskuf-selector-link-cloud");n.removeAttribute("data-bx-doc-handler");t.PopupMenu.destroy("disk_open_menu_with_import_services");return t.PreventDefault(e)}})}var r=new t.CViewer({});r.openMenu("disk_open_menu_with_import_services",t(e),n,{offsetTop:0,offsetLeft:25});return t.PreventDefault()};e.DiskActionFileMenu=function(e,n,a){i++;t.PopupMenu.show("bx-viewer-wd-popup"+i+"_"+e,t(n),a,{angle:{position:"top",offset:25},autoHide:true});return false};e.WDInlineElementClickDispatcher=function(e,i){var n=t(i);if(n){t.fireEvent(n,"click")}return false}})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:100:"/bitrix/components/bitrix/tasks.widget.checklist.new/templates/.default/logic.min.js?169925808316242";s:6:"source";s:80:"/bitrix/components/bitrix/tasks.widget.checklist.new/templates/.default/logic.js";s:3:"min";s:84:"/bitrix/components/bitrix/tasks.widget.checklist.new/templates/.default/logic.min.js";s:3:"map";s:84:"/bitrix/components/bitrix/tasks.widget.checklist.new/templates/.default/logic.map.js";}"*/
"use strict";BX.Tasks.CheckList=function(){var t=function(t){this.renderTo=t.renderTo;this.optionManager=new BX.Tasks.CheckList.OptionManager(t);this.treeStructure=this.buildTreeStructure(t.items);this.dragndrop=new BX.Tasks.CheckList.DragManager({dndZone:this.renderTo,treeStructure:this.treeStructure,canDrag:this.optionManager.getCanDrag()});this.clickEventHandler=new BX.Tasks.CheckList.ClickEventHandler({treeStructure:this.treeStructure});this.loader=new BX.Loader({target:this.renderTo});this.suffixDomId=t.suffixDomId;this.setOptionManager(this.treeStructure);this.setClickEventHandler(this.treeStructure);this.saveStableTreeStructure();this.bindControls();this.render();this.treeStructure.handleTaskOptions()};t.prototype.bindControls=function(){var t=this.renderTo.closest("form");if(t){BX.bind(t,"submit",BX.proxy((function(){this.treeStructure.appendRequestLayout()}),this))}var e=document.getElementById("addCheckList_"+this.suffixDomId);if(!e){e=top.document.getElementById("addCheckList_"+this.suffixDomId)}BX.bind(e,"click",this.onAddCheckListClick.bind(this));BX.bind(document,"mousedown",this.onDocumentMouseDown.bind(this));BX.bind(document,"mouseup",this.onDocumentMouseUp.bind(this))};t.prototype.buildTreeStructure=function(t){var e=new BX.Tasks.CheckListItem;e.setNodeId(0);if(t.length!==0){var i=this;var s=t.DESCENDANTS;Object.keys(s).forEach((function(t){e.add(i.makeTree(s[t]))}))}return e};t.prototype.makeTree=function(t){var e=t.FIELDS;var i=t.DESCENDANTS;e.action=t.ACTION;var s=new BX.Tasks.CheckListItem(e);s.fields.setTotalCount(0);if(typeof i!=="undefined"){var r=this;Object.keys(i).forEach((function(t){s.add(r.makeTree(i[t]));s.fields.setTotalCount(s.fields.getTotalCount()+1)}))}return s};t.prototype.setOptionManager=function(t){var e=this;t.optionManager=this.optionManager;t.getDescendants().forEach((function(t){e.setOptionManager(t)}))};t.prototype.setClickEventHandler=function(t){var e=this;t.clickEventHandler=this.clickEventHandler;t.getDescendants().forEach((function(t){e.setClickEventHandler(t)}))};t.prototype.getTreeStructure=function(){return this.treeStructure};t.prototype.render=function(){var t=this.treeStructure.getLayout();if(this.optionManager.converted){BX.append(t,this.renderTo)}else{var e="<div>PART_1</div><br><div>PART_2</div><div>PART_3</div><br><div>PART_4</div>";var i=["PART_1","PART_2","PART_3","PART_4"];i.forEach((function(t){e=e.replace(t,BX.message("TASKS_CHECKLIST_COMPONENT_JS_CHECKLIST_NOT_CONVERTED_MESSAGE_"+t))}));var s=new BX.UI.Alert({text:e,color:BX.UI.Alert.Color.PRIMARY,icon:BX.UI.Alert.Icon.DANGER});BX.append(s.getContainer(),this.renderTo)}};t.prototype.activateLoading=function(){this.loader.show();BX.addClass(this.renderTo.parentElement,"tasks-checklist-zone-disabled");BX.bind(window,"keydown",BX.proxy(this.disableTabbing,this))};t.prototype.deactivateLoading=function(){BX.removeClass(this.renderTo.parentElement,"tasks-checklist-zone-disabled");BX.unbind(window,"keydown",BX.proxy(this.disableTabbing,this));this.loader.hide()};t.prototype.disableTabbing=function(t){if(t.keyCode===9){t.preventDefault()}};t.prototype.getDestructedTreeStructure=function(t){var e=this;var i={};var s={accomplice:"A",auditor:"U"};Object.keys(t.fields).forEach((function(e){if(e==="members"){i[e]={};t.fields[e].forEach((function(t,r){i[e][r]={TYPE:s[t.type],NAME:BX.util.htmlspecialcharsback(t.nameFormatted)}}));return}else if(e==="attachments"){i[e]={};Object.keys(t.fields[e]).forEach((function(s){i[e][s]=t.fields[e][s]}));return}else if(e==="title"){i[e]=BX.util.htmlspecialcharsback(t.fields[e]);return}i[e]=t.fields[e]}));var r={FIELDS:i,ACTION:{MODIFY:t.checkCanUpdate(),REMOVE:t.checkCanRemove(),TOGGLE:t.checkCanToggle()},DESCENDANTS:[]};t.getDescendants().forEach((function(t){r.DESCENDANTS.push(e.getDestructedTreeStructure(t))}));return r};t.prototype.saveStableTreeStructure=function(){this.optionManager.setStableTreeStructure(this.getDestructedTreeStructure(this.treeStructure))};t.prototype.loadStableTreeStructure=function(){return this.buildTreeStructure(this.optionManager.getStableTreeStructure())};t.prototype.rerender=function(){BX.remove(this.treeStructure.panel);this.treeStructure=this.loadStableTreeStructure();this.dragndrop.treeStructure=this.treeStructure;this.clickEventHandler.treeStructure=this.treeStructure;this.setOptionManager(this.treeStructure);this.setClickEventHandler(this.treeStructure);while(this.renderTo.lastChild){this.renderTo.removeChild(this.renderTo.lastChild)}this.render();this.treeStructure.handleTaskOptions()};t.prototype.onAddCheckListClick=function(){if(this.treeStructure.checkActiveUpdateExist()){return}this.addCheckList().then((function(t){t.addCheckListItem()}));BX.Event.EventEmitter.emit("BX.Tasks.CheckListItem:CheckListChanged")};t.prototype.addCheckList=function(){if(!this.optionManager.getCanAdd()){return}var t=new BX.Promise;var e=BX.message("TASKS_CHECKLIST_COMPONENT_JS_NEW_CHECKLIST_TITLE_2").replace("#ITEM_NUMBER#",this.treeStructure.getDescendantsCount()+1);var i=new BX.Tasks.CheckListItem({TITLE:e});this.treeStructure.addCheckListItem(i).then((function(e){t.resolve(e)}));return t};t.prototype.onDocumentMouseDown=function(t){if(t.button!==0){return}this.focusElement=t.target.closest(".ui-ctl-textbox")};t.prototype.onDocumentMouseUp=function(t){if(t.button!==0){return}var e=false;var i=[t.target.closest(".tasks-checklist-item-content-block"),t.target.closest(".tasks-checklist-item-editor-panel-container"),t.target.closest(".tasks-checklist-item-attachment-file"),t.target.closest(".tasks-checklist-header-name"),t.target.closest("#files_chooser"),t.target.closest("#DiskFileDialog"),t.target.closest(".ui-selector-dialog")];i.forEach((function(t){if(!e&&t!==null){e=true}}));if(e||this.focusElement){return}this.treeStructure.disableAllUpdateModes();this.treeStructure.handleTaskOptions()};t.prototype.onSave=function(){this.treeStructure.disableAllGroup()};return t}();BX.Tasks.CheckList.ClickEventHandler=function(){var t=function(){this.pos={x:0,y:0};this.time=0;this.timeoutHandle=0;this.clicked=0};t.prototype.registerClickDoneCallback=function(t){this.callback=t};t.prototype.handleMouseDown=function(t){if(this.timeoutHandle>0){this.clearTimeout()}this.time=(new Date).valueOf();this.pos={x:t.clientX,y:t.clientY}};t.prototype.handleMouseUp=function(t){if(this.timeoutHandle>0){this.clearTimeout()}if((new Date).valueOf()-this.time<400&&Math.abs(this.pos.x-t.clientX)<2){this.clicked+=1;if(this.clicked<2){this.timeoutHandle=window.setTimeout(this.callback,150);setTimeout(this.clearClicked.bind(this),200)}else{this.clearTimeout();setTimeout(this.clearClicked.bind(this),200)}}this.time=0};t.prototype.clearTimeout=function(){window.clearTimeout(this.timeoutHandle);this.timeoutHandle=0};t.prototype.clearClicked=function(){this.clicked=0};return t}();BX.Tasks.CheckList.OptionManager=function(){var t=function(t){this.userId=t.userId;this.entityId=t.entityId;this.entityType=t.entityType;this.userPath=t.userPath;this.prefix=t.prefix;this.commonAction=t.commonAction;this.converted=t.converted;this.ajaxActions=t.ajaxActions;this.attachments=t.attachments;this.diskUrls=t.diskUrls;this.showCompleteAllButton=t.showCompleteAllButton;this.collapseOnCompleteAll=t.collapseOnCompleteAll;this.isNetworkEnabled=t.isNetworkEnabled;this.showCompleted=t.options.SHOW_COMPLETED;this.defaultMemberSelectorType=t.options.DEFAULT_MEMBER_SELECTOR_TYPE;this.showOnlyMine=false;this.stableTreeStructure=null;this.slider=BX.SidePanel.Instance.getTopSlider()};t.prototype.getUserPath=function(){return this.userPath};t.prototype.getUserId=function(){return this.userId};t.prototype.getPrefix=function(){return this.prefix};t.prototype.getCanAdd=function(){return this.commonAction.canAdd};t.prototype.getCanDrag=function(){return this.commonAction.canDrag};t.prototype.getCanAddAccomplice=function(){return this.commonAction.canAddAccomplice};t.prototype.getShowCompleteAllButton=function(){return this.showCompleteAllButton};t.prototype.getCollapseOnCompleteAll=function(){return this.collapseOnCompleteAll};t.prototype.getShowCompleted=function(){return this.showCompleted};t.prototype.setShowCompleted=function(t){this.showCompleted=t;this.updateTaskOption("show_completed",t)};t.prototype.getShowOnlyMine=function(){return this.showOnlyMine};t.prototype.setShowOnlyMine=function(t){this.showOnlyMine=t};t.prototype.getDefaultMemberSelectorType=function(){return this.defaultMemberSelectorType};t.prototype.getStableTreeStructure=function(){return this.stableTreeStructure};t.prototype.setStableTreeStructure=function(t){this.stableTreeStructure=t};t.prototype.updateTaskOption=function(t,e){BX.ajax.runComponentAction("bitrix:tasks.widget.checklist.new","updateTaskOption",{mode:"class",data:{option:t,value:e,userId:this.userId,entityType:this.entityType}}).then(function(t){}.bind(this),function(t){}.bind(this))};return t}();BX.Tasks.CheckList.DragManager=function(){var t=function(t){this.dragObject={};this.dropObject={};this.itemDropPlace=BX.create("div",{props:{className:"tasks-checklist-item tasks-checklist-item-drop-place droppable"},children:[BX.create("div",{props:{className:"tasks-checklist-item-inner"}})]});this.checkListDropPlace=BX.create("div",{props:{className:"tasks-checklist-wrapper-drop-place droppable"}});this.canDrag=t.canDrag;this.dndZone=t.dndZone;this.treeStructure=t.treeStructure;BX.bind(document,"mousedown",this.onMouseDown.bind(this))};t.prototype.onMouseDown=function(t){if(t.button!==0||!this.canDrag){return}var e=t.target.closest(".tasks-checklist-item-dragndrop")||t.target.closest(".tasks-checklist-wrapper-dragndrop");if(!e){return}var i=this.getNodeByDragButton(e);if(!i||i.getCheckList().fields.getIsSelected()){return}this.dragObject={};this.dropObject={};this.dragObject.node=i;this.dragObject.downX=t.pageX;this.dragObject.downY=t.pageY;this.disableSelection(this.dndZone);BX.bind(document,"mousemove",BX.proxy(this.onMouseMove,this));BX.bind(document,"mouseup",BX.proxy(this.onMouseUp,this));return false};t.prototype.getNodeByDragButton=function(t){return this.treeStructure.findChild(t.parentElement.parentElement.id)};t.prototype.getDropObjectType=function(t){if(BX.hasClass(t,"tasks-checklist-item-drop-place")||BX.hasClass(t,"tasks-checklist-wrapper-drop-place")){return"dropPlace"}if(BX.hasClass(t,"tasks-checklist-item-inner")){return"node"}if(BX.hasClass(t,"tasks-checklist-items-list-actions")){return"addButton"}if(BX.hasClass(t,"tasks-checklist-header-wrapper")){return"checklist"}};t.prototype.getDropObjectNode=function(){var t=null;var e=this.dropObject.targetDrop;switch(this.dropObject.type){case"node":t=this.treeStructure.findChild(e.parentElement.id);if(this.dropObject.position==="bottom"&&t.getDescendantsCount()>0){this.dropObject.position="top";t=t.getFirstDescendant()}break;case"addButton":t=this.treeStructure.findChild(e.parentElement.parentElement.id);this.dropObject.position="bottom";break;case"checklist":t=this.treeStructure.findChild(e.parentElement.id);if(!this.dragObject.node.isCheckList()){this.dropObject.position="top"}break}return t};t.prototype.spawnDropPlace=function(){switch(this.dropObject.type){case"node":if(this.dropObject.position==="top"){BX.insertBefore(this.itemDropPlace,this.dropObject.node.getContainer())}else{BX.insertAfter(this.itemDropPlace,this.dropObject.node.getContainer())}break;case"addButton":if(this.dropObject.node.getDescendantsCount()>0){BX.insertAfter(this.itemDropPlace,this.dropObject.node.getLastDescendant().getContainer())}else{BX.append(this.itemDropPlace,this.dropObject.node.getSubItemsContainer())}break;case"checklist":if(this.dragObject.node.isCheckList()){if(this.dropObject.position==="top"){BX.insertBefore(this.checkListDropPlace,this.dropObject.node.getContainer())}else{BX.insertAfter(this.checkListDropPlace,this.dropObject.node.getContainer())}}else if(this.dropObject.node.getDescendantsCount()>0){BX.insertBefore(this.itemDropPlace,this.dropObject.node.getFirstDescendant().getContainer())}else{BX.append(this.itemDropPlace,this.dropObject.node.getSubItemsContainer())}break}};t.prototype.onMouseMove=function(t){if(!this.dragObject.node){return}if(!this.dragObject.avatar){var e=t.pageX-this.dragObject.downX;var i=t.pageY-this.dragObject.downY;if(Math.abs(e)<5&&Math.abs(i)<5){return}this.dragObject.avatar=this.createAvatar();if(!this.dragObject.avatar){this.dragObject={};return}this.startDrag()}this.moveAvatar(t);var s=this.findDroppable(t);if(!s){return false}var r=this.getDropObjectType(s);if(r==="node"||r==="checklist"&&this.dragObject.node.isCheckList()){var o=this.getCoords(s);this.dropObject.position=t.pageY<o.top+o.height/2?"top":"bottom";this.dropObject.targetDrop=s;this.dropObject.type=r;this.dropObject.node=this.getDropObjectNode();this.spawnDropPlace()}else if(r!=="dropPlace"&&s!==this.dropObject.targetDrop){this.dropObject.position=r==="checklist"?"top":"bottom";this.dropObject.targetDrop=s;this.dropObject.type=r;this.dropObject.node=this.getDropObjectNode();this.spawnDropPlace()}return false};t.prototype.createAvatar=function(){var t=this.dragObject.node.getContainer();var e=t.cloneNode(true);if(this.dragObject.node.isCheckList()){BX.addClass(e,"tasks-checklist-wrapper-draggable");if(!BX.hasClass(e,"tasks-checklist-collapse")){BX.addClass(e,"tasks-checklist-collapse")}e.querySelector(".tasks-checklist-items-wrapper").style.height=0}else{BX.addClass(e,"tasks-checklist-item-draggable");if(this.dragObject.node.getDescendantsCount()>0){BX.append(BX.create("div",{props:{className:"tasks-checklist-group-draggable"}}),e)}}BX.removeClass(e.querySelector(".droppable"),"droppable");e.style.left=this.dragObject.downX+"px";e.style.width=t.offsetWidth/2+"px";return e};t.prototype.moveAvatar=function(t){var e=this.dragObject.node.isCheckList()?10:20;var i=25;this.dragObject.avatar.style.left=t.pageX-e+"px";this.dragObject.avatar.style.top=t.pageY-i+"px"};t.prototype.startDrag=function(){var t=this.dragObject.avatar;BX.hide(this.dragObject.node.getContainer());BX.append(t,document.body);t.style.zIndex=9999;t.style.position="absolute";if(this.dragObject.node.isCheckList()){this.treeStructure.getDescendants().forEach((function(t){if(!t.fields.getIsCollapse()){t.toggleCollapse();t.fields.setIsCollapse(false)}}))}};t.prototype.onMouseUp=function(t){if(this.dragObject.avatar){this.finishDrag(t)}this.dragObject={};this.enableSelection();BX.unbind(document,"mousemove",BX.proxy(this.onMouseMove,this));BX.unbind(document,"mouseup",BX.proxy(this.onMouseUp,this))};t.prototype.finishDrag=function(t){var e=this.findDroppable(t);BX.remove(this.itemDropPlace);BX.remove(this.checkListDropPlace);if(!e||this.dragObject.node.isCheckList()&&this.dropObject.type!=="checklist"){this.cancelDrag()}else{this.endDrag()}if(this.dragObject.node.isCheckList()){this.treeStructure.getDescendants().forEach((function(t){if(!t.fields.getIsCollapse()){t.toggleCollapse()}}))}};t.prototype.cancelDrag=function(){this.dragObject.node.getContainer().style.display="";BX.remove(this.dragObject.avatar)};t.prototype.endDrag=function(){var t=this.dragObject.node;var e=this.dropObject.node;BX.remove(this.dragObject.avatar);if(this.dropObject.type==="node"||this.dropObject.type==="checklist"&&t.isCheckList()){t.move(e,this.dropObject.position)}else{t.makeChildOf(e,this.dropObject.position)}t.getContainer().style.display=""};t.prototype.findDroppable=function(t){BX.hide(this.dragObject.avatar);var e=document.elementFromPoint(t.clientX,t.clientY);BX.show(this.dragObject.avatar);if(e==null){return null}return e.closest(".droppable")};t.prototype.getCoords=function(t){var e=t.getBoundingClientRect();return{top:e.top+pageYOffset,left:e.left+pageXOffset,width:e.width,height:e.height}};t.prototype.enableSelection=function(){BX.removeClass(document.body,"tasks-checklist-zone-noselect")};t.prototype.disableSelection=function(){BX.addClass(document.body,"tasks-checklist-zone-noselect")};return t}();(function(){if(typeof BX.Tasks.Component.TasksWidgetCheckListNew!="undefined"){return}BX.Tasks.Component.TasksWidgetCheckListNew=BX.Tasks.Component.extend({sys:{code:"checklist"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component)},bindEvents:function(){}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:101:"/bitrix/components/bitrix/tasks.widget.member.selector/templates/.default/logic.min.js?16992580828977";s:6:"source";s:82:"/bitrix/components/bitrix/tasks.widget.member.selector/templates/.default/logic.js";s:3:"min";s:86:"/bitrix/components/bitrix/tasks.widget.member.selector/templates/.default/logic.min.js";s:3:"map";s:86:"/bitrix/components/bitrix/tasks.widget.member.selector/templates/.default/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetMemberSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetMemberSelector=BX.Tasks.Component.extend({sys:{code:"tdp-mem-sel",types:[]},methodsStatic:{instances:[],getInstance:function(e){return BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]},addInstance:function(e,t){BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]=t}},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);BX.Tasks.Component.TasksWidgetMemberSelector.addInstance(this.id(),this);this.getSelector();if(this.option("inputSpecial")){this.getSelector().bindEvent("change",this.onChanged.bind(this))}var e=this;if(this.option("userType")==="auditor"||this.option("userType")==="accomplice"){BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:"+this.option("userType")+"Added",(function(t){e.getSelector().onSelectorItemSelected(t.data)}))}BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",(function(t){e.getSelector().onControlItemSelected(t.data)}));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",(function(t){e.getSelector().onSelectorItemDeselected(t.data)}))},onChanged:function(e){var t="";var i="";if(e[0]){t=this.getSelector().get(e[0]).id()}this.control("sole-input").value=t;if(e[0]&&e[0].substr(0,2)==="SG"){i=this.getSelector().get(e[0]).opts.data.DISPLAY;BX.onCustomEvent(this,"onProjectChanged",{groupId:e,owner:i})}else{BX.onCustomEvent(this,"onProjectChanged",{})}},getSelector:function(){return this.subInstance("selector",(function(){var e={scope:this.scope(),hidePreviousIfSingleAndRequired:true,data:this.option("data"),max:this.option("max"),min:this.option("min"),nameTemplate:this.option("nameTemplate"),path:this.option("path"),preRendered:true,popupOffsetTop:3,popupOffsetLeft:40,readOnly:this.option("readOnly"),parent:this,userType:this.option("userType"),taskLimitExceeded:this.option("taskLimitExceeded"),networkEnabled:this.option("networkEnabled")};var t=this.option("types");e.mode=t.USER?"user":"group";e.useAdd=!!t["USER.MAIL"]&&this.option("modulesAvailable").mail;var i=new this.constructor.ItemManager(e);i.bindEvent("change",function e(){this.fireEvent("change",[arguments[0]])}.bind(this));return i}))},count:function(){return this.getSelector().count()},export:function(){return this.getSelector().exportItemData(true)},replaceItem:function(e,t){this.getSelector().replaceItem(e,t)},value:function(){return this.getSelector().value()},replaceAll:function(e){var t=this.getSelector();t.unload({itemFx:false,checkRestrictions:false});t.load(e)},readOnly:function(e){this.getSelector().readonly(e)}}});BX.Tasks.Component.TasksWidgetMemberSelector.ItemManager=BX.Tasks.UserItemSet.extend({dialog:null,dialogCallback:true,sys:{code:"tdp-mem-sel-is"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:true,prefixId:true,mode:"all",path:{},hidePreviousIfSingleAndRequired:false},methods:{construct:function(){this.callConstruct(BX.Tasks.UserItemSet);this.initDialog()},getDialog:function(){if(this.dialog){return this.dialog}this.dialog=new BX.UI.EntitySelector.Dialog({id:"tasksMemberSelector_"+this.option("userType"),enableSearch:true,multiple:this.option("max")>1,context:"TASKS_MEMBER_SELECTOR_EDIT_"+this.option("userType"),entities:this.getDialogEntities(),preselectedItems:this.getDialogSelectedItems(),autoHide:true,autoHideHandler:function(e){if(!BX.Dom.hasClass(e.target,"task-form-field-item-delete")){return true}var t=e.target.parentElement;var i=this.getItemByNode(t);return!i||i.detectScope()!==t}.bind(this),hideOnSelect:this.option("userType")==="responsible",events:{"Item:onSelect":function(e){if(this.dialogCallback===false){return}var t=e.getData().item;var i=this.prepareUserData(t);BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",i)}.bind(this),"Item:onDeselect":function(e){if(this.dialogCallback===false){return}if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min===1&&this.count()===1){this.forceDeleteFirst()}else{var t=e.getData().item;var i=this.prepareUserData(t);BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",i)}}.bind(this),onHide:function(){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0&&this.count()<1){this.restoreKept()}}.bind(this)}});return this.dialog},initDialog:function(){var e=this.scope().getElementsByClassName("js-id-tdp-mem-sel-is-control");for(var t=0;t<e.length;t++){var i=e[t];i.addEventListener("click",function(e){var t=this.option("userType");var i=this.option("taskLimitExceeded");if((t==="accomplice"||t==="auditor")&&i){BX.UI.InfoHelper.show("limit_tasks_observers_participants",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"taskEdit",subject:t}});return}this.getDialog().setTargetNode(e);this.getDialog().show()}.bind(this))}},getDialogSelectedItems:function(){var e=this.option("data");var t=[];var i=null;for(var s=0;s<e.length;s++){i=this.prepareItemData(e[s]);if(i){t.push(i)}}return t},getDialogUndeselectedItems:function(){var e=this.option("data");var t=[];if(this.option("min")!==1||this.option("max")!==1){return}var i=null;for(var s=0;s<e.length;s++){i=this.prepareItemData(e[s]);if(i){t.push(i)}}return t},getDialogEntities:function(){var e=this.option("mode");var t=this.option("networkEnabled");var i=[];if(e==="user"){i=[{id:"user",options:{emailUsers:true,networkUsers:t,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true}},{id:"department"}]}else if(e==="group"){i=[{id:"project"}]}return i},prepareItemData:function(e){var t=0;if(typeof e==="string"){t=e.replace(/[A-Za-z]/gi,"")}else if(typeof e==="object"){if(e.ID){t=e.ID}else if(e.id){t=e.id}}if(t<=0){return null}var i=this.option("mode");return[i==="group"?"project":"user",t]},prepareUserData:function(e){var t=e.getCustomData();var i=e.getEntityType();var s=this.option("mode");return{AVATAR:e.avatar,DESCRIPTION:"",ENTITY_TYPE:s==="group"?"SG":"U",ID:e.getId(),NAME:t.get("name"),LAST_NAME:t.get("lastName"),EMAIL:t.get("email"),nameFormatted:BX.Text.encode(e.getTitle()),NETWORK_ID:"",URL:e.getLink(),USER_TYPE:i,type:{crmemail:false,extranet:i==="extranet",email:i==="email",network:i==="network"},VALUE:(s==="group"?"SG":"U")+e.getId()}},onSearchBlurred:function(){var e=BX("invite-email-email-user-popup");if(e!==null&&e.style.display==="block"){return}if(this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0){this.restoreKept()}}},onSelectorItemSelected:function(e){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0){this.vars.changed=true;var t=this.extractItemValue(e);if(!this.hasItem(t)){this.addItem(e);this.vars.toDelete=false;if(!this.checkCanAddItems()){this.instances.selector.close();this.onSearchBlurred()}}this.resetInput()}else{this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)}},onControlItemSelected:function(e){this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)},openAddForm:function(){var e=this.option("userType");var t=this.option("taskLimitExceeded");if((e==="accomplice"||e==="auditor")&&t){BX.UI.InfoHelper.show("limit_tasks_observers_participants",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"taskEdit",subject:e}});return}if(this.option("hidePreviousIfSingleAndRequired")){if(this.vars.constraint.min==1&&this.vars.constraint.max==1){this.forceDeleteFirst()}}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},onItemDeleteByCross:function(e){if(this.callMethod(BX.Tasks.UserItemSet,"onItemDeleteByCross",arguments)){return true}if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min===1&&this.count()===1){this.forceDeleteFirst();this.getDialog().setTargetNode(this.scope());this.getDialog().show()}return false},forceDeleteFirst:function(){var e=this.getItemFirst();if(e){this.vars.toDelete=e.data();this.deleteItem(e.value(),{checkRestrictions:false})}},restoreKept:function(){if(this.vars.toDelete){this.addItem(this.vars.toDelete,{checkRestrictions:false});this.vars.toDelete=false}},addItem:function(e,t){this.callMethod(BX.Tasks.UserItemSet,"addItem",arguments);this.selectDialogItem(e)},deleteItem:function(e,t){if(this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.unselectDialogItem(e);return true}return false},unselectDialogItem:function(e){if(!this.getDialog()){return}this.dialogCallback=false;if(typeof e==="object"){e=e.data()}e=this.prepareItemData(e);if(e){var t=this.getDialog().getItem(e);t&&t.deselect()}this.dialogCallback=true},selectDialogItem:function(e){if(!this.getDialog()){return}this.dialogCallback=false;e=this.prepareItemData(e);if(e){var t=this.getDialog().getItem(e);t&&t.select(true)}this.dialogCallback=true}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:95:"/bitrix/components/bitrix/tasks.widget.optionbar/templates/.default/logic.min.js?16992580821317";s:6:"source";s:76:"/bitrix/components/bitrix/tasks.widget.optionbar/templates/.default/logic.js";s:3:"min";s:80:"/bitrix/components/bitrix/tasks.widget.optionbar/templates/.default/logic.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/tasks.widget.optionbar/templates/.default/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetOptionBar!="undefined"){return}BX.Tasks.Component.TasksWidgetOptionBar=BX.Tasks.Component.extend({sys:{code:"wg-optbar"},methods:{bindEvents:function(){this.bindDelegateControl("flag","click",this.passCtx(this.onToggleFlag))},onToggleFlag:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var i=this.control(e);var a=BX.data(t,"flag-name");var s=BX.data(t,"yes-value")||"Y";var n=BX.data(t,"no-value")||"N";if(BX.type.isElementNode(i)){i.value=t.checked?s:n}if(a==="TASK_CONTROL"&&i.value==="Y"&&this.option("taskLimitExceeded")){i.value=n;t.checked=false;BX.UI.InfoHelper.show("limit_tasks_control",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"taskEdit"}})}this.fireEvent("toggle",[a,i.value==s])}},toggleFlag:function(t,e){},switchOption:function(t,e){t=t.toLowerCase().replace(/_/g,"-");var i=this.control("flag-"+t);if(i){if(e){BX.Tasks.Util.enable(i)}else{BX.Tasks.Util.disable(i);if(this.isOptionChecked(i)){i.checked=false;this.onToggleFlag(i)}}BX.data(this.control("flag-label-"+t),"hint-enabled",!e)}},switchFlag:function(t,e){return this.switchOption(t,e)},isOptionChecked:function(t){return t.checked}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/tasks.widget.timeestimate/templates/.default/logic.min.js?16992580831134";s:6:"source";s:79:"/bitrix/components/bitrix/tasks.widget.timeestimate/templates/.default/logic.js";s:3:"min";s:83:"/bitrix/components/bitrix/tasks.widget.timeestimate/templates/.default/logic.min.js";s:3:"map";s:83:"/bitrix/components/bitrix/tasks.widget.timeestimate/templates/.default/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetTimeEstimate!="undefined"){return}BX.Tasks.Component.TasksWidgetTimeEstimate=BX.Tasks.Component.extend({sys:{code:"timeestimate"},methods:{bindEvents:function(){var t=this.controlAll("time");for(var e=0;e<t.length;e++){BX.Tasks.Util.bindInstantChange(t[e],this.onChange.bind(this))}this.bindDelegateControl("flag","click",this.passCtx(this.onToggleFlag))},onChange:function(){var t=this.control("hour");var e=this.control("minute");var n=this.control("second");if(!BX.type.isElementNode(n)){return}var a=0;if(BX.type.isElementNode(t)){var s=parseInt(t.value);if(!isNaN(s)){a=s}}var i=0;if(BX.type.isElementNode(e)){var s=parseInt(e.value);if(!isNaN(s)){i=s}}n.value=i*60+a*3600},onToggleFlag:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var n=this.control(e);var a=BX.data(t,"yes-value")||"Y";var s=BX.data(t,"no-value")||"N";if(BX.type.isElementNode(n)){n.value=t.checked?a:s}BX.Tasks.Util.fadeToggleByClass(this.control("inputs"),200)}}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:101:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/reminder/logic.min.js?16992580839380";s:6:"source";s:82:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/reminder/logic.js";s:3:"min";s:86:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/reminder/logic.min.js";s:3:"map";s:86:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/reminder/logic.map.js";}"*/
BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskDetailPartsReminder!="undefined"){return}BX.Tasks.Component.TaskDetailPartsReminder=BX.Tasks.Util.ItemSet.extend({sys:{code:"reminder"},constants:{UNIT_DAY:"D",UNIT_HOUR:"H"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.ItemSet);this.vars.editItemValue=0;this.instances.windows={};this.instances.form=new e({scope:this.control("form"),id:this.id()+"-form",parent:this});this.setTaskId(this.option("taskId"));this.setTaskDeadLine(this.option("taskDeadline"));this.instances.form.bindEvent("save",BX.delegate(this.onItemApply,this));this.bindEvent("setTaskDeadLine",BX.delegate(this.setTaskDeadLine,this));BX.addCustomEvent(window,"tasksTaskEventChangeDeadline",BX.delegate(this.onTaskDeadLineChange,this));BX.addCustomEvent(window,"tasksTaskEventAddReminder",BX.delegate(this.openAddForm,this))},extractItemValue:function(){return this.vars.idOffset++},extractItemDisplay:function(){return"1"},openUpdateForm:function(t){var e=this.vars.items[t];this.vars.editItemValue=t;this.instances.form.open(e.scope(),e.vars.data)},createItem:function(e){e=t.prepareData(e);var i=this.getNodeByTemplate("item",e)[0];BX.append(i,this.control("items"));var s=new t({scope:i,data:e,auxData:this.option("auxData"),parent:this});return s},setTaskId:function(t){this.vars.taskId=t?t:0},setTaskDeadLine:function(t){var e=0;if(BX.type.isNotEmptyString(t)){e=this.dateStringToStamp(t)}this.instances.form.setDeadLineStamp(e)},openAddForm:function(t){this.vars.editItemValue=0;this.instances.form.open(t)},onTaskDeadLineChange:function(t,e){if(t==this.vars.taskId){this.setTaskDeadLine(e)}},onItemApply:function(t){if(this.vars.editItemValue!=0){this.vars.items[this.vars.editItemValue].update(t);this.syncAllIfCan()}else{this.addItem(t)}},fireChangeEvent:function(t){this.callMethod(BX.Tasks.Util.ItemSet,"fireChangeEvent",arguments);if(!t.load){this.syncAllIfCan()}},getDateDiff:function(t,e){if(!BX.type.isNumber(t)){t=this.dateStringToStamp(t)}if(!BX.type.isNumber(e)){e=this.dateStringToStamp(e)}var i=e-t;var s=this.UNIT_HOUR;if(i%86400==0){s=this.UNIT_DAY;i=Math.floor(i/86400)}else{i=Math.floor(i/3600)}return{diff:i,unit:s}},dateStampToString:function(t,e){var i=new Date(t*1e3);return BX.date.format(e,i,false,true)},dateStringToStamp:function(t){var e=BX.parseDate(t,true);if(e!=null){return Math.floor(parseInt(e.getTime())/1e3)}return 0},syncAll:function(){var t=parseInt(this.option("taskId"));if(!t){return}var e=[];for(var i in this.vars.items){e.push(this.vars.items[i].data())}BX.ajax.runComponentAction("bitrix:tasks.task","setReminder",{mode:"class",data:{taskId:t,data:e}}).then(function(t){}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))}}});var t=BX.Tasks.Util.ItemSet.Item.extend({sys:{code:"item"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.ItemSet.Item);this.vars.data=this.option("data");this.vars.randomTag=Math.round(Math.random()*1e5);this.bindEvents()},bindEvents:function(){this.bindDelegateControl("edit","click",BX.delegate(this.onEditClick,this))},data:function(){return{TRANSPORT:this.vars.data.TRANSPORT,TYPE:this.vars.data.TYPE,REMIND_DATE:this.vars.data.REMIND_DATE,RECEPIENT_TYPE:this.vars.data.RECEPIENT_TYPE}},value:function(){return this.vars.data.VALUE},display:function(){return this.vars.data.DISPLAY},update:function(e){e=t.prepareData(e);this.control("transport").value=e.TRANSPORT;this.control("type").value=e.TYPE;this.control("remind-date").value=e.REMIND_DATE;this.control("recipient-type").value=e.RECEPIENT_TYPE;this.control("edit").innerHTML=e.REMINDER_TEXT;BX[e.TRANSPORT=="J"?"addClass":"removeClass"](this.control("info"),"transport-j");this.vars.data=BX.mergeEx(this.vars.data,e)},delete:function(){var t=this.value();BX.remove(this.sys.scope);this.sys.scope=null;this.ctrls=null;this.vars.data=null;return t},onEditClick:function(t){this.parent().openUpdateForm(this.value());BX.PreventDefault(t)},onDeleteClick:function(t){this.parent().deleteItem(this.value());BX.PreventDefault(t)}}});t.prepareData=function(t){var e="";if(t.RECEPIENT_TYPE=="R"||t.RECEPIENT_TYPE=="O"||t.RECEPIENT_TYPE=="S"){e=BX.message("TASKS_TTDP_TEMPLATE_REMINDER_RECEPIENT_TYPE_"+t.RECEPIENT_TYPE)}t.REMINDER_TEXT=t.REMIND_DATE+" "+e;t.TRANSPORT_CLASS=t.TRANSPORT=="J"?"transport-j":"";return t};var e=BX.Tasks.Util.Widget.extend({sys:{code:"form"},constants:{REMINDER_TYPE_DEADLINE:"D",REMINDER_TYPE_COMMON:"A"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.vars.data={TYPE:"A",RECEPIENT_TYPE:"R",REMIND_DATE:"",TRANSPORT:"J"};this.vars.deadLine=0;this.vars.formatValue=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"))},load:function(t){if(!BX.type.isNotEmptyString(t.REMIND_DATE)){return}this.setType(t.TYPE);this.setRecipientType(t.RECEPIENT_TYPE);this.setTransportType(t.TRANSPORT);if(t.TYPE==this.REMINDER_TYPE_DEADLINE){var e=this.parent().getDateDiff(t.REMIND_DATE,this.vars.deadLine);this.setUnit(e.unit);this.setMultiplier(e.diff)}else{this.setDate(t.REMIND_DATE,true)}},reset:function(){this.setType("A");this.setRecipientType("R");this.setDate("",true);this.setTransportType("J");this.setMultiplier(1);this.setUnit(this.parent().UNIT_DAY)},open:function(t,e){var i=this.getWindow(t);if(typeof e!="undefined"){this.load(e)}else{this.reset()}this.changeCSSFlag("mode-update",typeof e!="undefined");i.show()},close:function(){this.getWindow().close();this.reset()},getWindow:function(t){if(typeof this.instances.window=="undefined"){this.instances.window=new BX.PopupWindow(this.id(),t,{autoHide:true,closeByEsc:true,content:this.scope(),overlay:false,lightShadow:true,closeIcon:true,draggable:false,titleBar:false,angle:{position:"top"},offsetTop:12,offsetLeft:45,events:{onPopupClose:BX.delegate(this.onFormClose,this)}});this.bindControl("change-type","click",this.passCtx(this.onChangeType));this.bindControl("change-recipient","change",this.passCtx(this.onChangeRecipientType));this.bindDelegateControl("change-transport","click",this.passCtx(this.onChangeTransportType));this.bindControl("submit","click",BX.delegate(this.onSubmit,this))}if(typeof this.instances.datepicker=="undefined"){var e=this.control("date");if(BX.type.isElementNode(e)){var i=new BX.Tasks.Util.DatePicker({scope:e,defaultTime:this.optionP("auxData").COMPANY_WORKTIME.HOURS.START,calendarSettings:this.optionP("auxData").CALENDAR_SETTINGS});i.bindEvent("change",BX.delegate(this.onChangeRemindDate,this));i.bindEvent("open",BX.delegate(this.closeTypeSubWindow,this));this.instances.datepicker=i}}if(BX.type.isElementNode(t)){this.instances.window.setBindElement(t)}return this.instances.window},setDeadLineStamp:function(t){this.vars.deadLine=t;this.toggleDeadLineMode()},onChangeRemindDate:function(t,e){this.setDate(e,false)},setMultiplier:function(t){this.control("time-multiplier").value=t},setUnit:function(t){this.control("time-unit").value=t},setDate:function(t,e){if(typeof t=="undefined"){return}this.vars.data.REMIND_DATE=t;if(e){this.instances.datepicker.setValue(t)}},setType:function(t){if(!t){return}this.vars.data.TYPE=t;this.setCSSMode("type",t.toLowerCase())},setRecipientType:function(t){if(!t){return}this.vars.data.RECEPIENT_TYPE=t;this.control("change-recipient").value=t},setTransportType:function(t){if(!t){return}this.vars.data.TRANSPORT=t;this.setCSSMode("transport",t.toLowerCase())},toggleDeadLineMode:function(){var t=this.vars.deadLine<=0;if(t){if(this.vars.data.TYPE==this.REMINDER_TYPE_DEADLINE){this.setType(this.REMINDER_TYPE_COMMON);this.setDate(0,"")}}this.changeCSSFlag("no-deadline",t)},getDeadLineOffset:function(){var t=parseInt(this.control("time-multiplier").value);if(isNaN(t)){t=0}var e=this.control("time-unit").value=="D"?86400:3600;return this.parent().dateStampToString(this.vars.deadLine-t*e,this.vars.formatValue)},onSubmit:function(){if(this.vars.data.TYPE==this.REMINDER_TYPE_DEADLINE){this.vars.data.REMIND_DATE=this.getDeadLineOffset()}if(this.vars.data.REMIND_DATE.length==""){return}this.fireEvent("save",[BX.clone(this.vars.data)]);this.close()},onFormClose:function(){this.closeTypeSubWindow();this.closeCalendarSubWindow()},closeTypeSubWindow:function(){if(typeof this.instances.typeWindow!="undefined"&&this.instances.typeWindow!=null){this.instances.typeWindow.popupWindow.close()}},closeCalendarSubWindow:function(){if(typeof this.instances.datepicker!="undefined"&&this.instances.datepicker!=null){this.instances.datepicker.closeCalendar()}},onChangeTransportType:function(t){var e=BX.data(t,"transport");if(typeof e!="undefined"&&e!=null){this.setTransportType(e)}},onChangeRecipientType:function(t){this.setRecipientType(t.value)},onChangeType:function(t){var e=this;var i=[{text:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_A"),title:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_A_EX"),className:"menu-popup-no-icon",onclick:function(){e.setType("A");this.popupWindow.close()}},{text:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_D"),title:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_D_EX"),className:"menu-popup-no-icon",onclick:function(){e.setType("D");this.popupWindow.close()}}];var s=this.id()+"-form-transport";BX.PopupMenu.show(s,t,i,{offsetTop:0,events:{onPopupShow:BX.delegate(this.closeCalendarSubWindow,this)}});this.instances.typeWindow=BX.PopupMenu.getMenuById(s)}}})})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/tasks.widget.replication/templates/.default/logic.min.js?169925808310967";s:6:"source";s:78:"/bitrix/components/bitrix/tasks.widget.replication/templates/.default/logic.js";s:3:"min";s:82:"/bitrix/components/bitrix/tasks.widget.replication/templates/.default/logic.min.js";s:3:"map";s:82:"/bitrix/components/bitrix/tasks.widget.replication/templates/.default/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetReplication!="undefined"){return}var e=BX.Tasks.Util.Widget.extend({sys:{code:"timepicker"},options:{value:"",inputId:"",controlBind:"class"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.bindDelegateControl("display","click",this.openClock.bind(this));this.vars.formatDisplay=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME").replace(BX.message("FORMAT_DATE"),"").replace(":SS","").replace("/SS","").trim());this.vars.formatValue=BX.date.convertBitrixFormat("HH:MI");this.setTime(this.parseTime(this.option("value")));BX.bind(BX(this.option("inputId")),"change",this.passCtx(this.onTimeChange))},openClock:function(){var e="bxShowClock_"+this.option("inputId");if(BX.type.isFunction(window[e])){window[e].call(window)}},onTimeChange:function(e){var t=this.parseTime(e.value);this.setTime(t);this.fireEvent("change",[t])},setTime:function(e){var t=3600*e.h+60*e.m;this.control("display").value=this.dateStampToString(t,this.vars.formatDisplay);this.control("value").value=this.dateStampToString(t,this.vars.formatValue)},parseTime:function(e){var t=e.toString().trim();var a=0;var i=0;var n=t.match(new RegExp("^(\\d{1,2})[^\\d]+(\\d{2})","i"));if(n){a=n[1]?parseInt(n[1]):0;i=n[2]?parseInt(n[2]):0}n=t.match(new RegExp("(am|pm)","i"));var s=n&&n[1];var r=s&&n[1].toLowerCase()=="pm";if(!isNaN(a)&&!isNaN(i)&&(a>=0&&a<=23)&&(i>=0&&i<=59)){if(s){if(r){if(a!=12){a+=12}}else{if(a==12){a=0}}}return{h:a,m:i}}return false},dateStampToString:function(e,t){return BX.date.format(t,new Date(e*1e3),false,true)}}});BX.Tasks.Component.TasksWidgetReplication=BX.Tasks.Component.extend({sys:{code:"replication"},options:{data:false},constants:{PERIOD_DAILY:"daily",PERIOD_WEEKLY:"weekly",PERIOD_MONTHLY:"monthly",PERIOD_YEARLY:"yearly",REPEAT_TILL_ENDLESS:"endless",REPEAT_TILL_TIMES:"times",REPEAT_TILL_DATE:"date",MONDAY:0,TUESDAY:1,THURSDAY:3,SUNDAY:6},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.vars.prevPeriod=this.getCurrentPeriod();this.onPeriodChange()},getStartDate:function(){return this.subInstance("start-date-datepicker",function(){return new BX.Tasks.Util.DatePicker({scope:this.control("start-date-datepicker"),controlBind:"class",displayFormat:"system-short",defaultTime:{H:0,M:0,S:0}})})},getEndDate:function(){return this.subInstance("end-date-datepicker",function(){return new BX.Tasks.Util.DatePicker({scope:this.control("end-date-datepicker"),controlBind:"class",displayFormat:"system-short",defaultTime:{H:0,M:0,S:0}})})},getTime:function(){return this.subInstance("creation-time",function(){return new e({scope:this.control("timepicker"),inputId:this.option("timerId"),value:this.option("data").TIME})})},bindEvents:function(){var e=BX.delegate(this.onUpdateHint,this);this.bindDelegateControl("period-type","change",BX.delegate(this.onPeriodChange,this));this.bindDelegateControl("period-type-option","click",this.passCtx(this.onSetPeriodValue));this.bindDelegateControl("day-type","change",e);BX.bindDelegate(this.scope(),"change",{tag:"select"},e);BX.bindDelegate(this.scope(),"change",{tag:"input",attr:{type:"checkbox"}},e);BX.bindDelegate(this.scope(),"change",{tag:"input",attr:{type:"radio"}},e);BX.Tasks.Util.bindInstantChange(this.control("every-day"),e);BX.Tasks.Util.bindInstantChange(this.control("daily-month-interval"),e);BX.Tasks.Util.bindInstantChange(this.control("every-week"),e);BX.Tasks.Util.bindInstantChange(this.control("monthly-day-num"),e);BX.Tasks.Util.bindInstantChange(this.control("monthly-month-num-1"),e);BX.Tasks.Util.bindInstantChange(this.control("monthly-month-num-2"),e);BX.Tasks.Util.bindInstantChange(this.control("yearly-day-num"),e);BX.Tasks.Util.bindInstantChange(this.control("times"),e);this.getStartDate().bindEvent("change",e);this.getEndDate().bindEvent("change",e);this.getTime().bindEvent("change",e);BX.Tasks.Util.hintManager.bindHelp(this.scope())},getCurrentPeriod:function(){return this.getValueString("period-type")},onSetPeriodValue:function(e){var t=BX.data(e,"type");if(BX.util.in_array(t,[this.PERIOD_DAILY,this.PERIOD_WEEKLY,this.PERIOD_MONTHLY,this.PERIOD_YEARLY])){this.control("period-type").value=t;this.onPeriodChange()}},setConstraintPanelHeight:function(e){var t=this.control("panel-"+e);if(t){var a=BX.pos(t).height;this.control("panel").style.height=a+"px"}},onPeriodChange:function(){var e=this.getCurrentPeriod();this.dropCSSFlags("period-*");this.setCSSFlag("period-"+BX.util.htmlspecialchars(e));if(this.vars.prevPeriod!=e){var t=this.control("panel-"+this.vars.prevPeriod);var a=this.control("panel-"+e);if(t&&a){this.setConstraintPanelHeight(this.vars.prevPeriod);BX.addClass(t,"nodisplay");BX.removeClass(a,"nodisplay");this.setConstraintPanelHeight(e);this.vars.prevPeriod=e}}this.onUpdateHint()},onUpdateHint:function(){var e=this.control("hint");if(!e){return}var t=this.parseTime(this.getValueString("time"));var a={PERIOD:this.getValueString("period-type"),EVERY_DAY:this.getValueInt("every-day"),WORKDAY_ONLY:this.getValueString("day-type"),DAILY_MONTH_INTERVAL:this.getValueInt("daily-month-interval"),EVERY_WEEK:this.getValueInt("every-week"),WEEK_DAYS:this.getWeekDays(-1),MONTHLY_DAY_NUM:this.getValueInt("monthly-day-num"),MONTHLY_MONTH_NUM_1:this.getValueInt("monthly-month-num-1"),MONTHLY_TYPE:this.getCheckedControlValues("monthly-type")[0],MONTHLY_WEEK_DAY_NUM:this.getValueInt("monthly-week-day-num"),MONTHLY_WEEK_DAY:this.getValueInt("monthly-week-day"),MONTHLY_MONTH_NUM_2:this.getValueInt("monthly-month-num-2"),YEARLY_TYPE:this.getCheckedControlValues("yearly-type")[0],YEARLY_DAY_NUM:this.getValueInt("yearly-day-num"),YEARLY_MONTH_1:this.getValueInt("yearly-month-1"),YEARLY_WEEK_DAY_NUM:this.getValueInt("yearly-week-day-num"),YEARLY_WEEK_DAY:this.getValueInt("yearly-week-day"),YEARLY_MONTH_2:this.getValueInt("yearly-month-2"),START_DATE:this.getStartDate().getValue(),END_DATE:this.getEndDate().getValue(),TIME:t==""?"05:00":t,TIMES:this.getValueInt("times"),REPEAT_TILL:this.getRepeatTill()};e.innerHTML=this.makeHintText(a)},makeHintText:function(e){var t=parseInt(this.option("tzOffset"));var a=BX.message("TASKS_TTDP_REPLICATION_HINT_AT_TIME").replace("#TIME#",e.TIME+" (UTC "+(t>0?"+":"")+BX.Tasks.Util.formatTimeAmount(t,"HH:MI")+")");if(e.PERIOD==this.PERIOD_DAILY){var i=e.EVERY_DAY;a+=BX.message("TASKS_TTDP_REPLICATION_DAILY_EXT").replace("#NUMBER#",i>1?" "+i:"").replace("#DAY_TYPE#",e.WORK_DAY=="Y"?" "+BX.message("TASKS_TTDP_REPLICATION_DAILY_WORK"):"");var n=e.DAILY_MONTH_INTERVAL;if(n>0){a+=BX.message("TASKS_TTDP_REPLICATION_HINT_DAILY_MONTH_INTERVAL").replace("#TIMES#",n).replace("#TIMES_PLURAL#",BX.Loc.getMessagePlural("TASKS_TTDP_REPLICATION_HINT_DAILY_MONTH_INTERVAL",n))}}else if(e.PERIOD==this.PERIOD_WEEKLY){var s=e.EVERY_WEEK;a+=BX.message("TASKS_TTDP_REPLICATION_WEEKLY_EXT").replace("#NUMBER#",s>1?" "+s:"");var r="";if(e.WEEK_DAYS.length==7){r=BX.message("TASKS_TTDP_REPLICATION_EVERY_DAY")}else{r=[];for(var T=0;T<e.WEEK_DAYS.length;T++){r.push(BX.message("TASKS_TTDP_REPLICATION_WD_"+e.WEEK_DAYS[T]))}r=r.join(", ")}a+=" ("+r+")"}else if(e.PERIOD==this.PERIOD_MONTHLY){if(e.MONTHLY_TYPE==1){var s=e.MONTHLY_DAY_NUM;var o=e.MONTHLY_MONTH_NUM_1;a+=BX.message("TASKS_TTDP_REPLICATION_MONTHLY_EXT_TYPE_1").replace("#DAY_NUMBER#",s).replace("#MONTH_NUMBER#",o>1?" "+o:"")}else{var _=this.getWeekDayGender(e.MONTHLY_WEEK_DAY);var l=this.getWeekDayName(e.MONTHLY_WEEK_DAY);var s=BX.message("TASKS_TTDP_REPLICATION_NUMBER_"+e.MONTHLY_WEEK_DAY_NUM+_);var E=BX.message("TASKS_TTDP_REPLICATION_EACH"+this.getWeekDayGender(e.MONTHLY_WEEK_DAY));var o=e.MONTHLY_MONTH_NUM_2;a+=BX.message("TASKS_TTDP_REPLICATION_MONTHLY_EXT_TYPE_2").replace("#EACH#",E).replace("#DAY_NUMBER#",s).replace("#WEEKDAY_NAME#",l).replace("#MONTH_NUMBER#",o>1?" "+o:"")}}else{if(e.YEARLY_TYPE==1){var s=e.YEARLY_DAY_NUM;var h=BX.message("TASKS_TTDP_REPLICATION_MONTH_"+e.YEARLY_MONTH_1);a+=BX.message("TASKS_TTDP_REPLICATION_YEARLY_EXT_TYPE_1").replace("#DAY_NUMBER#",s).replace("#MONTH_NAME#",h)}else{var _=this.getWeekDayGender(e.YEARLY_WEEK_DAY);var l=this.getWeekDayName(e.YEARLY_WEEK_DAY);var s=BX.message("TASKS_TTDP_REPLICATION_NUMBER_"+e.YEARLY_WEEK_DAY_NUM+_);var E=BX.message("TASKS_TTDP_REPLICATION_EACH"+this.getWeekDayGender(e.YEARLY_WEEK_DAY));var h=BX.message("TASKS_TTDP_REPLICATION_MONTH_"+e.YEARLY_MONTH_2);a+=BX.message("TASKS_TTDP_REPLICATION_YEARLY_EXT_TYPE_2").replace("#EACH#",E).replace("#DAY_NUMBER#",s).replace("#WEEKDAY_NAME#",l).replace("#MONTH_NAME#",h)}}var A="";var c=e.TIMES;if(e.START_DATE!=""){var I=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),BX.parseDate(e.START_DATE,true),false,true);A+=BX.message("TASKS_TTDP_REPLICATION_HINT_START_CONSTRAINT").replace("#DATETIME#",I)}else{A+=BX.message("TASKS_TTDP_REPLICATION_HINT_START_CONSTRAINT_NONE")}var g=this.getRepeatTill();var u=true;if(e.END_DATE!=""&&g==this.REPEAT_TILL_DATE){var N=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),BX.parseDate(e.END_DATE,true),false,true);A+=BX.message("TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT").replace("#DATETIME#",N);u=false}else if(c>0&&g==this.REPEAT_TILL_TIMES){A+=BX.message("TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT_TIMES").replace("#TIMES#",c).replace("#TIMES_PLURAL#",BX.Loc.getMessagePlural("TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT_TIMES",c));u=false}if(u){A+=BX.message("TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT_NONE")}return BX.message("TASKS_TTDP_REPLICATION_HINT_BASE").replace("#CONDITION#",a).replace("#CONSTRAINT#",A)},getWeekDayName:function(e){var t=this.getWeekDayGender(e);return BX.message("TASKS_TTDP_REPLICATION_WD_"+e+(t=="_F"?"_ALT":""))},getValueString:function(e){var t=this.control(e);if(BX.type.isElementNode(t)){return BX.util.htmlspecialchars(t.value.toString())}return""},getValueInt:function(e){var t=this.control(e);if(BX.type.isElementNode(t)){var a=parseInt(t.value.toString());if(isNaN(a)){return 0}return a}return 0},getCheckedControlValues:function(e){var t=[];var a=this.controlAll(e);for(var i in a){if(a[i].checked){t.push(a[i].value)}}return t},parseTime:function(e){e=e.toString().replace(/^\s+/,"").replace(/\s+$/,"");if(e.length>0){var t=e.match(/^(\d{1,2}):(\d{1,2})$/);if(t===null){return""}var a=parseInt(t[1]);var i=parseInt(t[2]);if(a>23||i>59){return""}var n=function(e){e=e.toString();if(e.length==1){return"0"+e}return e};return n(a)+":"+n(i)}return e},getRepeatTill:function(){var e=this.getCheckedControlValues("repeat-till");if(typeof e[0]=="undefined"){return this.REPEAT_TILL_ENDLESS}return e[0]},getWeekDays:function(e){var t=this.getCheckedControlValues("week-days");if(t.length==0){t.push(this.MONDAY)}else{for(var a=0;a<t.length;a++){t[a]=parseInt(t[a])+e}}return t},getWeekDayGender:function(e){if(e==this.MONDAY||e==this.TUESDAY||e==this.THURSDAY){return"_M"}if(e==this.SUNDAY){return""}return"_F"}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:110:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/projectdependence/logic.min.js?16992580833597";s:6:"source";s:91:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/projectdependence/logic.js";s:3:"min";s:95:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/projectdependence/logic.min.js";s:3:"map";s:95:"/bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/projectdependence/logic.map.js";}"*/
BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskDetailPartsProjDep!="undefined"){return}var t=BX.Tasks.Util.ItemSet.Item.extend({sys:{code:"item"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.ItemSet.Item);this.vars.data=this.option("data");this.bindEvents()},bindEvents:function(){this.bindDelegateControl("type-left","change",this.passCtx(this.onRelationLeftChange));this.bindDelegateControl("type-right","change",this.passCtx(this.onRelationRightChange))},value:function(){return this.vars.data.VALUE},display:function(){return this.vars.data.DISPLAY},destruct:function(){var t=this.value();BX.remove(this.sys.scope);this.sys.scope=null;this.ctrls=null;this.vars.data=null;return t},onRelationLeftChange:function(t){this.control("type").value=this.getLinkTypeByEnds(t.value,this.control("type-right").value)},onRelationRightChange:function(t){this.control("type").value=this.getLinkTypeByEnds(this.control("type-left").value,t.value)},onDeleteClick:function(){this.fireEvent("delete",[this.value()])},getLinkTypeByEnds:function(e,n){if(e=="s"){return n=="s"?t.LINK_TYPE_START_START:t.LINK_TYPE_START_FINISH}else{return n=="s"?t.LINK_TYPE_FINISH_START:t.LINK_TYPE_FINISH_FINISH}}}});t.LINK_TYPE_START_START=0;t.LINK_TYPE_START_FINISH=1;t.LINK_TYPE_FINISH_START=2;t.LINK_TYPE_FINISH_FINISH=3;BX.Tasks.Component.TaskDetailPartsProjDep=BX.Tasks.PopupItemSet.extend({sys:{code:"projdep-item-set"},options:{itemFx:"vertical",itemFxHoverDelete:true},methods:{construct:function(){this.callConstruct(BX.Tasks.PopupItemSet);if(typeof this.instances!="undefined"){this.instances={calendar:false}}this.instances.selector=window["O_"+this.option("selectorCode")]},load:function(){this.callMethod(BX.Tasks.PopupItemSet,"load",arguments);this.toggleContainer()},openAddForm:function(){if(this.option("restricted")){BX.UI.InfoHelper.show("limit_tasks_gantt",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"taskEdit"}});return}return this.callMethod(BX.Tasks.PopupItemSet,"openAddForm",arguments)},assignCalendar:function(t){this.instances.calendar=t},bindFormEvents:function(){BX.addCustomEvent(this.instances.selector,"on-change",BX.delegate(this.itemsChanged,this));this.bindEvent("item-destroy",this.onItemDestroy)},toggleContainer:function(){var t=this.control("container");if(t){BX[this.itemCount()?"removeClass":"addClass"](t,"hidden")}},onItemDestroy:function(){this.toggleContainer()},addItem:function(t,e){if(this.callMethod(BX.Tasks.PopupItemSet,"addItem",arguments)){if(!e.load){this.toggleContainer()}}},createItem:function(e){e.DEPENDS_ON_TITLE=e.SE_DEPENDS_ON.TITLE;e.L_START=e.TYPE==t.LINK_TYPE_START_START||e.TYPE==t.LINK_TYPE_START_FINISH?"selected":"";e.L_FINISH=e.TYPE==t.LINK_TYPE_FINISH_START||e.TYPE==t.LINK_TYPE_FINISH_FINISH?"selected":"";e.R_START=e.TYPE==t.LINK_TYPE_START_START||e.TYPE==t.LINK_TYPE_FINISH_START?"selected":"";e.R_FINISH=e.TYPE==t.LINK_TYPE_START_FINISH||e.TYPE==t.LINK_TYPE_FINISH_FINISH?"selected":"";var n=this.getNodeByTemplate("item",e)[0];BX.append(n,this.control("items"));var s=new t({scope:n,data:e,parent:this});return s},getPopupAttachTo:function(){return this.control("open-form")},applySelectionChange:function(){for(var e in this.vars.temporalItems){var n=this.vars.temporalItems[e];this.addItem({TASK_ID:this.option("task").data.TASK_ID,DEPENDS_ON_ID:n.id,SE_DEPENDS_ON:{TITLE:n.name},TYPE:t.LINK_TYPE_FINISH_START},{});break}this.instances.window.close()},extractItemValue:function(t){return t.DEPENDS_ON_ID},extractItemDisplay:function(t){return"1"}}})})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/tasks.task.selector/templates/.default/tasks.min.js?16992580835931";s:6:"source";s:73:"/bitrix/components/bitrix/tasks.task.selector/templates/.default/tasks.js";s:3:"min";s:77:"/bitrix/components/bitrix/tasks.task.selector/templates/.default/tasks.min.js";s:3:"map";s:77:"/bitrix/components/bitrix/tasks.task.selector/templates/.default/tasks.map.js";}"*/
function TasksTask(e,t,a){this.name=e;this.multiple=t;this.arSelected=[];this.useLocalCache=a;this.arTasksData=[];this.ajaxParameters={}}TasksTask.arTasks={};TasksTask.arTasksData={};TasksTask.prototype.addAjaxParameter=function(e,t){if(typeof e!="undefined"&&e.toString().length>0){this.ajaxParameters[e.toString()]=t}};TasksTask.prototype.setSelected=function(){throw new Exception("setSelected is not implemented")};TasksTask.prototype.getSelected=function(){return this.toObject(this.arSelected)};TasksTask.prototype.select=function(e){var t;var a=e.target||e.srcElement;if(e.currentTarget){t=e.currentTarget}else{t=a;while(!BX.hasClass(t,"finder-box-item")){t=t.parentNode}}var s=BX.findChild(t,{tag:"input"});var i=BX.findChild(t,{tag:"DIV",className:"finder-box-item-text"},true);var n,r=null;if(typeof TasksTask.arTasksData[s.value]!="undefined"){n=TasksTask.arTasksData[s.value].sub;r=TasksTask.arTasksData[s.value].position}else if(typeof this.arTasksData[s.value]!="undefined"){n=this.arTasksData[s.value].sub;r=this.arTasksData[s.value].position}var l={id:s.value,name:BX.util.htmlspecialcharsback(i.innerHTML),sub:n,position:r};if(!this.multiple){var c=document.getElementsByName(this.name);for(var o=0;o<c.length;o++){if(c[o].value!=s.value){BX.removeClass(c[o].parentNode,"finder-box-item-selected")}else{BX.addClass(c[o].parentNode,"finder-box-item-selected")}}s.checked=true;BX.addClass(t,"finder-box-item-selected");this.searchInput.value=BX.util.htmlspecialcharsback(i.innerHTML);this.arSelected=[];this.arSelected[s.value]=l}else{c=document.getElementsByName(this.name+"[]");for(o=0;o<c.length;o++){if(c[o].value==s.value){c[o].checked=false;BX.toggleClass(c[o].parentNode,"finder-box-item-selected")}}if(BX.hasClass(s.parentNode,"finder-box-item-selected")){s.checked=true}if(s.checked){var d=BX.findChild(BX(this.name+"_selected_tasks"),{className:"finder-box-selected-items"});if(!BX(this.name+"_task_selected_"+s.value)){var h=BX.create("DIV");h.id=this.name+"_task_selected_"+s.value;h.className="finder-box-selected-item";h.innerHTML='<div class="finder-box-selected-item-icon" onclick="O_'+this.name+".unselect("+s.value+', this);" id="task-unselect-'+s.value+'"></div><a href="'+BX.message("TASKS_PATH_TO_TASK").replace("#task_id#",s.value).replace("#action#","view")+'" target="_blank" class="finder-box-selected-item-text">'+i.innerHTML+"</a>";d.appendChild(h);var u=BX(this.name+"_current_count");u.innerHTML=parseInt(u.innerHTML)+1;this.arSelected[s.value]=l}}else{BX.remove(BX(this.name+"_task_selected_"+s.value));u=BX(this.name+"_current_count");u.innerHTML=parseInt(u.innerHTML)-1;this.arSelected[s.value]=null}}if(this.onSelect){this.onSelect(l)}BX.onCustomEvent(this,"on-change",[this.toObject(this.arSelected)]);if(this.onChange){this.onChange(this.arSelected)}};TasksTask.prototype.toObject=function(e){var t={};for(var a in e){a=parseInt(a);if(typeof a=="number"&&e[a]!==null){t[a]=BX.clone(e[a])}}return t};TasksTask.prototype.unselect=function(e,t){if(!this.arSelected[e]){return}var a=document.getElementsByName(this.name+(this.multiple?"[]":""));for(var s=0;s<a.length;s++){if(a[s].value==e){a[s].checked=false;BX.removeClass(a[s].parentNode,"finder-box-item-selected")}}if(this.multiple){if(!t){t=BX("task-unselect-"+e)}if(t){BX.remove(t.parentNode)}var i=BX(this.name+"_current_count");i.innerHTML=parseInt(i.innerHTML)-1}this.arSelected[e]=null;BX.onCustomEvent(this,"on-change",[this.toObject(this.arSelected)]);if(this.onChange){this.onChange(this.arSelected)}};TasksTask.prototype.setFocus=function(){var e=BX(this.name+"_task_input");if(e){e.focus()}};TasksTask.prototype.search=function(){if(this.searchInput.value.length>1){this.displayTab("search");var e=(typeof this.ajaxUrl!="undefined"?this.ajaxUrl:TasksTask.ajaxUrl)+"&MODE=SEARCH&SEARCH_STRING="+encodeURIComponent(this.searchInput.value)+"&"+BX.ajax.prepareData(this.filter,"FILTER");BX.ajax({url:e,method:"post",dataType:"json",async:true,processData:true,emulateOnload:true,start:true,data:this.ajaxParameters,onsuccess:BX.proxy(function(e){this.showResults(e)},this)})}};TasksTask.prototype.showResults=function(e){var t=e;var a=BX(this.name+"_search");var s=a.getElementsByTagName("input");for(var i=0,n=s.length;i<n;i++){if(s[i].checked){BX(this.name+"_last").appendChild(s[i])}}if(a){a.innerHTML="";for(i=0;i<t.length;i++){var r=false;(this.useLocalCache?this:TasksTask).arTasksData[t[i].ID]={id:t[i].ID,name:t[i].TITLE,status:t[i].STATUS};var l=BX.create("input",{props:{className:"tasks-hidden-input"}});if(this.multiple){l.name=this.name+"[]";l.type="checkbox"}else{l.name=this.name;l.type="radio"}s=document.getElementsByName(l.name);var c=0;while(!r&&c<s.length){if(s[c].value==t[i].ID&&s[c].checked){r=true}c++}l.value=t[i].ID;var o="";switch(parseInt(t[i].STATUS)){case-1:o=" task-status-overdue";break;case-2:case 1:o=" task-status-new";break;case 2:o=" task-status-accepted";break;case 3:o=" task-status-in-progress";break;case 4:o=" task-status-waiting";break;case 5:o=" task-status-completed";break;case 6:o=" task-status-delayed";break;case 7:o=" task-status-declined";break;default:break}obTaskRow=BX.create("div",{props:{className:"finder-box-item"+o+(r?" finder-box-item-selected":"")},events:{click:BX.proxy(this.select,this)},children:[l,BX.create("div",{props:{className:"finder-box-item-text"},text:t[i].TITLE}),BX.create("div",{props:{className:"finder-box-item-icon"}})]});a.appendChild(obTaskRow)}}};TasksTask.prototype.displayTab=function(e){BX.removeClass(BX(this.name+"_last"),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_search"),"finder-box-tab-content-selected");BX.addClass(BX(this.name+"_"+e),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_tab_last"),"finder-box-tab-selected");BX.removeClass(BX(this.name+"_tab_search"),"finder-box-tab-selected");BX.addClass(BX(this.name+"_tab_"+e),"finder-box-tab-selected")};
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/crm.field.element/templates/main.edit/script.min.js?16992579614990";s:6:"source";s:73:"/bitrix/components/bitrix/crm.field.element/templates/main.edit/script.js";s:3:"min";s:77:"/bitrix/components/bitrix/crm.field.element/templates/main.edit/script.min.js";s:3:"map";s:77:"/bitrix/components/bitrix/crm.field.element/templates/main.edit/script.map.js";}"*/
BX.CrmElementEntitySelector=function(){var t=function(t){this.randomString=t.randomString;this.jsObject=t.jsObject;this.fieldUid=t.fieldUid;this.fieldName=t.fieldName;this.usePrefix=t.usePrefix;this.listPrefix=t.listPrefix;this.selectorEntityTypes=t.selectorEntityTypes;this.multiple=t.multiple;this.listElement=t.listElement;this.listEntityType=t.listEntityType;this.pluralCreation=Boolean(t.pluralCreation);this.listEntityCreateUrl=t.listEntityCreateUrl;this.currentEntityType=t.currentEntityType;this.context=t.context;this.dynamicTypeTitles=t.dynamicTypeTitles;this.initialize()};t.prototype.initialize=function(){this.popupObject=null;this.popupId="crm-"+this.randomString+"-popup";this.popupBindElement=null;this.popupContent="";this.externalRequestData=null;this.externalEventHandler=null;BX.addCustomEvent("onCrmSelectedItem",BX.proxy(this.setSelectedElement,this));BX.addCustomEvent("onCrmUnSelectedItem",BX.proxy(this.unsetSelectedElement,this))};t.prototype.createNewEntity=function(t){if(this.pluralCreation){t=t||window.event;this.popupBindElement=t.currentTarget;this.createPopup()}else{this.performExternalRequest()}};t.prototype.performExternalRequest=function(t){if(this.popupObject){this.popupObject.popupWindow.close()}if(t){this.setCurrentEntityType(t)}var e=BX.util.add_url_param(this.getCreateUrl(),{external_context:this.context});BX.SidePanel.Instance.open(e);if(!this.externalRequestData){this.externalRequestData={}}this.externalRequestData[this.context]={context:this.context,url:e};if(!this.externalEventHandler){this.externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this.externalEventHandler)}};t.prototype.onExternalEvent=function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var s=BX.type.isNotEmptyString(i["entityTypeName"])?i["entityTypeName"]:"";var n=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(e==="onCrmEntityCreate"&&s===this.currentEntityType.toUpperCase()&&this.externalRequestData&&BX.type.isPlainObject(this.externalRequestData[n])){var r=BX.type.isBoolean(i["isCanceled"])?i["isCanceled"]:false;if(!r&&BX.type.isPlainObject(i["entityInfo"])){var l=BX.UI.SelectorManager.instances[this.fieldUid];var a=i.entityInfo.type.toUpperCase();if(BX.type.isNotEmptyObject(l)){var p={};if(this.multiple==="Y"){for(var o in l.itemsSelected){if(!l.itemsSelected.hasOwnProperty(o)){continue}p[o]=l.itemsSelected[o]}}p[this.listPrefix[a]+"_"+i.entityInfo.id]=this.selectorEntityTypes[a];BX.onCustomEvent("BX.Main.SelectorV2:reInitDialog",[{selectorId:this.fieldUid,selectedItems:p}])}}if(this.externalRequestData[n]["url"]){var E=BX.SidePanel.Instance.getSlider(this.externalRequestData[n]["url"]);if(E){E.destroy()}}delete this.externalRequestData[n]}};t.prototype.createPopup=function(){var t=[];var e="";for(var i in this.listEntityType){if(this.listEntityType[i].toUpperCase().indexOf("DYNAMIC_")===0){e=this.dynamicTypeTitles["DYNAMICS_"+i]}else{e=BX.message("CRM_ELEMENT_CREATE_"+this.listEntityType[i].toUpperCase());t.push({text:e,onclick:'BX["'+this.jsObject+'"].performExternalRequest("'+this.listEntityType[i]+'");'})}}if(!BX.PopupMenu.getMenuById(this.popupId)){var s=this.popupBindElement.getBoundingClientRect();this.popupObject=BX.PopupMenu.create(this.popupId,this.popupBindElement,t,{closeByEsc:true,angle:true,offsetLeft:s.width/2})}if(this.popupObject){this.popupObject.popupWindow.show()}};t.prototype.setCurrentEntityType=function(t){this.currentEntityType=t};t.prototype.getCreateUrl=function(){if(this.listEntityCreateUrl.hasOwnProperty(this.currentEntityType)){return this.listEntityCreateUrl[this.currentEntityType]}else{return""}};t.prototype.setSelectedElement=function(t){for(var e in this.listElement){if(t.id===this.listElement[e].id){this.listElement[e].selected="Y"}}};t.prototype.unsetSelectedElement=function(t){for(var e in this.listElement){if(t.id===this.listElement[e].id){this.listElement[e].selected="N"}}};t.prototype.initWidgetEntitySelection=function(){BX.loadCSS("/bitrix/js/crm/css/crm.css");if(typeof CRM=="undefined"){BX.loadScript("/bitrix/js/crm/crm.js",BX[""+this.jsObject+""].initWidgetEntitySelection());return}CRM.Set(BX("crm-"+this.fieldUid+"-open"),this.fieldName,"",this.listElement,this.usePrefix==="Y",this.multiple==="Y",this.listEntityType,{lead:BX.message("CRM_ELEMENT_LEAD"),contact:BX.message("CRM_ELEMENT_CONTACT"),company:BX.message("CRM_ELEMENT_COMPANY"),deal:BX.message("CRM_ELEMENT_DEAL"),quote:BX.message("CRM_ELEMENT_QUOTE"),order:BX.message("CRM_ELEMENT_ORDER"),ok:BX.message("CRM_ELEMENT_OK"),cancel:BX.message("CRM_ELEMENT_CANCEL"),close:BX.message("CRM_ELEMENT_CLOSE"),wait:BX.message("CRM_ELEMENT_SEARCH"),noresult:BX.message("CRM_ELEMENT_NO_RESULT"),add:BX.message("CRM_ELEMENT_CHOISE"),edit:BX.message("CRM_ELEMENT_CHANGE"),search:BX.message("CRM_ELEMENT_SEARCH"),last:BX.message("CRM_ELEMENT_LAST")})};return t}();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/main.user.selector/templates/.default/script.min.js?16992579508493";s:6:"source";s:73:"/bitrix/components/bitrix/main.user.selector/templates/.default/script.js";s:3:"min";s:77:"/bitrix/components/bitrix/main.user.selector/templates/.default/script.min.js";s:3:"map";s:77:"/bitrix/components/bitrix/main.user.selector/templates/.default/script.map.js";}"*/
(function(){BX.namespace("BX.Main.User");if(BX.Main.User.Selector){return}function e(e){this.caller=e.caller;this.container=BX(e.containerId);this.id=e.id;this.containerId=e.containerId;this.inputName=e.inputName;this.inputId=e.inputName;this.isInputMultiple=e.isInputMultiple;this.inputNode=this.container?this.container.querySelector('input[name="'+e.inputName+'"]'):null;this.useSymbolicId=e.useSymbolicId;this.openDialogWhenInit=!!e.openDialogWhenInit;this.selector=BX.UI.TileSelector.getById(this.id);if(!this.selector){throw new Error("Tile selector `"+this.id+"` not found.")}this.searchInputNode=this.selector.getSearchInput();if(!this.searchInputNode.id){this.searchInputNode.id=this.inputId+"-"+this.id+"-search-input"}this.lazyload=!!e.lazyload;BX.addCustomEvent(this.selector,this.selector.events.buttonSelect,this.openDialog.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileRemove,this.removeTile.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileClick,this.clickTile.bind(this));BX.Main.User.SelectorController.init(this)}e.prototype={openDialog:function(){if(this.lazyload){var e=false;if(BX.Main.selectorManagerV2){var t=BX.Main.selectorManagerV2.getById(this.id);if(t&&t.initialized){BX.Main.User.SelectorController.open(this);e=true}}if(!e){BX.onCustomEvent("BX.Main.SelectorV2:initDialog",[{selectorId:this.id,openDialogWhenInit:true}])}}else{BX.Main.User.SelectorController.open(this)}},removeTile:function(e){this.unsetValue(e.id)},clickTile:function(e){if(BX.type.isNotEmptyObject(e.data)&&BX.type.isNotEmptyString(e.data.url)){if(BX.type.isNotEmptyString(e.data.urlUseSlider)&&e.data.urlUseSlider=="Y"&&BX.type.isNotEmptyObject(BX.SidePanel)){BX.SidePanel.Instance.open(e.data.url)}else{window.open(e.data.url,"_blank")}}},setUsers:function(e){e=e||[];if(this.isInputMultiple){this.addInputs(e)}else{this.inputNode.value=e.join(",");BX.fireEvent(this.inputNode,"change")}},getUsers:function(){if(!this.isInputMultiple&&!this.inputNode){return[]}var e;if(this.isInputMultiple){e=this.getInputs().map((function(e){return e.value}))}else{e=this.inputNode.value.split(",")}if(!this.useSymbolicId){return e.filter((function(e){e=parseInt(e);return!!e})).map((function(e){return parseInt(e)}))}else{return e.filter((function(e){return e.length>0}))}},setValue:function(e){if(!this.useSymbolicId){if(/^\d+$/.test(e)!==true){return}e=parseInt(e)}if(this.selectOne){this.setUsers([e])}else{var t=this.getUsers();if(!BX.util.in_array(e,t)){t.push(e)}this.setUsers(t)}},unsetValue:function(e){if(!this.useSymbolicId){if(/^\d+$/.test(e)!==true){return}e=parseInt(e)}if(this.selectOne){this.setUsers()}else{var t=false;if(BX.type.isNotEmptyObject(BX.Main.selectorManagerV2)){var i=BX.Main.selectorManagerV2.getById(this.id);if(i.getOption("returnJsonValue")=="Y"){t=true}}var n=this.getUsers().filter((function(i){if(t){var n=JSON.parse(i);if(BX.type.isNotEmptyObject(n)){i=n.id}}return i!==e}));this.setUsers(n)}},addInput:function(e){var t=document.createElement("input");t.type="hidden";t.name=this.inputName;t.value=e;this.container.appendChild(t);BX.fireEvent(t,"change");BX.Event.EventEmitter.emit(window,"BX.Main.User.SelectorController:itemRendered",[{selectorId:this.id,value:e}])},addInputs:function(e){this.removeInputs();e.forEach((function(e){this.addInput(e)}),this);if(e.length<=0&&this.isInputMultiple){this.addInput("")}},getInputs:function(){return BX.convert.nodeListToArray(this.container.querySelectorAll('input[name="'+this.inputName+'"]'))},removeInputs:function(){this.getInputs().forEach((function(e){BX.fireEvent(e,"change");BX.remove(e)}))}};var t={list:[],init:function(e){this.list.push(e);BX.onCustomEvent(window,"BX.Main.User.SelectorController::init",[{id:e.id,inputId:e.searchInputNode.id,containerId:e.containerId,openDialogWhenInit:e.openDialogWhenInit}])},open:function(e){if(e.isOpen){return}if(BX.UI.SelectorManager){var t=BX.UI.SelectorManager.instances[e.id];if(t){if(!e.isInputMultiple){t.itemsSelected={}}e.getUsers().forEach((function(e){var i=null;for(var n in t.entities){if(t.entities.hasOwnProperty(n)&&BX.type.isNotEmptyObject(t.entities[n].items)){if(BX.util.in_array(e,Object.keys(t.entities[n].items))){i=n}}}if(i){t.itemsSelected[e]=i.toLowerCase()}}));t.nodes.input=e.selector.input;t.nodes.tag=e.selector.buttonSelect}}e.isOpen=true;BX.onCustomEvent(window,"BX.Main.User.SelectorController::open",[{id:e.id,inputId:e.searchInputNode.id,containerId:e.containerId,bindNode:e.container}])},formatName:function(e){var t="";var i=BX.type.isNotEmptyString(e.nameTemplate)?BX.util.htmlspecialcharsback(BX.util.htmlspecialcharsback(e.nameTemplate)):"#NAME#";if(BX.type.isNotEmptyObject(e.item)){var n=e.item;t=i}else{return t}for(var r in n){if(n.hasOwnProperty(r)){t=t.replace("#"+r.toUpperCase()+"#",BX.util.htmlspecialcharsback(n[r]))}}return t},select:function(e){var t=BX.type.isNotEmptyObject(BX.Main.selectorManagerV2)?BX.Main.selectorManagerV2.getById(e.selectorId):null;var i=BX.Main.User.SelectorController;var n=i.getUserSelector(e.selectorId);if(!n||!BX.type.isNotEmptyObject(e.item)){return}var r=n.useSymbolicId?e.item.id:e.item.entityId;if(BX.type.isNotEmptyObject(e.item.params)&&BX.type.isNotEmptyString(e.item.params.email)&&(!t||t.getOption("returnJsonValue")!="Y")){r=(BX.type.isNotEmptyString(e.prefix)?e.prefix:"UE")+r}var s=false;if(t&&t.getOption("returnJsonValue")=="Y"){n.setValue(JSON.stringify(e.item))}else{n.setValue(r)}var o={readonly:!!e.undeletable};if(BX.type.isNotEmptyString(e.entityType)){o.entityType=e.entityType}if(BX.type.isNotEmptyString(e.item.url)){o.url=e.item.url}if(BX.type.isNotEmptyString(e.item.urlUseSlider)){o.urlUseSlider=e.item.urlUseSlider}if(BX.type.isNotEmptyString(e.item.isExtranet)&&e.item.isExtranet=="Y"){o.extranet=true}if(BX.type.isNotEmptyString(e.item.isCrmEmail)&&e.item.isCrmEmail=="Y"){o.crmEmail=true}if(BX.type.isNotEmptyString(e.state)){o.state=e.state}n.selector.addTile(i.formatName({item:e.item,nameTemplate:t?t.getOption("nameTemplate"):"#NAME# #LAST_NAME#"}),o,r);n.selector.input.value="";if(!n.isInputMultiple||!BX.type.isNotEmptyString(e.tab)||e.tab!="search"){n.selector.input.style.display="none";n.selector.buttonSelect.style.display=""}BX.onCustomEvent("BX.Main.User.SelectorController:select",[{selectorId:e.selectorId,item:e.item,contextNode:n.selector.context,containerId:n.containerId,inputName:n.inputName}])},unSelect:function(e){var t=BX.Main.User.SelectorController;var i=t.getUserSelector(e.selectorId);if(!i||!BX.type.isNotEmptyObject(e.item)){return}var n=i.useSymbolicId?e.item.id:e.item.entityId;i.unsetValue(n);var r=i.selector.getTile(n);if(r){i.selector.removeTile(r)}if(BX.UI.SelectorManager){var s=BX.UI.SelectorManager.instances[e.selectorId];if(s){if(typeof s.deleteSelectedItem=="function"){s.deleteSelectedItem({itemId:e.item.id})}else{delete s.itemsSelected[e.item.id]}}}if(!i.isInputMultiple||!BX.type.isNotEmptyString(e.tab)||e.tab!="search"){i.selector.input.style.display="none";i.selector.buttonSelect.style.display=""}BX.onCustomEvent("BX.Main.User.SelectorController:unSelect",[{selectorId:e.selectorId,item:e.item,contextNode:i.selector.context,containerId:i.containerId,inputName:i.inputName}])},openDialog:function(e){var t=BX.Main.User.SelectorController;var i=t.getUserSelector(e.selectorId);if(!i){return}i.isOpen=true;if(i.selector){i.selector.input.style.display="";i.selector.buttonSelect.style.display="none";i.selector.input.focus()}},closeDialog:function(e){var t=BX.Main.User.SelectorController;var i=t.getUserSelector(e.selectorId);if(!i){return}i.isOpen=false;if(i.selector){i.selector.input.style.display="none";i.selector.buttonSelect.style.display=""}},openSearch:function(e){var t=BX.Main.User.SelectorController;var i=t.getUserSelector(e.selectorId);if(!i){return}i.isOpen=false;if(i.selector){i.selector.input.style.display="";i.selector.buttonSelect.style.display="none"}},closeSearch:function(e){var t=BX.Main.User.SelectorController;var i=t.getUserSelector(e.selectorId);if(!i){return}if(i.selector){var n=BX.UI.SelectorManager.instances[e.selectorId];if(!n||!n.closeByEmptySearchResult){i.selector.input.style.display="none";i.selector.buttonSelect.style.display=""}}},getUserSelector:function(e){var t=this.list.filter((function(t){return t.id===e&&(!t.container||document.body.contains(t.container))}));return t[0]}};if(!BX.Main.User.SelectorController){BX.Main.User.SelectorController=t}BX.Main.User.Selector=e})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/ui.tile.selector/templates/.default/script.min.js?169925809614347";s:6:"source";s:71:"/bitrix/components/bitrix/ui.tile.selector/templates/.default/script.js";s:3:"min";s:75:"/bitrix/components/bitrix/ui.tile.selector/templates/.default/script.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/ui.tile.selector/templates/.default/script.map.js";}"*/
(function(t){BX.namespace("BX.UI");if(BX.UI.TileSelector){return}var e=[];function i(t){this.id=t.id;this.name=t.name||null;this.node=t.node;this.data=t.data;this.removeNode=null;this.nameNode=o.getNode("tile-item-name",this.node);if(!this.name){this.name=this.nameNode.textContent}}i.prototype.changeRemoving=function(t){if(!this.removeNode){return}this.removeNode.style.display=t?"":"none"};function n(t){this.init(t)}n.prototype.events={containerClick:"container-click",tileClick:"tile-click",tileRemove:"tile-remove",tileEdit:"tile-edit",tileAdd:"tile-add",buttonAdd:"add",buttonSelect:"select",buttonSelectFirst:"select-first",search:"search",input:"input",searcherCategoryClick:"popup-category-click",searcherItemClick:"popup-item-click",searcherInit:"popup-search-init"};n.getById=function(t){var i=e.filter(function(e){return e.id===t&&document.body.contains(e.context)});return i.length>0?i[0]:null};n.getList=function(){return e};n.prototype.init=function(t){this.list=[];this.id=t.id;this.context=BX(t.containerId);this.duplicates=t.duplicates;this.multiple=t.multiple;this.readonly=t.readonly;this.manualInputEnd=t.manualInputEnd;this.caption=t.caption;this.captionMore=t.captionMore;this.tilesLimit=!!t.tilesLimit?parseInt(t.tilesLimit):10;this.attributeId="data-bx-id";this.attributeData="data-bx-data";this.tileContainer=o.getNode("tile-container",this.context);this.tileTemplate=o.getNode("tile-template",this.context);this.input=o.getNode("tile-input",this.context);this.buttonAdd=o.getNode("tile-add",this.context);this.buttonSelect=o.getNode("tile-select",this.context);this.buttonMore=o.getNode("tile-more",this.context);if(!this.context||!this.input){return}o.getNodes("tile-item",this.context).forEach(this.initNode.bind(this));if(!this.readonly){this.initEventHandlers()}this.searcher=null;e.push(this)};n.prototype.initEventHandlers=function(){if(this.buttonAdd){BX.bind(this.buttonAdd,"click",this.onButtonAdd.bind(this))}if(this.context){BX.bind(this.context,"click",this.onContainerClick.bind(this))}if(this.buttonSelect){BX.bind(this.buttonSelect,"click",this.onButtonSelect.bind(this));BX.bind(this.tileContainer,"click",this.onButtonSelect.bind(this))}BX.bind(this.input,"input",this.onInput.bind(this));if(this.buttonMore){BX.bind(this.buttonMore,"click",this.onButtonMore.bind(this))}if(!this.manualInputEnd){BX.bind(this.input,"blur",this.onInputEnd.bind(this));o.handleKeyEnter(this.input,this.onInputEnd.bind(this))}BX.bind(this.input,"keydown",function(t){if(t.key==="Enter"){t.preventDefault();t.stopPropagation();return false}})};n.prototype.getSearchInput=function(){return this.input};n.prototype.isSearcherInit=function(){return!!this.searcher};n.prototype.clearSearcher=function(){this.isButtonSelectFired=false;if(this.searcher){this.searcher.hide();this.searcher=null}};n.prototype.hideSearcher=function(){this.searcher.hide()};n.prototype.showSearcher=function(t){if(!this.searcher){this.searcher=new s({id:this.id,caller:this,context:this.context,title:t||""});this.fire(this.events.searcherInit,[this.searcher])}this.searcher.filterByName();this.searcher.show()};n.prototype.setSearcherData=function(t){if(!this.searcher){this.showSearcher()}this.searcher.setCategories(t)};n.prototype.initNode=function(t){if(!t){return null}var e=t.getAttribute(this.attributeId);var n=t.getAttribute(this.attributeData);try{n=JSON.parse(n)}catch(t){try{n=JSON.parse(BX.util.htmlspecialcharsback(n))}catch(t){n={}}}var s=new i({id:e,node:t,data:n});if(s.id&&!this.duplicates&&this.findDuplicates(s.id)){s=null;return null}s.removeNode=o.getNode("remove",t);if(s.removeNode){BX.bind(s.removeNode,"click",this.onRemove.bind(this,s))}BX.bind(t,"click",this.onClick.bind(this,s));this.list.push(s);return s};n.prototype.onRemove=function(t,e){e.preventDefault();e.stopPropagation();this.removeTile(t);if(BX.UI.SelectorManager){var i=BX.UI.SelectorManager.instances[this.id];if(i&&i.callback.unSelect){if(BX.type.isNotEmptyObject(t.data)&&BX.type.isNotEmptyString(t.data.entityType)){i.callback.unSelect({item:i.entities[t.data.entityType.toUpperCase()].items[t.id.match(/^\d+$/)?"U"+t.id:t.id],entityType:t.data.entityType,selectorId:i.id})}}}return false};n.prototype.onClick=function(t,e){e.preventDefault();e.stopPropagation();this.fire(this.events.tileClick,[t])};n.prototype.removeTiles=function(){var t=this.list;t.forEach(this.removeTile.bind(this))};n.prototype.removeTile=function(t){this.list=BX.util.deleteFromArray(this.list,this.list.indexOf(t));BX.remove(t.node);this.fire(this.events.tileRemove,[t]);this.recalcButtonSelectText();if(this.buttonMore.style.display!="none"){this.recalcMore()}};n.prototype.recalcMore=function(){if(this.checkTilesLimit({action:"remove"})){this.buttonMore.style.display="none"}o.getNodes("tile-item",this.context).forEach(function(t,e){t.style.display=e>=this.tilesLimit?"none":""}.bind(this))};n.prototype.getTile=function(t){var e=this.list.filter(function(e){return e.id===t});return e.length>0?e[0]:null};n.prototype.getTilesData=function(){return this.list.map(function(t){return t.data})};n.prototype.getTilesId=function(){return this.list.map(function(t){return t.id}).filter(function(t){return!!t})};n.prototype.getTiles=function(){return this.list};n.prototype.findDuplicates=function(t){var e=this.getTile(t);if(!e){return false}this.removeTile(e)};n.prototype.addTile=function(t,e,i,n,s){if(!t||this.readonly){return null}i=i||"";if(!this.multiple){if(this.isSearcherInit()){this.hideSearcher()}if(this.list.length>0){var r=this.list[0];if(r&&r.id==i){return}}this.removeTiles()}e=e||{};s=s||"";n=n||"";var a=this.tileTemplate;if(!a){return null}a=a.innerHTML;var l="";if(s){l+="color: "+BX.util.htmlspecialchars(s)+"; "}if(n){l+="background-color: "+BX.util.htmlspecialchars(n)+"; "}if(BX.type.isNotEmptyString(e.state)&&e.state=="init"){l+=this.checkTilesLimit({action:"init"})?"":"display: none;"}var c=BX.type.isNotEmptyString(e.entityType)?e.entityType.toLowerCase():"none";if(!!e.extranet){c+="-extranet"}if(!!e.crmEmail){c+="-crm"}a=o.replace(a,{id:BX.util.htmlspecialchars(i+""),name:BX.util.htmlspecialchars(t),data:BX.util.htmlspecialchars(JSON.stringify(e)),style:l,type:c,readonly:!!e.readonly?"yes":"no"},true);var h=document.createElement("div");h.innerHTML=a;h=h.children[0];var u=this.initNode(h);if(!u){return null}this.buttonMore.parentNode.insertBefore(h,this.buttonMore);this.fire(this.events.tileAdd,[u]);this.recalcButtonSelectText();return u};n.prototype.updateTile=function(t,e,i,n,o){if(!t||this.readonly){return null}e=e||null;i=i||null;n=n||null;o=o||null;if(e){t.nameNode.textContent=e}if(i){t.data=i}if(n||n===null){t.node.style.backgroundColor=n}if(o){t.node.style.color=o}this.fire(this.events.tileEdit,[t]);return t};n.prototype.checkTilesLimit=function(t){var e=true,i=o.getNodes("tile-item",this.context).length,n=BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyString(t.action)?t.action:null;if(i>=this.tilesLimit){e=false;this.buttonMore.style.display="";this.buttonMore.title=BX.message("UI_TILE_SELECTOR_MORE").replace("#NUM#",i-this.tilesLimit+(n=="init"?1:0))}return e};n.prototype.fire=function(t,e){BX.onCustomEvent(this,t,e)};n.prototype.onInput=function(){var t=this.input.value;if(this.searcher&&t.length>0){this.searcher.filterByName(t)}this.fire(this.events.input,[this.input.value])};n.prototype.onInputEnd=function(){var t=this.input.value;this.input.value="";o.changeDisplay(this.input,false);o.changeDisplay(this.buttonSelect,true);this.recalcButtonSelectText();this.fire(this.events.search,[t])};n.prototype.onButtonAdd=function(t){t.preventDefault();t.stopPropagation();this.fire(this.events.buttonAdd,[])};n.prototype.onContainerClick=function(){this.fire(this.events.containerClick,[])};n.prototype.onButtonSelect=function(t){t.preventDefault();t.stopPropagation();o.changeDisplay(this.buttonSelect,false);o.changeDisplay(this.input,true);this.input.focus();this.fire(this.events.buttonSelect,[]);if(!this.isButtonSelectFired){this.fire(this.events.buttonSelectFirst,[]);this.isButtonSelectFired=true}};n.prototype.onButtonMore=function(t){t.preventDefault();t.stopPropagation();o.getNodes("tile-item",this.context).forEach(function(t){t.style.display=""});t.currentTarget.style.display="none"};n.prototype.recalcButtonSelectText=function(){if(!this.buttonSelect){return}var t=this.getTiles();this.buttonSelect.innerHTML=t.length>0?this.captionMore:this.caption};var o={getObjectByKey:function(t,e,i){var n=t.filter(function(t){return t.hasOwnProperty(e)&&t[e]===i});return n.length>0?n[0]:null},getNode:function(t,e){var i=this.getNodes(t,e);return i.length>0?i[0]:null},getNodes:function(t,e){if(!e){return[]}return BX.convert.nodeListToArray(e.querySelectorAll('[data-role="'+t+'"]'))},changeClass:function(t,e,i){if(!t){return}if(i){BX.addClass(t,e)}else{BX.removeClass(t,e)}},changeDisplay:function(t,e){if(!t){return}t.style.display=e?"":"none"},replace:function(t,e,i){e=e||{};i=i||false;if(!t){return""}for(var n in e){if(!e.hasOwnProperty(n)){continue}var o=e[n];o=o||"";if(!i&&o){o=BX.util.htmlspecialchars(o)}t=t.replace(new RegExp("%"+n+"%","g"),o)}return t},handleKeyEnter:function(e,i){if(!i){return}var n=function(e){e=e||t.event;if(e.keyCode===10||e.keyCode===13){e.preventDefault();e.stopPropagation();i();return false}};BX.bind(e,"keyup",n)},getTemplatedNode:function(t,e,i){if(!t){return null}var n=o.replace(t.innerHTML,e,i);var s=document.createElement("div");s.innerHTML=n;return s.children[0]}};function s(t){this.init(t)}s.prototype.classNameCategoryActive="ui-tile-selector-searcher-sidebar-item-selected";s.prototype.classNameItemActive="ui-tile-selector-searcher-content-item-selected";s.prototype.init=function(t){this.id=t.id;this.context=t.context;this.caller=t.caller;this.categories=[];this.items=[];this.currentCategory=null;this.categoryTemplate=o.getNode("popup-category-template",this.context);this.itemTemplate=o.getNode("popup-item-template",this.context);this.content=o.getTemplatedNode(o.getNode("popup-template",this.context));this.loader=o.getNode("popup-loader",this.content);this.categoryContainer=o.getNode("popup-category-list",this.content);this.itemContainer=o.getNode("popup-item-list",this.content);this.itemContainer.innerHTML="";this.categoryContainer.innerHTML="";this.title=o.getNode("popup-title",this.content);if(this.title){this.title.textContent=t.title}if(t.dataList){this.setCategories(t.dataList)}BX.addCustomEvent(this.caller,this.caller.events.tileAdd,this.onTileAdd.bind(this));BX.addCustomEvent(this.caller,this.caller.events.tileRemove,this.onTileRemove.bind(this))};s.prototype.onTileAdd=function(t){var e=o.getObjectByKey(this.items,"id",t.id);if(!e){return}o.changeClass(e.node,this.classNameItemActive,true)};s.prototype.onTileRemove=function(t){var e=o.getObjectByKey(this.items,"id",t.id);if(!e){return}o.changeClass(e.node,this.classNameItemActive,false)};s.prototype.filterByName=function(t){t=t||"";if(t.length<3){o.changeDisplay(this.categoryContainer,true);this.setCurrentCategory();return}var e=new RegExp(BX.util.escapeRegExp(t),"i");this.items.forEach(function(t){o.changeDisplay(t.node,e.test(t.name))});o.changeDisplay(this.categoryContainer,false)};s.prototype.onCategoryClick=function(t){this.setCurrentCategory(t);this.caller.fire(this.caller.events.searcherCategoryClick,[t])};s.prototype.setCurrentCategory=function(t){t=t||this.categories[0];if(this.currentCategory){BX.removeClass(this.currentCategory.node,this.classNameCategoryActive)}this.currentCategory=t;if(!t){return}BX.addClass(this.currentCategory.node,this.classNameCategoryActive);this.items.forEach(function(e){o.changeDisplay(e.node,e.category===t)})};s.prototype.onItemClick=function(t){this.caller.addTile(t.name,t.data,t.id,t.bgcolor,t.color);this.caller.fire(this.caller.events.searcherItemClick,[t])};s.prototype.getCategory=function(t){return o.getObjectByKey(this.categories,"id",t)};s.prototype.getItem=function(t){return o.getObjectByKey(this.items,"id",t)};s.prototype.updateItem=function(t,e,i){if(e){t.node.textContent=e;t.node.title=e}if(i){t.data=i}};s.prototype.addItem=function(t,e,i,n){var s=o.getTemplatedNode(this.itemTemplate,{name:i});var r={category:t,node:s,id:e,name:i,data:n||{}};this.items.push(r);this.itemContainer.appendChild(s);BX.bind(s,"click",this.onItemClick.bind(this,r));return r};s.prototype.setItems=function(t,e){this.items=[];e.forEach(function(e){this.addItem(t,e.id,e.name,e.data)},this)};s.prototype.addItems=function(t,e){e.forEach(function(e){this.addItem(t,e.id,e.name,e.data)},this)};s.prototype.addCategory=function(t,e,i,n){var s=o.getTemplatedNode(this.categoryTemplate,{name:e});var r={node:s,id:t,name:e,data:i||{}};this.categories.push(r);this.categoryContainer.appendChild(s);BX.bind(s,"click",this.onCategoryClick.bind(this,r));this.addItems(r,n);return r};s.prototype.setCategories=function(t){this.items=[];this.categories=[];this.itemContainer.innerHTML="";this.categoryContainer.innerHTML="";t.forEach(function(t){this.addCategory(t.id,t.name,t.data,t.items)},this);if(this.categories.length>0){this.setCurrentCategory(this.categories[0])}var e=this.caller.getTilesId();this.items.filter(function(t){var i=t.id&&BX.util.in_array(t.id,e);o.changeClass(t.node,this.classNameItemActive,i)},this);o.changeDisplay(this.loader,false);o.changeDisplay(this.itemContainer,true);o.changeDisplay(this.categoryContainer,true)};s.prototype.showLoader=function(){o.changeDisplay(this.loader,true)};s.prototype.hide=function(){if(!this.popup){return}this.popup.close()};s.prototype.show=function(){if(this.popup){this.popup.show();return}this.popup=BX.Main.PopupManager.create(this.id,this.context,{width:620,height:290,autoHide:true,lightShadow:true,closeByEsc:true,closeIcon:false,offsetLeft:40,angle:true,buttons:[new BX.UI.CloseButton({onclick:function(){this.popup.close()}.bind(this)})]});this.popup.setContent(this.content);o.changeDisplay(this.content,true);this.popup.show()};BX.UI.TileSelector=n;BX.addCustomEvent("BX.Main.SelectorV2:onGetDataStart",function(t){var e=BX("ui-tile-selector-"+t+"-mask");if(!e){return}e.classList.add("ui-tile-selector-selector-mask-active")});BX.addCustomEvent("BX.Main.SelectorV2:onGetDataFinish",function(t){var e=BX("ui-tile-selector-"+t+"-mask");if(!e){return}e.classList.remove("ui-tile-selector-selector-mask-active")})})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js?169925795113346";s:6:"source";s:71:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.js";s:3:"min";s:75:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main");BX.Main.selectorManagerV2={getById:function(t){if(typeof this.controls[t]!="undefined"){return this.controls[t]}return null},controls:{},loadedEntities:{}};BX.Main.SelectorV2=function(){this.initialized=false;this.blockInit=false;this.id="";this.apiVersion=2;this.fieldName=null;this.inputId=null;this.input=null;this.tagId=null;this.tag=null;this.options=null;this.callback=null;this.callbackBefore=null;this.items=null;this.entities=null;this.mainPopupWindow=null;this.entitiesSet=["users","emails","crmemails","groups","sonetgroups","department","departmentRelation","contacts","companies","leads","deals"];this.entityTypes={};this.auxObject=null;this.selectorInstance=null;this.eventOpenBinded=false};BX.Main.SelectorV2.controls={};BX.Main.SelectorV2.create=function(t){if(typeof t.id=="undefined"||!t.id){t.id=BX.util.hashCode(Math.random().toString())}else if(typeof BX.Main.selectorManagerV2.controls[t.id]!="undefined"){var e=BX.Main.selectorManagerV2.controls[t.id];if(e.bindNode&&!document.body.contains(e.bindNode)){delete BX.Main.selectorManagerV2.controls[t.id]}else{return BX.Main.selectorManagerV2.controls[t.id]}}var i=new BX.Main.SelectorV2;BX.Main.selectorManagerV2.controls[t.id]=i;i.init(t);return i};BX.Main.SelectorV2.proxyCallback=function(t,e){t(e)};BX.Main.SelectorV2.prototype={init:function(t){this.id=t.id;this.apiVersion=t.apiVersion&&parseInt(t.apiVersion)>=2?parseInt(t.apiVersion):2;this.fieldName=t.fieldName?t.fieldName:null;this.inputId=t.inputId?t.inputId:null;this.input=t.inputId&&BX(t.inputId)?BX(t.inputId):null;this.inputBox=t.inputBoxId&&BX(t.inputBoxId)?BX(t.inputBoxId):null;this.inputItemsContainer=t.inputContainerId&&BX(t.inputContainerId)?BX(t.inputContainerId):null;this.containerNode=t.containerId&&BX(t.containerId)?BX(t.containerId):null;this.bindNode=t.bindId&&BX(t.bindId)?BX(t.bindId):this.containerNode;this.tagId=t.tagId?t.tagId:null;this.tag=t.tagId&&BX(t.tagId)?BX(t.tagId):null;this.openDialogWhenInit=typeof t.openDialogWhenInit=="undefined"||!!t.openDialogWhenInit;this.options=t.options||{};this.callback=t.callback||null;this.callbackBefore=t.callbackBefore||null;this.items=t.items||null;this.entities=t.entities||null;this.entityTypes={};BX.onCustomEvent("BX.Main.SelectorV2:onGetEntityTypes",[{selector:this}]);this.selectorInstance=BX.UI.Selector.create({id:this.id,fieldName:this.fieldName,type:"xxx",pathToAjax:BX.type.isNotEmptyString(t.pathToAjax)?t.pathToAjax:null,input:this.input||null,tag:this.tag||null,inputBox:this.inputBox||null,inputItemsContainer:this.inputItemsContainer||null,entities:BX.clone(this.entityTypes),itemsSelected:BX.clone(this.items.selected)||{},itemsUndeletable:BX.clone(this.items.undeletable)||[],options:{multiple:this.getOption("multiple"),useSearch:this.getOption("useSearch"),useContainer:this.getOption("useContainer")=="Y"?"Y":"N",userNameTemplate:this.getOption("userNameTemplate"),siteDepartmentId:this.getOption("siteDepartmentId"),showCloseIcon:"Y",popupAutoHide:this.getOption("popupAutoHide")=="N"?"N":"Y",last:{disable:this.getOption("disableLast")=="Y"?"Y":"N"},search:{useAjax:this.getOption("sendAjaxSearch")!="N"?"Y":"N",useClientDatabase:this.getOption("useClientDatabase")=="Y"?"Y":"N"},focusInputOnSelectItem:this.getOption("focusInputOnSelectItem")!="N"?"Y":"N",focusInputOnSwitchTab:this.getOption("focusInputOnSwitchTab")!="N"?"Y":"N",isCrmFeed:this.getOption("isCrmFeed")=="Y"?"Y":"N",tagLink1:this.getOption("tagLink1"),tagLink2:this.getOption("tagLink2")},bindOptions:{node:this.bindNode,offsetTop:5,offsetLeft:15,zIndex:parseInt(this.getOption("popupZIndex"))>0?parseInt(this.getOption("popupZIndex")):1200},callback:this.callback,callbackBefore:this.callbackBefore});BX.addCustomEvent("BX.UI.SelectorManager:getTreeItemRelation",function(t){if(this.id==t.selectorId){this.getTreeItemRelation(t)}}.bind(this));BX.addCustomEvent("BX.UI.SelectorManager:loadAll",function(t){this.loadAll(t)}.bind(this));BX.addCustomEvent("BX.Main.SelectorV2:initDialog",function(t){if(this.id==t.selectorId){if(!!t.openDialogWhenInit){this.openDialogWhenInit=true}this.initDialog()}}.bind(this));BX.addCustomEvent("BX.Main.SelectorV2:reInitDialog",function(t){if(this.id==t.selectorId){this.initialized=false;this.items.selected=BX.type.isNotEmptyObject(t.selectedItems)?t.selectedItems:{};this.items.undeletable=BX.type.isNotEmptyObject(t.undeletableItems)?t.undeletableItems:{};var e=BX.UI.SelectorManager.instances[t.selectorId],i=null,n=null,s=0;if(e){for(var o in e.itemsSelected){if(e.itemsSelected.hasOwnProperty(o)){i=e.itemsSelected[o].toUpperCase();n=BX.UI.SelectorManager.getEntityTypeFullList(i);for(s=0;s<n.length;s++){if(BX.type.isNotEmptyObject(e.entities[n[s]])){e.unselectItem({itemNode:BX.type.isNotEmptyObject(e.entities[n[s]].items)&&BX.type.isNotEmptyObject(e.entities[n[s]].items[o])?e.entities[n[s]].items[o]:false,itemId:o,entityType:n[s],mode:"reinit"})}}}}e.itemsSelected=this.items.selected;e.itemsUndeletable=this.items.undeletable}this.initDialog()}}.bind(this));BX.addCustomEvent("BX.UI.SelectorManager:searchRequest",function(t){if(this.id==t.selectorInstance.id){t.selectorInstance.timeouts.search=setTimeout(function(){this.searchRequest(t)}.bind(this),1e3)}}.bind(this));BX.addCustomEvent("BX.UI.Selector:onSelectItem",function(t){if(this.apiVersion>=3&&BX.type.isNotEmptyObject(t)&&this.id==t.selectorId&&BX.type.isNotEmptyString(t.itemId)){this.saveDestination({itemId:t.itemId})}}.bind(this));if(!BX.type.isNotEmptyString(this.getOption("lheName"))){var e=BX("div"+this.getOption("lheName"));if(e){BX.addCustomEvent(e,"OnShowLHE",function(t){if(!t){this.selectorInstance.closeAllPopups()}}.bind(this))}}if(this.getOption("useContainer")!="Y"&&this.input){if(this.getOption("lazyLoad")!="Y"||BX.type.isNotEmptyObject(this.items.selected)){if(BX.type.isNotEmptyObject(this.items.selected)){this.openDialogWhenInit=false}this.initDialog()}if(this.tag){BX.bind(this.tag,"focus",BX.delegate(function(t){this.initDialog({realParams:true,bByFocusEvent:true});return t.preventDefault()},this));this.selectorInstance.setTagTitle()}BX.bind(this.input,"keydown",function(t){this.selectorInstance.getSearchInstance().beforeSearchHandler({event:t})}.bind(this));BX.bind(this.input,"bxchange",function(e){setTimeout(function(){this.selectorInstance.getSearchInstance().searchHandler({event:e,tagInputName:t.tagId})}.bind(this),0)}.bind(this));this.input.setAttribute("data-bxchangehandler","Y")}else if(this.getOption("useContainer")=="Y"&&(this.getOption("lazyLoad")!="Y"||this.getOption("useContainer")=="Y")){this.initDialog()}if(this.items.hidden){for(var i in this.items.hidden){if(this.items.hidden.hasOwnProperty(i)){this.callback.select.apply({id:(typeof this.items.hidden[i]["PREFIX"]!="undefined"?this.items.hidden[i]["PREFIX"]:"SG")+this.items.hidden[i]["ID"],name:this.items.hidden[i]["NAME"]},typeof this.items.hidden[i]["TYPE"]!="undefined"?this.items.hidden[i]["TYPE"]:"sonetgroups","",true,"","init")}}}},show:function(){this.initDialog()},initDialog:function(t){if(typeof t=="undefined"||typeof t.realParams=="undefined"){t=null}if(this.blockInit){return}var e={id:this.id};if(!this.initialized){BX.onCustomEvent(window,"BX.Main.SelectorV2:beforeInitDialog",[e])}setTimeout(BX.delegate(function(){if(typeof e.blockInit=="undefined"||e.blockInit!==true){if(this.initialized){if(!this.mainPopupWindow||!this.mainPopupWindow.isShown()){if(this.input){this.input.style.display="inline-block"}if(this.inputBox){this.inputBox.style.display="inline-block"}this.openDialog(t)}}else{this.getData(BX.delegate(function(e){if(!!this.openDialogWhenInit){if(this.input){this.input.style.display="inline-block"}if(this.inputBox){this.inputBox.style.display="inline-block"}this.openDialog(t)}BX.onCustomEvent(window,"BX.Main.SelectorV2:afterInitDialog",[{id:this.id}]);if(typeof this.options.eventOpen!="undefined"&&!this.eventOpenBinded){this.eventOpenBinded=true;BX.addCustomEvent(window,this.options.eventOpen,function(t){if(typeof t.id=="undefined"||t.id!=this.id){return}if(this.options.multiple!="Y"&&this.inputItemsContainer&&this.inputItemsContainer.children.length>0){return}if(this.mainPopupWindow&&this.mainPopupWindow.isShown()){return}if(this.input){this.input.style.display="inline-block"}if(this.inputBox){this.inputBox.style.display="inline-block"}var e=BX.type.isNotEmptyObject(t)&&t.bindNode?t.bindNode:this.bindNode;var i=BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyObject(t.bindPosition)?t.bindPosition:false;if(e){var n=BX.findChild(e,{tagName:"input",attr:{type:"text"}},true);if(n){this.selectorInstance.nodes.input=n;var s=this.tag||BX(t.tagId);if(s){this.selectorInstance.nodes.tag=s}if(n.getAttribute("data-bxchangehandler")!=="Y"){BX.bind(n,"keydown",function(t){this.selectorInstance.getSearchInstance().beforeSearchHandler({event:t})}.bind(this));BX.bind(n,"bxchange",function(t){this.selectorInstance.getSearchInstance().searchHandler({event:t})}.bind(this));n.setAttribute("data-bxchangehandler","Y")}}}if(i||e){if(!this.initialized){this.selectorInstance.itemsSelected={}}if(typeof t.value!="undefined"){this.selectorInstance.itemsSelected=t.value}this.openDialog({bindNode:e,bindPosition:i})}}.bind(this))}},this))}}},this),1)},openDialog:function(t){if(BX.type.isNotEmptyObject(t)){if(typeof t.bindNode!="undefined"){this.selectorInstance.bindOptions.node=t.bindNode}if(typeof t.bindPosition!="undefined"){this.selectorInstance.bindOptions.position=t.bindPosition}}this.selectorInstance.openDialog();this.mainPopupWindow=this.getOption("useContainer")=="Y"?this.selectorInstance.popups.container:this.selectorInstance.popups.main},closeDialog:function(){this.selectorInstance.closeDialog()},getData:function(t){this.blockInit=true;BX.onCustomEvent("BX.Main.SelectorV2:onGetDataStart",[this.id]);BX.ajax.runComponentAction("bitrix:main.ui.selector","getData",{mode:"ajax",data:{options:this.options,entityTypes:this.entityTypes,selectedItems:this.items.selected||{}}}).then(function(e){if(BX.type.isNotEmptyObject(e.data)){this.blockInit=false;BX.onCustomEvent("BX.Main.SelectorV2:onGetDataFinish",[this.id]);this.addData(e.data,t);this.initialized=true}}.bind(this),function(t){this.blockInit=false;BX.onCustomEvent("BX.Main.SelectorV2:onGetDataFinish",[this.id])}.bind(this))},loadAll:function(t){var e=BX.type.isNotEmptyString(t.entity)?t.entity.toUpperCase():"USERS";if(BX.type.isNotEmptyObject(t)&&BX.type.isFunction(t.callback)&&!BX.Main.selectorManagerV2.loadedEntities[e]){BX.Main.selectorManagerV2.loadedEntities[e]=true;BX.ajax.runComponentAction("bitrix:main.ui.selector","loadAll",{mode:"ajax",data:{entityType:e}}).then(function(e){if(BX.type.isNotEmptyObject(e.data)){for(var i in e.data){if(e.data.hasOwnProperty(i)){BX.onCustomEvent("onFinderAjaxLoadAll",[e.data[i],BX.UI.SelectorManager,i.toLowerCase()])}}t.callback()}}.bind(this),function(t){}.bind(this))}},searchRequest:function(t){this.blockInit=true;if(this.selectorInstance.timeouts.search){clearTimeout(this.selectorInstance.timeouts.search)}var e=new Date;this.selectorInstance.searchRequestId=e.getTime();BX.ajax.runComponentAction("bitrix:main.ui.selector","doSearch",{mode:"ajax",data:{searchString:t.searchString,searchStringConverted:BX.message("LANGUAGE_ID")=="ru"&&BX.correctText?BX.correctText(t.searchString):"",currentTimestamp:this.selectorInstance.searchRequestId,options:this.options,entityTypes:this.entityTypes,additionalData:BX.type.isNotEmptyObject(t.additionalData)?t.additionalData:{}},onrequeststart:function(t){this.selectorInstance.searchXhr=t}.bind(this)}).then(function(e){this.blockInit=false;if(BX.type.isNotEmptyObject(e.data)&&e.data.currentTimestamp&&e.data.currentTimestamp==this.selectorInstance.searchRequestId&&BX.type.isNotEmptyObject(t.callback)&&BX.type.isFunction(t.callback.success)){t.callback.success(e.data,{searchString:t.searchString,searchStringOriginal:BX.type.isNotEmptyObject(t.searchStringOriginal)?t.searchStringOriginal:t.searchString})}}.bind(this),function(e){this.blockInit=false;if(BX.type.isNotEmptyObject(t.callback)&&BX.type.isFunction(t.callback.failure)){t.callback.failure(BX.type.isNotEmptyObject(e.data)?e.data:{})}}.bind(this))},getTreeItemRelation:function(t){BX.ajax.runComponentAction("bitrix:main.ui.selector","getTreeItemRelation",{mode:"ajax",data:{entityType:t.entityType,categoryId:t.categoryId,allowSearchSelf:t.allowSearchSelf}}).then(function(e){if(BX.type.isNotEmptyObject(e.data)&&typeof t.callback!="undefined"){t.callback({selectorInstanceId:this.selectorInstance.id,entityType:t.entityType,categoryId:t.categoryId,data:e.data})}}.bind(this),function(t){})},addData:function(t,e){BX.onCustomEvent("BX.Main.SelectorV2:onAddData",[this.id,t]);if(typeof t.ENTITIES.CRM!="undefined"&&typeof t.ENTITIES.CRM.ITEMS_LAST!="undefined"&&BX.type.isNotEmptyObject(t.ENTITIES.CRM.ITEMS_LAST)){}e.apply(this,t)},getId:function(){return this.id},getOption:function(t){return typeof this.options[t]!="undefined"?this.options[t]:null},saveDestination:function(t){if(BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyString(t.itemId)){var e=this.getOption("context");if(BX.type.isNotEmptyString(e)){BX.ajax.runComponentAction("bitrix:main.ui.selector","saveDestination",{mode:"ajax",data:{context:e,itemId:t.itemId}}).then(function(t){},function(t){})}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:99:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/script.min.js?16992580828462";s:6:"source";s:80:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/script.js";s:3:"min";s:84:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/script.min.js";s:3:"map";s:84:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/script.map.js";}"*/
this.BX=this.BX||{};(function(t){"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetTagSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetTagSelector=BX.Tasks.Component.extend({sys:{code:"tag-sel-is"},methods:{construct:function t(){this.callConstruct(BX.Tasks.Component);this.subInstance("items",(function(){return new this.constructor.Items({scope:this.scope(),data:this.option("data"),groupId:this.option("groupId"),taskId:this.option("taskId"),userName:this.option("userName"),isScrumTask:this.option("isScrumTask")==="Y",tagsAreConverting:this.option("tagsAreConverting"),preRendered:true})}))}}});BX.Tasks.Component.TasksWidgetTagSelector.Items=BX.Tasks.Util.ItemSet.extend({sys:{code:"tag-sel"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:true,dialog:null,dialogCallback:true},methods:{bindEvents:function t(){this.callMethod(BX.Tasks.Util.ItemSet,"bindEvents");this.bindDelegateControl("form-control","click",this.passCtx(this.openAddForm));BX.addCustomEvent(window,"onTaskTagSelectAlt",this.onTagsChange.bind(this));var e=function t(e){var s=e.oldTagsNames;if(this.opts.dialog){this.opts.dialog.hide()}var a=[];this.each((function(t){a.push(t)}));var i=[];a.forEach((function(t){i.push(t.display())}));var o=e.oldTagName;var n=e.newTagName;if(!this.opts.changedItems){this.opts.changedItems=[]}a.forEach(function(t){if(o&&n!==""&&t.display()===o){this.addItem({NAME:n});this.opts.changedItems.indexOf(n)===-1&&this.opts.changedItems.push(n);var e=this.opts.changedItems.indexOf(o);this.opts.changedItems.splice(e,e);this.deleteItem(t.value());return}if(o&&n===""&&t.display()===o){var a=this.opts.changedItems.indexOf(o);this.opts.changedItems.splice(a,a);this.deleteItem(t.value());return}if(s&&s.length!==0){if(s.indexOf(t.display())!==-1){var i=this.opts.changedItems.indexOf(o);this.opts.changedItems.splice(i,i);this.deleteItem(t.value());return}else{this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}return}this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}.bind(this));this.opts.dialog=null};var s=function t(e){if(this.opts.dialog){this.selectedItems=this.opts.dialog.getSelectedItems();this.opts.dialog.hide();this.opts.dialog=null}if(!e.data.groupId||e.data.groupId.length===0){this.opts.groupId=0;this.tagOwner=this.option("userName")}else{this.opts.groupId=parseInt(e.data.groupId[0].match(/\d+/));this.tagOwner=e.data.owner}};BX.addCustomEvent("onProjectChanged",s.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"tag_changed",callback:e.bind(this)});this.getTagSelector().load()},onTagsChange:function t(e){var s=e.getTarget();var a=e.getData().item;a.setSort(1);s.getTab("all").getRootNode().addItem(a);var i=[];this.each((function(t){i.push(t.display())}));var o=this.getTagSelector().getItems();var n=[];for(var r=0;r<o.length;r++){var d=o[r];if(d.isSelected()){n.push(d.getTitle());if(!BX.util.in_array(d.getTitle(),i)){this.addItem({NAME:d.getTitle()})}}}this.each((function(t){if(!BX.util.in_array(t.display(),n)){this.deleteItem(t.value())}}))},openAddForm:function t(e){if(this.option("tagsAreConverting")){var s=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function t(){s.close()}});s.show();return}this.getTagSelector().show()},onItemDeleteByCross:function t(e){BX.onCustomEvent("onTaskTagDeleteByCross",[e.opts.data]);this.callMethod(BX.Tasks.Util.ItemSet,"onItemDeleteByCross",arguments);this.unselectDialogItem(e)},unselectDialogItem:function t(e){var s=this.getTagSelector();if(!s){return}this.opts.dialogCallback=false;if(babelHelpers["typeof"](e)==="object"){e=e.data()}var a=s.getItem(this.prepareTagItemData(e,s));a&&a.deselect();this.opts.dialogCallback=true},prepareItemData:function t(e){return["task-tag",e.NAME]},prepareTagItemData:function t(e,s){var a=s.getItems();var i=null;a.forEach((function(t){if(t.title.text===e.NAME){i=t.id;return}}));return{id:i,entityId:"task-tag"}},extractItemDisplay:function t(e){return e.NAME},extractItemValue:function t(e){if("VALUE"in e){return e.VALUE}return Math.abs(this.hashCode(e.NAME))},hashCode:function t(e){if(!BX.type.isNotEmptyString(e)){return 0}var s=0;for(var a=0;a<e.length;a++){var i=e.charCodeAt(a);if(i>255){i-=848}s=(s<<5)-s+i;s=s&s}return s},getTagSelector:function t(){var e=this.opts.taskId;var s=this.opts.groupId;var a=this.selectedItems;var i=this.opts.changedItems;var o=this.tagOwner;if(this.opts.groupId===0){var n=BX.UI.EntitySelector.Dialog.getById("tasksMemberSelector_project");if(n){var r=n.getSelectedItems();if(r.length!==0){this.opts.dialog=null;this.opts.groupId=r[0].id;s=this.opts.groupId}}}var d=function t(){var e=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");e.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;e.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var l=function t(){var e=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");e.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;e.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var c=function t(e){var s=e.getTarget();var a=e.getData().query;if(a.trim()!==""){d()}else{l()}};var g=function t(e,s){var a=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");if(a.getContainer().querySelector("div.".concat(e))){return}var i=document.createElement("div");i.className=e;i.innerHTML="\n\t\t\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t\t\t".concat(s,"\n\t\t\t\t\t\t\t</span> \n\t\t\t\t\t\t</div>\n\t\t\t\t\t");a.getFooterContainer().before(i)};var h=function t(n){var r=n.getTarget();if(i){i.forEach((function(t){var e=r.addItem({id:t,entityId:"task-tag",title:t,tabs:"all",badges:[{title:o}]});e.select()}))}if(a){a.forEach((function(t){var e=t.title.text;var s=false;r.getItems().forEach((function(t){if(t.title.text===e){s=true;t.select();t.setBadges([{title:o}])}}));if(!s){var a=r.addItem({id:t.title.text,entityId:t.entityId,title:t.title.text,tabs:"all",badges:[{title:o}]});a.select()}}))}var d=["click","keydown"];var l=function t(a){if(a.type==="keydown"){if(!((a.ctrlKey||a.metaKey)&&a.keyCode===13)){return}}var i=r.getTagSelectorQuery();if(i.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.tag.list","addTag",{mode:"class",data:{newTag:i,taskId:e,groupId:s}}).then((function(t){if(t.data.success){var e=r.addItem({id:i,entityId:"task-tag",title:i,sort:1,badges:[{title:t.data.owner}]});r.getTab("all").getRootNode().addItem(e);e.select();r.clearSearch()}else{var s="tasks-selector-add-tag-already-exists-alert";g(s,t.data.error);var a=function t(){var e=r.getContainer().querySelector("div.".concat(s));e&&e.remove()};setTimeout(a,2e3)}}))};d.forEach((function(t){if(t==="click"){r.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(t,l)}else{r.getContainer().addEventListener(t,l)}}))};var u=function(){var t=document.querySelectorAll("div.task-options-item-open-inner");var e=this.control("form-control");t.forEach((function(t){if(t.contains(e)){e=t}}));return e}.bind(this);if(this.opts.dialog){return this.opts.dialog}this.opts.dialog=new BX.UI.EntitySelector.Dialog({id:"tasksTagSelector",targetNode:u(),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:this.option("taskId"),groupId:this.opts.groupId}}],searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{taskId:this.opts.taskId,groupId:this.opts.groupId},clearUnavailableItems:true,events:{onLoad:function(t){t.getTarget().getFooterContainer().style.zIndex=1;h(t)}.bind(this),onSearch:function(t){c(t)}.bind(this),"Item:onSelect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this),"Item:onDeselect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this)}});return this.opts.dialog}}})}).call(undefined)})(this.BX.Tasks=this.BX.Tasks||{});
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/logic.min.js?16992580828205";s:6:"source";s:79:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/logic.js";s:3:"min";s:83:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/logic.min.js";s:3:"map";s:83:"/bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetTagSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetTagSelector=BX.Tasks.Component.extend({sys:{code:"tag-sel-is"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.subInstance("items",(function(){return new this.constructor.Items({scope:this.scope(),data:this.option("data"),groupId:this.option("groupId"),taskId:this.option("taskId"),userName:this.option("userName"),isScrumTask:this.option("isScrumTask")==="Y",tagsAreConverting:this.option("tagsAreConverting"),preRendered:true})}))}}});BX.Tasks.Component.TasksWidgetTagSelector.Items=BX.Tasks.Util.ItemSet.extend({sys:{code:"tag-sel"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:true,dialog:null,dialogCallback:true},methods:{bindEvents:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindEvents");this.bindDelegateControl("form-control","click",this.passCtx(this.openAddForm));BX.addCustomEvent(window,"onTaskTagSelectAlt",this.onTagsChange.bind(this));var t=function(t){var e=t.oldTagsNames;if(this.opts.dialog){this.opts.dialog.hide()}var s=[];this.each((function(t){s.push(t)}));var a=[];s.forEach((function(t){a.push(t.display())}));var i=t.oldTagName;var o=t.newTagName;if(!this.opts.changedItems){this.opts.changedItems=[]}s.forEach(function(t){if(i&&o!==""&&t.display()===i){this.addItem({NAME:o});this.opts.changedItems.indexOf(o)===-1&&this.opts.changedItems.push(o);var s=this.opts.changedItems.indexOf(i);this.opts.changedItems.splice(s,s);this.deleteItem(t.value());return}if(i&&o===""&&t.display()===i){var a=this.opts.changedItems.indexOf(i);this.opts.changedItems.splice(a,a);this.deleteItem(t.value());return}if(e&&e.length!==0){if(e.indexOf(t.display())!==-1){var n=this.opts.changedItems.indexOf(i);this.opts.changedItems.splice(n,n);this.deleteItem(t.value());return}else{this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}return}this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}.bind(this));this.opts.dialog=null};var e=function(t){if(this.opts.dialog){this.selectedItems=this.opts.dialog.getSelectedItems();this.opts.dialog.hide();this.opts.dialog=null}if(!t.data.groupId||t.data.groupId.length===0){this.opts.groupId=0;this.tagOwner=this.option("userName")}else{this.opts.groupId=parseInt(t.data.groupId[0].match(/\d+/));this.tagOwner=t.data.owner}};BX.addCustomEvent("onProjectChanged",e.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"tag_changed",callback:t.bind(this)});this.getTagSelector().load()},onTagsChange:function(t){var e=[];this.each((function(t){e.push(t.display())}));var s=this.getTagSelector().getItems();var a=[];for(var i=0;i<s.length;i++){var o=s[i];if(o.isSelected()){a.push(o.getTitle());if(!BX.util.in_array(o.getTitle(),e)){this.addItem({NAME:o.getTitle()})}}}this.each((function(t){if(!BX.util.in_array(t.display(),a)){this.deleteItem(t.value())}}))},openAddForm:function(t){if(this.option("tagsAreConverting")){var e=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function(){e.close()}});e.show();return}this.getTagSelector().show()},onItemDeleteByCross:function(t){BX.onCustomEvent("onTaskTagDeleteByCross",[t.opts.data]);this.callMethod(BX.Tasks.Util.ItemSet,"onItemDeleteByCross",arguments);this.unselectDialogItem(t)},unselectDialogItem:function(t){var e=this.getTagSelector();if(!e){return}this.opts.dialogCallback=false;if(typeof t==="object"){t=t.data()}var s=e.getItem(this.prepareTagItemData(t,e));s&&s.deselect();this.opts.dialogCallback=true},prepareItemData:function(t){return["task-tag",t.NAME]},prepareTagItemData:function(t,e){var s=e.getItems();var a=null;s.forEach((function(e){if(e.title.text===t.NAME){a=e.id;return}}));return{id:a,entityId:"task-tag"}},extractItemDisplay:function(t){return t.NAME},extractItemValue:function(t){if("VALUE"in t){return t.VALUE}return Math.abs(this.hashCode(t.NAME))},hashCode:function(t){if(!BX.type.isNotEmptyString(t)){return 0}var e=0;for(var s=0;s<t.length;s++){var a=t.charCodeAt(s);if(a>255){a-=848}e=(e<<5)-e+a;e=e&e}return e},getTagSelector:function(){var t=this.opts.taskId;var e=this.opts.groupId;var s=this.selectedItems;var a=this.opts.changedItems;var i=this.tagOwner;if(this.opts.groupId===0){var o=BX.UI.EntitySelector.Dialog.getById("tasksMemberSelector_project");if(o){var n=o.getSelectedItems();if(n.length!==0){this.opts.dialog=null;this.opts.groupId=n[0].id;e=this.opts.groupId}}}var r=function(){var t=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");t.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;t.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var d=function(){var t=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");t.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;t.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var l=function(t){var e=t.getTarget();var s=t.getData().query;if(s.trim()!==""){r()}else{d()}};var c=function(t,e){var s=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");if(s.getContainer().querySelector(`div.${t}`)){return}var a=document.createElement("div");a.className=t;a.innerHTML=`\n\t\t\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t\t\t${e}\n\t\t\t\t\t\t\t</span> \n\t\t\t\t\t\t</div>\n\t\t\t\t\t`;s.getFooterContainer().before(a)};var g=function(o){var n=o.getTarget();if(a){a.forEach((function(t){var e=n.addItem({id:t,entityId:"task-tag",title:t,tabs:"all",badges:[{title:i}]});e.select()}))}if(s){s.forEach((function(t){var e=t.title.text;var s=false;n.getItems().forEach((function(t){if(t.title.text===e){s=true;t.select();t.setBadges([{title:i}])}}));if(!s){var a=n.addItem({id:t.title.text,entityId:t.entityId,title:t.title.text,tabs:"all",badges:[{title:i}]});a.select()}}))}var r=["click","keydown"];var d=function(s){if(s.type==="keydown"){if(!((s.ctrlKey||s.metaKey)&&s.keyCode===13)){return}}var a=n.getTagSelectorQuery();if(a.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.tag.list","addTag",{mode:"class",data:{newTag:a,taskId:t,groupId:e}}).then((function(t){if(t.data.success){var e=n.addItem({id:a,entityId:"task-tag",title:a,tabs:"all",badges:[{title:i}]});var s={title:t.data.owner};e.setBadges([s]);e.select();n.clearSearch()}else{var o="tasks-selector-add-tag-already-exists-alert";c(o,t.data.error);var r=function(){var t=n.getContainer().querySelector(`div.${o}`);t&&t.remove()};setTimeout(r,2e3)}}))};r.forEach((function(t){if(t==="click"){n.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(t,d)}else{n.getContainer().addEventListener(t,d)}}))};var h=function(){var t=document.querySelectorAll("div.task-options-item-open-inner");var e=this.control("form-control");t.forEach((function(t){if(t.contains(e)){e=t}}));return e}.bind(this);if(this.opts.dialog){return this.opts.dialog}this.opts.dialog=new BX.UI.EntitySelector.Dialog({id:"tasksTagSelector",targetNode:h(),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:this.option("taskId"),groupId:this.opts.groupId}}],searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{taskId:this.opts.taskId,groupId:this.opts.groupId},clearUnavailableItems:true,events:{onLoad:function(t){t.getTarget().getFooterContainer().style.zIndex=1;g(t)}.bind(this),onSearch:function(t){l(t)}.bind(this),"Item:onSelect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this),"Item:onDeselect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this)}});return this.opts.dialog}}})}).call(this);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:99:"/bitrix/components/bitrix/tasks.scrum.epic.selector/templates/.default/script.min.js?16992580838941";s:6:"source";s:80:"/bitrix/components/bitrix/tasks.scrum.epic.selector/templates/.default/script.js";s:3:"min";s:84:"/bitrix/components/bitrix/tasks.scrum.epic.selector/templates/.default/script.min.js";s:3:"map";s:84:"/bitrix/components/bitrix/tasks.scrum.epic.selector/templates/.default/script.map.js";}"*/
this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,i,r){"use strict";var n,s,a;var o=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=t.groupId;this.taskId=t.taskId;this.epic=t.epic;this.canEdit=t.canEdit;this.dialog=null;this.node=null;this.nameNode=null;this.selectorNode=null;i.EventEmitter.subscribe("onChangeProjectLink",this.onChangeTaskProject.bind(this))}babelHelpers.createClass(e,[{key:"renderTo",value:function e(i){t.Dom.append(this.render(),i)}},{key:"render",value:function e(){this.node=t.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>\n\t\t"])),this.renderName(),this.renderSelector());return this.node}},{key:"onChangeTaskProject",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,2),n=r[0],s=r[1];this.groupId=parseInt(n,10);this.taskId=parseInt(s,10);this.epic=null;this.dialog=null;this.updateSelector(null)}},{key:"renderName",value:function e(){if(t.Type.isNull(this.epic)){return""}var i=this.convertHexToRGBA(this.epic.color,.7);var r=this.convertHexToRGBA(this.epic.color,.3);this.nameNode=t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div\n\t\t\t\tclass="tasks-scrum__epic-selector--epic"\n\t\t\t\tstyle="background: ',"; border-color: ",';"\n\t\t\t>\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),r,i,t.Text.encode(this.epic.name));return this.nameNode}},{key:"renderSelector",value:function e(){this.selectorNode=t.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="ui-btn-link tasks-scrum__epic-selector--link">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.getButtonText());var i=this.selectorNode.firstElementChild;t.Event.bind(i,"click",this.onClick.bind(this,i));return this.selectorNode}},{key:"onClick",value:function e(i){var n=this;if(this.dialog){if(this.dialog.isOpen()){this.dialog.hide()}else{this.dialog.show()}return}var s=[];if(!t.Type.isNull(this.epic)){s.push(["epic-selector",this.epic.id])}this.dialog=new r.Dialog({id:t.Text.getRandom(),targetNode:this.selectorNode,width:350,height:300,multiple:false,dropdownMode:true,enableSearch:true,compactView:true,hideOnDeselect:true,context:"epic-selector-"+this.groupId,preselectedItems:s,entities:[{id:"epic-selector",options:{groupId:this.groupId},dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:true,footerOptions:{label:t.Loc.getMessage("TSE_SELECTOR_SEARCHER_EPIC_ADD")}},events:{"Search:onItemCreateAsync":function e(t){return new Promise((function(e){var i=t.getData(),r=i.searchQuery;n.createEpic(r.getQuery()).then((function(t){var i=n.getEpicDialogItem(t);i.selected=true;i.sort=1;n.dialog.addItem(i);n.dialog.hide();e()}))}))}},tagSelectorOptions:{textBoxWidth:300}});this.dialog.subscribe("onHide",(function(){var e=n.dialog.getSelectedItems();var t=e.length?e[0].getId():0;n.changeTaskEpic(t).then((function(e){return n.updateSelector(e)}))}));this.dialog.show()}},{key:"updateSelector",value:function e(i){this.epic=i;this.selectorNode.firstElementChild.textContent=this.getButtonText();if(t.Type.isNull(i)){t.Dom.remove(this.nameNode);this.nameNode=null}else{if(t.Type.isNull(this.nameNode)){t.Dom.insertBefore(this.renderName(),this.selectorNode)}else{t.Dom.replace(this.nameNode,this.renderName())}}}},{key:"getEpicDialogItem",value:function e(t){return{id:t.id,entityId:"epic-selector",title:t.name,tabs:"recents",avatarOptions:{bgColor:t.color,bgImage:"none",borderRadius:"12px"}}}},{key:"changeTaskEpic",value:function e(i){var r=this;return t.ajax.runComponentAction("bitrix:tasks.scrum.epic.selector","changeTaskEpic",{mode:"class",data:{taskId:this.taskId,epicId:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"createEpic",value:function e(i){var r=this;return t.ajax.runAction("bitrix:tasks.scrum.epic.createEpic",{data:{groupId:this.groupId,name:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"getButtonText",value:function e(){if(t.Type.isNull(this.epic)){return t.Loc.getMessage("TSE_SELECTOR_ADD")}else{return t.Loc.getMessage("TSE_SELECTOR_EDIT")}}},{key:"convertHexToRGBA",value:function e(t,i){var r=t.replace("#","");if(r.length===3){r="".concat(r[0]).concat(r[0]).concat(r[1]).concat(r[1]).concat(r[2]).concat(r[2])}var n=parseInt(r.substring(0,2),16);var s=parseInt(r.substring(2,4),16);var a=parseInt(r.substring(4,6),16);return"rgba(".concat(n,",").concat(s,",").concat(a,",").concat(i,")")}},{key:"showErrorAlert",value:function e(i,r){if(t.Type.isUndefined(i.errors)){return}if(i.errors.length){var n=i.errors.shift();if(n){var s=n.code?n.code:"";var a=n.message+" "+s;var o=r?r:t.Loc.getMessage("TSE_SELECTOR_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(a,o)}}}}]);return e}();var c;var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=t.groupId;this.taskId=t.taskId;this.savedEpic=t.epic;this.inputName=t.inputName;this.selector=null;this.node=null;this.inputNode=null;i.EventEmitter.subscribe("BX.Tasks.MemberSelector:projectSelected",this.onProjectSelected.bind(this));i.EventEmitter.subscribe("BX.Tasks.Component.Task:projectPreselected",this.onProjectPreselected.bind(this))}babelHelpers.createClass(e,[{key:"renderTo",value:function e(i){this.node=i;t.Dom.addClass(this.node,"tasks-scrum-epic-edit-selector");if(this.inputName){t.Dom.append(this.renderInput(),this.node)}this.buildSelector().renderTo(this.node)}},{key:"renderInput",value:function e(){var i=this.savedEpic?parseInt(this.savedEpic.id,10):0;this.inputNode=t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="hidden" name="','" value="','">\n\t\t'])),t.Text.encode(this.inputName),i);return this.inputNode}},{key:"buildSelector",value:function e(){var i=this;var n=[];if(this.savedEpic){n.push(["epic-selector",this.savedEpic.id]);this.updateInputValue(this.savedEpic.id)}this.selector=new r.TagSelector({multiple:false,textBoxWidth:200,dialogOptions:{width:350,height:240,dropdownMode:true,compactView:true,multiple:false,hideOnDeselect:true,context:"epic-selector-"+this.groupId,preselectedItems:n,entities:[{id:"epic-selector",options:{groupId:this.groupId},dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:true,footerOptions:{label:t.Loc.getMessage("TSE_SELECTOR_SEARCHER_EPIC_ADD")}},items:[],events:{"Search:onItemCreateAsync":function e(t){return new Promise((function(e){var r=t.getData(),n=r.searchQuery;var s=t.getTarget();i.createEpic(n.getQuery()).then((function(t){var r=i.getEpicDialogItem(t);r.selected=true;r.sort=1;s.addItem(r);i.updateInputValue(r.id);e()}))}))},"Item:onSelect":function e(t){var r=t.getData().item;i.updateInputValue(r.getId())},"Item:onDeselect":function e(t){var r=t.getTarget();setTimeout((function(){if(r.getSelectedItems().length===0){i.updateInputValue(0)}}),50)}}}});this.selector.subscribe("onMetaEnter",(function(e){var t=e.getTarget();if(t.getDialog().isOpen()){var i=e.getData(),r=i.event;r.stopPropagation()}}));return this.selector}},{key:"onProjectSelected",value:function e(i){var r=i.getData();this.groupId=parseInt(r.ID,10);this.updateInputValue(0);this.savedEpic=null;t.Dom.clean(this.node);this.renderTo(this.node)}},{key:"onProjectPreselected",value:function e(i){var r=i.getData();this.groupId=parseInt(r.groupId,10);t.Dom.clean(this.node);this.renderTo(this.node)}},{key:"updateInputValue",value:function e(t){this.inputNode.value=parseInt(t,10)}},{key:"getEpicDialogItem",value:function e(t){return{id:t.id,entityId:"epic-selector",title:t.name,tabs:"recents",avatarOptions:{bgColor:t.color,bgImage:"none",borderRadius:"12px"}}}},{key:"createEpic",value:function e(i){var r=this;return t.ajax.runAction("bitrix:tasks.scrum.epic.createEpic",{data:{groupId:this.groupId,name:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"showErrorAlert",value:function e(i,r){if(t.Type.isUndefined(i.errors)){return}if(i.errors.length){var n=i.errors.shift();if(n){var s=n.code?n.code:"";var a=n.message+" "+s;var o=r?r:t.Loc.getMessage("TSE_SELECTOR_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(a,o)}}}}]);return e}();var d=function(){function e(i){babelHelpers.classCallCheck(this,e);this.groupId=parseInt(i.groupId,10);this.taskId=parseInt(i.taskId,10);this.epic=t.Type.isPlainObject(i.epic)?i.epic:null;this.canEdit=i.canEdit==="Y";this.mode=i.mode==="edit"?"edit":"view";this.inputName=i.inputName}babelHelpers.createClass(e,[{key:"renderTo",value:function e(t){if(this.mode==="view"){new o({groupId:this.groupId,taskId:this.taskId,epic:this.epic,canEdit:this.canEdit}).renderTo(t)}else{new l({groupId:this.groupId,taskId:this.taskId,epic:this.epic,inputName:this.inputName}).renderTo(t)}}}]);return e}();e.EpicSelector=d})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX,BX.Event,BX.UI.EntitySelector);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:95:"/bitrix/components/bitrix/tasks.userfield.panel/templates/.default/logic.min.js?169925808314709";s:6:"source";s:75:"/bitrix/components/bitrix/tasks.userfield.panel/templates/.default/logic.js";s:3:"min";s:79:"/bitrix/components/bitrix/tasks.userfield.panel/templates/.default/logic.min.js";s:3:"map";s:79:"/bitrix/components/bitrix/tasks.userfield.panel/templates/.default/logic.map.js";}"*/
"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.UserFieldPanel!="undefined"){return}BX.Tasks.Component.UserFieldPanel=BX.Tasks.Component.extend({sys:{code:"uf-panel"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.instances.items=new BX.Tasks.Component.UserFieldPanel.ItemSet({scope:this.scope(),data:this.option("scheme"),itemFx:"vertical",parent:this});this.instances.items.bindEvent("item-save",BX.delegate(this.onItemSave,this));this.instances.items.bindEvent("item-hide",BX.delegate(this.onItemHide,this));this.instances.items.bindEvent("item-delete",BX.delegate(this.onItemDelete,this));this.saveState=BX.debounce(this.saveStateInstant,1200,this);this.redrawButtons()},bindEvents:function(){this.bindControlPassCtx("add-field","click",this.showAddPopup);this.bindControlPassCtx("action","click",this.showActionPopup);this.bindControlPassCtx("un-hide-field","click",this.showUnHideFieldPopup);this.bindDelegateControl("item-label-edit","keypress",this.jamEnter,this.control("new-item-place"))},jamEnter:function(t){if(BX.Tasks.Util.isEnter(t)){BX.eventReturnFalse(t)}},redrawButtons:function(){var t=false;var e=true;this.instances.items.each((function(i){if(!i.data().STATE.D){t=true}else{e=false}}));this.changeCSSFlag("invisible",!t,this.control("un-hide-field"));this.changeCSSFlag("not-empty",!e,this.control("items"))},openAddForm:function(t,e,i){t.popupWindow.close();i.options=i.options||{};this.instances.items.openAddForm(i.options.code||i.code)},onItemSave:function(t,e,i){i.ENTITY_CODE=this.option("entityCode");BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","saveField",{mode:"class",data:{id:e,data:i,parameters:{INPUT_PREFIX:this.option("inputPrefix"),RELATED_ENTITIES:this.option("relatedEntities")}}}).then(function(e){if(!e.status||e.status!=="success"){return}t.fulfill(e.data)}.bind(this),function(e){t.reject(e.errors)}.bind(this))},onItemHide:function(t,e){var i=this.option("user");var s=i.IS_SUPER;var n=BX.message(s?"TASKS_TUFP_FIELD_HIDE_DELETE_CONFIRM":"TASKS_TUFP_FIELD_HIDE_CONFIRM");var a={id:this.code()+"-fh-confirm-v2",ctx:this,isDisposable:!s,buttonSet:s?[{text:BX.message("TASKS_COMMON_DELETE"),type:"red",code:"delete"},{text:BX.message("TASKS_COMMON_HIDE"),type:"green",code:"continue",default:true}]:false};BX.Tasks.confirm(n,null,a).then(function(i){if(i==="continue"){this.setItemStateDisplay(e,false);t.fulfill("hide")}else if(i==="delete"){BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","deleteField",{mode:"class",data:{id:e,parameters:{RELATED_ENTITIES:this.option("relatedEntities")}}}).then(function(e){if(!e.status||e.status!=="success"){t.reject();return}t.fulfill("delete")}.bind(this),function(e){BX.Tasks.alert(e.errors);t.reject()}.bind(this))}}.bind(this))},onItemDelete:function(t){this.redrawButtons()},setItemStateDisplay:function(t,e,i){this.instances.items.get(t).data().STATE.D=e;this.redrawButtons();if(i){this.saveStateInstant()}else{this.saveState()}},setItemSortBefore:function(t,e){var i=[];this.instances.items.each((function(t){i.push({value:parseInt(t.value()),sort:t.data().STATE.S})}));i=i.sort((function(t,e){if(t.sort>e.sort){return 1}else if(t.sort<e.sort){return-1}return 0}));var s=parseInt(t.value());var n=e?parseInt(e.value()):-1;var a=1;for(var o in i){if(i.hasOwnProperty(o)){if(i[o].value!=s){if(i[o].value==n){this.instances.items.get(s).data().STATE.S=a;a=a+1}this.instances.items.get(i[o].value).data().STATE.S=a;a=a+1}}}if(n<0){this.instances.items.get(s).data().STATE.S=a}this.saveState()},saveStateInstant:function(t){BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","setState",{mode:"class",data:{state:this.packState(),dropAll:!!t,entityCode:this.option("entityCode")}}).then(function(t){}.bind(this),function(t){}.bind(this))},packState:function(){var t={};this.instances.items.each((function(e){t[e.value()]=e.data().STATE}));return t},initDragNDrop:function(){if(!this.instances.dragNDrop){var t=new BX.Tasks.Util.DragAndDrop({createFlying:BX.delegate((function(t){var e=this.getItemByNode(t);return this.getNodeByTemplate("item-flying",e.data())[0]}),this),autoMarkItemAfter:true,autoMarkZoneTopBottom:true});t.bindDropZone(this.control("items"));t.bindEvent("item-relocation-before",this.onDragNDropItemRelocatedBefore,this);t.bindEvent("item-relocation-after",this.onDragNDropItemRelocatedAfter,this);this.instances.dragNDrop=t;this.instances.items.each(BX.delegate(this.bindDragNDropNode,this))}},onDragNDropItemRelocatedBefore:function(t,e,i){var s=this.getItemByNode(e);if(s){t.cancelAutoResolve();s.disappear().then((function(){t.fulfill()}))}},onDragNDropItemRelocatedAfter:function(t,e,i){var s=this.getItemByNode(e);if(s){t.cancelAutoResolve();s.appear().then((function(){t.fulfill()}));this.setItemSortBefore(s,this.getItemByNode(i.before))}},getItemByNode:function(t){var e=null;if(t){var i=BX.data(t,"item-value");if(i){e=this.instances.items.get(i)}}return e},bindDragNDropNode:function(t){if(this.instances.dragNDrop){this.instances.dragNDrop.bindNode(t.scope(),{handle:this.controlAll("item-drag",t.scope())})}},registerItem:function(t){this.bindDragNDropNode(t);this.saveStateInstant()},doMenuAction:function(t,e,i){t.popupWindow.close();var s=i.action;if(s=="dragToggle"){i.layout.text.innerHTML=BX.message("TASKS_TUFP_DRAG_N_DROP_"+(i.enabled?"ON":"OFF"));i.enabled=!i.enabled;if(i.enabled){this.initDragNDrop()}this.changeCSSFlag("drag-mode-on",i.enabled,this.scope())}else if(s=="saveToAll"){BX.Tasks.confirm(BX.message("TASKS_TUFP_SAVE_TO_ALL_CONFIRM"),null,{isDisposable:true,id:this.code()+"-savetoall-confirm",ctx:this}).then((function(){this.saveState(true)}))}},getItem:function(t){var e=new BX.Promise(null,this);var i=this.instances.items.get(t);if(i.data().NO_FIELD_HTML){BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","getFieldHtml",{mode:"class",data:{id:t,entityCode:this.option("entityCode"),entityId:this.option("entityId"),parameters:{INPUT_PREFIX:this.option("inputPrefix"),RELATED_ENTITIES:this.option("relatedEntities")}}}).then(function(t){var s="";if(t.status&&t.status==="success"){s=t.data}else{var n=[];for(var a=0;a<t.errors.length;a++){n.push(t.errors[a].message)}s='<div class="task-message-label error">'+n.join("<br />")+"</div>"}i.setFieldHtml(s);e.fulfill(i)}.bind(this),function(t){var s=[];for(var n=0;n<t.errors.length;n++){s.push(t.errors[n].message)}var a='<div class="task-message-label error">'+s.join("<br />")+"</div>";i.setFieldHtml(a);e.fulfill(i)}.bind(this));i.data().NO_FIELD_HTML=false}else{e.fulfill(i)}return e},unHideField:function(t){var e=BX.data(t,"id");if(BX.type.isNotEmptyString(e)){this.setItemStateDisplay(e,true,true);this.getItem(e).then((function(t){this.instances.items.showItem(t)}))}if(this.instances.unHideMenu){this.instances.unHideMenu.hide()}},showActionPopup:function(t){var e=this.option("user");var i=[{action:"dragToggle",enabled:false,text:BX.message("TASKS_TUFP_DRAG_N_DROP_ON"),onclick:this.passCtx(this.doMenuAction)}];if(e.IS_SUPER){i.unshift({action:"saveToAll",text:BX.message("TASKS_TUFP_SAVE_SCHEME_TO_EVERYONE"),onclick:this.passCtx(this.doMenuAction)})}BX.PopupMenu.show(this.id()+"action",t,i,{angle:true,position:"right",offsetLeft:18,offsetTop:0})},canManage:function(){var t=this.option("restriction");if(!t.MANAGE){if(t.TASK_LIMIT_EXCEEDED){BX.UI.InfoHelper.show("limit_tasks_custom_fields",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"taskEdit"}});return false}return true}return true},showAddPopup:function(t){if(!this.canManage()){return}var e=[];var i=this.option("typesToCreate");if(BX.type.isPlainObject(i)){for(var s in i){if(i.hasOwnProperty(s)){e.push({code:s,text:i[s],title:i[s],onclick:this.passCtx(this.openAddForm)})}}}BX.PopupMenu.show(this.id()+"add",t,e,{angle:true,closeByEsc:true,position:"top",offsetLeft:40,offsetTop:5})},showUnHideFieldPopup:function(t){var e="";var i=this.subInstance("items").exportItemData();if(!i.count()){return}i.sort([["STATE.S","asc"]]).each(BX.delegate((function(t){if(!t.STATE.D){e+=this.getHTMLByTemplate("menu-item",{LABEL:t.LABEL,ID:t.ID,LABEL_EXT:t.LABEL+(t.MANDATORY?" ("+BX.message("TASKS_TUFP_FIELD_MANDATORY")+")":""),STAR_INVISIBLE:t.MANDATORY?"":"invisible"})}}),this));this.control("uhmenu").innerHTML=e;if(!this.instances.unHideMenu){this.instances.unHideMenu=new BX.Tasks.Util.ScrollPanePopup({scope:this.control("un-hide-menu"),maxHeight:300,popupParameters:{angle:true,position:"top",offsetLeft:40,offsetTop:5,noAllPaddings:true}});this.instances.unHideMenu.bindDelegateControl("item","click",this.passCtx(this.unHideField))}this.instances.unHideMenu.show(t)}}});BX.Tasks.Component.UserFieldPanel.ItemSet=BX.Tasks.Util.ItemSet.extend({options:{controlBind:"class",preRendered:true,itemAppearFxSpeed:300,itemDisappearFxSpeed:300},methods:{getItemClass:function(){return BX.Tasks.Component.UserFieldPanel.ItemSet.Item},bindItemActions:function(){this.bindDelegateControl("item-hide","click",this.bindOnItem(this.hideItem));this.bindDelegateControl("item-edit","click",this.bindOnItem(this.enterEditItem));this.bindDelegateControl("item-cancel","click",this.bindOnItem(this.leaveEditItem,this.leaveEditItemNew));this.bindDelegateControl("item-save","click",this.bindOnItem(this.saveItem,this.saveItemNew));this.bindDelegateControl("item-label-edit","keypress",this.bindOnItem(this.itemLabelChanged))},hideItem:function(t){var e=new BX.Promise(null,this);this.fireEvent("item-hide",[e,t.value()]);e.then((function(e){if(e=="hide"){t.disappear()}else if(e=="delete"){this.deleteItem(t.value())}}))},showItem:function(t){t.appear()},enterEditItem:function(t){if(this.parent()&&!this.parent().canManage()){return}t.toggleEditMode(true);t.initForm()},leaveEditItem:function(t){t.toggleEditMode(false)},leaveEditItemNew:function(){if(this.instances.newItem){this.instances.newItem.disappear()}},itemLabelChanged:function(t,e){if(BX.Tasks.Util.isEnter(e)){this.saveItem(t);BX.eventReturnFalse(e)}},saveItem:function(t){if(t.isLoading()){return}t.setLoading(true);t.hideErrors();var e=new BX.Promise(null,this);this.fireEvent("item-save",[e,t.value(),t.getFormData()]);e.then((function(e){t.setLoading(false);t.update({LABEL:e.LABEL,MANDATORY:e.MANDATORY!="0"});t.toggleEditMode(false)}),(function(e){t.setLoading(false);t.showErrors(e)}))},saveItemNew:function(){if(this.instances.newItem){var t=this.instances.newItem;if(t.isLoading()){return}t.setLoading(true);t.hideErrors();var e=new BX.Promise(null,this);this.fireEvent("item-save",[e,0,t.getFormData()]);e.then((function(e){t.setLoading(false);t.update({ID:e.ID,FIELD_HTML:e.FIELD_HTML,LABEL:e.LABEL,MULTIPLE:e.MULTIPLE!="0",MANDATORY:e.MANDATORY!="0",STATE:{D:true,S:999999}});t.toggleEditMode(false).then(BX.delegate((function(){this.registerItem(t,{useAppear:false});if(this.parent()){this.parent().registerItem(t)}this.instances.newItem=null}),this))}),(function(e){t.setLoading(false);t.showErrors(e)}))}},openAddForm:function(t){var e=BX.message("TASKS_TUFP_NEW_FIELD_"+t.toUpperCase());if(this.instances.newItem){this.instances.newItem.update({USER_TYPE_ID:t,LABEL:e,DISPLAY:e})}else{this.instances.newItem=this.createItem({VALUE:"new",DISPLAY:e,LABEL:e,USER_TYPE_ID:t,MANDATORY:false,MULTIPLE:false,FIELD_HTML:this.getHTMLByTemplate("item-field-stub"),REQUIRED:"",EDIT:"edit",INVISIBLE:"invisible",DEFACEABLE:"defaceable",DISPLAY_MULTIPLE:"0"});BX.append(this.instances.newItem.scope(),this.control("new-item-place"));this.instances.newItem.toggleEditMode(true,true)}this.instances.newItem.initForm();if(!this.instances.newItem.isShown()){this.instances.newItem.appear()}}}});BX.Tasks.Component.UserFieldPanel.ItemSet.Item=BX.Tasks.Util.ItemSet.Item.extend({options:{controlBind:"class"},methods:{toggleEditMode:function(t,e){this.changeCSSFlag("edit",t);var i=new BX.Promise(null,this);var s=this.control("form-place");if(e){this.changeCSSFlag("invisible",!t,s);i.fulfill()}else{BX.Tasks.Util.fadeSlideToggleByClass(s).then((function(){i.fulfill()}))}if(t){this.initForm()}return i},initForm:function(){var t=this.data();var e=this.control("multiple-edit");this.control("label-edit").value=t.DISPLAY;this.control("required-edit").checked=t.MANDATORY;e.checked=t.MULTIPLE;var i=parseInt(t.VALUE)||t.USER_TYPE_ID=="boolean";e.disabled=i;BX[i?"addClass":"removeClass"](e.parentNode,"disabled");if(t.USER_TYPE_ID=="boolean"){e.checked=false}this.control("label-edit").focus();this.hideErrors()},getFormData:function(){var t=BX.clone(this.data());t.DISPLAY=t.LABEL=this.control("label-edit").value;t.MANDATORY=this.control("required-edit").checked;t.MULTIPLE=this.control("multiple-edit").checked;return t},update:function(t){var e=this.data();if("LABEL"in t){e.LABEL=e.DISPLAY=t.LABEL}if("MANDATORY"in t){e.MANDATORY=t.MANDATORY}if("MULTIPLE"in t){e.MULTIPLE=t.MULTIPLE}if("FIELD_HTML"in t){e.FIELD_HTML=t.FIELD_HTML}if("USER_TYPE_ID"in t){e.USER_TYPE_ID=t.USER_TYPE_ID}if("STATE"in t){e.STATE=t.STATE}if("ID"in t){this.value(t.ID)}this.redraw()},redraw:function(){this.control("label").innerHTML=BX.util.htmlspecialchars(this.data().LABEL);BX[this.data().MANDATORY?"addClass":"removeClass"](this.scope(),"required");this.scope().setAttribute("data-type",this.data().USER_TYPE_ID);this.scope().setAttribute("data-multiple",this.data().MULTIPLE?"1":"0");this.scope().setAttribute("data-item-value",this.data().VALUE);this.setFieldHtml(this.data().FIELD_HTML);delete this.data().FIELD_HTML},value:function(t){if(t){this.data().ID=t}return this.callMethod(BX.Tasks.Util.ItemSet.Item,"value",arguments)},isLoading:function(){return!!this.vars.actionInProgress},setLoading:function(t){this.vars.actionInProgress=t;if(!this.vars.loading){this.vars.loading=BX.Tasks.Util.delay((function(){BX.addClass(this.control("save"),"ui-btn-clock")}),(function(){BX.removeClass(this.control("save"),"ui-btn-clock")}),100,this)}if(t){this.vars.loading.call(this)}else{this.vars.loading.cancel()}},setFieldHtml:function(t){if(!t){return}t=t.replace(new RegExp("/bitrix/js/main/core/images/calendar-icon.gif","g"),"/bitrix/js/tasks/css/images/calendar.png");BX.html(this.control("field-html"),t)},hideErrors:function(){BX.Tasks.Util.hideByClass(this.control("error"))},showErrors:function(t){if(Object.prototype.toString.call(t)==="[object Array]"){var e=[];for(var i=0;i<t.length;i++){e.push(t[i].message)}this.control("error").innerHTML=e.join("<br />");BX.Tasks.Util.showByClass(this.control("error"));return}this.control("error").innerHTML=t.getMessages(true).join("<br />");BX.Tasks.Util.showByClass(this.control("error"))}}});BX.Tasks.Component.UserFieldPanel.ItemSet.Item.prepareData=function(t){t.VALUE=t.ID;t.DISPLAY=t.LABEL;return t}}).call(this);
/* End */
;; /* /bitrix/components/bitrix/socialnetwork.admin.set/templates/.default/script.js?16992580712527*/
; /* /bitrix/components/bitrix/tasks.iframe.popup/templates/wrap/logic.min.js?16992580841319*/
; /* /bitrix/components/bitrix/tasks.task/templates/.default/logic.min.js?169925808224459*/
; /* /bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/script.min.js?169925808360*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?169925794962259*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js?16992579501940*/
; /* /bitrix/components/bitrix/tasks.interface.topmenu/templates/.default/logic.min.js?16992580834013*/
; /* /bitrix/components/bitrix/tasks.interface.filter.buttons/templates/.default/script.min.js?16992580822944*/
; /* /bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/templateselector/logic.min.js?16992580832638*/
; /* /bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?169925795070830*/
; /* /bitrix/components/bitrix/system.field.edit/script.min.js?1699257951814*/
; /* /bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?169925797466406*/
; /* /bitrix/components/bitrix/tasks.widget.checklist.new/templates/.default/logic.min.js?169925808316242*/
; /* /bitrix/components/bitrix/tasks.widget.member.selector/templates/.default/logic.min.js?16992580828977*/
; /* /bitrix/components/bitrix/tasks.widget.optionbar/templates/.default/logic.min.js?16992580821317*/
; /* /bitrix/components/bitrix/tasks.widget.timeestimate/templates/.default/logic.min.js?16992580831134*/
; /* /bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/reminder/logic.min.js?16992580839380*/
; /* /bitrix/components/bitrix/tasks.widget.replication/templates/.default/logic.min.js?169925808310967*/
; /* /bitrix/components/bitrix/tasks.task.detail.parts/templates/flat/projectdependence/logic.min.js?16992580833597*/
; /* /bitrix/components/bitrix/tasks.task.selector/templates/.default/tasks.min.js?16992580835931*/
; /* /bitrix/components/bitrix/crm.field.element/templates/main.edit/script.min.js?16992579614990*/
; /* /bitrix/components/bitrix/main.user.selector/templates/.default/script.min.js?16992579508493*/
; /* /bitrix/components/bitrix/ui.tile.selector/templates/.default/script.min.js?169925809614347*/
; /* /bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js?169925795113346*/
; /* /bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/script.min.js?16992580828462*/
; /* /bitrix/components/bitrix/tasks.widget.tag.selector/templates/selector/logic.min.js?16992580828205*/
; /* /bitrix/components/bitrix/tasks.scrum.epic.selector/templates/.default/script.min.js?16992580838941*/
; /* /bitrix/components/bitrix/tasks.userfield.panel/templates/.default/logic.min.js?169925808314709*/

//# sourceMappingURL=page_bfd12df840f8bf3a807dd5323ad993fb.map.js