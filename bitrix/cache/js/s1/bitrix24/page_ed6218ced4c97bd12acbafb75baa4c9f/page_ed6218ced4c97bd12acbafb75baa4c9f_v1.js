
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/ui.sidepanel.wrapper/templates/.default/template.min.js?16992580965071";s:6:"source";s:77:"/bitrix/components/bitrix/ui.sidepanel.wrapper/templates/.default/template.js";s:3:"min";s:81:"/bitrix/components/bitrix/ui.sidepanel.wrapper/templates/.default/template.min.js";s:3:"map";s:81:"/bitrix/components/bitrix/ui.sidepanel.wrapper/templates/.default/template.map.js";}"*/
(function(){BX.namespace("BX.UI.SidePanel");if(BX.UI.SidePanel.Wrapper){return}function t(t){}t.prototype.init=function(t){this.container=BX(t.containerId);this.isCloseAfterSave=t.isCloseAfterSave||false;this.isReloadGridAfterSave=t.isReloadGridAfterSave||false;this.isReloadPageAfterSave=t.isReloadPageAfterSave||false;this.skipNotification=t.skipNotification||false;this.useLinkTargetsReplacing=t.useLinkTargetsReplacing||false;this.notification=t.notification||{};var e=BX.SidePanel.Instance.getPreviousSlider(BX.SidePanel.Instance.getSliderByWindow(window));this.parentWindow=e?e.getWindow():top;this.initEditableTitle(t);if(this.isReloadGridAfterSave){if(this.getParam("reloadGridAfterSave")){this.reloadGridOnParentPage()}this.setParam("reloadGridAfterSave",true)}if(this.isCloseAfterSave){if(this.getParam("closeAfterSave")){var i;if(this.notification.content&&top.BX&&!this.getParam("skipNotification")){i=function(){top.BX.loadExt("ui.notification").then(function(){top.BX.UI.Notification.Center.notify(this.notification)}.bind(this))}.bind(this)}else if(this.isReloadPageAfterSave){i=function(){this.parentWindow.location.reload()}.bind(this)}BX.SidePanel.Instance.close(false,i)}if(this.skipNotification){this.setParam("skipNotification",true)}this.setParam("closeAfterSave",true)}if(this.useLinkTargetsReplacing){this.initLinkTargetsReplacing()}};t.prototype.initEditableTitle=function(t){if(!t.title||!t.title.selector||!t.title.defaultTitle){return}var i=this.container.querySelector(t.title.selector);if(!i){return}var n=i.querySelector('input[type="text"]');if(!n){return}i.style.display="none";e.init({dataContainer:i,dataNode:n,defaultTitle:t.title.defaultTitle})};t.prototype.initLinkTargetsReplacing=function(){this.replaceLinkTargets();if(!window.MutationObserver){return}var t=new MutationObserver(this.domMutationHandler.bind(this));t.observe(this.container,{childList:true,subtree:true})};t.prototype.domMutationHandler=function(t){t.forEach(function(t){for(var e=0;e<t.addedNodes.length;++e){var i=t.addedNodes.item(e);if(!i){continue}this.replaceLinkTargets(i)}},this)};t.prototype.replaceLinkTargets=function(t){if(!t){t=document.body}var e=[];if(t.tagName==="A"){e=[t]}else if(t.nodeName!=="#text"){e=BX.convert.nodeListToArray(t.querySelectorAll("a"))}if(e.length===0){return}BX.convert.nodeListToArray(e).filter(function(t){return!t.target}).forEach(function(t){t.target="_top"})};t.prototype.setParam=function(t,e){var i=BX.SidePanel.Instance.getSliderByWindow(window);if(i){i.getData().set(t,e)}};t.prototype.getParam=function(t){var e=BX.SidePanel.Instance.getSliderByWindow(window);if(e){return e.getData().get(t)}return undefined};t.prototype.removeParam=function(t){var e=BX.SidePanel.Instance.getSliderByWindow(window);if(e){e.getData().delete(t)}};t.prototype.reloadGridOnParentPage=function(){var t=this.parentWindow;var e=BX.type.isString(this.isReloadGridAfterSave)?this.isReloadGridAfterSave:null;if(!t.BX.Main||!t.BX.Main.gridManager){return}if(e==="all"){t.BX.Main.gridManager.data.forEach(function(t){t.instance.reload()});return}if(!e&&t.BX.Main.gridManager.data){var i=t.BX.Main.gridManager.data;e=i.length>0?i[0].id:null}if(!e){return}var n=t.BX.Main.gridManager.getById(e);if(!n){return}n.instance.reload()};var e={isInit:false,init:function(t){this.dataNode=t.dataNode;this.titleNode=document.querySelector(".ui-side-panel-wrap-title-name");this.inputNode=document.querySelector(".ui-side-panel-wrap-title-input");this.buttonNode=document.querySelector(".ui-side-panel-wrap-title-edit-button");this.initialTitle=this.titleNode.textContent;this.defaultTitle=t.defaultTitle;BX.bind(this.dataNode,"bxchange",this.onDataNodeChange.bind(this));BX.bind(this.buttonNode,"click",this.startEdit.bind(this));BX.bind(this.inputNode,"keyup",this.onKeyUp.bind(this));BX.bind(this.inputNode,"blur",this.endEdit.bind(this));this.isInit=true;if(!t.disabled){this.enable()}if(!this.dataNode.value){this.dataNode.value=this.defaultTitle}},enable:function(t){t=t||false;if(!this.isInit){return}this.changeDisplay(this.buttonNode,!t);this.titleNode.textContent=!t?this.dataNode.value?this.dataNode.value:this.defaultTitle:this.initialTitle},disable:function(){this.enable(true)},onDataNodeChange:function(){this.titleNode.textContent=this.dataNode.value},onKeyUp:function(t){t=t||window.event;if(t.keyCode===10||t.keyCode===13){this.endEdit();t.preventDefault();return false}},getTitle:function(){var t=this.dataNode.value;if(!t){t=this.titleNode.textContent}return t},startEdit:function(){this.inputNode.value=this.getTitle();this.changeDisplay(this.titleNode,false);this.changeDisplay(this.buttonNode,false);this.changeDisplay(this.inputNode,true);this.inputNode.focus()},endEdit:function(){this.dataNode.value=this.inputNode.value;this.titleNode.textContent=this.inputNode.value;this.changeDisplay(this.inputNode,false);this.changeDisplay(this.buttonNode,true);this.changeDisplay(this.titleNode,true)},changeDisplay:function(t,e){return t.style.display=e?"":"none"}};BX.UI.SidePanel.Wrapper=new t})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/rpa.automation.editrobot/templates/.default/script.min.js?16992580444551";s:6:"source";s:79:"/bitrix/components/bitrix/rpa.automation.editrobot/templates/.default/script.js";s:3:"min";s:83:"/bitrix/components/bitrix/rpa.automation.editrobot/templates/.default/script.min.js";s:3:"map";s:83:"/bitrix/components/bitrix/rpa.automation.editrobot/templates/.default/script.map.js";}"*/
(function(t,e,n,a){"use strict";a=a&&a.hasOwnProperty("default")?a["default"]:a;function r(){var t=babelHelpers.taggedTemplateLiteral(['<div class="rpa-edit-robot-btn-list-target-target"></div>']);r=function e(){return t};return t}function i(){var t=babelHelpers.taggedTemplateLiteral(['<div class="rpa-edit-robot-btn-item-drag-target"></div>']);i=function e(){return t};return t}function o(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="rpa-edit-robot-btn-icon-draggable"></span>\n\t\t\t']);o=function e(){return t};return t}var s=e.Reflection.namespace("BX.Rpa");var g=function(){function t(n){babelHelpers.classCallCheck(this,t);this.btnContainer=n;this.draggableBtnContainer=null;this.dragElement=null;this.cache=new e.Cache.MemoryCache}babelHelpers.createClass(t,[{key:"init",value:function t(){var n=this.getDragButton();e.Dom.prepend(n,this.btnContainer);n.onbxdragstart=this.onDragStart.bind(this);n.onbxdrag=this.onDrag.bind(this);n.onbxdragstop=this.onDragStop.bind(this);jsDD.registerObject(n);this.btnContainer.onbxdestdraghover=this.onDragEnter.bind(this);this.btnContainer.onbxdestdraghout=this.onDragLeave.bind(this);this.btnContainer.onbxdestdragfinish=this.onDragDrop.bind(this);jsDD.registerDest(this.btnContainer,30)}},{key:"getDragButton",value:function t(){return this.cache.remember("dragButton",function(){return e.Tag.render(o())})}},{key:"onDragStart",value:function t(){e.Dom.addClass(this.btnContainer,"rpa-edit-robot-btn-item-disabled");if(!this.dragElement){this.dragElement=this.btnContainer.cloneNode(true);this.dragElement.style.position="absolute";this.dragElement.style.width=this.btnContainer.offsetWidth+"px";this.dragElement.className="rpa-edit-robot-btn-item rpa-edit-robot-btn-item-drag";e.Dom.append(this.dragElement,document.body)}}},{key:"onDrag",value:function t(e,n){if(this.dragElement){this.dragElement.style.left=e+"px";this.dragElement.style.top=n+"px"}}},{key:"onDragStop",value:function t(){e.Dom.removeClass(this.btnContainer,"rpa-edit-robot-btn-item-disabled");e.Dom.remove(this.dragElement);this.dragElement=null}},{key:"onDragEnter",value:function t(e){this.draggableBtnContainer=e.closest(".rpa-edit-robot-btn-item");if(this.draggableBtnContainer!==this.btnContainer){this.showDragTarget()}}},{key:"onDragLeave",value:function t(){this.hideDragTarget()}},{key:"onDragDrop",value:function t(){if(this.draggableBtnContainer!==this.btnContainer){this.hideDragTarget();e.Dom.remove(this.draggableBtnContainer);e.Dom.insertBefore(this.draggableBtnContainer,this.btnContainer)}}},{key:"showDragTarget",value:function t(){e.Dom.addClass(this.btnContainer,"rpa-edit-robot-btn-item-target-shown");this.getDragTarget().style.height=this.btnContainer.offsetHeight+"px"}},{key:"hideDragTarget",value:function t(){e.Dom.removeClass(this.btnContainer,"rpa-edit-robot-btn-item-target-shown");this.getDragTarget().style.height=0}},{key:"getDragTarget",value:function t(){if(!this.dragTarget){this.dragTarget=e.Tag.render(i());e.Dom.prepend(this.dragTarget,this.btnContainer)}return this.dragTarget}}]);return t}();var h=function(){function t(){babelHelpers.classCallCheck(this,t);this.container=document.querySelector(".rpa-edit-robot-btn-item-list");this.height=null}babelHelpers.createClass(t,[{key:"init",value:function t(){this.container.onbxdestdraghover=BX.delegate(this.onDragEnter,this);this.container.onbxdestdraghout=BX.delegate(this.onDragLeave,this);this.container.onbxdestdragfinish=BX.delegate(this.onDragDrop,this);jsDD.registerDest(this.container,40)}},{key:"onDragEnter",value:function t(e){this.draggableBtnContainer=e.closest(".rpa-edit-robot-btn-item");this.height=this.draggableBtnContainer.offsetHeight;this.showDragTarget()}},{key:"onDragLeave",value:function t(){this.hideDragTarget()}},{key:"onDragDrop",value:function t(){this.hideDragTarget();e.Dom.remove(this.draggableBtnContainer);e.Dom.insertBefore(this.draggableBtnContainer,this.dragTarget)}},{key:"showDragTarget",value:function t(){e.Dom.addClass(this.container,"rpa-edit-robot-btn-list-target-shown");this.getDragTarget().style.height=this.height+"px"}},{key:"hideDragTarget",value:function t(){e.Dom.removeClass(this.container,"rpa-edit-robot-btn-list-target-shown");this.getDragTarget().style.height=0}},{key:"getDragTarget",value:function t(){if(!this.dragTarget){this.dragTarget=e.Tag.render(r());e.Dom.append(this.dragTarget,this.container)}return this.dragTarget}}]);return t}();s.DragDropBtn=g;s.DragDropBtnContainer=h})(this.window=this.window||{},BX,BX.Rpa,BX);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/bizproc.automation/templates/.default/script.min.js?169925795238817";s:6:"source";s:73:"/bitrix/components/bitrix/bizproc.automation/templates/.default/script.js";s:3:"min";s:77:"/bitrix/components/bitrix/bizproc.automation/templates/.default/script.min.js";s:3:"map";s:77:"/bitrix/components/bitrix/bizproc.automation/templates/.default/script.map.js";}"*/
if(!BX.getClass("BX.Bizproc.Automation.Component"))(function(t){"use strict";t.namespace("BX.Bizproc.Automation");var e=function(e){if(!t.type.isDomNode(e)){throw"baseNode must be Dom Node Element"}this.node=e;c.getInstance().component=this;r.component=this;l.component=this};e.ViewMode={None:0,View:1,Edit:2,Manage:3};var i=function(e){e=e||"/bitrix/components/bitrix/bizproc.automation/ajax.php";return t.util.add_url_param(e,{site_id:t.message("SITE_ID"),sessid:t.bitrix_sessid()})};var o=function(e){var i;if(t.type.isArray(e)){var o,n;for(o=0;o<e.length;++o){n=e[o];if(n["Id"]==="ASSIGNED_BY_ID"||n["Id"]==="RESPONSIBLE_ID"){i="{{"+n["Name"]+"}}";break}}}return i};e.prototype={init:function(i,o){this.viewMode=o||e.ViewMode.Edit;if(t.Type.isUndefined(i)){i={}}this.data=i;this.initData();this.initTracker();this.initContext();this.initActionPanel();this.initSearch();this.initTriggerManager();this.initTemplateManager();this.initButtons();this.initButtonsPosition();this.initHelpTips();this.initSelectors();const n=new t.Bizproc.Automation.Statuses(this.node);n.init(this.templateManager.templates);n.fixColors();this.initRobotSelector();this.initHowCheckAutomationTourGuide();if(!this.embeddedMode){window.onbeforeunload=()=>{if(this.isNeedSave()){return t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_NEED_SAVE")}}}if(this.frameMode){this.subscribeOnSliderClose()}},isNeedSave:function(){return this.templateManager.needSave()||this.triggerManager.needSave()},initData:function(){this.document=new t.Bizproc.Automation.Document({rawDocumentType:this.data.DOCUMENT_TYPE,documentId:this.data.DOCUMENT_ID,categoryId:this.data.DOCUMENT_CATEGORY_ID,statusList:this.data.DOCUMENT_STATUS_LIST,documentFields:this.data.DOCUMENT_FIELDS,title:this.data["ENTITY_NAME"]});this.documentSigned=this.data.DOCUMENT_SIGNED;this.bizprocEditorUrl=this.data.WORKFLOW_EDIT_URL;this.constantsEditorUrl=this.data.CONSTANTS_EDIT_URL||null;this.parametersEditorUrl=this.data.PARAMETERS_EDIT_URL||null;this.setDocumentStatus(this.data.DOCUMENT_STATUS);var e={};if(t.type.isPlainObject(this.data.USER_OPTIONS)){e=this.data.USER_OPTIONS}this.userOptions=new t.Bizproc.Automation.UserOptions(e);this.frameMode=t.type.isBoolean(this.data.FRAME_MODE)?this.data.FRAME_MODE:false;this.embeddedMode=this.data.IS_EMBEDDED===true},initContext:function(){const e=new t.Bizproc.Automation.Context({document:this.document,signedDocument:this.documentSigned,ajaxUrl:this.getAjaxUrl(),availableRobots:t.type.isArray(this.data["AVAILABLE_ROBOTS"])?this.data["AVAILABLE_ROBOTS"]:[],availableTriggers:t.Type.isArray(this.data["AVAILABLE_TRIGGERS"])?this.data["AVAILABLE_TRIGGERS"]:[],canManage:this.data["IS_TEMPLATES_SCHEME_SUPPORTED"],canEdit:this.canEdit(),userOptions:this.userOptions,tracker:this.tracker,bizprocEditorUrl:this.bizprocEditorUrl,constantsEditorUrl:this.constantsEditorUrl,parametersEditorUrl:this.parametersEditorUrl,isFrameMode:this.isFrameMode,marketplaceRobotCategory:this.data["MARKETPLACE_ROBOT_CATEGORY"],showTemplatePropertiesMenuOnSelecting:this.data["SHOW_TEMPLATE_PROPERTIES_MENU_ON_SELECTING"]===true,automationGlobals:new t.Bizproc.Automation.AutomationGlobals({variables:this.data["GLOBAL_VARIABLES"],constants:this.data["GLOBAL_CONSTANTS"]})});e.set("TRIGGER_CAN_SET_EXECUTE_BY",this.data["TRIGGER_CAN_SET_EXECUTE_BY"]);e.set("IS_WORKTIME_AVAILABLE",this.data["IS_WORKTIME_AVAILABLE"]);t.Bizproc.Automation.setGlobalContext(e)},setDocumentStatus:function(t){this.document.setStatus(t);return this},isPreviousStatus:function(t){var e=this.document.getPreviousStatusIdList();for(var i=0;i<e.length;++i){if(t===e[i]){return true}}return false},isCurrentStatus:function(t){return t===this.document.getCurrentStatusId()},isNextStatus:function(t){var e=this.document.getNextStatusIdList();for(var i=0;i<e.length;++i){if(t===e[i]){return true}}return false},initActionPanel:function(){var e=document.querySelector('[data-role="automation-actionpanel"]');if(!e){return}this.actionPanel=new t.UI.ActionPanel({renderTo:e,removeLeftPosition:true,maxHeight:58,parentPosition:"bottom",autoHide:false});this.actionPanel.draw();var i="/bitrix/components/bitrix/bizproc.automation/templates/.default/image/";this.actionPanel.appendItem({id:"automation_choose_all",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_CHOOSE_ALL"),icon:i+"bizproc-automation--panel-icon-choose-all.svg",onclick:function(){var t=this.templateManager.targetManageModeStatus;var e=this.templateManager.getTemplateByStatusId(t);if(e){e.robots.forEach((function(t){t.selectNode()}))}}.bind(this)});this.actionPanel.appendItem({id:"automation_copy_to",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_COPY"),icon:i+"bizproc-automation--panel-icon-copy.svg",onclick:this.onCopyMoveButtonClick.bind(this,"copy")});this.actionPanel.appendItem({id:"automation_move_to",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_MOVE"),icon:i+"bizproc-automation--panel-icon-move.svg",onclick:this.onCopyMoveButtonClick.bind(this,"move")});this.actionPanel.appendItem({id:"automation_delete",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_DELETE"),icon:i+"bizproc-automation--panel-icon-delete.svg",onclick:this.onDeleteButtonClick.bind(this)});t.addCustomEvent("BX.UI.ActionPanel:hidePanel",function(){if(this.templateManager.isManageModeEnabled()){this.disableManageMode()}}.bind(this))},onCopyMoveButtonClick:function(i){this.viewMode=e.ViewMode.Edit;var o=this.templateManager.targetManageModeStatus;var n=this.templateManager.getTemplateByStatusId(o);var a=n.getSelectedRobotNames();if(a.length===0){t.UI.Notification.Center.notify({content:t.message("BIZPOC_AUTOMATION_NO_ROBOT_SELECTED"),autoHideDelay:4e3});return}t.SidePanel.Instance.open("/bitrix/components/bitrix/bizproc.automation.scheme/index.php",{width:569,cacheable:false,requestMethod:"post",requestParams:{documentSigned:this.documentSigned,templateStatus:this.templateManager.targetManageModeStatus,action:i,selectedRobots:a},events:{onDestroy:function(e){var o=e.slider;if(o){var n=o.getData();var a=n.get("restoreData");var s=n.get("targetScope");var r=i==="copy"?n.get("copied"):n.get("moved");var l=n.get("denied");if(!t.type.isArray(r)||!t.type.isArray(l)){return}var c="BIZPROC_AUTOMATION_CMP_ROBOTS_"+(i==="copy"?"COPIED":"MOVED");var d=t.message(c);d=d.replace("#ACCEPTED_COUNT#",r.length);d=d.replace("#TOTAL_COUNT#",r.length+l.length);t.UI.Notification.Center.notify({content:d,actions:[{title:t.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(e,i){e.preventDefault();if(t.type.isArray(a)){this.saveTemplates(a);i.close()}}.bind(this)}}]});var u=[];var h=this.templateManager.targetManageModeStatus;if(i==="move"){u.push(h)}if(s&&this.data.DOCUMENT_TYPE_SIGNED===s.documentType.Type&&this.templateManager.getTemplateByStatusId(s.status.Id)){u.push(s.status.Id)}this.templateManager.updateTemplates(u).onload=function(){var e=this.templateManager.getTemplateByStatusId(h);l.forEach(function(i){var o=e.getRobotById(i);if(o){t.Dom.addClass(o.node,"--denied");setTimeout(t.Dom.removeClass.bind(null,o.node,"--denied"),10*1e3)}}.bind(this))}.bind(this)}this.disableManageMode()}.bind(this)}})},onDeleteButtonClick:function(){this.viewMode=e.ViewMode.Edit;var i=this.templateManager.targetManageModeStatus;var o=this.templateManager.getTemplateByStatusId(i);if(!o){return}var n=this.templateManager.templatesData.findIndex((function(t){return t.ID===o.getId()}));var a=o.getSelectedRobotNames();if(a.length===0){t.UI.Notification.Center.notify({content:t.message("BIZPOC_AUTOMATION_NO_ROBOT_SELECTED"),autoHideDelay:4e3});return}t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:{ajax_action:"delete_robots",document_signed:this.documentSigned,selected_status:o.getStatusId(),robot_names:u.toJsonString(a)},onsuccess:function(e){var i=t.message("BIZPROC_AUTOMATION_CMP_ROBOTS_DELETED");i=i.replace("#TOTAL_COUNT#",a.length);if(e.SUCCESS){o.reInit(e.DATA.template,this.viewMode);this.templateManager.templatesData[n]=e.DATA.template;this.disableManageMode();i=i.replace("#ACCEPTED_COUNT#",a.length);var s=e.DATA.restoreData}else{i=i.replace("#ACCEPTED_COUNT#",0)}t.UI.Notification.Center.notify({content:i,actions:[{title:t.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(e,i){e.preventDefault();if(t.type.isArray(s)){this.saveTemplates(s);i.close()}}.bind(this)}}]})}.bind(this)})},initTriggerManager:function(){this.triggerManager=new h(this.node);this.subscribeTriggerManagerEvents();this.triggerManager.init(this.data,t.Bizproc.Automation.ViewMode.fromRaw(this.viewMode));this.triggerManager.subscribe("TriggerManager:onHelpClick",function(t){this.onGlobalHelpClick.call(this,t.data)}.bind(this));t.Event.EventEmitter.subscribe(this,"BX.Bizproc.Automation.Component:onSearch",this.triggerManager.onSearch.bind(this.triggerManager))},subscribeTriggerManagerEvents:function(){const e=this;this.triggerManager.subscribe("TriggerManager:dataModified",(function(){e.markModified()}));this.triggerManager.subscribe("TriggerManager:trigger:delete",(function(e){const i=e.getData().trigger;t.ajax.runAction("bizproc.analytics.push",{analyticsLabel:{automation_trigger_delete:"Y",delete_trigger:i.getCode().toLowerCase()}})}))},reInitTriggerManager:function(e){if(t.type.isArray(e)){this.data.TRIGGERS=e}this.triggerManager.reInit(this.data,t.Bizproc.Automation.ViewMode.fromRaw(this.viewMode))},initTemplateManager:function(){this.templateManager=new n(this);this.templateManager.init(this.data,this.viewMode)},reInitTemplateManager:function(e){if(t.type.isArray(e))this.data.TEMPLATES=e;this.templateManager.reInit(this.data,this.viewMode)},initButtons:function(){if(t.Bizproc.Automation.ViewMode.fromRaw(this.viewMode).isEdit()){this.initAddButtons()}var e=this.node.querySelector('[data-role="automation-buttons"]');if(e){this.bindSaveButton();this.bindCancelButton()}this.bindCreationButton()},initAddButtons:function(){const e=this.node.querySelectorAll('[data-role="add-button-container"]');const i=this;e.forEach((function(e){const o=i.templateManager.getTemplateByStatusId(e.dataset.statusId);if(!o){return}const n=t.Dom.create("span",{events:{click:()=>{if(i.canEdit()){i.robotSelector.setStageId(e.dataset.statusId);i.robotSelector.show()}else{t.Bizproc.Automation.HelpHint.showNoPermissionsHint(n)}}},attrs:{className:"bizproc-automation-robot-btn-add"},children:[t.Dom.create("span",{attrs:{className:"bizproc-automation-btn-add-text"},text:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_ADD")})]});t.Dom.append(n,e)}))},initButtonsPosition:function(){var e=this.node.querySelector('[data-role="automation-buttons"]');if(e){if(this.frameMode){t.addClass(e,"bizproc-automation-buttons-fixed-slider")}}},initSearch:function(){var e=this.node.querySelector('[data-role="automation-search"]');if(e){t.bind(e,"input",t.debounce(this.onSearch.bind(this,e),255));t.Event.EventEmitter.setMaxListeners(this,"BX.Bizproc.Automation.Component:onSearch",500);var i=this.node.querySelector('[data-role="automation-search-clear"]');if(i){t.bind(i,"click",this.onClearSearch.bind(this,e))}}},reInitSearch:function(){var t=this.node.querySelector('[data-role="automation-search"]');if(t){this.onSearch(t)}},onSearch:function(e){t.Event.EventEmitter.emit(this,"BX.Bizproc.Automation.Component:onSearch",{queryString:e.value.toLowerCase()})},onClearSearch:function(t){if(t.value!==""){t.value="";this.onSearch(t)}},initHelpTips:function(){t.UI.Hint.init(this.node)},initSelectors:function(){t.Event.EventEmitter.subscribe("BX.Bizproc.Automation:Template:onSelectorMenuOpen",function(e){const i=e.getData().template;const o=e.getData().selector;const n=e.getData().isMixedCondition;if(t.Type.isBoolean(n)&&!n){return}const a=this.triggerManager.getReturnProperties(i.getStatusId());const s=a.map((t=>({id:t["SystemExpression"],title:t["Name"]||t["Id"],subtitle:t["ObjectName"]||t["ObjectId"],customData:{field:t}})));if(s.length>0){o.addGroup("__TRESULT",{id:"__TRESULT",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_TRIGGER_LIST"),children:s})}}.bind(this))},reInitButtons:function(){var t=this.node.querySelector('[data-role="automation-btn-change-view"]');if(t){t.innerHTML=t.getAttribute("data-label-"+(this.viewMode===e.ViewMode.View?"edit":"view"))}},enableDragAndDrop:function(){this.templateManager.enableDragAndDrop();this.triggerManager.enableDragAndDrop()},disableDragAndDrop:function(){this.templateManager.disableDragAndDrop();this.triggerManager.disableDragAndDrop()},initTracker:function(){this.tracker=new d(this.document,this.getAjaxUrl());this.tracker.init(this.data.LOG)},bindSaveButton:function(){var e=this,i=t("ui-button-panel-save");if(i){t.bind(i,"click",(function(t){t.preventDefault();e.saveAutomation();i.classList.remove("ui-btn-wait")}))}},bindCancelButton:function(){const e=this.node.querySelector('[data-role="automation-btn-cancel"]');if(e){t.bind(e,"click",this.onCancelButtonClick.bind(this))}},onCancelButtonClick:function(t){if(t){t.preventDefault()}this.reInitTriggerManager();this.reInitTemplateManager();this.reInitSearch();this.markModified(false)},bindCreationButton:function(){const e=this;const i=this.node.querySelector('[data-role="automation-btn-create"]');if(i){if(e.canEdit()){t.bind(i,"click",(()=>{this.robotSelector.setStageId(this.templateManager.templates[0]?.getStatusId());this.robotSelector.show()}));const e=new t.Bizproc.LocalSettings.Settings("aut-cmp");if(e.get("beginning-guide-shown")!==true){const e=this.document.getRawType();const o=e[0];const n=e[2];const a=o==="crm"&&["LEAD","DEAL","INVOICE","SMART_INVOICE","QUOTE"].includes(n);new t.Bizproc.Automation.BeginningGuide({target:i,text:a?t.Loc.getMessage("BIZPROC_AUTOMATION_TOUR_GUIDE_BEGINNING_SUBTITLE_SELLING_DOCUMENT_TYPE"):null,article:a?"16547606":null}).start()}e.set("beginning-guide-shown",true)}}},getAjaxUrl:function(){return i(this.data.AJAX_URL)},getLimits:function(){const t=this.data["ROBOTS_LIMIT"];if(t<=0){return false}const e=this.triggerManager.countAllTriggers();const i=this.templateManager.countAllRobots();return e+i>t?[t,e,i]:false},saveAutomation:function(e){if(this.savingAutomation){return}const i=this.getLimits();if(i){if(top.BX.UI&&top.BX.UI.InfoHelper){top.BX.UI.InfoHelper.show("limit_crm_robots");return}t.UI.Dialogs.MessageBox.show({title:t.Loc.getMessage("BIZPROC_AUTOMATION_ROBOTS_LIMIT_ALERT_TITLE"),message:t.Loc.getMessage("BIZPROC_AUTOMATION_ROBOTS_LIMIT_SAVE_ALERT").replace("#LIMIT#",i[0]).replace("#SUM#",i[1]+i[2]).replace("#TRIGGERS#",i[1]).replace("#ROBOTS#",i[2]),modal:true,buttons:t.UI.Dialogs.MessageBoxButtons.OK,okCaption:t.Loc.getMessage("BIZPROC_AUTOMATION_CLOSE_CAPTION")});return}const o=this;const n={ajax_action:"save_automation",document_signed:this.documentSigned,triggers_json:u.toJsonString(this.triggerManager.serialize()),templates_json:u.toJsonString(this.templateManager.serializeModified())};const a={automation_save:"Y",robots_count:this.templateManager.countAllRobots(),triggers_count:this.triggerManager.countAllTriggers(),automation_module:this.document.getRawType()[0],automation_entity:this.document.getRawType()[2]+"_"+this.document.getCategoryId()};this.savingAutomation=true;return t.ajax({method:"POST",dataType:"json",url:t.Uri.addParam(this.getAjaxUrl(),{analyticsLabel:a}),data:n,onsuccess:function(i){o.savingAutomation=null;i.DATA.templates.forEach((function(t){const e=o.data.TEMPLATES.findIndex((function(e){return e.ID===t.ID}));o.data.TEMPLATES[e]=t}));if(i.SUCCESS){o.reInitTriggerManager(i.DATA.triggers);o.reInitTemplateManager();o.reInitSearch();o.markModified(false);t.Event.EventEmitter.emit("BX.Bizproc.Component.Automation.Component:onSuccessAutomationSave",new t.Event.BaseEvent({data:{analyticsLabel:a}}));if(e){e(i.DATA)}}else{alert(i.ERRORS[0])}}})},subscribeOnSliderClose:function(){const e=t.SidePanel.Instance.getSliderByWindow(window);if(e){const i=t.UI.Dialogs.MessageBox.create({message:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_ON_CLOSE_SLIDER_MESSAGE"),okCaption:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_ON_CLOSE_SLIDER_OK_TITLE"),onOk:()=>{if(e.isCacheable()){this.onCancelButtonClick()}e.getData().set("ignoreChanges",true);e.close();return true},buttons:t.UI.Dialogs.MessageBoxButtons.OK_CANCEL});t.addCustomEvent(e,"SidePanel.Slider:onClose",(t=>{if(this.isNeedSave()&&e.getData()?.get("ignoreChanges")!==true){t.denyAction();i.show();return}e.getData()?.set("ignoreChanges",false)}))}},initHowCheckAutomationTourGuide(){const e=this.document.getRawType();const i=e[0];const o=e[2];const n=this.document.getCategoryId();const a=this.data["DOCUMENT_ID"];if(i==="crm"){const e=t.Type.isPlainObject(this.data.USER_OPTIONS)?this.data.USER_OPTIONS:{};const i=t.Type.isPlainObject(e["crm_check_automation"])?Object.keys(e["crm_check_automation"]).length>0:false;if(this.canEdit()&&!i){t.Bizproc.Automation.CrmCheckAutomationGuide.startCheckAutomationTour(o,Number(n))}if(i&&t.Type.isStringFilled(a)){t.Bizproc.Automation.CrmCheckAutomationGuide.showSuccessAutomation(o,n,e["crm_check_automation"])}}},saveTemplates:function(e){if(this.savingAutomation){return}var i={ajax_action:"save_automation",document_signed:this.documentSigned,templates_json:u.toJsonString(e)};this.savingAutomation=true;var o=this;return t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:i,onsuccess:function(t){o.savingAutomation=null;if(t.SUCCESS){e.forEach((function(t){var e=o.templateManager.getTemplateById(t.ID);if(e){e.reInit(t,o.viewMode)}}))}else{alert(t.ERRORS[0])}}})},changeViewMode:function(i,o){if(!o&&this.isNeedSave()){alert(t.message("BIZPROC_AUTOMATION_CMP_NEED_SAVE"));return}if(i!==e.ViewMode.View&&i!==e.ViewMode.Edit)throw"Unknown view mode";this.viewMode=i;this.reInitTriggerManager();this.reInitTemplateManager();this.reInitButtons()},enableManageMode:function(t){if(!this.isNeedSave()){this.viewMode=e.ViewMode.Manage;this.templateManager.enableManageMode(t);this.triggerManager.enableManageMode()}},disableManageMode:function(){this.viewMode=e.ViewMode.Edit;this.templateManager.disableManageMode();this.triggerManager.disableManageMode()},markModified:function(i){i=i!==false;const o=this.robotSelector&&this.robotSelector.isShown();var n=this.node.querySelector('[data-role="automation-buttons"]');if(!n){return}if(i&&this.canEdit()&&this.viewMode===e.ViewMode.Edit){if(!o){t.show(n)}}else{t.hide(n)}},canEdit:function(){return this.data["CAN_EDIT"]},updateTracker:function(){this.tracker.update(this.documentSigned).onload=function(){if(this.viewMode===e.ViewMode.View){this.templateManager.reInit()}}.bind(this)},onGlobalHelpClick:function(t){t.preventDefault();const e=t.target.closest('[name="bizproc_automation_robot_dialog"]')?"#after":"";if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=14889274"+e)}},getUserOption:function(t,e,i){return this.userOptions.get(t,e,i)},setUserOption:function(t,e,i){this.userOptions.set(t,e,i);return this},getConstants:function(){const e=t.Bizproc.Automation.getGlobalContext();return e.automationGlobals.globalConstants},getConstant:function(t){return this.getConstants().find((e=>e.Id===t))||null},getGVariables:function(){const e=t.Bizproc.Automation.getGlobalContext();return e.automationGlobals.globalVariables},getGVariable:function(t){return this.getGVariables().find((e=>e.Id===t))||null},getDocumentFields:function(){return this.document.getFields()},initRobotSelector(){if(!this.robotSelector){const e=this;const i=new t.Bizproc.LocalSettings.Settings("aut-cmp");const o=new t.Bizproc.Automation.AutomationGuide({isShownRobotGuide:i.get("robot-guide-shown")===true,isShownTriggerGuide:i.get("trigger-guide-shown")===true});this.robotSelector=new t.Bizproc.Automation.RobotSelector({context:t.Bizproc.Automation.getGlobalContext(),stageId:this.templateManager.templates[0]?.getStatusId(),events:{robotSelected:n=>{if(!this.canEdit()){return}const a=n.getData().item;const s=n.getData().stageId;const r=t.Runtime.clone(a.customData.robotData);const l=n.getData().originalEvent;r.NAME=a.title;r.DIALOG_CONTEXT={addMenuGroup:a.groupIds[0]};const c=this.templateManager.getTemplateByStatusId(s);if(!c){return}if(!c.isExternalModified()){c.addRobot(r,(n=>{const a=t.Type.isBoolean(r["ROBOT_SETTINGS"]["IS_SUPPORTING_ROBOT"])?"setShowSupportingRobotGuide":"setShowRobotGuide";this.notifyAboutNewRobot(c,n);if(!(l.ctrlKey||l.metaKey)){e.robotSelector.close();c.openRobotSettingsDialog(n);c.subscribeOnce("Template:robot:closeSettings",(()=>{o[a](true,n.node);o.start();i.set("robot-guide-shown",o.isShownRobotGuide);i.set("trigger-guide-shown",o.isShownTriggerGuide)}))}}))}else{this.showNotification({content:t.message("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT_STAGE_TEXT")})}},triggerSelected:n=>{if(!this.canEdit()){return}const a=n.getData().item;const s=n.getData().stageId;const r=t.Runtime.clone(a.customData.triggerData);const l=n.getData().originalEvent;r["DOCUMENT_STATUS"]=s;this.triggerManager.addTrigger(r,(t=>{t.setName(a.title);this.triggerManager.insertTriggerNode(s,t.node);this.triggerManager.insertTrigger(t);this.notifyAboutNewTrigger(t);if(!(l.ctrlKey||l.metaKey)){e.robotSelector.close();this.triggerManager.openTriggerSettingsDialog(t);this.triggerManager.subscribeOnce("TriggerManager:onCloseTriggerSettingsDialog",(()=>{o.setShowTriggerGuide(true,t.node);o.start();i.set("robot-guide-shown",o.isShownRobotGuide);i.set("trigger-guide-shown",o.isShownTriggerGuide)}))}}))},onAfterShow:()=>{t.Dom.addClass(this.node,"automation-base-blocked");if(!this.isOpenRobotSelectorAnalyticsPushed){const e=this.document;t.ajax.runAction("bizproc.analytics.push",{analyticsLabel:{automation_enter_dialog:"Y",start_module:e.getRawType()[0],start_entity:e.getRawType()[2]+"_"+e.getCategoryId()}});this.isOpenRobotSelectorAnalyticsPushed=true}},onAfterClose:()=>{t.Dom.removeClass(this.node,"automation-base-blocked");if(this.isNeedSave()){this.markModified()}}}})}},notifyAboutNewRobot(e,i){const o=e.getStatus()??{};const n=t.Bizproc.Automation.getGlobalContext();let a="BIZPROC_AUTOMATION_ROBOT_SELECTOR_NEW_ROBOT_ADDED";if(n.document.statusList.length>1){a+="_ON_STAGE"}this.showNotification({content:t.Loc.getMessage(a,{"#ROBOT_NAME#":t.Text.encode(i.getTitle()),"#STAGE_NAME#":t.Text.encode(o.NAME||o.TITLE)}),actions:[{title:t.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),events:{click:function(t,o){t.preventDefault();e.deleteRobot(i);i.destroy();o.close()}}}]})},notifyAboutNewTrigger(e){const i=this;const o=e.getStatus()??{};const n=t.Bizproc.Automation.getGlobalContext();let a="BIZPROC_AUTOMATION_ROBOT_SELECTOR_NEW_TRIGGER_ADDED";if(n.document.statusList.length>1){a+="_ON_STAGE"}this.showNotification({content:t.Loc.getMessage(a,{"#TRIGGER_NAME#":t.Text.encode(e.getName()),"#STAGE_NAME#":t.Text.encode(o.NAME||o.TITLE)}),actions:[{title:t.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),events:{click:function(o,n){o.preventDefault();i.triggerManager.deleteTrigger(e);t.Dom.remove(e.node);n.close()}}}]})},showNotification(e){const i={autoHideDelay:3e3};t.UI.Notification.Center.notify(Object.assign(i,e))}};var n=function(t){this.component=t};n.prototype={init:function(i,o){if(!t.type.isPlainObject(i))i={};this.viewMode=o||e.ViewMode.Edit;this.availableRobots=t.type.isArray(i.AVAILABLE_ROBOTS)?i.AVAILABLE_ROBOTS:[];this.templatesData=t.type.isArray(i.TEMPLATES)?i.TEMPLATES:[];this.initTemplates()},reInit:function(i,o){if(!t.type.isPlainObject(i))i={};this.viewMode=o||e.ViewMode.Edit;if(t.type.isArray(i.TEMPLATES)){this.templatesData=i.TEMPLATES}if(this.viewMode!==e.ViewMode.Edit){this.targetManageModeStatus=""}this.reInitTemplates(this.templatesData);if(this.isManageModeEnabled()){this.enableManageMode(this.targetManageModeStatus)}else{this.disableManageMode()}},isManageModeSupported:function(){return this.component.data.IS_TEMPLATES_SCHEME_SUPPORTED},isManageModeEnabled:function(){return t.type.isString(this.targetManageModeStatus)&&this.targetManageModeStatus!==""},enableManageMode:function(t){this.viewMode=e.ViewMode.Manage;this.targetManageModeStatus=t;this.templates.forEach(function(e){if(e.getStatusId()===t){e.enableManageMode(true)}else{e.enableManageMode(false)}}.bind(this));this.component.disableDragAndDrop();this.component.actionPanel.showPanel()},disableManageMode:function(){this.viewMode=e.ViewMode.Edit;this.targetManageModeStatus="";this.component.actionPanel.hidePanel();this.templates.forEach((function(t){t.disableManageMode()}));this.component.enableDragAndDrop()},enableDragAndDrop:function(){this.templates.forEach((function(t){t.enableDragAndDrop()}))},disableDragAndDrop:function(){this.templates.forEach((function(t){t.disableDragAndDrop()}))},initTemplates:function(){this.templates=[];this.templatesMap={};for(var t=0;t<this.templatesData.length;++t){var e=this.createTemplate(this.templatesData[t]);this.templates.push(e);this.templatesMap[e.getStatusId()]=e}},createTemplate:function(e){const i=new t.Bizproc.Automation.Template({constants:{},variables:{},templateContainerNode:this.component.node,delayMinLimitM:this.component.data["DELAY_MIN_LIMIT_M"],userOptions:this.component.userOptions});i.init(e,this.viewMode);t.Event.EventEmitter.subscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",i.onSearch.bind(i));this.subscribeTemplateEvents(i);this.subscribeRobotEvents(i);return i},subscribeTemplateEvents:function(t){this.getTemplateEventListeners(t).forEach((function(e){t.subscribe(e.eventName,e.listener)}))},subscribeRobotEvents:function(t){this.getRobotEventListeners(t).forEach((function(e){t.subscribeRobotEvents(e.eventName,e.listener)}))},getTemplateEventListeners:function(i){return[{eventName:"Template:help:show",listener:function(t){this.component.onGlobalHelpClick(t.data)}.bind(this)},{eventName:"Template:robot:showSettings",listener:function(){t.Dom.addClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Template:robot:closeSettings",listener:function(){t.Dom.removeClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Template:robot:add",listener:function(t){var e=t.getData().robot;this.getRobotEventListeners(i).forEach((function(t){e.subscribe(t.eventName,t.listener)}))}.bind(this)},{eventName:"Template:robot:delete",listener:function(e){const i=e.getData().robot;t.ajax.runAction("bizproc.analytics.push",{analyticsLabel:{automation_robot_delete:"Y",delete_robot:i.data.Type.toLowerCase()}})}.bind(this)},{eventName:"Template:modified",listener:function(){this.component.markModified()}.bind(this)},{eventName:"Template:enableManageMode",listener:function(t){if(this.viewMode===e.ViewMode.Edit){this.component.enableManageMode(t.getData().documentStatus)}}.bind(this)}]},getRobotEventListeners:function(e){return[{eventName:"Robot:selected",listener:function(){this.component.actionPanel.setTotalSelectedItems(e.getSelectedRobotNames().length)}.bind(this)},{eventName:"Robot:unselected",listener:function(){this.component.actionPanel.setTotalSelectedItems(e.getSelectedRobotNames().length)}.bind(this)},{eventName:"Robot:title:editStart",listener:function(){t.addClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Robot:title:editCompleted",listener:function(){t.removeClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Robot:manage",listener:function(i){var o=this.getTemplateByColumnNode(i.getData().templateNode);var n=i.getData().droppableItem;var a=i.getData().robot;var s=undefined;if(!t.Type.isNil(n)){s=o.getRobotById(n.getAttribute("data-id"))}if(e){if(i.getData().isCopy){g.copyRobotTo(o,a,s)}else if(a!==s){a.moveTo(o,s)}}}.bind(this)}]},reInitTemplates:function(t){for(var e=0;e<this.templates.length;++e){if(t[e]){this.templates[e].reInit(t[e],this.viewMode);this.subscribeRobotEvents(this.templates[e])}}},updateTemplates:function(e){return t.ajax({method:"POST",dataType:"json",url:this.component.getAjaxUrl(),data:{ajax_action:"update_templates",document_signed:this.component.documentSigned,statuses:e},onsuccess:function(t){if(t.SUCCESS){var e=t.DATA.templates;for(var i in e){if(e.hasOwnProperty(i)){var o=this.getTemplateByStatusId(i);var n=this.templatesData.findIndex((function(t){return t.ID===o.getId()}));o.reInit(e[i],this.viewMode);this.templatesData[n]=e[i]}}}}.bind(this)})},getAvailableRobots:function(){return this.availableRobots},getRobotDescription:function(t){return this.availableRobots.find((function(e){return e["CLASS"]===t}))},serialize:function(){var t=[];for(var e=0;e<this.templates.length;++e){t.push(this.templates[e].serialize())}return t},serializeModified:function(){var t=[];this.templates.forEach((function(e){if(e.isModified()){t.push(e.serialize())}}));return t},countAllRobots:function(){var t=0;this.templates.forEach((function(e){t+=e.robots.length}));return t},getTemplateByColumnNode:function(t){var e=t.getAttribute("data-status-id");return this.getTemplateByStatusId(e)},getTemplateById:function(t){return this.templates.find((function(e){return e.getId()===t}))},getTemplateByStatusId:function(t){return this.templatesMap[t]||null},canEdit:function(){return this.component&&this.component.canEdit()},needSave:function(){var t=false;for(var e=0;e<this.templates.length;++e){if(this.templates[e].isModified()){t=true;break}}return t}};var a=function(e,i){var o,n=i.getAttribute("data-config");if(n){o=t.parseJSON(n)}if(!t.type.isPlainObject(o))o={};this.container=i;this.type=o.type||a.Type.File;if(o.selected&&!o.selected.length){this.type=a.Type.None}this.multiple=o.multiple||false;this.required=o.required||false;this.valueInputName=o.valueInputName||"";this.typeInputName=o.typeInputName||"";this.useDisk=o.useDisk||false;this.label=o.label||"Attachment";this.labelFile=o.labelFile||"File";this.labelDisk=o.labelDisk||"Disk";var s=e.template?e.template.robots:[];this.setFileFields(e.getDocument().getFields(),s);this.createDom();if(o.selected&&o.selected.length>0){this.addItems(t.clone(o.selected))}};a.Type={None:"",Disk:"disk",File:"file"};a.prototype={setFileFields:function(e,i){var o=[];var n={};for(var a=0;a<e.length;++a){if(e[a]["Type"]==="file"){o.push(e[a])}}if(t.type.isArray(i)){i.forEach((function(t){t.getReturnFieldsDescription().forEach((function(e){if(e["Type"]==="file"){var i="{{~"+t.getId()+":"+e["Id"]+"}}";o.push({Id:i,Name:t.getTitle()+": "+e["Name"],Type:"file",Expression:i});n[i]=t.getTitle()+": "+e["Name"]}}))}))}this.fileFields=o;this.fileLabels=n;return this},createDom:function(){this.container.appendChild(this.createBaseNode());this.showTypeControllerLayout(this.type)},createBaseNode:function(){var e=t.Bizproc.Automation.Helper.generateUniqueId();var i=null;if(this.fileFields.length>0){i=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-1"+e,name:this.typeInputName,value:a.Type.File}});if(this.type===a.Type.File){i.setAttribute("checked","checked")}}var o=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-2"+e,name:this.typeInputName,value:a.Type.Disk}});if(this.type===a.Type.Disk){o.setAttribute("checked","checked")}var n=[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:this.label+":"})];if(i){n.push(i,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-1"+e},text:this.labelFile,events:{click:this.onTypeChange.bind(this,a.Type.File)}}))}n.push(o,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-2"+e},text:this.labelDisk,events:{click:this.onTypeChange.bind(this,a.Type.Disk)}}));return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:n})]})},showTypeControllerLayout:function(t){if(t===a.Type.Disk){this.hideFileControllerLayout();this.showDiskControllerLayout()}else if(t===a.Type.File){this.hideDiskControllerLayout();this.showFileControllerLayout()}else{this.hideFileControllerLayout();this.hideDiskControllerLayout()}},showDiskControllerLayout:function(){if(!this.diskControllerNode){this.diskControllerNode=t.create("div");this.container.appendChild(this.diskControllerNode);var e=this.getDiskUploader();e.layout(this.diskControllerNode);e.show(true)}else{t.show(this.diskControllerNode)}},hideDiskControllerLayout:function(){if(this.diskControllerNode){t.hide(this.diskControllerNode)}},showFileControllerLayout:function(){if(!this.fileControllerNode){this.fileItemsNode=t.create("span");this.fileControllerNode=t.create("div",{children:[this.fileItemsNode]});this.container.appendChild(this.fileControllerNode);var e=t.create("a",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-thin"},text:t.message("BIZPROC_AUTOMATION_CMP_ADD")});this.fileControllerNode.appendChild(e);t.bind(e,"click",this.onFileFieldAddClick.bind(this,e))}else{t.show(this.fileControllerNode)}},hideFileControllerLayout:function(){if(this.fileControllerNode){t.hide(this.fileControllerNode)}},getDiskUploader:function(){if(!this.diskUploader){this.diskUploader=t.Bizproc.Automation.DiskUploader.create("",{msg:{diskAttachFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACH_FILE"),diskAttachedFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACHED_FILES"),diskSelectFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE"),diskSelectFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE_LEGEND"),diskUploadFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE"),diskUploadFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE_LEGEND")}});this.diskUploader.setMode(1)}return this.diskUploader},onTypeChange:function(t){if(this.type!==t){this.type=t;this.showTypeControllerLayout(this.type)}},isFileItemSelected:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');return!!e},addFileItem:function(e){if(this.isFileItemSelected(e)){return false}var i=this.createFileItemNode(e);if(!this.multiple){t.cleanNode(this.fileItemsNode)}this.fileItemsNode.appendChild(i)},addItems:function(t){if(this.type===a.Type.File){for(var e=0;e<t.length;++e){this.addFileItem(t[e])}}else{this.getDiskUploader().setValues(this.convertToDiskItems(t))}},convertToDiskItems:function(t){var e=[];for(var i=0;i<t.length;++i){var o=t[i];e.push({ID:o["id"],NAME:o["name"],SIZE:o["size"],VIEW_URL:""})}return e},removeFileItem:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');if(e){this.fileItemsNode.removeChild(e)}},onFileFieldAddClick:function(e,i){var o=this,n,a=[];var s=this.fileFields;for(n=0;n<s.length;++n){a.push({text:t.util.htmlspecialchars(s[n]["Name"]),field:s[n],onclick:function(t,e){this.popupWindow.close();o.onFieldSelect(e.field)}})}if(!this.menuId){this.menuId=t.Bizproc.Automation.Helper.generateUniqueId()}t.PopupMenu.show(this.menuId,e,a,{autoHide:true,offsetLeft:t.pos(e)["width"]/2,angle:{position:"top",offset:0}});this.menu=t.PopupMenu.currentItem;i.preventDefault()},onFieldSelect:function(t){this.addFileItem({id:t.Id,expression:t.Expression,name:t.Name,type:a.Type.File})},destroy:function(){if(this.menu){this.menu.popupWindow.close()}},createFileItemNode:function(e){var i=e.name||"";if(this.fileLabels[i]){i=this.fileLabels[i]}return t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-item","data-file-id":e.id,"data-file-expression":e.expression},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-name"},text:i}),t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-delete"},events:{click:this.removeFileItem.bind(this,e)}})]})},onBeforeSave:function(){var e=[];if(this.type===a.Type.Disk){e=this.getDiskUploader().getValues()}else if(this.type===a.Type.File){this.fileItemsNode.childNodes.forEach((function(t){var i=t.getAttribute("data-file-expression");if(i!==""){e.push(i)}}))}for(var i=0;i<e.length;++i){this.container.appendChild(t.create("input",{props:{type:"hidden",name:this.valueInputName+(this.multiple?"[]":""),value:e[i]}}))}}};const s={documentName:null,documentType:null,documentFields:null,documentSigned:null,showRobotSettings:function(o,n,a,s){const r=new t.Bizproc.Automation.Document({rawDocumentType:n,statusId:a,documentFields:this.documentFields,title:this.documentName});const l=new p({document:r,isFrameMode:false});const c=new t.Bizproc.Automation.AutomationGlobals({variables:[],constants:[]});l.init(o,t.Bizproc.Automation.ViewMode.none());t.Bizproc.Automation.setGlobalContext(new t.Bizproc.Automation.Context({document:r,signedDocument:this.documentSigned,ajaxUrl:i(),automationGlobals:c}));const d={document:r,documentSigned:this.documentSigned,ajaxUrl:i()};const u=new g({config:d});u.init({DOCUMENT_FIELDS:this.documentFields},e.ViewMode.None);u.subscribe("Template:help:show",(t=>{t.preventDefault();if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=14889274")}}));u.openRobotSettingsDialog(l,null,s)}};const r={showVariables:function(){const e=this.component.data["DOCUMENT_TYPE_SIGNED"];const i=t.Bizproc.Globals.Manager.Instance.mode.variable;t.Bizproc.Globals.Manager.Instance.showGlobals(i,e).then(this.onAfterSliderClose.bind(this,i))},showConstants:function(){const e=this.component.data["DOCUMENT_TYPE_SIGNED"];const i=t.Bizproc.Globals.Manager.Instance.mode.constant;t.Bizproc.Globals.Manager.Instance.showGlobals(i,e).then(this.onAfterSliderClose.bind(this,i))},onAfterSliderClose:function(e,i){if(!this.isCorrectMode(e)||!i){return}const o=i.getData().get("upsert");const n=i.getData().get("delete");const a=t.Bizproc.Automation&&t.Bizproc.Automation.tryGetGlobalContext();if(!a){return}const s=a.automationGlobals;if(!s){return}if(t.Type.isPlainObject(o)){s.updateGlobals(e,o)}if(t.Type.isArrayFilled(n)){s.deleteGlobals(e,n)}},isCorrectMode:function(e){return t.Type.isStringFilled(e)&&Object.values(t.Bizproc.Globals.Manager.Instance.mode).includes(e)}};const l={showStartPage:function(){t.Bizproc.Debugger.Manager.Instance.openDebuggerStartPage(this.component.documentSigned).then()},showDebugSessions:function(){var t={documentSigned:this.component.documentSigned};this.openSlider("bizproc.debugger.session.list",t,{width:1150})},openSlider(e,i,o){const n={width:850,cacheable:false};const a=t.Type.isPlainObject(o)?Object.assign(n,o):n;const s=t.Uri.addParam("/bitrix/components/bitrix/"+e,t.Type.isPlainObject(i)?i:{});t.SidePanel.Instance.open(s,a)}};const c=t.Bizproc.Automation.Designer;const d=t.Bizproc.Automation.Tracker;const u=t.Bizproc.Automation.Helper;const h=t.Bizproc.Automation.TriggerManager;const p=t.Bizproc.Automation.Robot;const g=t.Bizproc.Automation.Template;t.Bizproc.Automation.Component=e;t.Bizproc.Automation.API=s;t.Bizproc.Automation.showGlobals=r;t.Bizproc.Automation.Debugger=l;t.namespace("BX.Bizproc.Automation.Selector");t.Bizproc.Automation.Selector.InlineSelectorCondition=t.Bizproc.Automation.InlineSelectorCondition})(window.BX||window.top.BX);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/ui.sidepanel.wrappermenu/templates/.default/script.min.js?16992580966351";s:6:"source";s:79:"/bitrix/components/bitrix/ui.sidepanel.wrappermenu/templates/.default/script.js";s:3:"min";s:83:"/bitrix/components/bitrix/ui.sidepanel.wrappermenu/templates/.default/script.min.js";s:3:"map";s:83:"/bitrix/components/bitrix/ui.sidepanel.wrappermenu/templates/.default/script.map.js";}"*/
(function(){"use strict";BX.namespace("BX.UI");BX.UI.DropdownMenu=function(e){this.container=e.container;this.items=[]};BX.UI.DropdownMenu.prototype={init:function(){var e=this.container.querySelectorAll(".ui-sidepanel-menu-item");for(var t=0;t<e.length;t++){var i={};i.id=t;i.container=null;i.link=null;i.button=null;i.submenu=null;i.container=e[t];i.link=i.container.querySelector(".ui-sidepanel-menu-link");i.operativeItem=i.link.getAttribute("bx-operative")==="Y";this.items.push(i);if(i.container.classList.contains("ui-sidepanel-menu-active")){i.activeItem=true}if(i.container.querySelector(".ui-sidepanel-menu-notice-icon")){i.noticeItem=true}}this.loadData()},loadData:function(){for(var e=0;e<this.items.length;e++){this.addItem(this.items[e])}},addItem:function(e){var t=new BX.UI.DropdownMenuItem(e);t.menu=this;this.items[e.id]=t},resetItems:function(){for(var e=0;e<this.items.length;e++){if(this.items[e].activeItem){this.items[e].reset()}}},resetSubItems:function(){for(var e=0;e<this.items.length;e++){this.items[e].resetSubItems()}}};var e=new WeakMap;BX.UI.DropdownMenuItem=function(t){this.container=t.container;this.link=t.link;this.button=null;this.activeItem=t.activeItem?t.activeItem:null;this.noticeItem=t.noticeItem?t.noticeItem:null;this.operativeItem=t.operativeItem?t.operativeItem:null;this.submenu=null;this.subItems=[];this.submenuOpen=false;this.newBadge=null;this.counter=null;this.addItem=null;this.init();e.set(this.container,this)};BX.UI.DropdownMenuItem.getItemByNode=function(t){if(BX.Dom.hasClass(t,"ui-sidepanel-menu-link")){return e.get(t.parentNode)}return e.get(t)};BX.UI.DropdownMenuItem.prototype={init:function(){if(this.isSubmenuExist()){this.submenu=this.container.querySelector(".ui-sidepanel-submenu");this.button=this.getToggleButton();this.link.appendChild(this.button)}var e=this.container.querySelectorAll(".ui-sidepanel-submenu-item"),t=false;for(var i=0;i<e.length;i++){var n={};n.id=i;n.container=e[i];this.subItems.push(n);if(n.container.classList.contains("ui-sidepanel-submenu-active")){n.activeSubItem=true;t=true}}this.loadData();if(this.isSubmenuExist()&&(this.activeItem===true&&this.operativeItem===true||t===true)){this.showSubmenu();this.setNewToggleButtonName()}this.loadData();this.addEvents()},loadData:function(){for(var e=0;e<this.subItems.length;e++){this.addSubItem(this.subItems[e])}},activate:function(){this.activeItem=true;this.container.classList.add("ui-sidepanel-menu-active")},reset:function(){this.activeItem=null;this.container.classList.remove("ui-sidepanel-menu-active")},addNoticeIcon:function(){this.noticeItem=true;if(!this.container.querySelector(".ui-sidepanel-menu-notice-icon")){this.container.children[0].appendChild(this.getNoticeIcon())}},removeNoticeIcon:function(){this.noticeItem=null;if(this.container.querySelector(".ui-sidepanel-menu-notice-icon")){this.container.querySelector(".ui-sidepanel-menu-notice-icon").remove()}},getNoticeIcon:function(){this.noticeIcon=document.createElement("span");this.noticeIcon.className="ui-sidepanel-menu-notice-icon";return this.noticeIcon},showSubmenu:function(){this.submenuOpen=true;this.submenu.style.height=this.getSubmenuHeight()},hideSubmenu:function(){this.submenuOpen=false;this.submenu.style.height=0},getSubmenuHeight:function(){var e=0;for(var t=0;t<this.subItems.length;t++){e=e+(this.subItems[t].getHeight()+6-3)}return e+"px"},addEvents:function(){this.link.addEventListener("click",this.setActiveHandler.bind(this))},setActiveHandler:function(e){this.menu.resetItems();this.activate();if(this.link.getAttribute("bx-operative")!=="Y"){this.link.classList.add("ui-sidepanel-menu-disable-active-state")}else{this.link.classList.remove("ui-sidepanel-menu-disable-active-state")}if(this.isSubmenuExist()){if(!this.submenuOpen){this.showSubmenu();this.setNewToggleButtonName();this.menu.resetSubItems();e&&e.preventDefault()}else{this.hideSubmenu();this.setDefaultToggleButtonName();this.menu.resetSubItems();e&&e.preventDefault()}}else{if(this.link.classList.contains("ui-sidepanel-menu-disable-active-state")){this.link.classList.remove("ui-sidepanel-menu-disable-active-state")}this.menu.resetSubItems()}},isSubmenuExist:function(){if(this.container.querySelector(".ui-sidepanel-submenu")){return true}return false},getToggleButton:function(){this.buttonContainer=document.createElement("div");this.buttonContainer.className="ui-sidepanel-toggle-btn";this.setDefaultToggleButtonName();return this.buttonContainer},setNewToggleButtonName:function(){this.buttonContainer.innerHTML=BX.message("UI_SIDEPANEL_MENU_BUTTON_CLOSE")},setDefaultToggleButtonName:function(){this.buttonContainer.innerHTML=BX.message("UI_SIDEPANEL_MENU_BUTTON_OPEN")},getNewItemBadge:function(){this.itemBadgeNewContainer=document.createElement("div");this.itemBadgeNewContainer.className="ui-sidepanel-badge-new";return this.itemBadgeNewContainer},getCounter:function(){this.counterContainer=document.createElement("span");this.counterContainer.className="ui-sidepanel-counter";return this.counterContainer},getAddItem:function(){this.addItemContainer=document.createElement("a");this.addItemContainer.className="ui-sidepanel-add-item";this.setAddItemName();return this.addItemContainer},setAddItemName:function(){this.addItemContainer.innerHTML=BX.message("UI_SIDEPANEL_MENU_ADD_ITEM")},addSubItem:function(e){var t=new BX.UI.DropdownMenuSubItem(e);t.subMenu=this;this.subItems[e.id]=t},resetSubItems:function(){for(var e=0;e<this.subItems.length;e++){if(this.subItems[e].activeSubItem){this.subItems[e].reset()}}}};BX.UI.DropdownMenuSubItem=function(e){this.container=e.container;this.id=e.id;this.activeSubItem=e.activeSubItem?e.activeSubItem:null;this.subMenu=null;this.init()};BX.UI.DropdownMenuSubItem.prototype={init:function(){this.addEvents()},activate:function(){this.activeSubItem=true;this.container.classList.add("ui-sidepanel-submenu-active")},reset:function(){this.activeSubItem=null;this.container.classList.remove("ui-sidepanel-submenu-active")},addEvents:function(){this.container.addEventListener("click",function(){if(this.activeSubItem){return}if(!this.activeSubItem&&!this.activeItem){this.subMenu.menu.resetItems()}this.subMenu.menu.resetSubItems();this.subMenu.resetSubItems();this.activate()}.bind(this))},getHeight:function(){return this.container.offsetHeight}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/ui.button.panel/templates/.default/script.min.js?16992580961189";s:6:"source";s:70:"/bitrix/components/bitrix/ui.button.panel/templates/.default/script.js";s:3:"min";s:74:"/bitrix/components/bitrix/ui.button.panel/templates/.default/script.min.js";s:3:"map";s:74:"/bitrix/components/bitrix/ui.button.panel/templates/.default/script.map.js";}"*/
(function(){"use strict";BX.namespace("BX.UI");var t=function(){this.layout={container:null}};t.prototype={init:function(t){this.layout.container=BX(t.containerId);this.isFrame=t.isFrame||false;this.hasHints=t.hasHints||false;this.pinnerContainer=t.pinnerContainer||false;this.pinner=new BX.UI.Pinner(this.layout.container,{fixBottom:this.isFrame,fullWidth:this.isFrame,anchorBottom:this.pinnerContainer});if(this.hasHints){BX.UI.Hint.init(this.layout.container)}t.buttons.forEach(this.initButton,this)},getContainer:function(){return this.layout.container},hide:function(){if(!this.layout.container){return}this.layout.container.classList.add("ui-button-panel-wrapper-hide")},show:function(){this.layout.container.classList.remove("ui-button-panel-wrapper-hide")},initButton:function(t){if(!t.ID){return}t.node=BX(t.ID);if(!t.node){return}BX.bind(t.node,"click",this.onButtonClick.bind(this,t))},onButtonClick:function(t,n){BX.onCustomEvent(this,"button-click",[t]);if(t.WAIT){BX.addClass(BX(t.ID),"ui-btn-wait")}if(this.isFrame&&(t.TYPE==="close"||t.TYPE==="cancel")){n.preventDefault();top.BX.SidePanel.Instance.close()}}};BX.UI.ButtonPanel=new t})();
/* End */
;; /* /bitrix/components/bitrix/ui.sidepanel.wrapper/templates/.default/template.min.js?16992580965071*/
; /* /bitrix/components/bitrix/rpa.automation.editrobot/templates/.default/script.min.js?16992580444551*/
; /* /bitrix/components/bitrix/bizproc.automation/templates/.default/script.min.js?169925795238817*/
; /* /bitrix/components/bitrix/ui.sidepanel.wrappermenu/templates/.default/script.min.js?16992580966351*/
; /* /bitrix/components/bitrix/ui.button.panel/templates/.default/script.min.js?16992580961189*/

//# sourceMappingURL=page_ed6218ced4c97bd12acbafb75baa4c9f.map.js