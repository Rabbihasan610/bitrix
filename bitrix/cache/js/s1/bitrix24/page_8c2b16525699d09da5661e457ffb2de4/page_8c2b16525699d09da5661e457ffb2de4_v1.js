
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?169925794962259";s:6:"source";s:77:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.js";s:3:"min";s:81:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js";s:3:"map";s:81:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.map.js";}"*/
BX.namespace("BX.Main");if(typeof BX.Main.interfaceButtons==="undefined"){BX.Main.interfaceButtons=function(t,e){this.classItem="main-buttons-item";this.classItemSublink="main-buttons-item-sublink";this.classItemText="main-buttons-item-text";this.classItemCounter="main-buttons-item-counter";this.classItemIcon="main-buttons-item-icon";this.classItemMore="main-buttons-item-more";this.classOnDrag="main-buttons-drag";this.classDropzone="main-buttons-submenu-dropzone";this.classSeparator="main-buttons-submenu-delimiter";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";this.classItemDisabled="main-buttons-disabled";this.classItemOver="--over";this.classMenuShown="--menu-shown";this.classItemActive="main-buttons-item-active";this.classSubmenu="main-buttons-submenu";this.classSecret="secret";this.classItemLocked="--locked";this.classExtraItemLink="";this.classExtraItemText="";this.classExtraItemIcon="";this.classExtraItemCounter="";this.submenuIdPrefix="main_buttons_popup_";this.childMenuIdPrefix="main_buttons_popup_child_";this.submenuWindowIdPrefix="menu-popup-";this.classSettingMenuItem="main-buttons-submenu-setting";this.classEditState="main-buttons-edit";this.classEditItemButton="main-buttons-item-edit-button";this.classDragItemButton="main-buttons-item-drag-button";this.classSettingsApplyButton="main-buttons-submenu-settings-apply";this.classSettingsResetButton="main-buttons-submenu-settings-reset";this.classSetHome="main-buttons-set-home";this.classSetHide="main-buttons-set-hide";this.classManage="main-buttons-manage";this.classContainer="main-buttons";this.classSubmenuNoHiddenItem="main-buttons-submenu-item-no-hidden";this.classDefaultSubmenuItem="menu-popup-item";this.classDefaultSubmenuDelimimeter="popup-window-delimiter-section";this.classInner="main-buttons-inner-container";this.listContainer=null;this.dragItem=null;this.overItem=null;this.moreButton=null;this.messages=null;this.licenseParams=null;this.ajaxSettings=null;this.enableItemMouseEnter=true;this.menuShowTimeout=null;this.isMoreMenuShown=false;this.onDragStarted=false;this.isSettingsEnabled=true;this.containerId=e.containerId;this.isEditEnabledState=false;this.theme=BX.Type.isStringFilled(e.theme)?e.theme:"default";this.maxItemLength=BX.Type.isNumber(e.maxItemLength)&&e.maxItemLength>6?e.maxItemLength:20;this.tmp={};this.itemData=new WeakMap;this.handleMoreMenuItemMouseEnter=this.handleMoreMenuItemMouseEnter.bind(this);this.init(t,e);return{getItemById:this.getItemById.bind(this),getAllItems:this.getAllItems.bind(this),getHiddenItems:this.getHiddenItems.bind(this),getVisibleItems:this.getVisibleItems.bind(this),getDisabledItems:this.getDisabledItems.bind(this),getMoreButton:this.getMoreButton.bind(this),adjustMoreButtonPosition:this.adjustMoreButtonPosition.bind(this),getItemData:this.getItemData.bind(this),getSubmenu:this.getMoreMenu.bind(this),showSubmenu:this.showMoreMenu.bind(this),closeSubmenu:this.closeMoreMenu.bind(this),refreshSubmenu:this.refreshMoreMenu.bind(this),getMoreMenu:this.getMoreMenu.bind(this),showMoreMenu:this.showMoreMenu.bind(this),closeMoreMenu:this.closeMoreMenu.bind(this),refreshMoreMenu:this.refreshMoreMenu.bind(this),getCurrentSettings:this.getCurrentSettings.bind(this),saveSettings:this.saveSettings.bind(this),updateCounter:this.updateCounter.bind(this),getActive:this.getActive.bind(this),isDisabled:this.isDisabled.bind(this),isVisibleItem:this.isVisibleItem.bind(this),isEditEnabled:this.isEditEnabled.bind(this),isActiveInMoreMenu:this.isActiveInMoreMenu.bind(this),isSettingsEnabled:this.isSettingsEnabled,classes:{item:this.classItem,itemText:this.classItemText,itemCounter:this.classItemCounter,itemIcon:this.classItemIcon,itemDisabled:this.classItemDisabled,itemOver:this.classItemOver,itemActive:this.classItemActive,itemLocked:this.classItemLocked,menuShown:this.classMenuShown,submenu:this.classSubmenu,submenuItem:this.classSubmenuItem,containerOnDrag:this.classOnDrag,classSettingMenuItem:this.classSettingMenuItem},itemsContainer:this.listContainer,itemsContainerId:this.listContainer.id}};BX.Main.interfaceButtons.prototype={init:function(t,e){this.listContainer=BX(this.getId());if(!BX.Type.isPlainObject(e)){throw"BX.MainButtons: params is not Object"}if(!("containerId"in e)||!BX.Type.isStringFilled(e.containerId)){throw"BX.MainButtons: containerId not set in params"}if(!BX.Type.isDomNode(this.listContainer)){throw"BX.MainButtons: #"+e.containerId+" is not dom node"}if("classes"in e&&BX.Type.isPlainObject(e.classes)){this.setCustomClasses(e.classes)}if("messages"in e&&BX.Type.isPlainObject(e.messages)){this.setMessages(e.messages)}if("licenseWindow"in e&&BX.Type.isPlainObject(e.licenseWindow)){this.setLicenseWindowParams(e.licenseWindow)}if("disableSettings"in e&&e.disableSettings==="true"){this.isSettingsEnabled=false;this.visibleControlMoreButton()}this.initSaving(e.ajaxSettings);this.moreButton=this.getMoreButton();this.listChildItems={};this.initItems();this.adjustMoreButtonPosition();this.bindEventsOnMoreButton();this.bindOnResizeFrame();BX.Event.bind(this.getContainer(),"click",BX.delegate(this._onDocumentClick,this));BX.addCustomEvent("onPullEvent-main",BX.delegate(this._onPush,this));this.updateMoreButtonCounter();if(this.isActiveInMoreMenu()){this.activateItem(this.moreButton)}const s=this.getHomeItem();if(s){const{url:t}=s;this.lastHomeLink=t}const i=Array.from(this.container.querySelectorAll(".main-buttons-item-child-button"));i.forEach((function(t){const e=t.closest(".main-buttons-item-child");if(e.dataset.isOpened){this.realChildButton=e;const t=e.closest(".main-buttons-item-child-button-cloned");if(t){this.clonedChildButton=t}}BX.Event.bind(t,"click",this.onShowChildButtonClick.bind(this))}),this)},calculateChildListWidth:function(){if(this.realChildButton){const t=this.realChildButton.querySelectorAll(".main-buttons-item-child-list-inner .main-buttons-item");const e=10;return Array.from(t).reduce((function(t,e){const s=BX.Text.toNumber(BX.Dom.style(e,"width"));const i=BX.Text.toNumber(BX.Dom.style(e,"margin-left"));const n=BX.Text.toNumber(BX.Dom.style(e,"margin-right"));return t+s+i+n}),e)}return 0},onShowChildButtonClick:function(t){t.preventDefault();if(!this.realChildButton){this.realChildButton=t.currentTarget.closest(".main-buttons-item-child")}const e=this.realChildButton.querySelector(".main-buttons-item-child-list");this.enableItemMouseEnter=false;setTimeout((()=>{this.enableItemMouseEnter=true}),200);const s=BX.Dom.attr(this.realChildButton,"data-child-items");const i=BX.Dom.attr(this.realChildButton,"data-is-opened");let n={};if(i){BX.Dom.attr(this.realChildButton,"data-is-opened",null);s.forEach((function(t){const e=this.getContainer().querySelector('[data-id="'+t+'"]');BX.Dom.style(e,"display",null);if(t.hasOwnProperty("PARENT_ITEM_ID")){n[t["PARENT_ITEM_ID"]]="N"}}),this);if(this.clonedChildButton){BX.Dom.remove(this.clonedChildButton)}BX.Dom.style(e,{overflow:null,"max-width":null});n=JSON.stringify(n);this.saveOptions("expanded_lists",n)}else{BX.Dom.attr(this.realChildButton,"data-is-opened",true);BX.Dom.style(e,"max-width",this.calculateChildListWidth()+"px");this.cloneChildButton(this.realChildButton);s.forEach((t=>{const e=this.getContainer().querySelector('[data-id="'+t+'"]');BX.Dom.insertBefore(e,this.realChildButton);BX.Dom.style(e,"display","inline-block");if(t.hasOwnProperty("PARENT_ITEM_ID")){n[t["PARENT_ITEM_ID"]]="Y"}}));setTimeout((()=>{BX.Dom.style(e,"overflow","unset")}),200);n=JSON.stringify(n);this.saveOptions("expanded_lists",n)}setTimeout((()=>{this._onResizeHandler()}),200)},cloneChildButton:function(t){this.clonedChildButton=BX.Runtime.clone(t);const e=this.clonedChildButton.querySelector(".main-buttons-item-child-list");if(e){BX.Dom.remove(e)}BX.Dom.addClass(this.clonedChildButton,"main-buttons-item-child-button-cloned");BX.Dom.style(this.clonedChildButton,"transition","none");BX.Dom.insertBefore(this.clonedChildButton,t);BX.Event.bind(this.clonedChildButton,"click",this.onShowChildButtonClick.bind(this));setTimeout((()=>{BX.Dom.style(this.clonedChildButton,"transition",null)}),0)},_onDocumentClick:function(t){if(this.isDragButton(t.target)){t.preventDefault();t.stopPropagation()}let e=this.getItem(t);if(BX.Type.isDomNode(e)){if(this.isSettings(e)){this.enableEdit();return false}if(this.isApplySettingsButton(e)){t.preventDefault();t.stopPropagation();this.disableEdit();return false}if(this.isResetSettingsButton(e)){this.resetSettings();return false}if(this.isEditButton(t.target)){this.handleEditButtonClick(t);return false}if(this.isSetHide(e)){const t=this.getVisibleItems();const e=BX.Type.isArray(t)?t.length:null;const s=this.editItemData.ID.replace(this.listContainer.id+"_","");let i=this.getItemById(s);const n=this.getItemAlias(i);i=this.isVisibleItem(i)?i:n;if(this.isDisabled(n)){this.enableItem(n)}else if(!this.isDisabled(n)&&e>2){this.disableItem(n)}if(e===1){BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[i,this])}this.refreshMoreMenu();this.saveSettings();this.adjustMoreButtonPosition();if(this.isEditEnabled()){this.enableEdit()}this.editMenu.popupWindow.close();return false}if(this.isSetHome(e)){const t=this.editItemData.ID.replace(this.listContainer.id+"_","");const e=this.getItemById(t);const s=this.getItemAlias(e);if(this.isDisabled(s)){this.enableItem(s)}this.listContainer.insertBefore(e,BX.firstChild(this.listContainer));this.adjustMoreButtonPosition();this.refreshMoreMenu();this.saveSettings();if(this.isEditEnabled()){this.enableEdit()}this.editMenu.popupWindow.close();return false}if(!this.isDragButton(t.target)&&!this.isEditButton(t.target)){const s=this.getItemData(e);let i=s["ON_CLICK"];if(this.isSublink(t.target)){i=BX.Type.isPlainObject(s["SUB_LINK"])?s["SUB_LINK"]["ON_CLICK"]:""}if(BX.Type.isStringFilled(i)){t.preventDefault();this.execScript(i,t)}}}if(this.isEditEnabled()&&this.getMoreMenu()){this.getMoreMenu().getPopupWindow().setAutoHide(false)}},isActiveInMoreMenu:function(){const t=this.getHiddenItems();const e=this.getDisabledItems();const s=t.concat(e);return s.some((function(t){const e=this.getItemData(t);return e["IS_ACTIVE"]===true}),this)},_onPush:function(t,e){if(t==="user_counter"&&e&&BX.message("SITE_ID")in e){const t=e[BX.message("SITE_ID")];for(const e in t){if(t.hasOwnProperty(e)){this.updateCounter(e,t[e])}}}},getActive:function(){let t=this.getAllItemsData();let e=null;let s=null;while(BX.Type.isArrayFilled(t)){const i=t.shift();if(i["IS_ACTIVE"]===true){if(s===null){s=i}e=i;t=BX.Type.isArrayFilled(i["ITEMS"])?[...i["ITEMS"]]:null}}if(e!==null&&s!==null){const t=BX(s.ID);if(BX.Type.isDomNode(t)){e.NODE=t}else{e.NODE=null}}return e},isSetHome:function(t){return BX.Dom.hasClass(t,this.classSetHome)},isSetHide:function(t){return BX.Dom.hasClass(t,this.classSetHide)},getSettingsButton:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSettingMenuItem)},getSettingsApplyButton:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSettingsApplyButton)},isApplySettingsButton:function(t){return BX.Dom.hasClass(t,this.classSettingsApplyButton)},enableEdit:function(){const t=this.getMoreMenu();if(t){const e=t.getPopupWindow();e.setAutoHide(false);BX.Dom.addClass(e.getPopupContainer(),this.classEditState)}BX.Dom.addClass(this.listContainer,this.classEditState);this.isEditEnabledState=true},disableEdit:function(){const t=this.getMoreMenu();if(t){const e=t.getPopupWindow();e.setAutoHide(true);BX.Dom.removeClass(e.getPopupContainer(),this.classEditState)}BX.Dom.removeClass(this.listContainer,this.classEditState);this.isEditEnabledState=false;this.destroyItemEditMenu()},isEditEnabled:function(){return this.isEditEnabledState},showItemEditMenu:function(t,e){if(BX.Type.isPlainObject(t)&&"ID"in t){const s=[this.listContainer.id,"_edit_item"].join("");let i=BX.Main.MenuManager.getMenuById(s);if(i){BX.Main.MenuManager.destroy(s)}i=this.createItemEditMenu(t,s,e);i.popupWindow.show()}},destroyItemEditMenu:function(){const t=[this.listContainer.id,"_edit_item"].join("");const e=BX.Main.MenuManager.getMenuById(t);if(e){BX.Main.MenuManager.destroy(t)}},getContainer:function(){if(!BX.Type.isDomNode(this.container)){this.container=BX(this.containerId).parentNode.parentNode}return this.container},getItemEditMenu:function(){return BX.Main.MenuManager.getMenuById([this.listContainer.id,"_edit_item"].join(""))},createItemEditMenu:function(t,e,s){const i=[{text:this.message("MIB_SET_HOME"),className:"main-buttons-set-home menu-popup-no-icon"}];const n=t["ID"].replace(this.listContainer.id+"_","");const o=this.getItemById(n);if(this.isDisabled(o)){i.push({text:this.message("MIB_SET_SHOW"),className:"main-buttons-set-hide menu-popup-no-icon"})}else{i.push({text:this.message("MIB_SET_HIDE"),className:"main-buttons-set-hide menu-popup-no-icon"})}if(t["IS_PINNED"]){const e=this.getParentItem(t["ID"]);i.push({text:this.message("MIB_UNPIN_ITEM").replace("#NAME#",e?e["TEXT"]:""),onclick:(e,s)=>{this.handleItemUnpin(t,o);s.getMenuWindow().close()}})}const a=BX.pos(s);const u={menuId:e,anchor:s,menuItems:i,settings:{autoHide:true,offsetTop:0,offsetLeft:a.width/2,zIndex:20,angle:{position:"top",offset:a.width/2}}};const r=BX.Main.MenuManager.create(u.menuId,u.anchor,u.menuItems,u.settings);if(this.isVisibleItem(o)){t.NODE=o}else{t.NODE=this.getItemAlias(o)}this.editItemData=t;if("menuItems"in r&&BX.Type.isArray(r.menuItems)){r.menuItems.forEach((function(t){BX.Event.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))}),this)}BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onBeforeCreateEditMenu",[r,t,this]);this.editMenu=r;return r},setHome:function(){const t=this.getHomeItem();if(!t){return}const{itemData:e,url:s,firstVisibleItem:i}=t;if(!e){return}if(this.lastHomeLink!==s){this.saveOptions("firstPageLink",s);BX.onCustomEvent("BX.Main.InterfaceButtons:onFirstItemChange",[s,i])}this.lastHomeLink=s},getHomeItem:function(){const t=this.getVisibleItems();const e=BX.Type.isArray(t)&&t.length>0?t[0]:null;if(!e){return null}const s=this.getItemData(e);const i=this.normalizeUrl(s["URL"]);if(this.canBeHomed(i,s)){return{itemData:s,url:i,firstVisibleItem:e}}if(BX.Type.isArrayFilled(s["ITEMS"])){for(let t=0;t<s["ITEMS"].length;t++){const i=s["ITEMS"][t];if(i["IS_PINNED"]||i["IS_DISBANDED"]||i["IS_DELIMITER"]){continue}const n=this.normalizeUrl(i["URL"]);if(this.canBeHomed(n,i)){return{itemData:i,url:n,firstVisibleItem:e}}}}return null},normalizeUrl:function(t){if(!BX.Type.isStringFilled(t)){return""}if(t.charAt(0)==="?"){const e=document.createElement("a");e.href=t;t=e.pathname+e.search}return t},canBeHomed:function(t,e){if(!BX.Type.isStringFilled(t)||BX.Type.isStringFilled(e["ON_CLICK"])){return false}if(BX.Reflection.getClass("BX.SidePanel.Instance")){const e=BX.SidePanel.Instance.getUrlRule(t);if(e){return false}}const s=new BX.Event.BaseEvent({data:{itemLink:t,itemData:e}});BX.Event.EventEmitter.emit("BX.Main.InterfaceButtons:onBeforeFirstItemChange",s);return!s.isDefaultPrevented()},isEditButton:function(t){return BX.Dom.hasClass(t,this.classEditItemButton)},isDragButton:function(t){return BX.Dom.hasClass(t,this.classDragItemButton)},isResetSettingsButton:function(t){return BX.Dom.hasClass(t,this.classSettingsResetButton)},getContainerHeight:function(){const t=this.getAllItems().map((function(t){const e=getComputedStyle(t);return BX.height(t)+parseInt(e.marginTop)+parseInt(e.marginBottom)}));return Math.max.apply(Math,t)},setLicenseWindowParams:function(t){this.licenseParams=t||{}},message:function(t){let e;try{e=this.messages[t]}catch(t){e=""}return e},setCustomClasses:function(t){if(!BX.Type.isPlainObject(t)){return}this.classItem=t.item||this.classItem;this.classItemSublink=t.itemSublink||this.classItemSublink;this.classItemText=t.itemText||this.classItemText;this.classItemCounter=t.itemCounter||this.classItemCounter;this.classItemIcon=t.itemIcon||this.classItemIcon;this.classItemMore=t.itemMore||this.classItemMore;this.classItemOver=t.itemOver||this.classItemOver;this.classMenuShown=t.menuShown||this.classMenuShown;this.classItemActive=t.itemActive||this.classItemActive;this.classItemDisabled=t.itemDisabled||this.classItemDisabled;this.classOnDrag=t.onDrag||this.classOnDrag;this.classDropzone=t.dropzone||this.classDropzone;this.classSeparator=t.separator||this.classSeparator;this.classSubmenuItem=t.submenuItem||this.classSubmenuItem;this.classSubmenu=t.submenu||this.classSubmenu;this.classSecret=t.secret||this.classSecret;this.classItemLocked=t.itemLocked||this.classItemLocked;this.classExtraItemLink=t.extraItemLink||this.classExtraItemLink;this.classExtraItemText=t.extraItemText||this.classExtraItemText;this.classExtraItemIcon=t.extraItemIcon||this.classExtraItemIcon;this.classExtraItemCounter=t.extraItemCounter||this.classExtraItemCounter},setMessages:function(t){if(!BX.Type.isPlainObject(t)){return}this.messages=t},makeFullItemId:function(t){if(!BX.Type.isStringFilled(t)){return}return[this.listContainer.id,t.replace("-","_")].join("_")},getItemById:function(t){let e=null;if(BX.Type.isStringFilled(t)){const s=t.startsWith(this.listContainer.id)?t:this.makeFullItemId(t);e=BX.Buttons.Utils.getBySelector(this.listContainer,"#"+s.replaceAll(":","\\:"))}return e},getItemCounterObject:function(t){let e=null;if(BX.Type.isDomNode(t)){e=BX.Buttons.Utils.getByClass(t,this.classItemCounter)}return e},updateCounter:function(t,e){if(t.indexOf("crm")===0&&e<0){return}this.updateItemsByCounterId(this.getAllItemsData(),t,e);this.updateMoreButtonCounter()},updateItemsByCounterId:function(t,e,s,i=[]){for(let n=0;n<t.length;n++){const o=t[n];if(o["COUNTER_ID"]===e){o["COUNTER"]=Number(s);this.setCounterValueById(e,o["COUNTER"]);for(let t=i.length-1;t>=0;t--){const e=i[t];e["COUNTER"]=e["ITEMS"].reduce(((t,e)=>{const s=e["IS_PINNED"]===true;const i=BX.Type.isNumber(e["COUNTER"])&&!s?e["COUNTER"]:0;return t+i}),0);this.setCounterValueById(e["COUNTER_ID"],e["COUNTER"])}}if(o["ITEMS"]){this.updateItemsByCounterId(o["ITEMS"],e,s,[...i,o])}}},recalculateItemsCounters:function(t,e=[]){let s=0;for(let i=0;i<t.length;i++){const n=t[i];if(n["ITEMS"]){n["COUNTER"]=this.recalculateItemsCounters(n["ITEMS"],[...e,n])}const o=n["IS_PINNED"]===true;s+=BX.Type.isNumber(n["COUNTER"])&&!o?n["COUNTER"]:0}for(let t=e.length-1;t>=0;t--){const s=e[t];s["COUNTER"]=s["ITEMS"].reduce(((t,e)=>{const s=e["IS_PINNED"]===true;const i=BX.Type.isNumber(e["COUNTER"])&&!s?e["COUNTER"]:0;return t+i}),0);this.setCounterValueById(s["COUNTER_ID"],s["COUNTER"])}return s},setCounterValueById:function(t,e){if(!BX.Type.isStringFilled(t)){return}const s=e>99?"99+":e>0?e:"";const i=document.querySelectorAll(`[data-mib-counter-id="${t}"]`);Array.from(i).forEach((t=>{t.textContent=s}))},setMoreButtonCounter:function(t){const e=this.getItemCounterObject(this.moreButton);e.textContent=t>99?"99+":t>0?t:""},bindEventsOnMoreButton:function(){BX.Event.bind(this.moreButton,"click",this.handleMoreButtonClick.bind(this));BX.Event.bind(this.moreButton,"mouseenter",this.handleMoreButtonMouseEnter.bind(this));BX.Event.bind(this.moreButton,"mouseleave",this.handleMoreButtonMouseLeave.bind(this))},bindOnResizeFrame:function(){window.frames["maininterfacebuttonstmpframe-"+this.getId()].onresize=BX.throttle(this._onResizeHandler,20,this)},getId:function(){return BX.Buttons.Utils.getByClass(this.getContainer(),this.classInner).id},getAllItems:function(){return BX.Buttons.Utils.getByClass(this.listContainer,this.classItem,true)},getAllItemsData:function(){return this.getAllItems().map((t=>this.getItemData(t)))},getVisibleItems:function(){const t=this.getAllItems();let e=[];if(t&&t.length){e=t.filter((t=>this.isVisibleItem(t)&&!this.isDisabled(t)))}return e},getHiddenItems:function(){const t=this.getAllItems();let e=[];if(t&&t.length){e=t.filter((t=>!this.isVisibleItem(t)&&!this.isDisabled(t)))}return e},getDisabledItems:function(){return this.getAllItems().filter((t=>this.isDisabled(t)))},getMoreButton:function(){const t=this.getContainer().getElementsByClassName(this.classItemMore);return t[0]||null},getLastVisibleItem:function(){const t=this.getVisibleItems();let e=null;if(BX.Type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.Type.isDomNode(e)){e=null}return e},getLastDisabledItem:function(){const t=this.getDisabledItems();let e=null;if(BX.Type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.Type.isDomNode(e)){e=null}return e},adjustMoreButtonPosition:function(){this.updateMoreButtonCounter();if(this.getMoreMenu()){this.getMoreMenu().getPopupWindow().adjustPosition()}},getMoreMenuId:function(t){let e="";if(BX.Type.isDomNode(this.listContainer)&&BX.Type.isStringFilled(this.listContainer.id)){e=this.submenuIdPrefix+this.listContainer.id}if(t){e=this.submenuWindowIdPrefix+e}return e},getChildMenuId:function(){let t="";if(BX.Type.isDomNode(this.listContainer)&&BX.Type.isStringFilled(this.listContainer.id)){t=this.childMenuIdPrefix+this.listContainer.id}return t},getMenuItemText:function(t,e=null){const s=BX.Type.isElementNode(t)?this.getItemData(t):t;return BX.Tag.render`
				<span class="main-buttons-menu-popup-item">${[BX.Tag.render`<span class="${this.classItemIcon}"></span>`,this.createItemText(s),this.createItemCounter(s),e&&this.isEditEnabled()?this.createItemPin(s,e):""]}</span>
			`},createRootItem:function(t){let e=this.classItem;e+=BX.Type.isStringFilled(t["CLASS"])?" "+t["CLASS"]:"";if(t["IS_PASSIVE"]){e+=" --passive"}else if(t["IS_ACTIVE"]){if(BX.Type.isStringFilled(this.classItemActive)){e+=" "+this.classItemActive}else{e+=" main-buttons-item-active"}}if(t["HAS_MENU"]){e+=" --has-menu"}if(t["IS_LOCKED"]){e+=" --locked"}const s=BX.Tag.render`
				<div
					id="${t["ID"]}"
					class="${e}"
					data-disabled="${t["IS_DISABLED"]}"
					data-class="${t["CLASS_SUBMENU_ITEM"]}"
					data-id="${t["DATA_ID"]}"
					data-top-menu-id="${this.getId()}"
					title=""
				>${[this.createItemLink(t,true),BX.Type.isPlainObject(t["SUB_LINK"])?this.createItemSubLink(t["SUB_LINK"]):""]}</div>
			`;this.setItemData(s,t);return s},createItemLink:function(t,e=false){t=BX.Type.isPlainObject(t)?t:{};let s;const i=["main-buttons-item-link",this.classExtraItemLink].join(" ").trim();if(BX.Type.isStringFilled(t["URL"])){s=BX.Tag.render`<a class="${i}" href="${BX.Text.encode(t["URL"])}"></a>`}else{s=BX.Tag.render`<span class="${i}"></span>`}BX.Dom.append(this.createItemIcon(t),s);BX.Dom.append(this.createItemText(t,e),s);BX.Dom.append(this.createItemCounter(t),s);return s},createItemSubLink:function(t){t=BX.Type.isPlainObject(t)?t:{};const e=BX.Type.isStringFilled(t["CLASS"])?" "+t["CLASS"]:"";const s=BX.Type.isStringFilled(t["URL"])?BX.Text.encode(t["URL"]):"";return BX.Tag.render`
				<a class="${this.classItemSublink}${e}" href="${s}"></a>
			`},createItemIcon:function(t){const e=[this.classItemIcon,this.classExtraItemIcon].join(" ").trim();return BX.Tag.render`<span class="${e}"></span>`},createItemText:function(t,e=false){t=BX.Type.isPlainObject(t)?t:{};const s=[this.classItemText,this.classExtraItemText].join(" ").trim();let i=BX.Type.isStringFilled(t["TEXT"])?t["TEXT"]:"";if(e&&i.length>this.maxItemLength){i=i.substring(0,this.maxItemLength-3)+"..."}let n="";if(BX.Type.isPlainObject(t["SUPER_TITLE"])){let{TEXT:e,CLASS:s,COLOR:i}=t["SUPER_TITLE"];s=BX.Type.isStringFilled(s)?` ${s}`:"";const o=BX.Type.isStringFilled(i)?` style="color:${i}"`:"";n=BX.Tag.render`
					<span class="main-buttons-item-super-title${s}"${o}>${e}</span>
				`}return BX.Tag.render`
				<span class="${s}">${[BX.Tag.render`<span 
						class="main-buttons-item-drag-button"
						onclick="${this.handleDragButtonClick.bind(this)}" 
						data-slider-ignore-autobinding="true"
					></span>`,n,BX.Tag.render`
						<span class="main-buttons-item-text-title">
							<span class="main-buttons-item-text-box">${BX.Text.encode(i)}<span class="main-buttons-item-menu-arrow"></span></span>
						</span>
					`,BX.Tag.render`<span 
						class="main-buttons-item-edit-button"
						onclick="${this.handleEditButtonClick.bind(this)}" 
						data-slider-ignore-autobinding="true"
					></span>`,BX.Tag.render`<span class="main-buttons-item-text-marker"></span>`]}</span>
			`},createItemCounter:function(t){t=BX.Type.isPlainObject(t)?t:{};const e=[this.classItemCounter,this.classExtraItemCounter].join(" ").trim();let s="";const i=BX.Type.isNumber(t["MAX_COUNTER_SIZE"])?t["MAX_COUNTER_SIZE"]:99;if(BX.Type.isNumber(t["COUNTER"])&&t["COUNTER"]>0){s=t["COUNTER"]>i?`${i}+`:t["COUNTER"]}const n=BX.Type.isStringFilled(t["COUNTER_ID"])?t["COUNTER_ID"]:"";return BX.Tag.render`<span data-mib-counter-id="${n}" class="${e}">${s}</span>`},createItemPin:function(t,e){return BX.Tag.render`
				<span class="main-buttons-item-pin" 
					data-slider-ignore-autobinding="true"
					onclick="${this.handleItemPin.bind(this,t,e)}"
					onmouseenter="${this.handleItemPinEnter.bind(this)}"
					onmouseleave="${this.handleItemPinLeave.bind(this)}"
				></span>
			`},getLockedClass:function(t){let e="";if(BX.Type.isDomNode(t)&&this.isLocked(t)){e=this.classItemLocked}return e},getMoreMenuItems:function(){const t=this.getAllItems();const e=this.getHiddenItems();const s=this.getDisabledItems();const i=[];if(t.length){t.forEach((t=>{if(e.indexOf(t)===-1&&s.indexOf(t)===-1){const e=this.getItemData(t);i.push({id:e["DATA_ID"],html:this.getMenuItemText(t),href:e["URL"],onclick:e["ON_CLICK"],title:t.getAttribute("title"),className:[this.classSubmenuItem,this.getIconClass(t),this.classSecret,this.getAliasLink(t),this.getLockedClass(t)].join(" "),items:this.getMoreMenuSubItems(t),events:{onMouseEnter:this.handleMoreMenuItemMouseEnter}})}}))}if(e.length){e.forEach((t=>{const e=this.getItemData(t);const s=[this.classSubmenuItem,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(e["IS_ACTIVE"]===true){s.push(this.classItemActive)}i.push({id:e["DATA_ID"],html:this.getMenuItemText(t),href:e["URL"],onclick:e["ON_CLICK"],title:t.getAttribute("title"),className:s.join(" "),items:this.getMoreMenuSubItems(t),events:{onMouseEnter:this.handleMoreMenuItemMouseEnter}})}))}if(this.isSettingsEnabled){i.push({delimiter:true,html:"<span>"+this.message("MIB_MANAGE")+"</span>",className:[this.classSeparator,this.classSubmenuItem,this.classManage].join(" ")});i.push({html:this.message("MIB_SETTING_MENU_ITEM"),className:[this.classSettingMenuItem,this.classSubmenuItem].join(" ")});const t=["ui-btn",this.theme==="default"?"ui-btn-sm":"ui-btn-xs","ui-btn-success-light","ui-btn-no-caps","ui-btn-round","ui-btn-icon-main-buttons-apply"];i.push({html:`\n\t\t\t\t\t<span class="${t.join(" ")}">\n\t\t\t\t\t\t<span class="ui-btn-text">${this.message("MIB_APPLY_SETTING_MENU_ITEM")}</span>\n\t\t\t\t\t</span>`,className:[this.classSettingsApplyButton,this.classSubmenuItem].join(" ")});i.push({html:this.message("MIB_RESET_SETTINGS"),className:[this.classSettingsResetButton,this.classSubmenuItem].join(" ")});i.push({delimiter:true,html:"<span>"+this.message("MIB_HIDDEN")+"</span>",className:[this.classSeparator,this.classSubmenuItem,this.classHiddenLabel].join(" ")});if(!s.length){i.push({html:"<span>"+this.message("MIB_NO_HIDDEN")+"</span>",className:[this.classSubmenuItem,this.classSubmenuNoHiddenItem].join(" ")})}if(s.length){s.forEach((t=>{const e=this.getItemData(t);const s=[this.classSubmenuItem,this.classItemDisabled,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(e["IS_ACTIVE"]===true){s.push(this.classItemActive)}i.push({id:e["DATA_ID"],html:this.getMenuItemText(t),href:e["URL"],onclick:e["ON_CLICK"],title:t.getAttribute("title"),className:s.join(" "),items:this.getMoreMenuSubItems(t),events:{onMouseEnter:this.handleMoreMenuItemMouseEnter}})}))}}return i},getMenuItems:function(t){return this.createMenuItems(this.getItemData(t),t)},getMoreMenuSubItems:function(t){return this.createMenuItems(this.getItemData(t),null)},createMenuItems:function(t,e=null){if(!BX.Type.isArrayFilled(t["ITEMS"])){return[]}const s=t["ITEMS"];const i=[];for(let t=0;t<s.length;t++){const n=s[t];if(n["IS_PINNED"]||n["IS_DISBANDED"]){continue}const o=n["IS_DELIMITER"]===true;if(o){const t=i.length===0;const e=i[i.length-1];if(t||e&&e["delimiter"]===true){continue}}const a=["menu-popup-no-icon","main-buttons-menu-item"];if(n["IS_ACTIVE"]===true){a.push("main-buttons-menu-item-active")}const u=BX.Text.toBoolean(n["IS_LOCKED"]);if(u){a.push(this.classItemLocked)}if(this.isEditEnabled()){a.push(this.classEditState)}let r;if(o){r={delimiter:true,className:a.join(" "),text:n["TEXT"]}}else{r={html:this.getMenuItemText(n,e),href:n["URL"],onclick:n["ON_CLICK"],title:n["TITLE"],className:a.join(" ")}}const l=n.hasOwnProperty("AJAX_OPTIONS");if(l){r.cacheable=true;r.events=this._getEvents(n["AJAX_OPTIONS"]);r.items=[{id:"loading",text:this.message("MIB_MAIN_BUTTONS_LOADING")}]}else if(BX.Type.isArrayFilled(n["ITEMS"])&&!this.isEditEnabled()){const t=this.createMenuItems(n,e);if(t.length){r.items=t}}i.push(r)}if(i.length&&i[i.length-1]["delimiter"]===true){i.pop()}return i},_setAjaxMode:function(t){for(let e in t){if(!t.hasOwnProperty(e)){continue}if(t[e].hasOwnProperty("ajaxOptions")){t[e].cacheable=true;t[e].events=this._getEvents(t[e]["ajaxOptions"]);t[e].items=[{id:"loading",text:this.message("MIB_MAIN_BUTTONS_LOADING")}]}}},_getEvents:function(t){return{onSubMenuShow:()=>{if(this.subMenuLoaded){return}const e=this.getSubMenu();e.removeMenuItem("loading");const s=e.getMenuItem("loading");this.getSubItems(t).then((t=>{this._setAjaxMode(t);this.subMenuLoaded=true;this.addSubMenu(t);this.showSubMenu()})).catch((t=>{if(s){s.getLayout().text.innerText=t}}))}}},getSubItems:function(t){return new Promise((function(e,s){if(this.progress){s(this.message("MIB_MAIN_BUTTONS_LOADING"));return}if(t.mode==="component"){this.progress=true;BX.ajax.runComponentAction(t.component,t.action,{mode:t.componentMode,signedParameters:t.signedParameters?t.signedParameters:{},data:t.data}).then((t=>{this.progress=false;e(t.data)}))}else{this.progress=true;BX.ajax.runAction(t.action,{data:t.data}).then((t=>{this.progress=false;e(t.data)}))}}))},getMoreMenuArgs:function(){const t=this.getMoreMenuId();const e=this.moreButton;const s=this.getMoreMenuItems();let i;const n=800;if(this.theme==="default"){const t=350;const s=25;i={autoHide:false,compatibleMode:false,offsetLeft:-s,offsetTop:4,cacheable:false,className:"main-buttons-menu-popup main-buttons-more-menu-popup",minWidth:240,maxWidth:t,maxHeight:n,subMenuOptions:{className:"main-buttons-menu-popup main-buttons-more-menu-popup --sub-menu",minWidth:150,maxWidth:t,events:{onFirstShow:this.handleMoreMenuFirstShow.bind(this)}},bindOptions:{position:"bottom",forceTop:true},events:{onClose:this.handleMoreMenuClose.bind(this),onDestroy:this.handleMoreMenuClose.bind(this),onFirstShow:this.handleMoreMenuFirstShow.bind(this),onShow:this.handleMoreMenuShow.bind(this),onBeforeAdjustPosition:this.handleAdjustPosition.bind(this,e)}}}else{const t=this.moreButton.querySelector(".main-buttons-item-text-title");const e=t.offsetWidth;const s=250;const o=e/2-s/2+BX.Main.Popup.getOption("angleLeftOffset");const a=BX.Main.Popup.getOption("angleLeftOffset")-BX.Main.Popup.getOption("angleMinTop");const u=s/2-a;i={autoHide:false,compatibleMode:false,offsetTop:4,offsetLeft:o,minWidth:s,maxWidth:s,maxHeight:n,angle:{position:"top",offset:u},className:"main-buttons-default-menu-popup main-buttons-more-menu-popup",subMenuOptions:{className:"main-buttons-default-menu-popup main-buttons-more-menu-popup --sub-menu",minWidth:null,events:{onFirstShow:this.handleMoreMenuFirstShow.bind(this)}},cacheable:false,bindOptions:{position:"bottom",forceTop:true},events:{onClose:this.handleMoreMenuClose.bind(this),onDestroy:this.handleMoreMenuClose.bind(this),onFirstShow:this.handleMoreMenuFirstShow.bind(this),onShow:this.handleMoreMenuShow.bind(this)}}}if(this.isEditEnabled()){i.className+=" "+this.classEditState}return[t,e,s,i]},getChildMenuArgs:function(t){const e=800;if(this.theme==="default"){const s=25;const i=350;return{autoHide:false,compatibleMode:false,offsetLeft:-s,offsetTop:4,cacheable:false,className:"main-buttons-menu-popup",maxWidth:i,minWidth:t.offsetWidth+s*2+30,maxHeight:e,subMenuOptions:{className:"main-buttons-menu-popup --sub-menu",minWidth:null,events:{onFirstShow:this._onChildMenuFirstShow.bind(this)}},bindOptions:{position:"bottom",forceTop:true},events:{onFirstShow:this._onChildMenuFirstShow.bind(this),onShow:this._onChildMenuShow.bind(this,t),onClose:this._onChildMenuClose.bind(this,t),onDestroy:this._onChildMenuClose.bind(this,t),onBeforeAdjustPosition:this.handleAdjustPosition.bind(this,t)}}}else{const s=250;return{autoHide:false,compatibleMode:false,offsetTop:4,cacheable:false,className:"main-buttons-default-menu-popup",minWidth:Math.min(t.offsetWidth+25*2+30,s),maxWidth:s,maxHeight:e,bindOptions:{position:"bottom",forceTop:true},subMenuOptions:{className:"main-buttons-default-menu-popup --sub-menu",minWidth:null,events:{onFirstShow:this._onChildMenuFirstShow.bind(this)}},events:{onFirstShow:this._onChildMenuFirstShow.bind(this),onShow:this._onChildMenuShow.bind(this,t),onClose:this._onChildMenuClose.bind(this,t),onDestroy:this._onChildMenuClose.bind(this,t)}}}},centerPopupArrow(t,e){const s=e.offsetWidth;const i=t.getPopupContainer().offsetWidth;const n=s/2-i/2;const o=BX.Main.Popup.getOption("angleLeftOffset")-BX.Main.Popup.getOption("angleMinTop");t.setAngle({offset:i/2-o});t.setOffset({offsetLeft:n+BX.Main.Popup.getOption("angleLeftOffset")})},visibleControlMoreButton:function(){const t=this.getHiddenItems();if(!t.length){this.getMoreButton().style.display="none"}else{this.getMoreButton().style.display=""}},createMoreMenu:function(){const t=BX.Main.MenuManager.create(...this.getMoreMenuArgs());if(this.isSettingsEnabled){this.dragAndDropInitInSubmenu()}t.getMenuItems().forEach((function(t){const e=t.getLayout().item;BX.Event.bind(e,"click",BX.delegate(this._onDocumentClick,this))}),this);return t},createChildMenu:function(t){const e=this.getMenuItems(t);if(e.length){const s=BX.Main.MenuManager.create(this.getChildMenuId(),t,e,this.getChildMenuArgs(t));if(!this.isEditEnabled()&&this.isSettingsEnabled){const e=()=>{this.showMoreMenu();this.enableEdit();this.destroyChildMenu();this.showChildMenu(t)};s.getMenuItems().forEach((t=>{const s=t.getLayout().item;s.draggable=true;BX.Event.bind(s,"dragstart",e)}))}return s}return null},showMoreMenu:function(){clearTimeout(this.submenuLeaveTimeout);if(!this.isEditEnabled()){this.closeChildMenu()}let t=this.getMoreMenu();if(t!==null){t.getPopupWindow().show()}else{this.destroyMoreMenu();t=this.createMoreMenu();t.getPopupWindow().show()}this.setMoreMenuShown(true);this.activateItem(this.moreButton);if(this.isEditEnabled()){t.getPopupWindow().setAutoHide(false)}},showChildMenu:function(t){clearTimeout(this.childMenuLeaveTimeout);if(!this.isEditEnabled()){this.closeMoreMenu()}if(!this.isVisibleItem(t)){return}const e=BX.Main.MenuManager.getMenuById(this.getChildMenuId());if(e&&e.bindElement===t){e.getPopupWindow().show();this.destroyItemEditMenu()}else{this.destroyChildMenu(t);const e=this.createChildMenu(t);if(e){e.getPopupWindow().show();this.destroyItemEditMenu()}}},closeMoreMenu:function(){const t=this.getMoreMenu();if(t===null){return}t.getPopupWindow().close();if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}this.setMoreMenuShown(false)},closeChildMenu:function(){const t=this.getChildMenu();if(t===null){return}this.closePinHint();t.close()},getMoreMenu:function(){return BX.Main.MenuManager.getMenuById(this.getMoreMenuId())},getChildMenu:function(){return BX.Main.MenuManager.getMenuById(this.getChildMenuId())},destroyMoreMenu:function(){BX.Main.MenuManager.destroy(this.getMoreMenuId())},destroyChildMenu:function(){BX.Main.MenuManager.destroy(this.getChildMenuId())},refreshMoreMenu:function(){const t=this.getMoreMenu();if(t===null){return}const e=this.getMoreMenuArgs();if(BX.Type.isArray(e)){this.destroyMoreMenu();this.createMoreMenu();this.showMoreMenu()}},setMoreMenuShown:function(t){this.isSubmenuShown=false;if(BX.type.isBoolean(t)){this.isSubmenuShown=t}if(this.isSubmenuShown){BX.Dom.addClass(this.moreButton,this.classMenuShown)}else{BX.Dom.removeClass(this.moreButton,this.classMenuShown)}},activateItem:function(t){if(!BX.Type.isDomNode(t)){return}if(!BX.Dom.hasClass(t,this.classItemActive)){BX.Dom.addClass(t,this.classItemActive)}},deactivateItem:function(t){if(!BX.Type.isDomNode(t)){return}if(BX.Dom.hasClass(t,this.classItemActive)){BX.Dom.removeClass(t,this.classItemActive)}},getCurrentSettings:function(){const t={};this.getAllItems().forEach(((e,s)=>{t[e.id]={sort:s,isDisabled:this.isDisabled(e),isPinned:this.isPinned(e)}}));return t},initSaving:function(t){this.sendOptions=this.sendOptions.bind(this);this.optionsToSave=[];this.debouncedSendOptions=BX.debounce(this.sendOptions,5e3);if(BX.Type.isPlainObject(t)){this.ajaxSettings={componentName:t.componentName,signedParams:t.signedParams}}},sendOptions:function(){if(this.optionsToSave.length<=0){return}const t={};this.optionsToSave.forEach((function(e){t[e.name]=e.value}));this.optionsToSave=[];window.removeEventListener("beforeunload",this.sendOptions);BX.removeCustomEvent("SidePanel.Slider:onClose",this.sendOptions);return BX.ajax.runComponentAction(this.ajaxSettings.componentName,"save",{mode:"class",signedParameters:this.ajaxSettings.signedParams,data:{options:t}})},saveOptions:function(t,e){if(this.ajaxSettings){if(this.optionsToSave.length<=0){window.addEventListener("beforeunload",this.sendOptions);BX.addCustomEvent("SidePanel.Slider:onClose",this.sendOptions)}this.optionsToSave.push({name:t,value:e});this.debouncedSendOptions()}else if(this.listContainer.id){BX.userOptions.save("ui",this.listContainer.id,t,e)}},saveSettings:function(){const t=this.getCurrentSettings();const e="settings";if(!BX.Type.isPlainObject(t)){return}if(BX.Type.isDomNode(this.listContainer)){if("id"in this.listContainer){this.saveOptions(e,JSON.stringify(t));this.setHome()}}},resetSettings:function(){let t=null;const e=BX.PopupWindowManager.create(this.listContainer.id+"_reset_popup",null,{content:this.message("MIB_RESET_ALERT"),autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true},titleBar:this.message("MIB_RESET_SETTINGS"),buttons:[t=new BX.PopupWindowButton({text:this.message("MIB_RESET_BUTTON"),className:"popup-window-button-create",events:{click:()=>{if(BX.Dom.hasClass(t.buttonNode,"popup-window-button-wait")){return}BX.Dom.addClass(t.buttonNode,"popup-window-button-wait");this.handleResetSettings((s=>{if(s){BX.Dom.removeClass(t.buttonNode,"popup-window-button-wait");e.setContent(s)}else{this.saveOptions("settings",JSON.stringify({}));this.saveOptions("firstPageLink","");this.sendOptions().then((function(){window.location.reload()})).catch((function(){window.location.reload()}))}}))}}}),new BX.PopupWindowButtonLink({text:this.message("MIB_CANCEL_BUTTON"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});e.show()},handleResetSettings:function(t){const e=[];BX.onCustomEvent("BX.Main.InterfaceButtons:onBeforeResetMenu",[e,this]);let s=new BX.Promise;const i=s;for(let t=0;t<e.length;t++){s=s.then(e[t])}s.then((function(e){t(null,e)}),(function(e){t(e,null)}));i.fulfill()},moveButtonAlias:function(t,e){if(!t||!this.dragItem){return}const s=this.getItemAlias(this.dragItem);const i=this.getItemAlias(t);if(this.isListItem(s)){if(i){if(e){BX.Dom.insertAfter(s,i)}else{this.listContainer.insertBefore(s,i)}}else{this.listContainer.appendChild(s)}}if(this.getMoreMenu()){this.getMoreMenu().getPopupWindow().adjustPosition()}},moveButton:function(t,e){if(!BX.Type.isDomNode(t)||!BX.Type.isDomNode(this.dragItem)){return}if(this.isListItem(t)){if(this.isDisabled(this.dragItem)){this.dragItem.dataset.disabled="false"}if(BX.Type.isDomNode(t)){if(e){BX.Dom.insertAfter(this.dragItem,t)}else{this.listContainer.insertBefore(this.dragItem,t)}}else{this.listContainer.appendChild(this.dragItem)}}if(this.isSubmenuItem(t)){if(e){BX.Dom.insertAfter(this.dragItem,t)}else{this.getMoreMenuContainer().insertBefore(this.dragItem,t)}}},getMoreMenuContainer:function(){const t=this.getMoreMenu();let e=null;if(t!==null){e=t.itemsContainer}return e},findNextSiblingByClass:function(t,e){const s=t;for(;!!t;t=t.nextElementSibling){if(e){if(BX.Dom.hasClass(t,e)&&t!==s){return t}}else{return null}}return null},findChildrenByClassName:function(t,e){let s=null;if(BX.Type.isDomNode(t)&&BX.Type.isStringFilled(e)){s=BX.Buttons.Utils.getByClass(t,e)}return s},initItems:function(){this.getAllItems().forEach((t=>{this.initItem(t)}))},initItem:function(t){if(this.isSettingsEnabled){t.setAttribute("draggable","true");t.setAttribute("tabindex","-1");BX.Event.bind(t,"dragstart",BX.delegate(this._onDragStart,this));BX.Event.bind(t,"dragend",BX.delegate(this._onDragEnd,this));BX.Event.bind(t,"dragenter",BX.delegate(this._onDragEnter,this));BX.Event.bind(t,"dragover",BX.delegate(this._onDragOver,this));BX.Event.bind(t,"dragleave",BX.delegate(this._onDragLeave,this));BX.Event.bind(t,"drop",BX.delegate(this._onDrop,this));t.dataset.link="item-"+BX.Text.getRandom().toLowerCase()}BX.Event.bind(t,"click",this._handleItemClick.bind(this));BX.Event.bind(t,"mouseenter",this.handleItemMouseEnter.bind(this));BX.Event.bind(t,"mouseleave",this.handleItemMouseLeave.bind(this))},dragAndDropInitInSubmenu:function(){const t=this.getMoreMenu();if(!t){return}const e=t.menuItems;e.forEach((t=>{if(this.isSeparator(t.layout.item)||this.isSettings(t.layout.item)||this.isApplySettingsButton(t.layout.item)||this.isResetSettingsButton(t.layout.item)){t.layout.item.draggable=false}else{t.layout.item.draggable=true;t.layout.item.dataset.sortable=true;BX.Event.bind(t.layout.item,"dragstart",BX.delegate(this._onDragStart,this));BX.Event.bind(t.layout.item,"dragenter",BX.delegate(this._onDragEnter,this));BX.Event.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this));BX.Event.bind(t.layout.item,"dragleave",BX.delegate(this._onDragLeave,this));BX.Event.bind(t.layout.item,"dragend",BX.delegate(this._onDragEnd,this));BX.Event.bind(t.layout.item,"drop",BX.delegate(this._onDrop,this))}if(BX.Dom.hasClass(t.layout.item,this.classHiddenLabel)||BX.Dom.hasClass(t.layout.item,this.classManage)){BX.Event.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this))}}))},getItem:function(t){if(!BX.Type.isDomNode(t)){if(!t||!BX.Type.isDomNode(t.target)){return null}}else{t={target:t}}let e=t.target.closest("."+this.classItem);if(!BX.Type.isDomNode(e)){e=t.target.closest("."+this.classDefaultSubmenuItem+", ."+this.classDefaultSubmenuDelimimeter)}return e},getItemData:function(t){if(!BX.Type.isDomNode(t)){return{}}const e=this.itemData.get(t);if(e){return e}let s;try{s=JSON.parse(t.dataset.item)}catch(t){s={}}this.setItemData(t,s);return s},setItemData(t,e){if(BX.Type.isElementNode(t)&&BX.Type.isPlainObject(e)){e.NODE=t;this.itemData.set(t,e)}},setOpacity:function(t){if(!BX.Type.isDomNode(t)){return}BX.style(t,"opacity",.5)},unsetOpacity:function(t){if(!BX.Type.isDomNode(t)){return}BX.style(t,"opacity","1")},setDragStyles:function(){BX.Dom.addClass(this.listContainer,this.classOnDrag);BX.Dom.addClass(BX(this.getMoreMenuId(true)),this.classOnDrag);this.setOpacity(this.dragItem)},unsetDragStyles:function(){const t=this.getMoreMenu();this.getAllItems().forEach((t=>{this.unsetOpacity(t);BX.Dom.removeClass(t,this.classItemOver)}));if(t&&BX.Type.isArray(t.menuItems)&&t.menuItems.length){t.menuItems.forEach((t=>{this.unsetOpacity(t);BX.Dom.removeClass(t.layout.item,this.classItemOver)}))}BX.Dom.removeClass(this.listContainer,this.classOnDrag);BX.Dom.removeClass(BX(this.getMoreMenuId(true)),this.classOnDrag)},getIconClass:function(t){let e="";if(BX.Type.isDomNode(t)&&"dataset"in t&&"class"in t.dataset&&BX.Type.isStringFilled(t.dataset.class)){e=t.dataset.class}return e},disableItem:function(t){const e=this.getItemAlias(t);if(t&&"dataset"in t){t.dataset.disabled="true";if(e){e.dataset.disabled="true"}}},enableItem:function(t){let e;if(!BX.Type.isDomNode(t)){return}if(this.isSubmenuItem(t)){BX.Dom.removeClass(t,this.classItemDisabled);e=this.getItemAlias(t);if(BX.Type.isDomNode(e)){e.dataset.disabled="false"}}},getAliasLink:function(t){return this.dataValue(t,"link")||""},getItemAlias:function(t){let e=null;if(!BX.Type.isDomNode(t)){return e}const s=this.getAllItems();const i=this.isSubmenuItem(t);const n=this.isListItem(t);if(!i&&!n){return e}if(i){s.forEach((function(s){BX.Dom.hasClass(t,this.getAliasLink(s))&&(e=s)}),this)}if(n){e=BX.Buttons.Utils.getByClass(document,this.getAliasLink(t))}return e},hideItem:function(t){!!t&&BX.Dom.addClass(t,this.classSecret)},showItem:function(t){!!t&&BX.Dom.removeClass(t,this.classSecret)},fakeDragItem:function(){if(!BX.Type.isDomNode(this.dragItem)||!BX.Type.isDomNode(this.overItem)){return}let t=null;if(this.isDragToSubmenu()){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.listContainer.appendChild(this.dragItem);this.dragItem=t;this.showItem(this.dragItem);this.adjustMoreButtonPosition();this.updateMoreMenuItems();this.tmp.moved=false;this.tmp.movetToSubmenu=true;this.setOpacity(this.dragItem)}}if(this.isDragToList()&&!this.tmp.movetToSubmenu){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.hideItem(this.dragItem);this.dragItem=t;this.adjustMoreButtonPosition();this.updateMoreMenuItems();this.setOpacity(this.dragItem)}}this.tmp.movetToSubmenu=false},updateMoreMenuItems:function(){const t=this.getMoreMenu();if(t===null){return}const e=t.menuItems;if(!BX.Type.isArray(e)||!e.length){return}const s=this.getHiddenItems();const i=this.getDisabledItems();const n=i.concat(s);e.forEach((t=>{const e=[].some.call(n,(e=>BX.Dom.hasClass(t.layout.item,this.dataValue(e,"link"))||this.isDisabled(t.layout.item)||this.isSeparator(t.layout.item)||this.isDropzone(t.layout.item)));if(e||(this.isSettings(t.layout.item)||this.isApplySettingsButton(t.layout.item)||this.isResetSettingsButton(t.layout.item)||this.isNotHiddenItem(t.layout.item)||this.isSeparator(t.layout.item)||t.layout.item===this.dragItem)&&!this.isMoreButton(t.layout.item)){this.showItem(t.layout.item)}else{this.hideItem(t.layout.item)}}))},isNotHiddenItem:function(t){return BX.Dom.hasClass(t,this.classSubmenuNoHiddenItem)},getNotHidden:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSubmenuNoHiddenItem)},setOverStyles:function(t){if(BX.Type.isDomNode(t)&&!BX.Dom.hasClass(t,this.classItemOver)){BX.Dom.addClass(t,this.classItemOver)}},unsetOverStyles:function(t){if(BX.Type.isDomNode(t)&&BX.Dom.hasClass(t,this.classItemOver)){BX.Dom.removeClass(t,this.classItemOver)}},dataValue:function(t,e){let s="";if(BX.Type.isDomNode(t)){const i=BX.data(t,e);if(typeof i!=="undefined"){s=i}}return s},execScript:function(t,e){if(BX.Type.isStringFilled(t)){const s=new Function("event",t);s(e)}},showLicenseWindow:function(){if(!B24.licenseInfoPopup){return}const t=B24.licenseInfoPopup;t.init({B24_LICENSE_BUTTON_TEXT:this.message("MIB_LICENSE_BUY_BUTTON"),B24_TRIAL_BUTTON_TEXT:this.message("MIB_LICENSE_TRIAL_BUTTON"),IS_FULL_DEMO_EXISTS:this.licenseParams.isFullDemoExists,HOST_NAME:this.licenseParams.hostname,AJAX_URL:this.licenseParams.ajaxUrl,LICENSE_ALL_PATH:this.licenseParams.licenseAllPath,LICENSE_DEMO_PATH:this.licenseParams.licenseDemoPath,FEATURE_GROUP_NAME:this.licenseParams.featureGroupName,AJAX_ACTIONS_URL:this.licenseParams.ajaxActionsUrl,B24_FEATURE_TRIAL_SUCCESS_TEXT:this.message("MIB_LICENSE_WINDOW_TRIAL_SUCCESS_TEXT")});t.show("main-buttons",this.message("MIB_LICENSE_WINDOW_HEADER_TEXT"),this.message("MIB_LICENSE_WINDOW_TEXT"))},_handleItemClick:function(t){if(!this.isEditEnabled()){const e=this.getItem(t);this.showChildMenu(e)}},handleEditButtonClick:function(t){t.preventDefault();t.stopPropagation();let e=this.getItem(t);if(!BX.Type.isDomNode(e)){return}if(this.isSubmenuItem(e)){e=this.getItemAlias(e)}const s=this.getItemData(e);const i=this.getItemEditMenu();if(i&&i.popupWindow.isShown()&&this.lastEditNode===e){i.popupWindow.close()}else{this.showItemEditMenu(s,t.target)}this.lastEditNode=e},handleDragButtonClick:function(t){t.preventDefault();t.stopPropagation()},handleItemPinEnter:function(t){const e=this.getChildMenu();if(e){this.showPinHint(t.currentTarget)}},showPinHint:function(t){const e=48;const s=BX.Main.PopupManager.create({id:"main-buttons-pin-hint",closeByEsc:true,padding:15,className:"main-buttons-pin-hint-popup",height:e,cacheable:false,autoHide:true,bindOptions:{forceBindPosition:true},content:this.message("MIB_PIN_HINT"),darkMode:true,events:{onAfterShow:function(e){const s=e.getTarget();const i=BX.Dom.getPosition(t);const n=BX.Dom.getPosition(s.getPopupContainer());if(n.left<i.left+i.width){s.setAngle({position:"top",offset:0});s.setOffset({offsetLeft:20,offsetTop:5});s.adjustPosition()}}}});s.setAngle({position:"left",offset:0});s.setOffset({offsetLeft:t.offsetWidth+5,offsetTop:-t.offsetHeight/2-e/2-2});s.setBindElement(t);s.show();s.adjustPosition()},closePinHint:function(){const t=BX.Main.PopupManager.getPopupById("main-buttons-pin-hint");if(t){t.close()}},handleItemPinLeave:function(t){this.closePinHint()},handleItemPin:function(t,e,s){s.stopPropagation();s.preventDefault();const i=this.createRootItem(t);BX.Dom.addClass(i,"main-buttons-item-insert-animation");BX.Dom.insertBefore(i,e);requestAnimationFrame((()=>{requestAnimationFrame((()=>{BX.Dom.style(i,{width:i.scrollWidth+"px",opacity:1})}))}));const n=()=>{BX.Dom.removeClass(i,"main-buttons-item-insert-animation");BX.Dom.style(i,"width",null);BX.Dom.style(i,"opacity",null);const t=this.getItemData(e);this.recalculateItemsCounters([t]);this.showMoreMenu();this.updateMoreButtonCounter();this.showChildMenu(e);this.saveSettings()};setTimeout(n,300);this.initItem(i);this.pinItem(t);this.destroyMoreMenu();this.destroyChildMenu()},handleItemUnpin:function(t,e){BX.Dom.style(e,{width:e.offsetWidth+"px"});BX.Dom.addClass(e,"main-buttons-item-insert-animation");requestAnimationFrame((()=>{requestAnimationFrame((()=>{BX.Dom.style(e,{width:0,margin:0,opacity:0})}))}));const s=()=>{BX.Dom.remove(e);this.showMoreMenu();this.updateMoreButtonCounter();this.saveSettings()};setTimeout(s,300);this.pinItem(t,false);const i=[];let n="";const o=t["ID"].split(":");o.forEach((t=>{n+=`${n===""?"":":"}${t}`;const e=this.getItemById(n);if(e){i.push(this.getItemData(e))}}));this.destroyMoreMenu();this.recalculateItemsCounters(i)},pinItem:function(t,e=true){const s=t["ID"];const i=s.split(":");let n="";i.forEach(((t,o)=>{n+=`${n===""?"":":"}${t}`;const a=this.getItemById(n);if(!a){return}const u=this.getItemData(a);let r=u["ITEMS"];let l=n;const h=i.slice(o+1);const m=[u];while(BX.Type.isArrayFilled(h)&&BX.Type.isArrayFilled(r)){l=l+":"+h.shift();for(let t=0;t<r.length;t++){const i=r[t];if(i["ID"]===s){i["IS_PINNED"]=e;for(let t=m.length-1;t>=0;t--){const s=m[t];const i=t===0;if(e){const t=s["ITEMS"].some((t=>{const e=t["IS_PINNED"]===true;const s=t["IS_DISBANDED"]===true;const i=t["IS_DELIMITER"]===true;return!e&&!s&&!i}));if(!t){s["IS_DISBANDED"]=true;if(i){a.dataset.disbanded=true}}}else{if(i){a.dataset.disbanded=false}s["IS_DISBANDED"]=false}const n=s["ITEMS"].some((t=>t["IS_ACTIVE"]===true&&t["IS_PINNED"]!==true&&t["IS_DELIMITER"]!==true));if(n){s["IS_ACTIVE"]=true;if(i){this.activateItem(a)}}else{s["IS_ACTIVE"]=false;if(i){this.deactivateItem(a)}}}return}else if(i["ID"]===l){r=i["ITEMS"];l=i["ID"];m.push(i);break}}}}))},getParentItem:function(t){const e=t.split(":");let s="";for(let i=0;i<e.length;i++){s+=`${s===""?"":":"}${e[i]}`;const n=this.getItemById(s);if(!n){continue}const o=this.getItemData(n);let a=o["ITEMS"];let u=s;const r=e.slice(i+1);let l=null;while(BX.Type.isArrayFilled(r)&&BX.Type.isArrayFilled(a)){u=u+":"+r.shift();for(let e=0;e<a.length;e++){const s=a[e];if(s["ID"]===t){return l===null?o:l}else if(s["ID"]===u){a=s["ITEMS"];u=s["ID"];l=s;break}}}}return null},_onDragStart:function(t){const e=this.getVisibleItems();const s=BX.Type.isArray(e)?e.length:null;this.dragItem=this.getItem(t);if(!BX.Type.isDomNode(this.dragItem)){return}if(s===1&&this.isListItem(this.dragItem)){t.preventDefault();BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[this.dragItem,this]);return}if(this.isMoreButton(this.dragItem)||this.isSeparator(this.dragItem)||this.isNotHiddenItem(this.dragItem)||BX.Dom.attr(this.dragItem,"data-parent-item-id")||BX.Dom.attr(this.dragItem,"data-has-child")){t.preventDefault();return}this.onDragStarted=true;this.closeChildMenu();this.destroyItemEditMenu();if(this.isListItem(this.dragItem)){this.showMoreMenu()}this.setDragStyles();if(!this.isEditEnabled()){this.enableEdit()}},_onDragEnd:function(t){t.preventDefault();const e=this.getItem(t);this.onDragStarted=false;if(!BX.Type.isDomNode(e)){return}this.unsetDragStyles();this.refreshMoreMenu();if(!this.isEditEnabled()){this.closeMoreMenu()}const s=BX.findNextSibling(this.dragItem,(t=>this.isVisibleItem(t)));const i=BX.findPreviousSibling(this.dragItem,(t=>this.isVisibleItem(t)));if(BX.Dom.hasClass(i,this.classHiddenLabel)||this.isDisabled(i)&&this.isSubmenuItem(i)||this.isDisabled(s)&&this.isSubmenuItem(s)){this.disableItem(this.dragItem);this.refreshMoreMenu()}if(this.isEditEnabled()){this.enableEdit()}else{this.disableEdit()}this.updateMoreButtonCounter();this.saveSettings();this.dragItem=null;this.overItem=null;this.tmp.moved=false},updateMoreButtonCounter:function(){let t=this.getHiddenItems();const e=this.getDisabledItems();t=t.concat(e);let s=0;if(BX.Type.isArray(t)){t.forEach((t=>{const e=this.getItemData(t);const i=BX.Type.isNumber(e["COUNTER"])&&e["COUNTER"]>0?e["COUNTER"]:0;s+=i}))}if(BX.Type.isNumber(s)){this.setMoreButtonCounter(s)}},_onDragEnter:function(t){const e=this.getItem(t);if(BX.Type.isDomNode(e)&&this.isNotHiddenItem(e)){this.setOverStyles(e)}},_onDragOver:function(t){t.preventDefault();this.overItem=this.getItem(t);if(!BX.Type.isDomNode(this.overItem)||!BX.Type.isDomNode(this.dragItem)||this.overItem===this.dragItem||this.isNotHiddenItem(this.overItem)||BX.Dom.attr(this.overItem,"data-parent-item-id")||BX.Dom.attr(this.overItem,"data-has-child")){return}this.fakeDragItem();const e=this.isNext(t);const s=this.isGoodPosition(t);if(e&&s){let t;let e=false;if(this.isListItem(this.overItem)){t=this.findNextSiblingByClass(this.overItem,this.classItem);if(t===null&&this.getLastVisibleItem()===this.overItem){t=this.overItem;e=true}}else{t=this.findNextSiblingByClass(this.overItem,this.classSubmenuItem);if(this.isSettings(t)||this.isApplySettingsButton(t)||this.isResetSettingsButton(t)){return}if(t===null&&this.getItemAlias(this.getLastDisabledItem())===this.overItem){t=this.overItem;e=true}}if(BX.Type.isDomNode(t)){this.moveButton(t,e);this.moveButtonAlias(t,e);this.adjustMoreButtonPosition();this.updateMoreMenuItems()}}else if(!e&&s&&!BX.Dom.hasClass(this.overItem,this.classHiddenLabel)){this.moveButton(this.overItem);this.moveButtonAlias(this.overItem);this.adjustMoreButtonPosition();this.updateMoreMenuItems()}},_onDragLeave:function(t){const e=this.getItem(t);if(BX.Type.isDomNode(e)){this.unsetOverStyles(t.target)}},_onDrop:function(t){const e=this.getItem(t);if(!BX.Type.isDomNode(e)){return}if(this.isNotHiddenItem(e)||this.isDisabled(e)){this.disableItem(this.dragItem);this.adjustMoreButtonPosition()}const s=this.getItemAlias(this.dragItem);if(this.isListItem(s)){s.dataset.disabled="false"}this.unsetDragStyles();t.preventDefault()},handleMoreMenuFirstShow:function(t){const e=t.getTarget();BX.Event.bind(e.getPopupContainer(),"mouseenter",this.handleMoreMenuMouseEnter.bind(this));BX.Event.bind(e.getPopupContainer(),"mouseleave",this.handleMoreMenuMouseLeave.bind(this))},handleMoreMenuMouseEnter:function(){clearTimeout(this.submenuLeaveTimeout)},handleMoreMenuMouseLeave:function(){this.tryCloseMoreMenuOnTimeout()},tryCloseMoreMenuOnTimeout:function(){clearTimeout(this.submenuLeaveTimeout);if(!this.isEditEnabled()){this.submenuLeaveTimeout=setTimeout((()=>{this.closeMoreMenu()}),500)}},handleMoreMenuShow:function(t){BX.Event.EventEmitter.emit("BX.Main.InterfaceButtons:onMenuShow");BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onMoreMenuShow",{event:t});setTimeout((()=>{if(!this.isEditEnabled()){t.getTarget().setAutoHide(true)}}),500)},handleMoreMenuClose:function(){BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onMoreMenuClose");this.setMoreMenuShown(false);if(this.isEditEnabled()){this.activateItem(this.moreButton)}else{if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}}this.destroyItemEditMenu()},_onChildMenuFirstShow:function(t){const e=t.getTarget();BX.Event.bind(e.getPopupContainer(),"mouseenter",this._onChildMenuMouseEnter.bind(this));BX.Event.bind(e.getPopupContainer(),"mouseleave",this._onChildMenuMouseLeave.bind(this))},_onChildMenuMouseEnter:function(){clearTimeout(this.childMenuLeaveTimeout)},_onChildMenuMouseLeave:function(){this.tryCloseChildMenuOnTimeout()},tryCloseChildMenuOnTimeout:function(){if(this.isEditEnabled()){return}clearTimeout(this.childMenuLeaveTimeout);this.childMenuLeaveTimeout=setTimeout((()=>{this.closeChildMenu()}),500)},_onChildMenuShow:function(t,e){BX.Dom.addClass(t,this.classMenuShown);BX.Event.EventEmitter.emit("BX.Main.InterfaceButtons:onMenuShow");BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onSubMenuShow",{item:t,event:e});if(this.theme!=="default"){this.centerPopupArrow(e.getTarget(),t)}setTimeout((()=>{e.getTarget().setAutoHide(true)}),500)},_onChildMenuClose:function(t){BX.Event.EventEmitter.emit(this,"BX.Main.InterfaceButtons:onSubMenuClose");BX.Dom.removeClass(t,this.classMenuShown);this.closePinHint()},handleAdjustPosition:function(t,e){const s=25;const i=BX.Dom.getPosition(t);const n=e.getTarget();if(e.left<i.left-s){const t=n.getPopupContainer().offsetWidth;const o=i.right-t+s;if(o>0){e.left=o;BX.Dom.addClass(n.getPopupContainer(),"--left-handed")}}else{BX.Dom.removeClass(n.getPopupContainer(),"--left-handed")}},_onResizeHandler:function(){this.adjustMoreButtonPosition();this.updateMoreMenuItems();this.closeChildMenu();if(!this.isSettingsEnabled){this.visibleControlMoreButton()}},handleMoreButtonClick:function(t){t.preventDefault();this.showMoreMenu()},handleMoreButtonMouseEnter:function(t){if(this.enableItemMouseEnter){clearTimeout(this.menuShowTimeout);this.menuShowTimeout=setTimeout((()=>{this.showMoreMenu()}),100)}clearTimeout(this.submenuLeaveTimeout)},handleMoreButtonMouseLeave:function(){clearTimeout(this.menuShowTimeout);this.tryCloseMoreMenuOnTimeout()},handleItemMouseEnter:function(t){if(!this.enableItemMouseEnter){return}if(this.onDragStarted){return}const e=this.getItem(t);clearTimeout(this.childMenuLeaveTimeout);clearTimeout(this.menuShowTimeout);this.menuShowTimeout=setTimeout((()=>{this.showChildMenu(e)}),100);BX.Dom.addClass(e,this.classItemOver)},handleItemMouseLeave:function(t){clearTimeout(this.menuShowTimeout);if(!this.enableItemMouseEnter){return}if(this.onDragStarted){return}const e=this.getItem(t);BX.Dom.removeClass(e,this.classItemOver);this.tryCloseChildMenuOnTimeout()},handleMoreMenuItemMouseEnter:function(t){if(this.isEditEnabled()){t.preventDefault()}},getSettingsResetButton:function(){return BX.Buttons.Utils.getByClass(this.getMoreMenuContainer(),this.classSettingsResetButton)},isDisabled:function(t){let e=false;if(BX.Type.isDomNode(t)){e=this.dataValue(t,"disabled")==="true"||BX.Dom.hasClass(t,this.classItemDisabled)}return e},isPinned:function(t){let e=false;if(BX.Type.isDomNode(t)){e=this.getItemData(t)["IS_PINNED"]===true}return e},isSettings:function(t){let e=false;if(BX.Type.isDomNode(t)){e=BX.Dom.hasClass(t,this.classSettingMenuItem)}return e},isLocked:function(t){let e=false;if(BX.Type.isDomNode(t)){e=this.dataValue(t,"locked")==="true"||BX.Dom.hasClass(t,this.classItemLocked)}return e},isDropzone:function(t){return BX.Dom.hasClass(t,this.classDropzone)},isNext:function(t){const e=this.dragItem.getBoundingClientRect();const s=this.overItem.getBoundingClientRect();const i=getComputedStyle(this.dragItem);const n=parseInt(i.marginRight.replace("px",""));let o=null;if(this.isListItem(this.overItem)){o=t.clientX>s.left-n&&t.clientX>e.right}if(this.isSubmenuItem(this.overItem)){o=t.clientY>e.top}return o},isGoodPosition:function(t){const e=this.overItem;if(!BX.Type.isDomNode(e)){return false}let s;const i=e.getBoundingClientRect();if(this.isListItem(e)){s=this.isNext(t)&&t.clientX>=i.left+i.width/2||!this.isNext(t)&&t.clientX<=i.left+i.width/2}if(this.isSubmenuItem(e)){s=this.isNext(t)&&t.clientY>=i.top+i.height/2||!this.isNext(t)&&t.clientY<=i.top+i.height/2}return s},isSubmenuItem:function(t){return BX.Dom.hasClass(t,this.classSubmenuItem)},isVisibleItem:function(t){if(!BX.Type.isDomNode(t)){return false}return t.offsetTop===0},isMoreButton:function(t){let e=false;if(BX.Type.isDomNode(t)&&BX.Dom.hasClass(t,this.classItemMore)){e=true}return e},isListItem:function(t){let e=false;if(BX.Type.isDomNode(t)&&BX.Dom.hasClass(t,this.classItem)){e=true}return e},isSublink:function(t){let e=false;if(BX.Type.isDomNode(t)){e=BX.Dom.hasClass(t,this.classItemSublink)}return e},isSeparator:function(t){let e=false;if(BX.Type.isDomNode(t)){e=BX.Dom.hasClass(t,this.classSeparator)}return e},isDragToSubmenu:function(){return!this.isSubmenuItem(this.dragItem)&&this.isSubmenuItem(this.overItem)},isDragToList:function(){return this.isSubmenuItem(this.dragItem)&&!this.isSubmenuItem(this.overItem)}}}if(typeof BX.Main.interfaceButtonsManager==="undefined"){BX.Main.interfaceButtonsManager={data:{},init:function(t){let e=null;if(!BX.Type.isPlainObject(t)||!("containerId"in t)){throw"BX.Main.interfaceButtonsManager: containerId not set in params Object"}e=BX(t.containerId);if(BX.Type.isDomNode(e)){this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}else{BX(BX.delegate((function(){e=BX(t.containerId);if(!BX.Type.isDomNode(e)){throw"BX.Main.interfaceButtonsManager: container is not dom node"}this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}),this))}},getById:function(t){let e=null;if(BX.type.isString(t)&&BX.Type.isStringFilled(t)){try{e=this.data[t]}catch(t){}}return e},getObjects:function(){return this.data}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js?16992579501940";s:6:"source";s:76:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
;(function() {
	'use strict';

	BX.namespace('BX.Buttons');

	/**
	 * BX.Main.interfaceButtons Utils
	 * @type {{getByClass: BX.Buttons.Utils.getByClass, getByTag: BX.Buttons.Utils.getByTag, getBySelector: BX.Buttons.Utils.getBySelector}}
	 */
	BX.Buttons.Utils = {
		/**
		 * Gets elements by className
		 * @param {HTMLElement|HTMLDocument} rootElement
		 * @param {string} className
		 * @param {boolean} [all = false] Gets all elements
		 * @returns {HTMLElement|Array}
		 */
		getByClass: function(rootElement, className, all)
		{
			var result = [];

			if (className)
			{
				result = (rootElement || document.body).getElementsByClassName(className);

				if (!all)
				{
					result = result.length ? result[0] : null;
				}
				else
				{
					result = [].slice.call(result);
				}
			}

			return result;
		},

		/**
		 * Gets elements by by element tag name
		 * @param {HTMLElement|HTMLDocument} rootElement
		 * @param {string} tag
		 * @param {boolean} [all = false] Gets all elements
		 * @returns {HTMLElement|Array}
		 */
		getByTag: function(rootElement, tag, all)
		{
			var result = [];

			if (tag)
			{
				result = (rootElement || document.body).getElementsByTagName(tag);

				if (!all)
				{
					result = result.length ? result[0] : null;
				}
				else
				{
					result = [].slice.call(result);
				}
			}

			return result;
		},

		/**
		 * Gets elements by css selector
		 * @param {HTMLElement|HTMLDocument} rootElement
		 * @param {string} selector
		 * @param {boolean} [all = false] Gets all elements
		 * @returns {HTMLElement|Array}
		 */
		getBySelector: function(rootElement, selector, all)
		{
			var result = [];

			if (selector)
			{
				if (!all)
				{
					result = (rootElement || document.body).querySelector(selector);
				}
				else
				{
					result = (rootElement || document.body).querySelectorAll(selector);
					result = [].slice.call(result);
				}
			}

			return result;
		}
	}
})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/crm.webform.edit/templates/.default/script.min.js?169925796279132";s:6:"source";s:71:"/bitrix/components/bitrix/crm.webform.edit/templates/.default/script.js";s:3:"min";s:75:"/bitrix/components/bitrix/crm.webform.edit/templates/.default/script.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/crm.webform.edit/templates/.default/script.map.js";}"*/
var CrmFormEditor=function(e){this.init=function(e){this.jsEventsManagerId=e.jsEventsManagerId;this.detailPageUrlTemplate=e.detailPageUrlTemplate;this.id=e.id;this.userBlockController=new CrmFormEditorUserBlockController(e.userBlocks);this.externalAnalytics=new CrmFormEditorExternalAnalytics;e.fields=e.fields||[];this.context=e.context;this.templates=e.templates;this.mess=e.mess;this.currency=e.currency;this.actionRequestUrl=e.actionRequestUrl;this.canRemoveCopyright=e.canRemoveCopyright;this.showRestrictionPopup=e.showRestrictionPopup;this.dynamicEntities=e.dynamicEntities;this.entityDictionary=e.entityDictionary;this.schemesDictionary=e.schemesDictionary;this.fieldsDictionary=e.fieldsDictionary;this.booleanFieldItems=e.booleanFieldItems;this.isFrame=e.isFrame;this.isSaved=e.isSaved;this.reloadList=e.reloadList;this.designPageUrl=e.designPageUrl;this.isAvailableDesign=e.isAvailableDesign;this.fields=[];if(!this.reloadList){this.actionRequestUrl=BX.util.add_url_param(this.actionRequestUrl,{RELOAD_LIST:"N"})}if(e.editorChoise.confirm){this.showEditorChoise(e.editorChoise)}BX.bind(BX("crm-webform-editor-choise-btn"),"click",this.showEditorChoise.bind(this,e.editorChoise));this.initSlider();this.helper=new CrmFormEditorHelper;this.dragdrop=new CrmFormEditorDragDrop(e.dragdrop);BX.addCustomEvent(this.dragdrop,"onSort",BX.delegate(this.onSort,this));this.initExistedFields(e);this.popupFieldSettings=new CrmWebFormEditPopupFieldSettings({caller:this,content:BX("CRM_WEB_FORM_POPUP_SETTINGS"),container:BX("CRM_WEB_FORM_POPUP_SETTINGS_CONTAINER")});this.fieldSelector=new CrmFormEditorFieldSelector({caller:this,context:BX("FIELD_SELECTOR")});this.formButton=new CrmWebFormEditFormButton({caller:this,context:BX("FORM_BUTTON_CONTAINER")});this.entityScheme=new CrmWebFormEditEntityScheme({caller:this,context:BX("ENTITY_SCHEME_CONTAINER")});this.dependencies=new CrmFormEditorDependencies({caller:this,dependencies:e.dependencies});this.presetFields=new CrmFormEditorFieldPreset({caller:this,fields:e.presetFields});this.destination=new CrmFormEditorDestination({caller:this,container:BX("crm-webform-edit-responsible")});this.adsForm=new CrmFormAdsForm({caller:this,container:BX("CRM_WEBFORM_ADS_FORM")});this.sortFields();this.initAnimation();this.initInterface();this.initToolTips();var t=document.getElementsByName("BACKGROUND_IMAGE");BX.bind(t[0],"bxchange",function(){var e=[];e=this.value.replace(/\\/g,"/").split("/");BX("BACKGROUND_IMAGE_TEXT").innerText=e[e.length-1];BX("BACKGROUND_IMAGE_TEXT").style.display=""})};this.showEditorChoise=function(e){if(!e.newLink){return}if(e.popup){e.popup.show();return}var t=e.new;e.popup=new BX.PopupWindow({autoHide:false,lightShadow:true,closeByEsc:true,width:600,overlay:{backgroundColor:"black",opacity:500},content:""+'<div class="crm-webform-ed-choise">'+'<div class="crm-webform-ed-choise-header1">'+this.mess.dlgEditorChoiseH1+"</div>"+'<div class="crm-webform-ed-choise-header2">'+this.mess.dlgEditorChoiseH2+"</div>"+'<div class="crm-webform-ed-choise-header3">'+this.mess.dlgEditorChoiseH3+"</div>"+'<div class="crm-webform-ed-choise-body">'+'<div id="crm-webform-editor-choise-new" class="crm-webform-ed-choise-item selected">'+'<div class="crm-webform-ed-choise-item-chip">&#x2714;</div>'+'<div class="crm-webform-ed-choise-item-title">'+this.mess.dlgEditorChoiseNew+"</div>"+'<div class="crm-webform-ed-choise-item-icon">'+'<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 72 62"><g fill="none" fill-rule="evenodd" transform="translate(.62 .5)"><path fill="#2FC6F6" d="M67.76,14.64 C69.4168542,14.64 70.76,15.9831458 70.76,17.64 L70.76,58 C70.76,59.6568542 69.4168542,61 67.76,61 L21.3,61 C19.6431458,61 18.3,59.6568542 18.3,58 L18.3,17.64 C18.3,15.9831458 19.6431458,14.64 21.3,14.64 L67.76,14.64 Z M67.1,24.399 L21.96,24.399 L21.96,56.94 C21.96,57.1332997 22.0971128,57.2945749 22.279386,57.3318734 L22.36,57.34 L66.7,57.34 C66.8932997,57.34 67.0545749,57.2028872 67.0918734,57.020614 L67.1,56.94 L67.1,24.399 Z M49.46,0 C51.1168542,-4.27501655e-15 52.46,1.34314575 52.46,3 L52.459,9.76 L48.8,9.76 L48.8,9.759 L3.66,9.759 L3.66,43.52 C3.66,43.7132997 3.7971128,43.8745749 3.97938605,43.9118734 L4.06,43.92 L13.112,43.92 L13.112,47.58 L3,47.58 C1.34314575,47.58 7.75242269e-15,46.2368542 7.10542736e-15,44.58 L7.10542736e-15,3 C7.34661044e-15,1.34314575 1.34314575,7.48448398e-16 3,0 L49.46,0 Z M13.112,29.28 L13.112,32.94 L9.54,32.94 C8.98771525,32.94 8.54,32.4922847 8.54,31.94 L8.54,30.28 C8.54,29.7277153 8.98771525,29.28 9.54,29.28 L13.112,29.28 Z M12.42,21.96 C12.9722847,21.96 13.42,22.4077153 13.42,22.96 L13.42,24.62 C13.42,25.1722847 12.9722847,25.62 12.42,25.62 L9.54,25.62 C8.98771525,25.62 8.54,25.1722847 8.54,24.62 L8.54,22.96 C8.54,22.4077153 8.98771525,21.96 9.54,21.96 L12.42,21.96 Z M26.84,17.08 C25.4924252,17.08 24.4,18.1724252 24.4,19.52 C24.4,20.8675748 25.4924252,21.96 26.84,21.96 C28.1875748,21.96 29.28,20.8675748 29.28,19.52 C29.28,18.1724252 28.1875748,17.08 26.84,17.08 Z M32.94,17.08 C31.5924252,17.08 30.5,18.1724252 30.5,19.52 C30.5,20.8675748 31.5924252,21.96 32.94,21.96 C34.2875748,21.96 35.38,20.8675748 35.38,19.52 C35.38,18.1724252 34.2875748,17.08 32.94,17.08 Z M39.04,17.08 C37.6924252,17.08 36.6,18.1724252 36.6,19.52 C36.6,20.8675748 37.6924252,21.96 39.04,21.96 C40.3875748,21.96 41.48,20.8675748 41.48,19.52 C41.48,18.1724252 40.3875748,17.08 39.04,17.08 Z M13.64,14.64 C14.1922847,14.64 14.64,15.0877153 14.64,15.64 L14.64,17.3 C14.64,17.8522847 14.1922847,18.3 13.64,18.3 L9.54,18.3 C8.98771525,18.3 8.54,17.8522847 8.54,17.3 L8.54,15.64 C8.54,15.0877153 8.98771525,14.64 9.54,14.64 L13.64,14.64 Z M8.54,2.44 C7.19242521,2.44 6.1,3.53242521 6.1,4.88 C6.1,6.22757479 7.19242521,7.32 8.54,7.32 C9.88757479,7.32 10.98,6.22757479 10.98,4.88 C10.98,3.53242521 9.88757479,2.44 8.54,2.44 Z M14.64,2.44 C13.2924252,2.44 12.2,3.53242521 12.2,4.88 C12.2,6.22757479 13.2924252,7.32 14.64,7.32 C15.9875748,7.32 17.08,6.22757479 17.08,4.88 C17.08,3.53242521 15.9875748,2.44 14.64,2.44 Z M20.74,2.44 C19.3924252,2.44 18.3,3.53242521 18.3,4.88 C18.3,6.22757479 19.3924252,7.32 20.74,7.32 C22.0875748,7.32 23.18,6.22757479 23.18,4.88 C23.18,3.53242521 22.0875748,2.44 20.74,2.44 Z"/><path fill="#9DCF00" d="M53.1657143,28.5 C53.717999,28.5 54.1657143,28.9477153 54.1657143,29.5 L54.1657143,43.5 C54.1657143,44.0522847 53.717999,44.5 53.1657143,44.5 L26.5942857,44.5 C26.042001,44.5 25.5942857,44.0522847 25.5942857,43.5 L25.5942857,29.5 C25.5942857,28.9477153 26.042001,28.5 26.5942857,28.5 L53.1657143,28.5 Z M32.4514286,31.9285714 C29.9266983,31.9285714 27.88,33.9752697 27.88,36.5 C27.88,39.0247303 29.9266983,41.0714286 32.4514286,41.0714286 C34.9761589,41.0714286 37.0228571,39.0247303 37.0228571,36.5 C37.0228571,33.9752697 34.9761589,31.9285714 32.4514286,31.9285714 Z M45.1657143,37.6428571 L40.3085714,37.6428571 C39.7562867,37.6428571 39.3085714,38.0905724 39.3085714,38.6428571 L39.3085714,38.6428571 L39.3085714,38.9285714 C39.3085714,39.4808562 39.7562867,39.9285714 40.3085714,39.9285714 L40.3085714,39.9285714 L45.1657143,39.9285714 C45.717999,39.9285714 46.1657143,39.4808562 46.1657143,38.9285714 L46.1657143,38.9285714 L46.1657143,38.6428571 C46.1657143,38.0905724 45.717999,37.6428571 45.1657143,37.6428571 L45.1657143,37.6428571 Z M50.88,33.0714286 L40.3085714,33.0714286 C39.7562867,33.0714286 39.3085714,33.5191438 39.3085714,34.0714286 L39.3085714,34.0714286 L39.3085714,34.3571429 C39.3085714,34.9094276 39.7562867,35.3571429 40.3085714,35.3571429 L40.3085714,35.3571429 L50.88,35.3571429 C51.4322847,35.3571429 51.88,34.9094276 51.88,34.3571429 L51.88,34.3571429 L51.88,34.0714286 C51.88,33.5191438 51.4322847,33.0714286 50.88,33.0714286 L50.88,33.0714286 Z"/></g></svg>'+"</div>"+"</div>"+'<div id="crm-webform-editor-choise-old" class="crm-webform-ed-choise-item">'+'<div class="crm-webform-ed-choise-item-chip">&#x2714;</div>'+'<div class="crm-webform-ed-choise-item-title">'+this.mess.dlgEditorChoiseOld+"</div>"+'<div class="crm-webform-ed-choise-item-icon">'+'<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 56 56"><g fill="none" fill-rule="evenodd"><path fill="#2FC6F6" d="M53,0 C54.6568542,-3.04359188e-16 56,1.34314575 56,3 L56,53 C56,54.6568542 54.6568542,56 53,56 L3,56 C1.34314575,56 2.02906125e-16,54.6568542 0,53 L0,3 C-2.02906125e-16,1.34314575 1.34314575,3.04359188e-16 3,0 L53,0 Z M51.9478261,3.65217391 L4.05217391,3.65217391 C3.83126001,3.65217391 3.65217391,3.83126001 3.65217391,4.05217391 L3.65217391,4.05217391 L3.65217391,51.9478261 C3.65217391,52.16874 3.83126001,52.3478261 4.05217391,52.3478261 L4.05217391,52.3478261 L51.9478261,52.3478261 C52.16874,52.3478261 52.3478261,52.16874 52.3478261,51.9478261 L52.3478261,51.9478261 L52.3478261,4.05217391 C52.3478261,3.83126001 52.16874,3.65217391 51.9478261,3.65217391 L51.9478261,3.65217391 Z"/><path fill="#2FC6F6" d="M38.1027733 9C39.2073428 9 40.1027733 9.8954305 40.1027733 11L40.1027733 16.862069C40.1027733 17.9666385 39.2073428 18.862069 38.1027733 18.862069L11 18.862069C9.8954305 18.862069 9 17.9666385 9 16.862069L9 11C9 9.8954305 9.8954305 9 11 9L38.1027733 9zM26.2065014 12.7931034L13.7930211 12.7931034C13.2407364 12.7931034 12.7930211 13.2408187 12.7930211 13.7931034L12.7930211 13.7931034 12.7930211 14.0689655C12.7930211 14.6212503 13.2407364 15.0689655 13.7930211 15.0689655L13.7930211 15.0689655 26.2065014 15.0689655C26.7587862 15.0689655 27.2065014 14.6212503 27.2065014 14.0689655L27.2065014 14.0689655 27.2065014 13.7931034C27.2065014 13.2408187 26.7587862 12.7931034 26.2065014 12.7931034L26.2065014 12.7931034zM38.1027733 21C39.2073428 21 40.1027733 21.8954305 40.1027733 23L40.1027733 28.862069C40.1027733 29.9666385 39.2073428 30.862069 38.1027733 30.862069L11 30.862069C9.8954305 30.862069 9 29.9666385 9 28.862069L9 23C9 21.8954305 9.8954305 21 11 21L38.1027733 21zM26.2065014 24.7931034L13.7930211 24.7931034C13.2407364 24.7931034 12.7930211 25.2408187 12.7930211 25.7931034L12.7930211 25.7931034 12.7930211 26.0689655C12.7930211 26.6212503 13.2407364 27.0689655 13.7930211 27.0689655L13.7930211 27.0689655 26.2065014 27.0689655C26.7587862 27.0689655 27.2065014 26.6212503 27.2065014 26.0689655L27.2065014 26.0689655 27.2065014 25.7931034C27.2065014 25.2408187 26.7587862 24.7931034 26.2065014 24.7931034L26.2065014 24.7931034z"/><path fill="#9DCF00" d="M25.9547172,33.8730044 C27.0592867,33.8730044 27.9547172,34.7684349 27.9547172,35.8730044 L27.9547172,45.9565217 C27.9547172,47.0610912 27.0592867,47.9565217 25.9547172,47.9565217 L11.2173913,47.9565217 C10.1128218,47.9565217 9.2173913,47.0610912 9.2173913,45.9565217 L9.2173913,35.8730044 C9.2173913,34.7684349 10.1128218,33.8730044 11.2173913,33.8730044 L25.9547172,33.8730044 Z M22.6663504,36.7831394 L17.2498727,41.7551904 L15.0830275,39.8654526 L13.2832589,41.4030009 L17.2498727,45.0005307 L24.5256545,38.3047153 L22.6663504,36.7831394 Z"/></g></svg>'+"</div>"+"</div>"+"</div>"+'<div class="crm-webform-ed-choise-notice">'+this.mess.dlgEditorChoiseNotice+"</div>"+"</div>",buttons:[new BX.UI.SaveButton({text:this.mess.dlgEditorChoiseBtnApply,events:{click:function(){this.setState(BX.UI.Button.State.WAITING);BX.ajax.runAction("crm.api.form.setEditor",{json:{editorId:t}}).then(function(){if(parseInt(t)===parseInt(e.new)){top.location.href=e.newLink}else{this.setState(null);this.context.close()}}.bind(this)).catch(function(){this.setState(null)}.bind(this))}}}),new BX.UI.CancelButton({text:this.mess.dlgEditorChoiseBtnHoldOver,events:{click:function(){this.context.close()}}})]});e.popup.show();var i=BX("crm-webform-editor-choise-new");var n=BX("crm-webform-editor-choise-old");var o=function(o){t=parseInt(o);if(t===parseInt(e.new)){i.classList.add("selected");n.classList.remove("selected")}else{n.classList.add("selected");i.classList.remove("selected")}};i.onclick=o.bind(this,e.new);n.onclick=o.bind(this,e.old)};this.initSlider=function(){if(!this.isFrame){return}if(this.isSaved){var e=BX.SidePanel.Instance.getSliderByWindow(window);if(e){e.getData().set("formId",this.id)}BX.SidePanel.Instance.close(false,this.reloadList?function(){window.top.location.reload()}:null)}this.slider.bindClose(BX("CRM_WEBFORM_EDIT_TO_LIST"));this.slider.bindClose(BX("CRM_WEBFORM_EDIT_TO_LIST_BOTTOM"))};this.slider={bindClose:function(e){BX.bind(e,"click",this.close)},close:function(e){e.preventDefault();BX.SidePanel.Instance.close()},open:function(e){BX.SidePanel.Instance.open(e)}};this.redirectToUrl=function(e){if(!this.isFrame){window.location.href=e}else{this.slider.open(e)}};this.initExistedFields=function(e){if(!e.fields){return}e.fields.forEach(function(e){var t={node:BX(e.CODE),name:e.CODE,type:e.TYPE,items:e.ITEMS||[],entity:e.ENTITY_NAME||"",settingsData:e.SETTINGS_DATA||[],getCaption:this.onGetFieldCaption,captionValue:e.CAPTION,isRequired:e.REQUIRED};this.initField(t);this.initFieldSettings(t)},this)};this.initInterfaceLicence=function(){var e=BX("LICENCE_CONTAINER");this.bindEditInline(e,"dynamic-field");var t=BX("USE_LICENCE");BX.bind(t,"click",function(){if(t.checked){BX.removeClass(e,"crm-webform-display-none")}else{BX.addClass(e,"crm-webform-display-none")}});if(BX.Helper){var i=e.querySelector('a[href*="5791365"]');if(i){BX.bind(i,"click",function(e){BX.Helper.show("redirect=detail&HD_ID=5791365");e.preventDefault()})}}};this.initInterface=function(){this.bindEditInline(BX("CAPTION_CONTAINER"),"dynamic-field");this.initInterfaceLicence();BX.bind(BX("USE_CSS_TEXT"),"click",function(){BX.toggleClass(BX("CSS_TEXT_CONTAINER"),"crm-webform-display-none")});BX.bind(BX("USE_RESULT_SUCCESS_TEXT"),"click",function(){BX.toggleClass(BX("RESULT_SUCCESS_TEXT_CONT"),"crm-webform-display-none")});var e=function(){var e="crm-webform-display-none";var t=false;if(!BX.hasClass(BX("RESULT_FAILURE_URL_CONT"),e)){t=true}if(!BX.hasClass(BX("RESULT_SUCCESS_URL_CONT"),e)){t=true}var i=BX("RESULT_REDIRECT_DELAY_CONTAINER");if(t){BX.removeClass(i,e)}else{BX.addClass(i,e)}};e();BX.bind(BX("USE_RESULT_SUCCESS_URL"),"click",function(){BX.toggleClass(BX("RESULT_SUCCESS_URL_CONT"),"crm-webform-display-none");e()});BX.bind(BX("USE_RESULT_FAILURE_TEXT"),"click",function(){BX.toggleClass(BX("RESULT_FAILURE_TEXT_CONT"),"crm-webform-display-none")});BX.bind(BX("USE_RESULT_FAILURE_URL"),"click",function(){BX.toggleClass(BX("RESULT_FAILURE_URL_CONT"),"crm-webform-display-none");e()});BX.bind(BX("IS_PAY"),"click",function(){BX.toggleClass(BX("PAY_SYSTEM_CONT"),"crm-webform-display-none")});BX.bind(BX("IS_CALLBACK_FORM"),"click",function(){BX.toggleClass(BX("CALLBACK_CONTAINER"),"crm-webform-display-none")});BX.bind(BX("DESCRIPTION_EDITOR_BUTTON"),"click",function(){BX.toggleClass(BX("DESCRIPTION_EDITOR_BUTTON"),"crm-webform-display-none");BX.toggleClass(BX("DESCRIPTION_EDITOR_CONTAINER"),"crm-webform-edit-animate-show");var e=BXHtmlEditor.Get("DESCRIPTION");if(e){e.Focus()}});if(!this.canRemoveCopyright){BX.bind(BX("COPYRIGHT_REMOVED_CONT"),"click",BX.proxy(function(e){BX.PreventDefault(e);this.showRestrictionPopup()},this))}var t=BX("CRM_WEBFORM_COPY_BUTTON");if(t){BX.bind(t,"click",BX.proxy(function(e){BX.ajax({url:this.actionRequestUrl,method:"POST",data:{action:"copy",form_id:this.id,sessid:BX.bitrix_sessid()},timeout:30,dataType:"json",processData:true,onsuccess:BX.proxy(function(e){e=e||{};if(e.error){}else{this.redirectToUrl(this.detailPageUrlTemplate.replace("#id#",e.copiedId).replace("#form_id#",e.copiedId))}},this),onfailure:BX.proxy(function(){},this)})},this))}if(this.isAvailableDesign){BX.bind(BX("crm-webform-edit-design-btn"),"click",function(){BX.SidePanel.Instance.open(this.designPageUrl,{cacheable:false,width:1050})}.bind(this))}};this.submitForm=function(){BX("crm_webform_edit_form").submit()};this.initAnimation=function(){var e=document.getElementsByClassName(".crm-webform-edit-animate");e=BX.convert.nodeListToArray(e);e.forEach(function(e){},this)};this.bindEditInline=function(e,t){var i=e.querySelector("[data-bx-web-form-lbl-cont]");var n=e.querySelector("[data-bx-web-form-lbl-caption]");var o=e.querySelector("[data-bx-web-form-btn-caption]");var s=e.querySelector("[data-bx-web-form-lbl-btn-edit]");var r=e.querySelector("[data-bx-web-form-lbl-btn-apply]");BX.bind(s,"click",function(){BX.addClass(i,t)});BX.bind(r,"click",function(){n.innerText=o.value;BX.removeClass(i,t)})};this.sendActionRequest=function(e,t,i,n){i=i||null;n=n||null;t=t||{};t.action=e;t.form_id=null;t.sessid=BX.bitrix_sessid();BX.ajax({url:this.actionRequestUrl,method:"POST",data:t,timeout:30,dataType:"json",processData:true,onsuccess:BX.proxy(function(e){e=e||{};if(e.error){n.apply(this,[e])}else if(i){i.apply(this,[e])}},this),onfailure:BX.proxy(function(){var e={error:true,text:""};n.apply(this,[e])},this)})};this.onGetFieldCaption=function(){var e=document.getElementsByName("FIELD["+this.name+"][CAPTION]");return e&&e[0]?e[0].value:""};this.getFieldNameList=function(){var e=[];this.fields.forEach(function(t){e.push(t.name)});return e};this.fireChangeFieldListEvent=function(){BX.onCustomEvent(this,"change-field-list",[this.fields])};this.fireFieldChangeItemsEvent=function(e){BX.onCustomEvent(e,"change-field-items");BX.onCustomEvent(this,"change-field-items",[this.fields,e])};this.addFieldByCode=function(e){var t=this.fieldsDictionary.filter(function(t){return t.name==e});if(t[0]){this.addField(t[0])}};this.addField=function(e,t){if(!e.duplicated&&this.findField(e.name)){return}var i=this.templates.field.replace("%type%",e.type);if(!this.helper.getTemplate(i)){i=this.templates.field.replace("%type%","string")}var n=null;var o=null;switch(e.entity_field_name){case"PHONE":n="phone";o="111-11-11";break;case"WEB":o="http://";break;case"EMAIL":n="email";o="my@example.com";break}e.entity_field_name=e.entity_field_name||"";var s=this.helper.appendNodeByTemplate(BX("FIELD_CONTAINER"),i,{id:e.id||"",type:n||e.type,name:e.name,caption:e.caption,placeholder:o||"",multiple:"N",required:"N",sort:1e3,value_type:"",value:"",items:"",settings_items:"",settings_data_quantity_min:"",settings_data_quantity_max:"",settings_data_quantity_step:"",url_display_style:e.entity_field_name.substring(0,3)=="UF_"?"initial":"none",entity_field_name:e.entity_field_name,entity_field_caption:e.caption,entity_name:e.entity_name,entity_caption:e.entity_caption});if(!s){return}var r={type:e.type,node:s,name:e.name,items:e.items||[],entity:e.entity_name,getCaption:this.onGetFieldCaption};this.initField(r);this.addFieldItems(r);this.addFieldSettingsItems(r);this.initFieldSettings(r);if(!t){this.sortFields();this.fireChangeFieldListEvent()}return r};this.addFieldItems=function(e,t){t=t||false;if(e.items.length==0||!e.itemsContainer){return}if(t){e.itemsContainer.innerHTML=""}var i=this.templates.field.replace("%type%",e.type);var n=i+"_item";e.items.forEach(function(t){var i=this.helper.appendNodeByTemplate(e.itemsContainer,n,{item_id:t.ID,item_value:t.VALUE,field_item_name:e.type+"_"+e.name+"_"+e.randomId+"[]",field_item_id:e.type+"_"+t.ID+this.helper.generateId()})},this)};this.initField=function(e){if(!e.node){return}var t=this.findDictionaryField(e.name);if(!t){if(e.type==="product"){t={code:e.name,type:e.type,required:false,multiple:true}}else{t={code:e.name,type:e.type,required:false,multiple:false}}}e.dict=t;e.randomId=this.helper.generateId();var i=e.node.querySelector("[data-bx-web-form-btn-caption]");var n=e.node.querySelector("[data-bx-web-form-btn-edit]");var o=e.node.querySelector("[data-bx-web-form-btn-delete]");e.lblCaption=e.node.querySelector("[data-bx-web-form-lbl-caption]");e.itemsContainer=e.node.querySelector("[data-bx-web-form-field-display-cont]");e.settingsContainer=e.node.querySelector("[data-bx-web-form-field-settings-cont]");var s=this;BX.bind(i,"change",function(){e.lblCaption.innerText=i.value;s.fireChangeFieldListEvent()});BX.bind(n,"click",function(){s.editField(e)});BX.bind(o,"click",function(){s.deleteField(e)});this.dragdrop.addItem(e.node);this.fields.push(e);BX.addCustomEvent(e,"change-field-items",BX.proxy(function(){var t=null;if(e.type=="product"){t=e.itemsContainer.children[0]}e.itemsContainer.innerHTML="";if(t){e.itemsContainer.appendChild(t)}this.addFieldItems(e)},this))};this.initFieldSettings=function(e){if(!e.node){return}var t=e.node.querySelector("[data-bx-web-form-field-type]");var i=e.node.querySelector("[data-bx-web-form-btn-multiple-value]");var n=e.node.querySelector("[data-bx-web-form-btn-multiple]");var o=e.node.querySelector("[data-bx-web-form-btn-multiple-cont]");var s=e.node.querySelector("[data-bx-web-form-btn-add]");var r=e.node.querySelector("[data-bx-web-form-btn-required-value]");var a=e.node.querySelector("[data-bx-web-form-btn-required]");var l=e.node.querySelector("[data-bx-web-form-btn-big-pic-value]");var d=e.node.querySelector("[data-bx-web-form-btn-big-pic]");if(o&&i&&n){if(!e.dict.multiple){this.helper.styleDisplay(o,false);i.value="N"}else{n.checked=i.value=="Y";if(e.dict.type==="checkbox"){var c=function(){i.value=n.checked?"Y":"N";t.value=e.type=n.checked?"checkbox":"radio";this.addFieldItems(e,true)};BX.bind(n,"click",BX.proxy(c,this));c.apply(this,[])}else{this.helper.styleDisplay(s,n.checked,"inline-block");BX.bind(n,"click",BX.proxy(function(){i.value=n.checked?"Y":"N";this.helper.styleDisplay(s,n.checked,"inline-block")},this))}}}if(r&&a){if(r.value==="Y"){a.checked=true}BX.bind(a,"change",function(){r.value=a.checked?"Y":"N"})}if(l&&d){if(l.value==="Y"){d.checked=true}BX.bind(d,"change",function(){l.value=d.checked?"Y":"N"})}var h=e.dict["type"]?e.dict.type:e.type;var u="initFieldType"+h.substring(0,1).toUpperCase()+h.substring(1);if(BX.type.isFunction(this[u])){this[u](e)}};this.addFieldSettingsItems=function(e){var t=e.node.querySelector("[data-bx-crm-webform-field-settings-items]");if(!t||e.items.length==0||!e.itemsContainer){return}var i=this.templates.field.replace("%type%",e.type);var n=i+"_settings_item";e.items.forEach(function(i){var o=this.helper.appendNodeByTemplate(t,n,{name:e.name,item_id:i.ID,item_value:i.VALUE,field_item_name:e.type+"_"+e.name+"_"+e.randomId+"[]",field_item_id:e.type+"_"+i.ID+this.helper.generateId()})},this)};this.initFieldTypeProduct=function(e){e.productSelector=new CrmFormEditorProductSelector({jsEventsManagerId:this.jsEventsManagerId,context:e.node,caller:this,id:e.id,field:e})};this.initFieldTypeCheckbox=function(e){this.initFieldTypeList(e)};this.initFieldTypeRadio=function(e){this.initFieldTypeList(e)};this.initFieldTypeList=function(e){e.fieldListManager=new CrmFormEditorFieldListSettings({caller:this,context:e.node,type:e.type,field:e})};this.initFieldTypeSection=function(e){this.bindEditInline(e.node,"dynamic-field")};this.initFieldTypePage=function(e){this.bindEditInline(e.node,"dynamic-field")};this.initFieldTypeString=function(e){var t=e.node.querySelector("[data-bx-web-form-field-string-type]");var i=e.node.querySelector("[data-bx-web-form-field-type]");if(t){t.value=i.value;BX.bind(t,"bxchange",function(){i.value=t.value||"string"})}};this.initFieldTypeTyped_string=function(e){this.initFieldTypeString(e);if(!e.dict["value_type"]){return}var t=e.node.querySelector("[data-bx-web-form-field-string-value-types]");var i=e.node.querySelector("[data-bx-web-form-field-string-value-type]");if(t){var n=i.value;var o=[];e.dict.value_type.forEach(function(e){if(!n){n=e.ID}o.push({caption:e.VALUE,value:e.ID,selected:e.ID==n})},this);this.helper.fillDropDownControl(t,o);i.value=n;BX.bind(t,"bxchange",function(){i.value=t.value||"OTHER"})}};this.initFieldTypeDouble=function(e){this.initFieldTypeString(e)};this.initFieldTypeInteger=function(e){this.initFieldTypeString(e)};this.findDictionaryField=function(e){var t=this.fieldsDictionary.filter(function(t){return t.name===e});if(t&&t.length>0){return t[0]}return null};this.initFieldTypeResourcebooking=function(e){BX.Runtime.loadExtension("calendar.resourcebookinguserfield").then(function(t){var i=t.ResourcebookingUserfield;if(BX.type.isFunction(i)){var n=i.initCrmFormFieldController({field:e});e.edit=n.showSettingsPopup.bind(n)}else if(BX.Calendar&&BX.Calendar.UserField&&BX.type.isFunction(BX.Calendar.UserField.getResourceBookingCrmFormField)){var o=new BX.Calendar.UserField.getResourceBookingCrmFormField({field:e});if(o){o.init()}e.edit=o.showSettingsPopup.bind(o)}})};this.findField=function(e){var t=this.fields.filter(function(t){return t.name===e});if(t&&t.length>0){return t[0]}return null};this.findFieldByNode=function(e){var t=this.fields.filter(function(t){return t.node==e});if(t&&t.length>0){return t[0]}return null};this.editField=function(e,t){if(e&&BX.type.isFunction(e.edit)){e.edit(e)}else{this.popupFieldSettings.show(e.settingsContainer)}BX.onCustomEvent(this,"edit-field",[e])};this.deleteField=function(e){BX.onCustomEvent(this,"delete-field",[e]);this.dragdrop.removeItem(e.node);BX.remove(e.node);var t=this.fields.indexOf(e);if(t>-1){delete this.fields[t]}this.sortFields();this.fireChangeFieldListEvent()};this.moveField=function(e,t){this.sortFields()};this.sortFields=function(){this.fields.forEach(function(e){e.sortValue=BX.convert.nodeListToArray(e.node.parentNode.children).indexOf(e.node)});this.fields.sort(function(e,t){return e.sortValue>t.sortValue?1:-1});var e=10;this.fields.forEach(function(t){var i=t.node.querySelector("[data-bx-web-form-field-sort]");if(i){i.value=(t.sortValue+1)*e}})};this.onSort=function(e,t){this.sortFields()};this.initToolTips=function(e){this.popupTooltip={};e=e||BX.convert.nodeListToArray(document.body.querySelectorAll(".crm-webform-context-help"));var t=this;for(var i=0;i<e.length;i++){if(e[i].getAttribute("context-help")=="y")continue;e[i].setAttribute("data-id",i);e[i].setAttribute("context-help","y");BX.bind(e[i],"mouseover",function(){var e=this.getAttribute("data-id");var i=this.getAttribute("data-text");t.showTooltip(e,this,i)});BX.bind(e[i],"mouseout",function(){var e=this.getAttribute("data-id");t.hideTooltip(e)})}};this.showTooltip=function(e,t,i){if(this.popupTooltip[e])this.popupTooltip[e].close();this.popupTooltip[e]=new BX.PopupWindow("bx-crm-webform-edit-tooltip",t,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:200,events:{onPopupClose:function(){this.destroy()}},content:BX.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:i})});this.popupTooltip[e].setAngle({offset:13,position:"bottom"});this.popupTooltip[e].show();return true};this.hideTooltip=function(e){this.popupTooltip[e].close();this.popupTooltip[e]=null};this.init(e)};function CrmWebFormEditEntityScheme(e){this.caller=e.caller;this.context=e.context;this.submitButtonEnabled=true;this.init()}CrmWebFormEditEntityScheme.prototype={init:function(){this.helper=BX.CrmFormEditorHelper;this.descriptionNode=this.context.querySelector("[data-bx-webform-edit-scheme-desc]");this.descriptionTopNode=BX("ENTITY_SCHEMES_TOP_DESCRIPTION");this.radioList=BX.convert.nodeListToArray(this.context.querySelectorAll("[data-bx-web-form-entity-scheme-value]"));this.invoiceCheckNode=this.context.querySelector("[data-bx-web-form-entity-scheme-invoice]");this.dealCategoryNode=this.context.querySelector("[data-bx-web-form-entity-scheme-deal-cat]");this.dynamicCategoryNode=this.context.querySelector("[data-bx-web-form-entity-scheme-dyn-cat]");this.dealDcNode=this.context.querySelector("[data-bx-web-form-entity-scheme-deal-dc]");var e=document.getElementsByName("ENTITY_SCHEME");this.valueNode=e[0];BX.bind(this.invoiceCheckNode,"change",BX.proxy(this.onChange,this));this.radioList.forEach(function(e){BX.bind(e,"change",BX.proxy(this.onChange,this))},this);this.submitButtonNode=BX("CRM_WEBFORM_SUBMIT_APPLY");BX.bind(this.submitButtonNode,"click",BX.proxy(this.checkCreateFields,this));this.initInvoiceBlock();this.actualizeDynamicCategory()},initInvoiceBlock:function(){this.invoice={node:this.context.querySelector("[data-bx-crm-webform-invoice]"),payerNode:this.context.querySelector("[data-bx-crm-webform-invoice-payer]"),payerTextNoNode:this.context.querySelector("[data-bx-crm-webform-invoice-payer-text-no]"),productNode:this.context.querySelector("[data-bx-crm-webform-invoice-product]"),productButton:this.context.querySelector("[data-bx-crm-webform-invoice-product-btn]"),productDraw:this.context.querySelector("[data-bx-crm-webform-invoice-product-draw]"),productField:null,payerTypeNodes:BX.convert.nodeListToArray(document.getElementsByName("INVOICE_SETTINGS[PAYER]")),hasFieldsContact:false,hasFieldsCompany:false};BX.bind(this.invoice.productButton,"click",BX.proxy(function(){this.actualizeInvoiceProductField(true);if(this.invoice.productField){this.caller.editField(this.invoice.productField)}},this));BX.addCustomEvent(this.caller,"change-field-list",BX.proxy(this.actualizeInvoiceSettings,this));this.invoice.payerTypeNodes.forEach(function(e){BX.bind(e,"change",BX.proxy(this.onChange,this))},this);this.actualizeInvoiceSettings()},isInvoiceChecked:function(){return this.invoiceCheckNode.checked},showPopupCreateProductField:function(){if(!this.popupCreateProductField){this.popupCreateProductField=BX.PopupWindowManager.create("crm_webform_edit_create_prod_field",null,{content:this.caller.mess.dlgInvoiceEmptyProduct,titleBar:this.caller.mess.dlgInvoiceEmptyProductTitle,autoHide:false,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});this.popupCreateProductField.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgContinue,className:"webform-small-button-accept",events:{click:BX.proxy(function(){this.popupCreateProductField.close()},this)}})])}this.popupCreateProductField.show();this.popupCreateProductField.resizeOverlay()},showPopupCreateFields:function(){if(!this.popupConfirmCreateFields){this.popupConfirmCreateFields=BX.PopupWindowManager.create("crm_webform_edit_create_fields",null,{titleBar:this.caller.mess.dlgTitleFieldCreate,content:BX("CRM_WEB_FORM_POPUP_CONFIRM_FIELD_CREATE"),autoHide:false,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500},onPopupClose:BX.proxy(this.onClose)});this.popupConfirmCreateFields.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgContinue,className:"webform-small-button-accept",events:{click:BX.proxy(function(){this.caller.submitForm()},this)}}),new BX.PopupWindowButton({text:this.caller.mess.dlgCancel,className:"webform-small-button-cancel",events:{click:BX.proxy(function(){this.submitButtonEnabled=true;BX.removeClass(this.submitButtonNode,"ui-btn-wait");this.popupConfirmCreateFields.close()},this)}})])}this.popupConfirmCreateFields.show()},checkCreateFields:function(e){if(!this.submitButtonEnabled){BX.PreventDefault(e);return false}var t=[];var i=this.getCurrent();var n=false;var o=[];var s={};this.caller.fields.forEach(function(e){if(e.type=="product"&&e.items.length>0){n=true}if(!e.dict["caption"]){return}if(!e.dict["entity_name"]){return}o.push(e.name);s[e.name]=e.dict.caption;if(BX.util.in_array(e.dict.entity_name,i.ENTITIES)){return}t.push('<li class="crm-p-s-f-item">'+BX.util.htmlspecialchars(e.dict.caption)+"</li>")},this);if(this.isInvoiceChecked()&&!n){BX.PreventDefault(e);this.showPopupCreateProductField();return false}if(t.length==0){return true}BX.PreventDefault(e);this.submitButtonEnabled=false;BX.addClass(this.submitButtonNode,"crm-webform-submit-button-loader");var r=BX("CRM_WEB_FORM_POPUP_CONFIRM_FIELD_CREATE_ENTITY");if(i.ID==2||i.ID==5){if(this.invoice.hasFieldsContact){r.innerText=this.caller.entityDictionary["CONTACT"]}else{r.innerText=this.caller.entityDictionary["COMPANY"]}}else{r.innerText=i.NAME}var a=BX("CRM_WEB_FORM_POPUP_CONFIRM_FIELD_CREATE_LIST");this.caller.sendActionRequest("get_create_fields",{schemeId:i.ID,fieldCodes:o},BX.proxy(function(e){e=e||{};var t=[];var i=e["syncFieldCodes"]?e.syncFieldCodes:[];if(i.length==0){this.caller.submitForm();return}i.forEach(function(e){if(!s[e]){return}t.push('<li class="crm-p-s-f-item">'+BX.util.htmlspecialchars(s[e])+"</li>")});a.innerHTML=t.join("");this.showPopupCreateFields()},this),BX.proxy(function(){a.innerHTML=t.join("");this.showPopupCreateFields()},this));return false},setCurrentId:function(e){if(this.valueNode){this.valueNode.value=e}},getCurrentPayerEntityType:function(){return this._currentPayerEntityType()},setCurrentPayerEntityType:function(e){return this._currentPayerEntityType(e)},_currentPayerEntityType:function(e){e=e||null;this.invoice.payerTypeNodes.forEach(function(t){if(e){t.checked=e==t.value}else if(t.checked){e=t.value}},this);return e},getCurrent:function(){var e=this.invoiceCheckNode.checked?"BY_INVOICE":"BY_NON_INVOICE";var t=null;this.radioList.forEach(function(e){if(e.checked){t=e.value}});return this.caller.schemesDictionary[e][t]},onChange:function(){var e=this.getCurrent();this.setCurrentId(e.ID);this.actualizeInvoiceSettings(e);this.actualizeDealCategory(e);this.actualizeDynamicCategory(e);BX.onCustomEvent(this.caller,"change-entity-scheme",[e])},getCurrentWillCreatedEntities:function(){var e=this.getCurrent();var t=[];var i=this.getCurrentPayerEntityType();e.ENTITIES.forEach(function(e){var n=i==e;var o=e=="CONTACT";var s=e=="COMPANY";if(o&&!this.invoice.hasFieldsContact&&!n){return}if(s&&!this.invoice.hasFieldsCompany&&!n){return}if(!this.caller.entityDictionary[e]){return}t.push(e)},this);return t},actualizeDealCategory:function(){var e=this.getCurrent();var t=BX.util.in_array("DEAL",e.ENTITIES);this.helper.changeClass(this.dealCategoryNode,"crm-webform-edit-animate-show-120",t);this.helper.changeClass(this.dealDcNode,"crm-webform-edit-animate-show-120",t)},actualizeDynamicCategory:function(){var e=this.getCurrent();var t=e.DYNAMIC;this.helper.changeClass(this.dynamicCategoryNode,"crm-webform-edit-animate-show-120",t);if(!t){return}var i=this.caller.dynamicEntities.filter(function(t){return t.id===e.MAIN_ENTITY})[0];if(!i){return}var n=BX("DYNAMIC_CATEGORY");var o=parseInt(n.value||0);n.innerHTML="";i.categories.forEach(function(e){var t=document.createElement("option");t.value=e.id;t.selected=parseInt(e.id)===o;t.textContent=e.name;n.appendChild(t)}.bind(this))},actualizeTextWillCreatedEntities:function(){var e=[];this.getCurrentWillCreatedEntities().forEach(function(t){e.push(this.caller.entityDictionary[t])},this);var t=this.getCurrent();var i=e.length>0?e.join(", "):t["DESCRIPTION"];if(this.descriptionNode){this.descriptionNode.innerText=i}if(this.descriptionTopNode){this.descriptionTopNode.innerText=i}},actualizeInvoiceProductField:function(e){var t=this.caller.fields.filter(function(e){return e.type=="product"},this);if(t.length>0&&!this.invoice.productField){this.invoice.productField=t[0];BX.addCustomEvent(this.invoice.productField,"change-field-items",BX.proxy(this.actualizeInvoiceSettings,this))}else if(t.length==0){if(this.invoice.productField){this.invoice.productField=null}else if(e){this.invoice.productField=this.caller.fieldSelector.addSpecialFormField("product");BX.addCustomEvent(this.invoice.productField,"change-field-items",BX.proxy(this.actualizeInvoiceSettings,this));this.invoice.productField.productSelector.addFieldItem({id:"n"+this.helper.generateId(),name:this.caller.mess.defaultProductName,price:1})}}if(!e&&this.invoice.productField){}if(this.invoice.productDraw){this.invoice.productDraw.innerHTML="";if(this.invoice.productField){this.invoice.productField.items.forEach(function(e){this.helper.appendNodeByTemplate(this.invoice.productDraw,"tmpl_field_product_items_draw",{name:e.VALUE||"",price:e.PRICE||"",discount:e.DISCOUNT||"",custom_price:e.CUSTOM_PRICE||""})},this)}}this.helper.styleDisplay(this.invoice.productNode,e)},actualizePayer:function(){var e=false,t=false;var i=this.caller.fields.filter(function(i){if(!i.dict["entity_name"])return false;if(i.dict.entity_name=="CONTACT")e=true;if(i.dict.entity_name=="COMPANY")t=true;return BX.util.in_array(i.dict.entity_name,["CONTACT","COMPANY"])},this);this.invoice.hasFieldsCompany=t;this.invoice.hasFieldsContact=e;var n=e&&t;if(!n){if(e){this.setCurrentPayerEntityType("CONTACT")}else if(t){this.setCurrentPayerEntityType("COMPANY")}}var o=i.length==0||n;this.helper.styleDisplay(this.invoice.payerNode,o);this.helper.styleDisplay(this.invoice.payerTextNoNode,!n)},actualizeInvoiceSettings:function(){var e=this.getCurrent();var t=this.isInvoiceChecked();this.helper.changeClass(this.invoice.node,"crm-webform-display-none",!t);this.actualizeInvoiceProductField(t);this.actualizePayer();this.actualizeTextWillCreatedEntities()}};function CrmWebFormEditFormButton(e){this.caller=e.caller;this.context=e.context;this.helper=BX.CrmFormEditorHelper;this.buttonNode=BX("FORM_BUTTON");this.buttonInputNode=BX("FORM_BUTTON_INPUT");this.buttonTextErrorNode=BX("FORM_BUTTON_INPUT_ERROR");this.buttonColorBgNode=BX("BUTTON_COLOR_BG");this.buttonColorFontNode=BX("BUTTON_COLOR_FONT");this.popupButtonNameNode=BX("CRM_WEB_FORM_POPUP_BUTTON_NAME");top.BX.addCustomEvent("crm-webform-design-save",this.onChangeDesign.bind(this));this.init()}CrmWebFormEditFormButton.prototype={onChangeDesign:function(e){this.setTextColor(e.color.primaryText.substr(0,7));this.setBackgroundColor(e.color.primary.substr(0,7))},init:function(){BX.bind(this.buttonNode.parentNode,"click",BX.proxy(this.editButton,this));BX.bind(this.buttonInputNode,"bxchange",BX.proxy(this.onButtonCaptionChange,this));this.picker=new BX.ColorPicker({popupOptions:{offsetLeft:15,offsetTop:5}});BX.bind(this.buttonColorBgNode.nextElementSibling,"click",this.showPickerBackground.bind(this));BX.bind(this.buttonColorFontNode.nextElementSibling,"click",this.showPickerTextColor.bind(this));this.setTextColor(this.buttonColorFontNode.value);this.setBackgroundColor(this.buttonColorBgNode.value)},editButton:function(){this.caller.popupFieldSettings.show(this.popupButtonNameNode,BX.proxy(this.onEditButtonClosePopup,this))},onEditButtonClosePopup:function(){var e=!!BX.util.trim(this.buttonInputNode.value);this.helper.styleDisplay(this.buttonTextErrorNode,!e,"block");return e},onButtonCaptionChange:function(){this.buttonNode.innerText=this.buttonInputNode.value},updateButtonColors:function(){this.buttonNode.style.background=this.buttonColorBgNode.value;this.buttonNode.style.color=this.buttonColorFontNode.value},showPickerBackground:function(){this.picker.close();this.picker.open({defaultColor:"",allowCustomColor:true,bindElement:this.buttonColorBgNode.nextElementSibling,onColorSelected:this.setBackgroundColor.bind(this)})},showPickerTextColor:function(){this.picker.close();this.picker.open({defaultColor:"",allowCustomColor:true,bindElement:this.buttonColorFontNode.nextElementSibling,onColorSelected:this.setTextColor.bind(this)})},setBackgroundColor:function(e){this.buttonColorBgNode.value=e;this.buttonColorBgNode.nextElementSibling.style.background=e;this.updateButtonColors()},setTextColor:function(e){this.buttonColorFontNode.value=e;this.buttonColorFontNode.nextElementSibling.style.background=e;this.updateButtonColors()}};function CrmWebFormEditPopupFieldSettings(e){this.caller=e.caller;this.popup=null;this.popupContent=e.content;this.popupContainer=e.container;this.popupCloseHandler=null;this.fieldContainer=null}CrmWebFormEditPopupFieldSettings.prototype={setAutoHide:function(e){if(this.popup){this.popup.params.autoHide=e}},show:function(e,t){this.popupCloseHandler=t||null;this.initPopup();this.moveSettingsBack();this.fieldContainer=e;this.moveSettingsOn();this.popup.show()},moveSettingsOn:function(){if(!this.fieldContainer){return}this.replaceSettingsNode(this.fieldContainer,this.popupContainer)},moveSettingsBack:function(){if(!this.fieldContainer){return}this.replaceSettingsNode(this.popupContainer,this.fieldContainer);this.fieldContainer=null},_popupClose:function(e){if(this.popupCloseHandler&&!this.popupCloseHandler.apply(this,[])){return}this.onClose();BX.PopupWindow.prototype.close.apply(this.popup,[e])},onClose:function(){this.moveSettingsBack();this.popupCloseHandler=null},replaceSettingsNode:function(e,t){if(!e||!e.firstElementChild){return}t.appendChild(e.firstElementChild)},initPopup:function(){if(this.popup){return}var e=BX.PopupWindowManager.create("crm_webform_edit_field_settings",null,{content:this.popupContent,autoHide:false,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500},zIndex:-400,titleBar:this.caller.mess.dlgTitle,closeIcon:true});e.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgClose,className:"webform-small-button-accept crm-webform-edit-popup-button",events:{click:BX.proxy(function(){this.popup.close()},this)}})]);e.close=BX.proxy(this._popupClose,this);this.popup=e}};function CrmFormEditorFieldSelector(e){this.caller=e.caller;this.context=e.context;this.attributeSearch="data-bx-crm-wf-selector-search";this.attributeSearchButton="data-bx-crm-wf-selector-search-btn";this.attributeGroup="data-bx-crm-wf-selector-field-group";this.attributeField="data-bx-crm-wf-selector-field-name";this.attributeAddButton="data-bx-crm-wf-selector-btn-add";this.classFieldSelected="crm-webform-edit-right-inner-list-active";this.classSearchActive="crm-webform-edit-constructor-right-search-active";this.classGroupShow="crm-webform-edit-open";this.helper=BX.CrmFormEditorHelper;this.init(e)}CrmFormEditorFieldSelector.prototype={getFieldNode:function(e){return this.context.querySelector("["+this.attributeField+'="'+e+'"]')},init:function(e){this.groupNodeList=this.context.querySelectorAll("["+this.attributeGroup+"]");this.groupNodeList=BX.convert.nodeListToArray(this.groupNodeList);this.groupNodeList.forEach(this.initGroup,this);this.fieldNodeList=this.context.querySelectorAll("["+this.attributeField+"]");this.fieldNodeList=BX.convert.nodeListToArray(this.fieldNodeList);this.fieldNodeList.forEach(this.initField,this);var t=this.context.querySelectorAll("["+this.attributeAddButton+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(e){BX.bind(e,"click",BX.proxy(function(){this.addSpecialFormField(e.getAttribute(this.attributeAddButton))},this))},this);BX.addCustomEvent(this.caller,"delete-field",BX.proxy(this.onCallerFieldDelete,this));this.searchButton=this.context.querySelector("["+this.attributeSearchButton+"]");BX.bind(this.searchButton,"click",BX.proxy(this.onSearchButtonClick,this));this.searchInput=this.context.querySelector("["+this.attributeSearch+"]");BX.bind(this.searchInput,"bxchange",BX.proxy(this.onSearchChange,this))},showSearchResult:function(e){e=e||"";e=e.toLowerCase();this.fieldNodeList.forEach(function(t){var i=!e?true:t.innerText.toLowerCase().indexOf(e)>-1;this.helper.styleDisplay(t,i,"list-item")},this)},onSearchChange:function(){this.showSearchResult(this.searchInput.value)},onSearchButtonClick:function(){var e=BX.hasClass(this.searchButton,this.classSearchActive);if(e){this.collapseGroups();this.showSearchResult()}else{this.expandGroups();this.showSearchResult(this.searchInput.value)}BX.toggleClass(this.searchButton,this.classSearchActive);this.searchInput.focus()},initGroup:function(e){BX.bind(e.children[0],"click",BX.proxy(function(){BX.toggleClass(e,this.classGroupShow)},this))},expandGroups:function(){this.groupNodeList.forEach(function(e){BX.addClass(e,this.classGroupShow)},this)},collapseGroups:function(){this.groupNodeList.forEach(function(e){BX.removeClass(e,this.classGroupShow)},this)},initField:function(e){var t=e.getAttribute(this.attributeField);var i=this.caller.fields.filter(function(e){return e.name==t});if(i.length>0){BX.addClass(e,this.classFieldSelected)}BX.bind(e,"click",BX.proxy(function(t){BX.addClass(e,this.classFieldSelected);var i=e.getAttribute(this.attributeField);this.caller.addFieldByCode(i);BX.PreventDefault(t);return true},this))},addSpecialFormField:function(e){var t={entity_caption:"-",caption:"",type:e,name:e+"_"+this.helper.generateId()};switch(e){case"product":t.caption=this.caller.mess.newFieldProductsCaption;t.id="n"+this.helper.generateId();break;case"section":t.caption=this.caller.mess.newFieldSectionCaption;break;case"page":t.caption=this.caller.mess.newFieldPageCaption;break;case"hr":break;case"br":break}t.entity_field_caption=t.caption;return this.caller.addField(t)},onCallerFieldDelete:function(e){var t=this.getFieldNode(e.name);if(t){BX.removeClass(t,this.classFieldSelected)}}};function CrmFormEditorDragDrop(e){this.init(e)}CrmFormEditorDragDrop.prototype={addItem:function(e){this.dragdrop.addDragItem([e]);this.dragdrop.addSortableItem(e)},removeItem:function(e){this.dragdrop.removeSortableItem(e)},init:function(e){this.dragdrop=BX.DragDrop.create({sortable:{rootElem:BX("FIELD_CONTAINER"),gagClass:"gag-class"},dragActiveClass:"crm-webform-field-drag",dragItemClassName:"field-selected",dragDrop:BX.delegate(function(e,t,i){BX.onCustomEvent(this,"onSort",[t,e])},this),dragStart:BX.delegate(function(e,t,i){},this),dragOver:BX.delegate(function(e,t,i){},this),dragEnter:BX.delegate(function(e,t,i){},this),dragLeave:BX.delegate(function(e,t,i){},this),dragEnd:BX.delegate(function(e,t,i){BX.onCustomEvent(this,"onSort",[t,e])},this)})}};function CrmFormEditorDependencies(e){e=e||{};e.dependencies=e.dependencies||[];this.helper=BX.CrmFormEditorHelper;this.deps=[];this.container=BX("DEPENDENCY_CONTAINER");this.buttonAdd=BX("DEPENDENCY_BUTTON_ADD");this.init(e)}CrmFormEditorDependencies.prototype={add:function(e){var t="n"+this.helper.generateId();var i={ID:t,IF_FIELD_CODE:"",IF_VALUE:"",DO_FIELD_CODE:"",DO_ACTION:""};var n=this.helper.appendNodeByTemplate(this.container,this.caller.templates.dependency,i);this.bind(i);return n},bind:function(e){e.node=BX("DEPENDENCIES_"+e.ID);e.ifValueNodeCtrlS=BX("DEPENDENCIES_"+e.ID+"_IF_VALUE_CTRL_S");e.ifValueNodeCtrlI=BX("DEPENDENCIES_"+e.ID+"_IF_VALUE_CTRL_I");e.ifFieldNodeCtrl=BX("DEPENDENCIES_"+e.ID+"_IF_FIELD_CODE_CTRL");e.doFieldNodeCtrl=BX("DEPENDENCIES_"+e.ID+"_DO_FIELD_CODE_CTRL");e.ifValueNode=BX("DEPENDENCIES_"+e.ID+"_IF_VALUE");e.ifFieldNode=BX("DEPENDENCIES_"+e.ID+"_IF_FIELD_CODE");e.doFieldNode=BX("DEPENDENCIES_"+e.ID+"_DO_FIELD_CODE");e.actionNodeCtrl=BX("DEPENDENCIES_"+e.ID+"_DO_ACTION");e.elseHideTextNode=BX("DEPENDENCIES_"+e.ID+"_ELSE_HIDE");e.elseShowTextNode=BX("DEPENDENCIES_"+e.ID+"_ELSE_SHOW");var t=this;BX.bind(BX("DEPENDENCIES_"+e.ID+"_BTN_REMOVE"),"click",function(){t.remove(e)});BX.bind(e.ifFieldNodeCtrl,"change",function(){if(t.canChangeFields){e.ifFieldNode.value=this.value;t.actualizeFieldValues(e)}});BX.bind(e.doFieldNodeCtrl,"change",function(){if(t.canChangeFields){e.doFieldNode.value=this.value}var i="";if(this.selectedOptions&&this.selectedOptions.length>0){i=this.selectedOptions[0].innerText;i='"'+i+'"'}e.elseShowTextNode.children[0].innerText=i;e.elseHideTextNode.children[0].innerText=i});BX.bind(e.ifValueNodeCtrlS,"change",function(){if(t.canChangeFields){e.ifValueNode.value=this.value}});BX.bind(e.ifValueNodeCtrlI,"change",function(){if(t.canChangeFields){e.ifValueNode.value=this.value}});BX.bind(e.actionNodeCtrl,"change",BX.proxy(function(){var t=e.actionNodeCtrl.value=="hide";this.helper.styleDisplay(e.elseHideTextNode,!t);this.helper.styleDisplay(e.elseShowTextNode,t)},this));this.actualize(e);this.deps.push(e)},remove:function(e){BX.remove(e.node);var t=BX.util.array_search(e,this.deps);if(t>-1){delete this.deps[t]}},actualizeFieldList:function(e,t,i){this.canChangeFields=false;var n=["hr","br"];var o;var s="";i=i||false;if(i){s=this.caller.mess.selectFieldOrSection;o=this.caller.fields.filter(function(e){return!BX.util.in_array(e.type,n)},this)}else{s=this.caller.mess.selectField;o=this.caller.fields.filter(function(e){return e.type!="section"&&e.type!="page"&&!BX.util.in_array(e.type,n)},this)}o=BX.util.array_merge([{caption:s,value:"",selected:false}],o.map(function(e){return{value:e.name||"",caption:e.getCaption(),selected:BX.util.in_array(e.name,t)}}));this.helper.fillDropDownControl(e,o);this.canChangeFields=true},actualizeFieldValues:function(e){this.canChangeFields=false;var t=["product","list","checkbox","radio"];var i=e.ifFieldNode.value;if(!i)return;var n=this.caller.findField(i);if(!n)return;var o=BX.util.in_array(n.type,t);e.ifValueNodeCtrlI.style.display=o?"none":"";e.ifValueNodeCtrlS.style.display=!o?"none":"";var s=this.caller.mess.selectValue;var r=[e.ifValueNode.value];if(o){var a;if(n.items&&n.items.length>0){a=n.items}else if(n.type=="checkbox"){a=this.caller.booleanFieldItems}else{a=[]}a=a.map(function(e){return{value:e.ID,caption:e.VALUE,selected:BX.util.in_array(e.ID,r)}});this.helper.fillDropDownControl(e.ifValueNodeCtrlS,BX.util.array_merge([{caption:s,value:"",selected:false}],a))}else if(!o){e.ifValueNodeCtrlI.value=r[0]}this.canChangeFields=true},actualizeFieldListConditional:function(e,t){this.actualizeFieldList(e,t,false)},actualizeFieldListOperational:function(e,t){this.actualizeFieldList(e,t,true)},actualize:function(e){var t=e.ifFieldNode.value;var i=e.doFieldNode.value;var n=this.caller.getFieldNameList();if(t&&!BX.util.in_array(t,n)||i&&!BX.util.in_array(i,n)){this.remove(e)}else{this.actualizeFieldListConditional(e.ifFieldNodeCtrl,[t]);this.actualizeFieldValues(e);this.actualizeFieldListOperational(e.doFieldNodeCtrl,[i])}},onChangeFormFields:function(){this.deps.forEach(this.actualize,this)},init:function(e){this.caller=e.caller;this.helper=new CrmFormEditorHelper;this.canChangeFields=true;BX.bind(this.buttonAdd,"click",BX.proxy(this.add,this));e.dependencies.forEach(this.bind,this);BX.addCustomEvent(this.caller,"change-field-list",BX.proxy(this.onChangeFormFields,this));BX.addCustomEvent(this.caller,"change-field-items",BX.proxy(this.onChangeFormFields,this))}};function CrmFormEditorFieldPreset(e){e=e||{};e.fields=e.fields||[];this.fields=[];this.container=BX("PRESET_FIELD_CONTAINER");this.buttonAdd=BX("PRESET_FIELD_SELECTOR_BTN");this.toggler=BX("USE_PRESET_FIELDS");this.context=BX("PRESET_FIELDS");this.dealCatrgoryNode=BX("DEAL_CATEGORY");this.init(e)}CrmFormEditorFieldPreset.prototype={isExists:function(e){var t=false;this.fields.forEach(function(i){if(i.CODE==e){t=true}});return t},add:function(e){if(this.isExists(e.CODE)){return null}var t=this.caller.findDictionaryField(e.CODE);if(!t){return null}var i={CODE:t.name,ENTITY_CAPTION:t.entity_caption,ENTITY_FIELD_CAPTION:t.caption,ENTITY_NAME:t.entity_name,ENTITY_FIELD_NAME:t.entity_field_name,VALUE:""};var n=this.helper.appendNodeByTemplate(this.container,this.caller.templates.presetField,i);i.ITEMS=t.items||null;this.bind(i);return n},bind:function(e){e.node=BX("FIELD_PRESET_"+e.CODE);e.valueNodeCtrl=BX("FIELD_PRESET_"+e.CODE+"_VALUE");e.valueNodeCtrlS=BX("FIELD_PRESET_"+e.CODE+"_VALUE_CTRL_S");e.valueNodeCtrlI=BX("FIELD_PRESET_"+e.CODE+"_VALUE_CTRL_I");e.valueNodeCtrlIMacros=BX("FIELD_PRESET_"+e.CODE+"_VALUE_CTRL_I_M");e.valueNodeCtrlIMacrosHint=e.node.querySelector(".crm-webform-context-help");this.caller.initToolTips([e.valueNodeCtrlIMacrosHint]);var t=this;BX.bind(BX("FIELD_PRESET_"+e.CODE+"_BTN_REMOVE"),"click",function(){t.remove(e)});BX.bind(e.valueNodeCtrlS,"change",function(){if(t.canChangeFields){e.valueNodeCtrl.value=this.value}});BX.bind(e.valueNodeCtrlI,"change",function(){if(t.canChangeFields){e.valueNodeCtrl.value=this.value}});BX.bind(e.valueNodeCtrlIMacros,"click",function(){t.popupMacrosCurrentInput=e.valueNodeCtrlI;t.popupMacros.setBindElement(e.valueNodeCtrlIMacros);t.popupMacros.show()});if(e.CODE=="DEAL_STAGE_ID"&&this.dealCatrgoryNode){BX.bind(this.dealCatrgoryNode,"click",function(){t.actualize(e)})}this.actualize(e);this.fields.push(e);if(this.isFieldTypeList(e)){BX.fireEvent(e.valueNodeCtrlS,"change")}else{BX.fireEvent(e.valueNodeCtrlI,"change")}if(this.isFieldTypeEquals(e,["date","datetime"])){var i=this;BX.bind(e.valueNodeCtrlI,"click",function(){BX.calendar({node:e.valueNodeCtrlI,field:e.valueNodeCtrlI,bTime:i.isFieldTypeEquals(e,["datetime"])})})}},removeAll:function(){this.fields.forEach(this.remove,this)},remove:function(e){BX.remove(e.node);var t=BX.util.array_search(e,this.fields);if(t>-1){delete this.fields[t]}},isFieldTypeEquals:function(e,t){t=BX.type.isArray(t)?t:[t];var i=e.CODE;if(!i)return false;var n=this.caller.findDictionaryField(i);if(!n)return false;return BX.util.in_array(n.type,t)},isFieldTypeList:function(e){return this.isFieldTypeEquals(e,["list","checkbox","radio"])},actualize:function(e){this.canChangeFields=false;var t=e.CODE;if(!t)return;var i=this.caller.findDictionaryField(t);if(!i)return;var n=this.isFieldTypeList(e);e.valueNodeCtrlI.style.display=n?"none":"";e.valueNodeCtrlIMacros.style.display=n?"none":"";e.valueNodeCtrlIMacrosHint.style.display=n?"none":"";e.valueNodeCtrlS.style.display=!n?"none":"";var o=[e.valueNodeCtrl.value];if(n){var s;if(!i.items||i.items.length==0){if(i.type=="checkbox"){s=this.caller.booleanFieldItems}}else{s=i.items}if(s){if(t=="DEAL_STAGE_ID"&&this.dealCatrgoryNode){var r=this.dealCatrgoryNode.value;if(r&&i.itemsByCategory&&i.itemsByCategory[r]){s=i.itemsByCategory[r]}}this.helper.fillDropDownControl(e.valueNodeCtrlS,s.map(function(e){return{value:e.ID,caption:e.VALUE,selected:BX.util.in_array(e.ID,o)}}))}}else if(!n){e.valueNodeCtrlI.value=o[0]}this.canChangeFields=true},onChangeEntityScheme:function(e){var t=this.caller.entityScheme.getCurrentWillCreatedEntities();t.push("ACTIVITY");var i=this.fields.filter(function(e){return!BX.util.in_array(e.ENTITY_NAME,t)},this);if(i){i.reverse();i.forEach(function(e){this.remove(e)},this)}var n;var o=BX.convert.nodeListToArray(BX("PRESET_FIELD_SELECTOR").querySelectorAll("optgroup"));o.forEach(function(e){var i=BX.util.in_array(e.getAttribute("data-bx-crm-wf-entity"),t);e.style.display=i?"block":"none";if(!n&&i)n=e.querySelector("option")},this);if(n){n.selected=true}},onButtonAddClick:function(){this.add({CODE:BX("PRESET_FIELD_SELECTOR").value})},toggle:function(){BX.toggleClass(this.context,"crm-webform-edit-animate-show");if(!this.toggler.checked){this.removeAll()}},onToggle:function(e){if(!this.toggler.checked&&this.fields.length>0&&!confirm(this.caller.mess.dlgFieldPresetRemoveConfirm)){e.preventDefault();e.stopPropagation();return false}this.toggle()},init:function(e){this.caller=e.caller;this.helper=new CrmFormEditorHelper;this.canChangeFields=true;BX.bind(this.buttonAdd,"click",BX.proxy(this.onButtonAddClick,this));if(e.fields){e.fields.forEach(this.bind,this)}BX.addCustomEvent(this.caller,"change-entity-scheme",BX.proxy(this.onChangeEntityScheme,this));this.onChangeEntityScheme(this.caller.entityScheme.getCurrent());BX.bind(this.toggler,"click",this.onToggle.bind(this));this.initMacros()},initMacros:function(){this.popupMacrosCurrentInput=null;var e="data-bx-preset-macros";var t=BX("CRM_WEB_FORM_POPUP_PRESET_MACROS");var i=BX.convert.nodeListToArray(t.querySelectorAll("["+e+"]"));i.forEach(BX.proxy(function(t){BX.bind(t,"click",BX.delegate(function(){if(!this.popupMacrosCurrentInput){return}this.popupMacrosCurrentInput.value+=" "+t.getAttribute(e);BX.fireEvent(this.popupMacrosCurrentInput,"change");this.popupMacros.close()},this))},this));this.popupMacros=BX.PopupWindowManager.create("crm_webform_edit_preset_macros",null,{content:t,autoHide:true,lightShadow:true,closeByEsc:true})}};function CrmFormEditorExternalAnalytics(e){this.context=BX("CRM_WEBFORM_EXTERNAL_ANALYTICS");this.classNameExisted="crm-webform-edit-task-options-metric-exist";this.attributeItem="data-bx-crm-webform-ext-an";this.attributeClose="data-bx-crm-webform-ext-an-close";this.attributeAdd="data-bx-crm-webform-ext-an-add";this.attributeValue="data-bx-crm-webform-ext-an-val";var t=this.context.querySelectorAll("["+this.attributeItem+"]");t=BX.convert.nodeListToArray(t);t.forEach(this.bind,this)}CrmFormEditorExternalAnalytics.prototype={bind:function(e){var t=e.querySelector("["+this.attributeClose+"]");var i=e.querySelector("["+this.attributeAdd+"]");var n=e.querySelector("["+this.attributeValue+"]");BX.bind(t,"click",BX.proxy(function(){BX.removeClass(e,this.classNameExisted);n.value=""},this));BX.bind(i,"click",BX.proxy(function(){BX.addClass(e,this.classNameExisted);n.focus()},this))}};function CrmFormEditorUserBlockController(e){this.context=BX("CRM_WEBFORM_ADDITIONAL_OPTIONS");this.additionalOptionContainer=BX("ADDITIONAL_OPTION_CONTAINER");this.attributeOption="data-bx-crm-webform-edit-option";this.attributeNav="data-bx-crm-webform-edit-option-nav";this.attributePin="data-bx-crm-webform-edit-option-pin";this.userOptionPin=e.optionPinName;this.blocks=[];this.helper=BX.CrmFormEditorHelper;var t=this.context.querySelectorAll("["+this.attributeOption+"]");t=BX.convert.nodeListToArray(t);t.forEach(this.initBlock,this);BX.bind(BX("ADDITIONAL_OPTION_BUTTON"),"click",BX.proxy(function(){BX.toggleClass(this.additionalOptionContainer,"crm-webform-edit-open")},this))}CrmFormEditorUserBlockController.prototype={initBlock:function(e){var t=e.getAttribute(this.attributeOption);var i=e.querySelector("["+this.attributePin+"]");var n={id:t,node:e,navNode:this.context.querySelector("["+this.attributeNav+'="'+t+'"]'),pinNode:i,isFixed:this.isBlockPinFixed(i)};this.blocks.push(n);var o=this;BX.bind(n.pinNode,"click",function(){o.onClickBlockPin(n)});BX.bind(n.navNode,"click",function(e){BX.PreventDefault(e);o.highLightBlock(n);return true});if(n.id=="ENTITY_SCHEME"){BX.bind(BX("CRM_WEBFORM_STICKER_ENTITY_SCHEME_NAV"),"click",function(e){BX.PreventDefault(e);o.highLightBlock(n);return true})}},isBlockPinFixed:function(e){return BX.hasClass(e,"task-option-fixed-state")},onClickBlockPin:function(e){e.isFixed=!this.isBlockPinFixed(e.pinNode);this.saveBlockPinState(e.id,e.isFixed);this.helper.changeClass(e.pinNode,"task-option-fixed-state",e.isFixed);this.moveBlock(e);this.helper.changeClass(e.navNode,"crm-webform-display-none",e.isFixed)},show:function(){BX.addClass(this.additionalOptionContainer,"crm-webform-edit-open")},hide:function(){BX.removeClass(this.additionalOptionContainer,"crm-webform-edit-open")},highLightBlock:function(e){this.show();var t="crm-webform-edit-highlight";BX.addClass(e.node,t);setTimeout(function(){var t=BX.pos(e.node);window.scrollTo(0,t.top)},600);setTimeout(function(){BX.removeClass(e.node,t)},3e3)},moveBlock:function(e){this.show();BX.addClass(e.node,"crm-webform-display-none");var t=e.isFixed?BX("FIXED_OPTION_PLACE"):BX("ADDITIONAL_OPTION_PLACE_"+e.id);t.appendChild(e.node);BX.removeClass(e.node,"crm-webform-display-none")},saveBlockPinState:function(e,t){BX.userOptions.save("crm",this.userOptionPin,e,t?"Y":"N")}};function CrmFormEditorFieldListSettings(e){this.type=e.type;this.context=e.context;this.caller=e.caller;this.field=e.field;this.helper=BX.CrmFormEditorHelper;this.nodeItemsContainer=this.context.querySelector("[data-bx-crm-webform-field-settings-items]");this.attributeItem="data-bx-crm-webform-field-settings-item";this.attributeItemCheck="data-bx-crm-webform-field-settings-item-check";this.attributeItemRadio="data-bx-crm-webform-field-settings-item-radio";this.attributeItemClear="data-bx-crm-webform-field-settings-item-clear";this.attributeItemInput="data-bx-crm-webform-field-settings-item-input";this.init()}CrmFormEditorFieldListSettings.prototype={init:function(){if(!this.nodeItemsContainer){return}var e=this.nodeItemsContainer.querySelectorAll("["+this.attributeItem+"]");e=BX.convert.nodeListToArray(e);e.forEach(function(e){var t=e.querySelector("["+this.attributeItemClear+"]");var i=e.querySelector("["+this.attributeItemInput+"]");var n=e.getAttribute(this.attributeItem);BX.bind(t,"click",function(){i.value="";BX.fireEvent(i,"change")});BX.bind(i,"change",BX.proxy(function(){this.field.items.forEach(function(e){if(e.ID==n){e.VALUE=i.value;this.caller.fireFieldChangeItemsEvent(this.field)}},this)},this))},this);if(this.type=="checkbox"){this.showControls(this.attributeItemCheck)}else if(this.type=="radio"){this.showControls(this.attributeItemRadio)}},showControls:function(e){var t=this.nodeItemsContainer.querySelectorAll("["+e+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(e){e.disabled=false;this.helper.styleDisplay(e,true)},this)}};function CrmFormEditorProductSelector(e){this.helper=BX.CrmFormEditorHelper;this.caller=e.caller;this.id=e.id;this.field=e.field;this.context=e.context;this.node=this.context.querySelector("[data-bx-crm-webform-product]");if(!this.node){return}this.nodeItems=this.node.querySelector("[data-bx-crm-webform-product-items]");this.nodeSelect=this.node.querySelector("[data-bx-crm-webform-product-select]");this.nodeAddRow=this.node.querySelector("[data-bx-crm-webform-product-add-row]");this.attributeItem="data-bx-crm-webform-product-item";this.attributeItemDelete="data-bx-crm-webform-product-item-del";this.attributeItemInput="data-bx-crm-webform-product-item-input";this.random=Math.random();this.jsEventsManagerId=e.jsEventsManagerId;this.caller=e.caller;BX.bind(this.nodeSelect,"click",BX.proxy(this.onClick,this));BX.bind(this.nodeAddRow,"click",BX.proxy(this.onClickAddRow,this));this._choiceBtnEnabled=true;BX.addCustomEvent("CrmProductSearchDialog_SelectProduct",BX.proxy(this.onProductClick,this));this.isCallSearchDialog=false;this.initItems()}CrmFormEditorProductSelector.prototype={onShow:function(e){this.isCallSearchDialog=true;this.helper.overlay.removeOverlay();this.caller.popupFieldSettings.setAutoHide(false)},onClose:function(e){this.isCallSearchDialog=false;this._choiceBtnEnabled=true;this.caller.popupFieldSettings.setAutoHide(false)},onClick:function(e){if(!this._choiceBtnEnabled)return;this._choiceBtnEnabled=false;this.helper.overlay.createOverlay(2e3);var t="crm_productrow_list";var i=BX.CrmProductSearchDialogWindow.create({content_url:"/bitrix/components/bitrix/crm.webform.edit/product_choice_dialog.php"+"?caller="+t+"&JS_EVENTS_MANAGER_ID="+BX.util.urlencode(this.jsEventsManagerId)+"&sessid="+BX.bitrix_sessid(),closeWindowHandler:BX.delegate(this.onClose,this),showWindowHandler:BX.delegate(this.onShow,this),jsEventsManagerId:this.jsEventsManagerId,height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),minHeight:500,minWidth:800,draggable:true,resizable:true});i.show()},onClickAddRow:function(){this.addFieldItem({id:"n"+this.helper.generateId(),name:"",price:"",discount:"",custom_price:""})},initItems:function(){this.field.items.forEach(function(e){var t=this.nodeItems.querySelector("["+this.attributeItem+'="'+e.ID+'"'+"]");if(!t){return}this.initProductItem(t,e)},this)},handleProductChoice:function(e,t){t=!!t;var i=typeof e["product"]!="undefined"&&typeof e["product"][0]!="undefined"?e["product"][0]:null;if(!i){return}var n=typeof i["customData"]!=="undefined"?i["customData"]:{};var o=typeof n["measure"]!=="undefined"?n["measure"]:{};var s={id:i["id"],name:i["title"],quantity:1,price:typeof n["price"]!="undefined"?parseFloat(n["price"]):0,customized:false,measureCode:typeof o["code"]!=="undefined"?parseInt(o["code"]):0,measureName:typeof o["name"]!=="undefined"?o["name"]:"",tax:typeof n["tax"]!=="undefined"?n["tax"]:{}};this.addFieldItem(s)},addFieldItem:function(e){var t=this.helper.getNodeByTemplate("tmpl_field_product_settings_item",{id:this.id,name:this.field.name,item_id:e.id,item_value:e.name,item_price:e.price,item_discount:e.discount||"",item_custom_price:e.custom_price==="Y"?"checked":"",currency_short_name:this.caller.currency.SHORT_NAME});var i={ID:e.id,PRICE:e.price,DISCOUNT:e.discount,CUSTOM_PRICE:e.custom_price,VALUE:e.name};this.initProductItem(t,i);this.field.items.push(i);this.nodeItems.appendChild(t);this.fireFieldItemsChange()},fireFieldItemsChange:function(){this.caller.fireFieldChangeItemsEvent(this.field)},initProductItem:function(e,t){var i=e.getAttribute(this.attributeItem);var n=e.querySelector("["+this.attributeItemDelete+"]");var o=e.querySelector("["+this.attributeItemInput+"]");BX.bind(n,"click",BX.proxy(function(){this.removeProductItem(e,t)},this));BX.bind(o,"change",BX.proxy(function(){this.field.items.forEach(function(e){if(e.ID==i){e.VALUE=o.value;this.caller.fireFieldChangeItemsEvent(this.field)}},this)},this))},removeProductItem:function(e,t){var i=BX.util.array_search(t,this.field.items);if(i>-1){this.field.items=BX.util.deleteFromArray(this.field.items,i)}BX.remove(e);this.fireFieldItemsChange()},onProductClick:function(e){if(!this.isCallSearchDialog){return}e=parseInt(e);if(e<=0){return}var t="";BX.ajax({url:"/bitrix/components/bitrix/crm.product.list/list.ajax.php",method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:t,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:"["+e+"]",LIMIT:1},onsuccess:BX.delegate(this.onProductChoiceByIdSuccess,this),onfailure:BX.delegate(this.onProductChoiceByIdFailure,this)})},onProductChoiceByIdSuccess:function(e){var t;if(e&&e["data"]){t=e["data"];if(t[0]){t={product:[t[0]]};this.handleProductChoice(t,true)}}},onProductChoiceByIdFailure:function(e){}};function CrmFormEditorHelper(){}CrmFormEditorHelper.prototype={generateId:function(e,t){e=e||1e6;t=t||9999999;return Math.floor(Math.random()*(t-e))+e},fillDropDownControl:function(e,t){t=t||[];e.innerHTML="";t.forEach(function(t){if(!t||!t.caption){return}var i=document.createElement("option");i.value=t.value;i.selected=!!t.selected;i.innerText=t.caption;e.appendChild(i)})},appendNodeByTemplate:function(e,t,i){var n=this.getNodeByTemplate(t,i);if(n){e.appendChild(n)}return n},getNodeByTemplate:function(e,t){var i=this.getTemplate(e,t);if(!i){return null}var n=BX.create("div",{html:i});return n.firstElementChild},getTemplate:function(e,t){var i=BX(e);if(!i){return null}var n=i.innerHTML;if(t){for(var o in t){if(t[o]===undefined){continue}var s=o;var r=BX.util.htmlspecialchars(t[o]);n=n.replace(new RegExp("%"+s+"%","g"),r)}}return n},changeClass:function(e,t,i){i=i||false;if(!e){return}if(i){BX.addClass(e,t)}else{BX.removeClass(e,t)}},styleDisplay:function(e,t,i){t=t||false;i=i||"";if(!e){return}e.style.display=t?i:"none"},overlay:{createOverlay:function(e){e=parseInt(e);if(!this._overlay){var t=BX.GetWindowScrollSize();this._overlay=document.body.appendChild(BX.create("DIV",{style:{position:"absolute",top:"0px",left:"0px",zIndex:e||parseInt(this.DIV.style.zIndex)-2,width:t.scrollWidth+"px",height:t.scrollHeight+"px"}}));BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));BX.bind(window,"resize",BX.proxy(this._resizeOverlay,this))}},removeOverlay:function(){if(this._overlay&&this._overlay.parentNode){this._overlay.parentNode.removeChild(this._overlay);BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));this._overlay=null}},_resizeOverlay:function(){var e=BX.GetWindowScrollSize();this._overlay.style.width=e.scrollWidth+"px"}}};BX.CrmFormEditorHelper=new CrmFormEditorHelper;if(typeof BX.CrmProductSearchDialogWindow==="undefined"){BX.CrmProductSearchDialogWindow=function(){this._settings={};this.popup=null;this.random="";this.contentContainer=null;this.zIndex=100;this.jsEventsManager=null;this.pos=null;this.height=0;this.width=0;this.resizeCorner=null};BX.CrmProductSearchDialogWindow.prototype={initialize:function(e){this.random=Math.random().toString().substring(2);this._settings=e?e:{};var t=BX.CrmProductSearchDialogWindow.size;this._settings.width=t.width||this._settings.width||1100;this._settings.height=t.height||this._settings.height||530;this._settings.minWidth=this._settings.minWidth||500;this._settings.minHeight=this._settings.minHeight||800;this._settings.draggable=!!this._settings.draggable||true;this._settings.resizable=!!this._settings.resizable||true;if(typeof this._settings.closeWindowHandler!=="function")this._settings.closeWindowHandler=null;if(typeof this._settings.showWindowHandler!=="function")this._settings.showWindowHandler=null;this.jsEventsManager=BX.Crm[this._settings.jsEventsManagerId]||null;this.contentContainer=BX.create("DIV",{attrs:{className:"crm-catalog",style:"display: block; background-color: #f3f6f7; height: "+this._settings.height+"px; overflow: hidden; width: "+this._settings.width+"px;"}})},_handleCloseDialog:function(e){if(e)e.destroy();this.popup=null;if(this.jsEventsManager){this.jsEventsManager.unregisterEventHandlers("CrmProduct_SelectSection")}if(typeof this._settings.closeWindowHandler==="function")this._settings.closeWindowHandler()},_handleAfterShowDialog:function(e){e.popupContainer.style.position="fixed";e.popupContainer.style.top=parseInt(e.popupContainer.style.top)-BX.GetWindowScrollPos().scrollTop+"px";if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},setContent:function(e){if(BX.type.isString(e)&&BX.type.isDomNode(this.contentContainer))this.contentContainer.innerHTML=e},show:function(){BX.ajax({method:"GET",dataType:"html",url:this._settings.content_url,data:{},skipAuthCheck:true,onsuccess:BX.delegate(function(e){this.setContent(e||"&nbsp;");this.showWindow()},this),onfailure:BX.delegate(function(){if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},this)})},showWindow:function(){this.popup=new BX.PopupWindow("CrmProductSearchDialogWindow_"+this.random,null,{overlay:{opacity:82},autoHide:false,draggable:this._settings.draggable,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},bindOnResize:false,zIndex:this.zIndex-300,closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:{content:BX.create("SPAN",{attrs:{className:"popup-window-titlebar-text"},text:BX.message("CRM_WEBFORM_EDIT_JS_PRODUCT_CHOICE")})},events:{onPopupClose:BX.delegate(this._handleCloseDialog,this),onAfterPopupShow:BX.delegate(this._handleAfterShowDialog,this)},content:this.contentContainer});if(this.popup.popupContainer){this.resizeCorner=BX.create("SPAN",{attrs:{className:"bx-crm-dialog-resize"},events:{mousedown:BX.delegate(this.resizeWindowStart,this)}});this.popup.popupContainer.appendChild(this.resizeCorner);if(!this._settings.resizable)this.resizeCorner.style.display="none"}this.popup.show()},setResizable:function(e){e=!!e;if(this._settings.resizable!==e){this._settings.resizable=e;if(this.resizeCorner){if(e)this.resizeCorner.style.display="inline-block";else this.resizeCorner.style.display="none"}}},resizeWindowStart:function(e){if(!this._settings.resizable)return;e=e||window.event;BX.PreventDefault(e);this.pos=BX.pos(this.contentContainer);BX.bind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.bind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));if(document.body.setCapture)document.body.setCapture();try{document.onmousedown=false}catch(e){}try{document.body.onselectstart=false}catch(e){}try{document.body.ondragstart=false}catch(e){}try{document.body.style.MozUserSelect="none"}catch(e){}try{document.body.style.cursor="nwse-resize"}catch(e){}},resizeWindowMove:function(e){var t=BX.GetWindowScrollPos();var i=e.clientX+t.scrollLeft;var n=e.clientY+t.scrollTop;BX.CrmProductSearchDialogWindow.size.height=this.height=Math.max(n-this.pos.top,this._settings.minHeight);BX.CrmProductSearchDialogWindow.size.width=this.width=Math.max(i-this.pos.left,this._settings.minWidth);this.contentContainer.style.height=this.height+"px";this.contentContainer.style.width=this.width+"px"},resizeWindowStop:function(e){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.unbind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));try{document.onmousedown=null}catch(e){}try{document.body.onselectstart=null}catch(e){}try{document.body.ondragstart=null}catch(e){}try{document.body.style.MozUserSelect=""}catch(e){}try{document.body.style.cursor="auto"}catch(e){}}};BX.CrmProductSearchDialogWindow.create=function(e){var t=new BX.CrmProductSearchDialogWindow;t.initialize(e);return t};BX.CrmProductSearchDialogWindow.loadCSS=function(e){BX.ajax({method:"GET",dataType:"html",url:e.content_url,data:{},skipAuthCheck:true})};BX.CrmProductSearchDialogWindow.size={width:0,height:0}}BX.namespace("BX.Crm");if(typeof BX.Crm.PageEventsManagerClass==="undefined"){BX.Crm.PageEventsManagerClass=function(){this._settings={}};BX.Crm.PageEventsManagerClass.prototype={initialize:function(e){this._settings=e?e:{};this.eventHandlers={}},registerEventHandler:function(e,t){if(!this.eventHandlers[e])this.eventHandlers[e]=[];this.eventHandlers[e].push(t);BX.addCustomEvent(this,e,t)},fireEvent:function(e,t){BX.onCustomEvent(this,e,t)},unregisterEventHandlers:function(e){if(this.eventHandlers[e]){for(var t=0;t<this.eventHandlers[e].length;t++){BX.removeCustomEvent(this,e,this.eventHandlers[e][t]);delete this.eventHandlers[e][t]}}}};BX.Crm.PageEventsManagerClass.create=function(e){var t=new BX.Crm.PageEventsManagerClass;t.initialize(e);return t}}function CrmFormEditorDestination(e){var t=this;this.caller=e.caller;var i=e.container;var n,o=i.getAttribute("data-config");if(o){n=BX.parseJSON(o)}if(!BX.type.isPlainObject(n))n={};this.container=i;this.itemsNode=BX.create("span");this.inputBoxNode=BX.create("span",{attrs:{className:"feed-add-destination-input-box",style:"display: none;"}});this.inputNode=BX.create("input",{props:{type:"text"},attrs:{className:"feed-add-destination-inp"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=BX.create("a",{attrs:{className:"feed-add-destination-link"}});BX.addClass(i,"crm-webform-popup-autocomplete");i.appendChild(this.itemsNode);i.appendChild(this.inputBoxNode);i.appendChild(this.tagNode);this.itemTpl=n.itemTpl;this.data=null;this.dialogId="crm_webform_edit_responsible_";this.createValueNode(n.valueInputName||"");this.selected=n.selected?BX.clone(n.selected):[];this.selectOne=!n.multiple;this.required=n.required||false;this.additionalFields=BX.type.isArray(n.additionalFields)?n.additionalFields:[];BX.bind(this.tagNode,"focus",function(e){t.openDialog({bByFocusEvent:true});return BX.PreventDefault(e)});BX.bind(this.container,"click",function(e){t.openDialog();return BX.PreventDefault(e)});this.addItems(this.selected);this.tagNode.innerHTML=this.selected.length<=0?this.caller.mess.dlgChoose:this.caller.mess.dlgChange}CrmFormEditorDestination.prototype={getData:function(e){var t=this;if(t.ajaxProgress)return;t.ajaxProgress=true;this.caller.sendActionRequest("get_destination_data",{},function(i){t.data=i.DATA||{};t.ajaxProgress=false;t.initDialog(e)},function(){})},initDialog:function(e){var t,i=this,n=this.data;if(!n){i.getData(e);return}var o={};for(t=0;t<i.selected.length;++t){o[i.selected[t].id]=i.selected[t].entityType}var s={users:n.USERS||{},department:n.DEPARTMENT||{},departmentRelation:n.DEPARTMENT_RELATION||{},bpuserroles:n.ROLES||{}};var r={users:n.LAST.USERS||{},bpuserroles:n.LAST.ROLES||{}};for(t=0;t<this.additionalFields.length;++t){s.bpuserroles[this.additionalFields[t]["id"]]=this.additionalFields[t]}if(!s["departmentRelation"]){s["departmentRelation"]=BX.SocNetLogDestination.buildDepartmentRelation(s["department"])}if(!i.inited){i.inited=true;var a=i.inputNode;a.id=i.dialogId+"input";var l=i.inputBoxNode;l.id=i.dialogId+"input-box";var d=this.tagNode;d.id=this.dialogId+"tag";var c=i.itemsNode;BX.SocNetLogDestination.init({name:i.dialogId,searchInput:a,extranetUser:false,bindMainPopup:{node:i.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:i.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,callback:{select:function(e,t,n,o){i.addItem(e,t);if(i.selectOne)BX.SocNetLogDestination.closeDialog()},unSelect:function(e){if(i.selectOne)return;i.unsetValue(e.entityId);BX.SocNetLogDestination.BXfpUnSelectCallback.call({formName:i.dialogId,inputContainerName:c,inputName:a.id,tagInputName:d.id,tagLink1:i.caller.mess.dlgChoose,tagLink2:i.caller.mess.dlgChange},e)},openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id}),closeSearch:BX.delegate(BX.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id})},items:s,itemsLast:r,itemsSelected:o,useClientDatabase:false,destSort:n.DEST_SORT||{},allowAddUser:false});BX.bind(a,"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:i.dialogId,inputName:a.id,tagInputName:d.id}));BX.bind(a,"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:i.dialogId,inputName:a.id}));BX.SocNetLogDestination.BXfpSetLinkName({formName:i.dialogId,tagInputName:d.id,tagLink1:i.caller.mess.dlgChoose,tagLink2:i.caller.mess.dlgChange})}e()},addItem:function(e,t){var i=this;var n=this.inputNode;var o=this.tagNode;var s=this.itemsNode;if(!BX.findChild(s,{attr:{"data-id":e.id}},false,false)){if(i.selectOne&&i.inited){var r=[];for(var a=0;a<s.childNodes.length;++a){r.push({itemId:s.childNodes[a].getAttribute("data-id"),itemType:s.childNodes[a].getAttribute("data-type")})}i.initDialog(function(){for(var e=0;e<r.length;++e){BX.SocNetLogDestination.deleteItem(r[e].itemId,r[e].itemType,i.dialogId)}});BX.cleanNode(s);i.cleanValue()}var l=this.createItemNode({text:e.name,deleteEvents:{click:function(n){if(i.selectOne&&i.required){i.openDialog()}else{i.initDialog(function(){BX.SocNetLogDestination.deleteItem(e.id,t,i.dialogId);BX.remove(l);i.unsetValue(e.entityId)})}BX.PreventDefault(n)}}});this.setValue(e.entityId);l.setAttribute("data-id",e.id);l.setAttribute("data-type",t);s.appendChild(l);if(!e.entityType)e.entityType=t}n.value="";o.innerHTML=this.caller.mess.dlgChange},addItems:function(e){for(var t=0;t<e.length;++t){this.addItem(e[t],e[t].entityType)}},openDialog:function(e){var t=this;this.initDialog(function(){BX.SocNetLogDestination.openDialog(t.dialogId,e)})},destroy:function(){if(this.inited){if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.SocNetLogDestination.closeSearch()}},createItemNode:function(e){return BX.create("span",{attrs:{className:"crm-webform-popup-autocomplete-item"},children:[BX.create("span",{attrs:{className:"crm-webform-popup-autocomplete-name"},html:e.text||""}),BX.create("span",{attrs:{className:"crm-webform-popup-autocomplete-delete"},events:e.deleteEvents})]})},createValueNode:function(e){this.valueNode=BX.create("input",{props:{type:"hidden",name:e}});this.container.appendChild(this.valueNode)},setValue:function(e){if(/^\d+$/.test(e)!==true)return;if(this.selectOne)this.valueNode.value=e;else{var t,i=[],n=this.valueNode.value.split(",");for(t=0;t<n.length;++t){if(!n[t]||e==n[t])continue;i.push(n[t])}i.push(e);this.valueNode.value=i.join(",")}},unsetValue:function(e){if(/^\d+$/.test(e)!==true)return;if(this.selectOne)this.valueNode.value="";else{var t,i=[],n=this.valueNode.value.split(",");for(t=0;t<n.length;++t){if(!n[t]||e==n[t])continue;i.push(n[t])}this.valueNode.value=i.join(",")}},cleanValue:function(){this.valueNode.value=""}};function CrmFormAdsForm(e){this.caller=e.caller;this.container=e.container;this.init()}CrmFormAdsForm.prototype={init:function(e){if(!this.container||!this.caller.id){return}this.attributeButton="data-bx-ads-button";var t=this.container.querySelectorAll("["+this.attributeButton+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(e){BX.bind(e,"click",BX.proxy(function(t){t.preventDefault();this.caller.slider.open(e.href)},this))},this);this.adsPopup=null}};
/* End */
;; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?169925794962259*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js?16992579501940*/
; /* /bitrix/components/bitrix/crm.webform.edit/templates/.default/script.min.js?169925796279132*/

//# sourceMappingURL=page_8c2b16525699d09da5661e457ffb2de4.map.js